---
title: "Carbon sequestration"
author: "Christopher L. Crawford"
date: "11/16/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r initialize}
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/0_start.R")
# install.packages("terra")
# packageVersion("terra")
# library(terra)

```

```{r load-files}
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/util/_util_files.R")
```

# Methods

Question: How much carbon could be sequestered over the course of the time series, for a) forests and, if possible, b) grasslands?

This analysis requires maps of annual rates of potential carbon sequestration in forests (aboveground biomass) and soils (for grasslands, savannas, shrublands), and three steps:  
1. Differentiate between forested and grassland/savanna regions
2. Apply forest sequestration rates from @Cook-Patton2020 to forested areas, and 
3. Apply soil carbon sequestration rates from @Sanderman2020 and @Woolf2020.

Step 1: separate forest from non-forest
Differentiate between forested and grassland/savanna regions using three methods:

Crop using the Ecoregions 2017 layer [@Dinerstein2017], excluding any grassland, savanna, or shrubland biome (following @Cook-Patton2020).

Step 2: for carbon sequestration rates

Within forested areas, estimate total carbon accumulated as a function of length of abandonment using data on annual carbon accumulation rates in aboveground biomass from @Cook-Patton2020.
These pixel values correspond to the potential aboveground carbon accumulation rates for the first 30 years of natural forest regrowth (1km), in terms of Mg C / ha / year.

@Cook-Patton2020 also includes 1) estimates of below-ground carbon sequestration rates (based on root-to-shoot ratio, and 2) estimates of soil organic carbon sequestration (SOC) in forest areas, based on a single global mean value of 0.42 Mg C / ha / year.

In order to calculate the carbon accumulated in each pixel, I will add the sequestration rates together (aboveground + belowground + SOC) to get an overall sequestration rate (Mg C / ha / year), which I will then multiply by the age of each pixel (years), and the area of each pixel (ha).

\begin{equation}
C_{accumulated} = MgC /ha /year * years (abandoned) * ha (area) = Mg C / pixel (\#eq:carbon-calculation)
\end{equation}

To calculate the total carbon accumulation, I then sum across all of these pixel values.


c.	This is akin to a maximum value, assuming perfect conditions, and represents the maximum amount of carbon that could be stored in forests. The full extent of the Cook-Patton layer is everywhere that could climatically support forests, not necessarily what is or was in forest (i.e. PNV).
d.	Note: Cook-Patton explicitly do not calculate sequestration rates in “grassland and shrubland” biomes, but they do in “savanna” biomes. These are the ones that need to be clipped out. 

3.	Within non-forested areas (i.e., grasslands, savannas, etc.), conservatively assume that all carbon being sequestered is being sequestered in soil organic carbon (SOC). 
a.	Use estimates from SoilsRevealed – Sanderman et al. 2020: https://doi.org/10.7910/DVN/HA17D3 (https://soilsrevealed.org/)
b.	Using the “rewilding” scenario, isolate pixels that initially fall as cropland according to their IPCC land cover layers (based on the 2015 Copernicus layer), and calculate the mean (min, max) change in SOC stock for just these pixels at each site as they transition to natural vegetation. Divide this mean change in SOC stock by the length of the time period in order to get a accumulation rate in terms of Mg C / ha / year.
c.	There are two “rewilding” scenarios: 20 years and 80 years (steady state). Because soil carbon does not accumulate linearly, I will use an annual rate based on the 20 year scenario for the first 20 years, and the annual rate derived from the 80 year layer for ages >20 years. 


Alternative method: crop based on PNV land cover map (Hengl, Martin, Visconti 2020) – what can return to forest is given forest rates (if they exist, otherwise the SOC rate), and everything else is given SOC rates.
Note that I decided to simply use the Ecoregions 2017 layer, because this is what was used by @Cook-Patton2020 and many others.

# Cook-Patton 2020


See West et al. 2010 PNAS (they applied the IPCC carbon seq values to a PNV map (Ramankutty et al. 1999)). This is what Folberth et al. 2020 Nat. Sustain. used.

Harris et al. 2021 - Nature Climate Change: Global maps of twenty-first century forest carbon fluxes https://www.nature.com/articles/s41558-020-00976-6.
Github: https://github.com/wri/carbon-budget

Harris et al. 2021 actually use Cook-Patton et al. 2020 to model natural regeneration.
Cook-Patton et al. 2020 Nature - https://www.nature.com/articles/s41586-020-2686-x

Cook-Patton et al. 2021 One Earth - https://www.reforestationhub.org/


```{r load-crop-cp}

# This dataset is the full extent of area that has the climatic potential to support forest - but not where the PNV or historical vegetation was in forest.
# Cook-Patton then clip this based on the Griscom layer of forests. 
# Yiwen has clipped this based on PNV forest vs. grassland. 

 
forest_c <- rast(paste0(p_dat, "climate/Cook-Patton_2020/sequestration_rate_layer_in_full_extent.tif"))
plot(forest_c, col = brewer_pal(palette = "Greens")(9), colNA = "gray80")
plot(cook_patton_abg, col = brewer_pal(palette = "Greens")(9), colNA = "gray80")


cook_patton_abg <- rast(
  paste0(p_dat, "climate/Cook-Patton_2020/sequestration_rate__mean__aboveground__full_extent__Mg_C_ha_yr.tif"))
cook_patton_blg <- rast(
  paste0(p_dat, "climate/Cook-Patton_2020/sequestration_rate__mean__belowground__full_extent__Mg_C_ha_yr.tif"))
cook_patton_abg_error <- rast(
  paste0(p_dat, "climate/Cook-Patton_2020/sequestration_rate__error_ratio__aboveground__full_extent__unitless.tif"))

plot(cook_patton_abg)
plot(cook_patton_blg)
plot(cook_patton_abg_error)


# crop to sites, resample

# ---------------------------------------------- #
# crop, and save to file
# ---------------------------------------------- #

site_forest_c <- lapply(1:11, function(i) {
  terra::crop(forest_c, ext(lc[[i]]),
              filename = paste0(p_derived, "site_forest_carbon/", 
                                names(lc[i]), "_forest_c.tif"),
              overwrite = TRUE
              )
  }
  )
names(site_forest_c) <- site_df$site
plot(site_forest_c)

# load back in
site_forest_c <- lapply(
  list.files(paste0(p_derived, "site_forest_carbon"), full.names = TRUE), 
  function(i) rast(i)
  )
names(site_forest_c) <- site_df$site


# ---------------------------------------------- #
# crop with a buffer, to deal with NA issues: use this going forward
# ---------------------------------------------- #

site_forest_c <- lapply(1:11, function(i) {
  terra::crop(forest_c, ext(lc[[i]]) + rep(0.1, 4), # with a bit of buffer
              filename = paste0(p_derived, "site_forest_carbon/", 
                                names(lc[i]), "_forest_c_buff.tif"),
              overwrite = TRUE
              )
  }
  )
names(site_forest_c) <- site_df$site
plot(site_forest_c)

# load back in
site_forest_c <- lapply(
  list.files(paste0(p_derived, "site_forest_carbon"), full.names = TRUE) %>%
    grep("buff", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_forest_c) <- site_df$site




freq(site_forest_c$shaanxi)
ncell(site_forest_c$shaanxi)
fcdt <- spatraster_to_dt(site_forest_c$shaanxi)
fcdt[!is.na(sequestration_rate_layer_in_full_extent)]


hist(
  fcdt[!is.na(sequestration_rate_layer_in_full_extent), 
       sequestration_rate_layer_in_full_extent]
  )


```

```{r save-forest-C-plot}
pdf(file = paste0(p_output, "plots/forest_carbon_seq_rates.pdf"), width = 10, height = 7.5)
mval <- 1.5
par(mfrow = c(3, 4), 
      # mar=c(0,0,0,0), 
      oma=c(1,1,0,0), 
      adj = 0,
      cex.main = 1#,
      # tcl = -0.2
      )
    
for(i in 1:11) {
  plot(site_forest_c[[i]], 
       main = names(site_forest_c[i]),
       mar = c(mval+0.5, mval, mval + 1.2, mval + 2) # bltr   
       # type = "classes", #legend = FALSE,
       )
  }

# plot.new()
# plot(site_pnv[[i]], type = "classes",
#      legend = "left",
#      plg = list(cex = 0.7, title = "Potential Natural Vegetation", title.adj = 0),
#      legend.only = TRUE,
#      col = pnv_table$cols, 
#      levels = pnv_table$labels
#      )
dev.off()

```

```{r resample-cp}

# ----------------------------------------------- #
# resolution
# ----------------------------------------------- #
res(site_forest_c$shaanxi) * 110 # = 0.9167 km grid (~ 1 km) at the equator, less at higher latitudes

res(lc$shaanxi) * 110 # = 0.029644 km grid (~ 30 m) at the equator, less at higher latitudes

0.9167/ 0.029644 # 30 times


site_forest_c_30 <- lapply(1:11, function(i) {
  terra::resample(
    x = site_forest_c[[i]], y = lc[[i]]$y2017, method = "near",
    filename = paste0(p_derived, "site_forest_carbon/", names(lc[i]), "_forest_c_30.tif"),
    names = paste0(names(lc[i]), "_forest_c_30"),
    overwrite = TRUE)
  }
  )
names(site_forest_c_30_b) <- site_df$site


# load back in:
site_forest_c_30 <- lapply(
  list.files(paste0(p_derived, "site_forest_carbon"), full.names = TRUE) %>% grep("_forest_c_30.tif", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_forest_c_30) <- site_df$site

plot(site_forest_c$chongqing, main = "Original resolution, ~1km")
plot(site_forest_c_30$chongqing, main = "Resampled to ~30 m")








# exploring different methods for resampling (decided to stick with "near")

fct3 <- lapply(3, function(i) {
  terra::resample(
    x = site_forest_c[[i]], y = lc[[i]]$y2017, method = "bilinear",
    filename = paste0(p_derived, "site_forest_carbon/", names(lc[i]), "_forest_c_30_bi.tif"),
    names = paste0(names(lc[i]), "_forest_c_30"),
    overwrite = TRUE)
  }
  )

fct4 <- lapply(3, function(i) {
  terra::resample(
    x = site_forest_c[[i]], y = lc[[i]]$y2017, method = "cubic",
    filename = paste0(p_derived, "site_forest_carbon/", names(lc[i]), "_forest_c_30_cubic.tif"),
    names = paste0(names(lc[i]), "_forest_c_30"),
    overwrite = TRUE)
  }
  )

par(mfrow = c(2,2))
plot(site_forest_c$chongqing, main = "original, 1km")
plot(fct1, main = "disagg, x30")
plot(fct2[[1]], main = "resampled, 30m, near")
plot(fct3[[1]], main = "resampled, 30m, bilinear", ext = ext(t_ext))
plot(fct4[[1]], main = "resampled, 30m, cubic", ext = ext(t_ext))
plot(fct4[[1]], main = "resampled, 30m, cubic")#, ext = ext(t_ext))
warnings()
dev.off()

t_ext <- drawExtent()

plot(site_forest_c$iraq, colNA = "blue")

```

```{r calc-total-carbon}

# calculate the total carbon that could be accumulated in regenerating forest in abandoned croplands in each year
# units are in terms of Mg C / ha / year.
# so, multiplying the age of abandoned lands (in years) yields the total amount of carbon (in Mg C) accumulated in that pixel per ha.
# to get to a total amount of carbon stored, I then need to multiply by the number of hectares in each pixel.
# Mg C / ha / year * number of years * area of pixel in ha = Mg C per pixel

# calculate Mg C per pixel:
site_forest_c_30_per_pixel <- lapply(1:11, function(i) {
  tmp <- site_forest_c_30[[i]] * 
    site_area_ha[[i]]

  writeRaster(tmp,
              filename = paste0(p_derived, "site_forest_carbon/", 
                                site_df$site[i], "_forest_c_30_per_pixel.tif"),
              overwrite = TRUE)
}
)
names(site_forest_c_30_per_pixel) <- site_df$site




site_forest_c_30$chongqing

age_t$chongqing$y2017

# total accumulation of forest carbon by the year 2017, at Chongqing
total_carbon_per_ha_2017 <- 
  site_forest_c_30$chongqing * 
  age_t$chongqing$y2017

tic()
total_carbon_2017 <- lapply(1:11, function(i) {
  tmp <- 
    age_t[[i]]$y2017 * 
    site_forest_c_30[[i]] * 
    site_area_ha[[i]]

  tmp
}
)
toc() # 201 seconds (just over 3 minutes) for 11 sites, just 2017.
total_carbon_2017
names(total_carbon_2017) <- site_df$site



# the full time series
tic()
site_carbon_acc <- lapply(1:11, function(i) {
  tmp <- 
    age_t[[i]] * 
    site_forest_c_30_per_pixel[[i]]
    # (site_forest_c_30[[i]] * 
    # site_area_ha[[i]])

  writeRaster(tmp,
              filename = paste0(p_derived, "site_forest_carbon/total/", 
                                site_df$site[i], "_carbon_accumulation.tif"),
              overwrite = TRUE)

})
toc() # 288 for CQ, 402 for CQ and Goias, 2600 seconds for all 11 sites
names(site_carbon_acc) <- site_df$site

# load it back in:
# 
# site_carbon_acc <- lapply(
#   list.files(paste0(p_derived, "site_forest_carbon/total"), full.names = TRUE), 
#   function(i) rast(i)
#   )
# names(site_carbon_acc) <- site_df$site


# ------------------------------- #
# calculate the sum total amount of carbon accumulated at each site:
# ------------------------------- #
tic()
site_carbon_df <- lapply(1:11, function(i) {
  # tmp <- global(total_carbon_2017[[i]], fun = "sum", na.rm = TRUE) # Mg C
  tmp <- global(site_carbon_acc[[i]], fun = "sum", na.rm = TRUE) # Mg C
  tmp <- tmp %>% 
    as_tibble() %>% 
    rownames_to_column(var = "year") %>%
    mutate(#year = gsub("y", "", year),
           site = site_df$site[i]
           )
  tmp
}) %>% bind_rows()
toc()

site_carbon_df <-
  site_carbon_df %>% 
  mutate(year = as.numeric(year) + 1986) %>%
  rename(total_c_Mg = sum)

# save site_carbon_df
write_csv(site_carbon_df, 
          file = paste0(p_derived, "/site_carbon_df.csv")
          )

cq_fc



dt1 <- data.table(v1 = 1:10, v2 = seq(from = 2, to = 20, by = 2))
dt2 <- data.table(v3 = 1:10)
dt1
dt2
dt1 * dt2$v3

cdt <- spatraster_to_dt(c(age_t[[3]]$y2017,
  site_forest_c_30[[i]], # forest carbon sequestration rates, in Mg C / ha / year
      site_area_ha[[i]]))

cdt[!is.na(y2017),][]

my_ext <- drawExtent()

terra::plot(forest_c, ext = ext(my_ext), type = "continuous")
terra::plot(forest_c, ext = ext(age_t$chongqing), type = "continuous")
plot(site_forest_c_30$chongqing, colNA= "blue", #ext = ext(my_ext), 
     add = T)

cq_plus <- crop(forest_c, ext(age_t$chongqing) + rep(0.1, 4))
cq_plus_resam <- terra::resample(
    x = cq_plus, y = lc[[i]]$y2017, method = "near")

plot(cq_plus)
plot(cq_plus_resam, colNA= "blue",
     add = T)
plot(cq_plus_resam)
is.na(values(cq_plus_resam)) %>% sum()
is.na(values(site_forest_c_30$chongqing)) %>% sum()

plot(age_t$chongqing$y2017)
plot(cq_plus_resam, add = T)

# ok, so there is some issue with the NA strip... maybe something having to do with the cropping and resampling?

# does this happen with other sites?
w_plus <- crop(forest_c, ext(age_t$wisconsin) + rep(0.1, 4))
plot(w_plus)
plot(site_forest_c_30$wisconsin, colNA= "blue", #ext = ext(my_ext), 
     add = T)

w_age_na <- terra::mask(age_t[[3]]$y2017, site_forest_c_30[[3]], inverse = TRUE)
plot(w_age_na)
w1 <- terra::cellSize(w_age_na, unit = "ha", mask = TRUE) %>% global(fun = "sum", na.rm = TRUE)
plot(w1)

area_of_age_na1 <- 
  lapply(1:11, function(i) {
    terra::mask(age_t[[i]]$y2017, site_forest_c_30[[i]], inverse = TRUE) %>%
      terra::cellSize(., unit = "ha", mask = TRUE) %>% 
      global(fun = "sum", na.rm = TRUE)
  }) %>% bind_rows(.id = "site") %>%
   as_tibble() %>%
  mutate(site = site_df$site)
  
area_of_age_na # original, without buffer:
area_of_age_na1 # after doing the buffer
area_of_age_na_b


area_of_age_na_b
area_of_age_na

plot(site_forest_c_30_b$chongqing)
plot(site_forest_c_30$chongqing)


area_of_age_na_b <- 
  lapply(1:11, function(i) {
    terra::mask(age_t[[i]]$y2017, site_forest_c_30_b[[i]], inverse = TRUE) %>%
      terra::cellSize(., unit = "ha", mask = TRUE) %>% 
      global(fun = "sum", na.rm = TRUE)
  }) %>% 
  bind_rows(.id = "site") %>% 
  as_tibble() %>%
  mutate(site = site_df$site)


area_summary_df %>% 
  select(site, area_abn_ha_2017) %>%
  left_join(., area_of_age_na, by= "site") %>%
  mutate(prop = sum/area_abn_ha_2017 * 100)

plot(w1)
ext(lc[[i]]$y2017) == ext(age_t$chongqing$y2017)

plot(site_forest_c_30$chongqing)
plot(cq_plus)



cdt[y2017>=5 & is.na(chongqing_forest_c_30), ]

cdt_age <- fread(paste0(p_dat_derived, "age_dts/chongqing_age_2021_03_13.csv"))

cdt_age_m <- merge(cdt_age[, .(x, y, y2010)], cdt[, !c("y2017")], by = c("x","y"), sort = FALSE)

tdt <- cdt[, .(y2017)] * cdt$chongqing_forest_c_30 * cdt$chongqing_area_ha
tdt[, sum(y2017, na.rm = TRUE)]

cq_fc[31,] # checks out




plot(total_carbon[[1:8]])

plot(total_carbon[[31]])
plot(total_carbon_2017)



# ------------------------------- #
# calculate sum across site:
# ------------------------------- #
total_carbon_2017

total_c_2017 <- lapply(1:11, function(i) {
  tmp <- global(total_carbon_2017[[i]], fun = "sum", na.rm = TRUE) # Mg C
  tmp
}) 

total_c_2017 %>% bind_rows() %>%
  rownames_to_column(var = "site") %>%
  mutate(site = gsub("_forest_c_30", "", site))

cq_fc <- global(total_carbon,  fun = "sum", na.rm = TRUE)


tic()
o_fc <- total_carbon_o %>% global(.,  fun = "sum", na.rm = TRUE)
toc() # 50 seconds.

cq_fc <- cq_fc %>% mutate(year = 1987:2017)
ggplot(data = cq_fc) + 
  geom_point(mapping = aes(x = year, y = sum))

length(cq_fc)


global(total_carbon, fun = "sum", na.rm = TRUE) # Mg C
global(total_carbon, fun = "sum", na.rm = TRUE) # Mg C








# ------------------------------- #
# print a pdf of the maps
# ------------------------------- #

par(mfrow = c(2,2))
plot(age_t$chongqing$y2017, main = "Abandonment age as of 2017")
plot(site_forest_c_30$chongqing, main = "forest carbon accumulation rates")
plot(total_carbon_per_ha_2017, main = "Accumulated carbon per ha in abandoned croplands as of 2017")
plot(total_carbon, main = "Total accumulated carbon per pixel in abandoned croplands as of 2017")


# Plot
{
  pdf(file = paste0(p_output, "plots/total_forest_c_accumulated_CQ.pdf"), width = 9, height = 7)
  mval <- 1.5
  
  par(mfrow = c(2, 2), oma=c(1,1,0,0), adj = 0)
  plot(age_t$chongqing$y2017, main = "Abandonment age as of 2017")
  plot(site_forest_c_30$chongqing, main = "forest carbon accumulation rates")
  plot(total_carbon_per_ha_2017, main = "Accumulated carbon per ha in abandoned croplands as of 2017")
  plot(total_carbon_2017, main = "Total accumulated carbon per pixel in abandoned croplands as of 2017")  
  dev.off()
}



# all eleven
pdf(file = paste0(p_output, "plots/forest_carbon_seq_rates.pdf"), width = 10, height = 7.5)
mval <- 1.5
par(mfrow = c(3, 4), 
      # mar=c(0,0,0,0), 
      oma=c(1,1,0,0), 
      adj = 0,
      cex.main = 1#,
      # tcl = -0.2
      )
    
for(i in 1:11) {
  plot(site_forest_c[[i]], 
       main = names(site_forest_c[i]),
       mar = c(mval+0.5, mval, mval + 1.2, mval + 2) # bltr   
       # type = "classes", #legend = FALSE,
       )
}

dev.off()

```

```{r plot-total-carbon}
site_carbon_df

gg_total_c <- 
  ggplot(data = site_carbon_df, 
         mapping = aes(x = year, y = total_c_Mg / 10^6, 
                       color = as_factor(site))) +
  geom_line(size = 2) + 
  labs(x = "Year", 
       y = "Millions of Mg C",
       color = "Site"
       ) +
  theme_classic()

ggsave(gg_total_c,
       file = paste0(p_output, "plots/total_forest_c_accumulated2.pdf"), 
       width = 6, height = 5)

site_carbon_df %>% filter(site == "shaanxi", total_c_Mg > 0)


```


# Soil Organic Carbon (SOC)

## Grassland

What is a good source for grassland carbon sequestration rates?

Quoting from Chapter 2 when I talk about grasslands:
Grassland biomes, where much of the abandonment we observed occurred, can also harbor substantial amounts of carbon sequestered in soils [@Lal2004].
However, grassland soil carbon may accumulate even more slowly than aboveground forest biomass, taking a century or longer to return to reference levels [@Yang2019].
For example, while abandoned croplands across Russia accumulated a total of 13.2 Mg C/ha in the top 5 cm of soil during the first 20 years following abandonment, these fields still had significantly less carbon sequestered than reference grasslands after 24 years of observation, and were expected to take >60 years to recover to reference levels [@Wertebach2017].

Wertebach et al. 2019 was based on data collected in Tyumen Oblast, which is to the east of Orenburg.

```{r tyumen}
russia <- ne_countries(scale = 110, returnclass = "sf", country = "russia")
russia <- ne_states(#scale = 110, 
                    returnclass = "sf", country = "russia")

plot(russia$geometry)

russia$name %>% grep("Tyumen", ., value = TRUE)

tyumen <- russia %>%
  filter(name == "Tyumen'") %>% 
  st_geometry

tyumen %>%
  plot()




st_bbox(tyumen) %>% extent %>% terra::ext()


tyumen_pnv <- terra::crop(pnv, terra::ext(extent(st_bbox(tyumen))))
tyumen_for <- terra::crop(forest_c, terra::ext(extent(st_bbox(tyumen))))
plot(tyumen_for)

tyumen_biomes <- st_crop(biomes, st_bbox(tyumen))
plot(tyumen_biomes[["biomes"]])
plot(tyumen_biomes$geometry)
plot(tyumen_biomes)


tyumen_ext <- terra::draw()

plot(tyumen_pnv,
     col = filter(pnv_table, Number %in% freq(tyumen_pnv)[, "value"])$cols, 
     levels = filter(pnv_table, Number %in% freq(tyumen_pnv)[, "value"])$labels,
     ext = tyumen_ext)

plot(tyumen, border = "red", add = T)


# ------------------------------------------------------- #
# wertebach's carbon sequestration rate for the average abandoned soils in Russia:
13.2 / 20 # 0.66 Mg C / ha / year (for 0-5 cm soil depth)
# stored more quickly in early stages of succession than in later stages
# this is opposite what they found in Yang et al. 2019

# 
```

```{r soils.revealed}
soils_revealed_files <- 
  list.files(paste0(p_dat, "soil/soils_revealed"), 
             full.names = TRUE)

soils_revealed_rewilding_Y20 <- rast(grep("scenario_rewilding", 
                                          soils_revealed_files, value = TRUE)[1])
soils_revealed_rewilding_YSS <- rast(grep("scenario_rewilding", 
                                          soils_revealed_files, value = TRUE)[2])

soils_revealed_all <- rast(c(grep(".tif", 
                                  soils_revealed_files, value = TRUE)
                             ))

soils_revealed_all <- rast(soils_revealed_files[c(2, 14, 15, 17)])



soils_revealed_rewilding_YSS
plot(soils_revealed_rewilding_Y20)
plot(soils_revealed_rewilding_YSS)
plot(soils_revealed_all$lc_ipcc, ext = ext(lc$shaanxi))
# 1. Forest, 2. Cropland, 3. Grassland, 4. Wetlands, 5. Settlements, 6. Other, 7. Water??

# ------------------------------------------------- #
# crop to sites
# ------------------------------------------------- #
soils_revealed_all
names(soils_revealed_all)
names(site_soils_revealed_all)
site_soils_revealed_all <- lapply(1:11, function(i) {
  terra::crop(soils_revealed_all, ext(lc[[i]]) + rep(0.1, 4),
              filename = paste0(p_derived, "site_soils_revealed/", 
                                names(lc[i]),
                                "_soils_revealed_all_buff.tif"),
              overwrite = TRUE
              )
  }
  )
names(site_soils_revealed_all) <- site_df$site

# load back in:
site_soils_revealed_all <- lapply(
  list.files(paste0(p_derived, "site_soils_revealed"), full.names = TRUE) %>%
    grep("_all_buff", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_soils_revealed_all) <- site_df$site



site_soils_revealed_rewilding_YSS <- lapply(1:11, function(i) {
  terra::crop(soils_revealed_rewilding_YSS, ext(lc[[i]]) + rep(0.1, 4),
              filename = paste0(p_derived, "site_soils_revealed/", 
                                names(lc[i]),
                                "_soils_revealed_rewilding_YSS_buff.tif"),
              overwrite = TRUE
              )
  }
  )
names(site_soils_revealed_rewilding_YSS) <- site_df$site
plot(site_soils_revealed_rewilding_YSS[[8]])

site_soils_revealed_rewilding_Y20 <- lapply(1:11, function(i) {
  terra::crop(soils_revealed_rewilding_Y20, ext(lc[[i]]) + rep(0.1, 4),
              filename = paste0(p_derived, "site_soils_revealed/", 
                                names(lc[i]),
                                "_soils_revealed_rewilding_Y20_buff.tif"),
              overwrite = TRUE
              )
  }
  )
names(site_soils_revealed_rewilding_Y20) <- site_df$site

plot(site_soils_revealed_rewilding_YSS[[8]])



# load back in
site_soils_revealed_rewilding_YSS <- lapply(
  list.files(paste0(p_derived, "site_soils_revealed"), full.names = TRUE) %>%
    grep("YSS_buff", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_soils_revealed_rewilding_YSS) <- site_df$site

# load back in
site_soils_revealed_rewilding_Y20 <- lapply(
  list.files(paste0(p_derived, "site_soils_revealed"), full.names = TRUE) %>%
    grep("Y20_buff", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_soils_revealed_rewilding_Y20) <- site_df$site

# ------------------------------------------------- #
# resample
# ------------------------------------------------- #

site_soils_revealed_rewilding_YSS_30 <- lapply(1:11, function(i) {
  terra::resample(
    x = site_soils_revealed_rewilding_YSS[[i]], y = lc[[i]]$y2017, method = "near",
    filename = paste0(p_derived, "site_soils_revealed/", names(lc[i]), "_soils_revealed_rewilding_YSS_30.tif"),
    names = paste0(names(lc[i]), "_soils_revealed_rewilding_YSS_30"),
    overwrite = TRUE)
  }
  )
names(site_soils_revealed_rewilding_YSS_30) <- site_df$site


# load back in:
site_soils_revealed_rewilding_YSS_30 <- lapply(
  list.files(paste0(p_derived, "site_soils_revealed"), full.names = TRUE) %>% grep("_soils_revealed_rewilding_YSS_30.tif", ., value = TRUE), 
  function(i) rast(i)
  )
names(site_soils_revealed_rewilding_YSS_30) <- site_df$site

```

```{r plot-soils_revealed}
site_soils_revealed_all[9] %>% names()

save_3x4_site_plot <- function(the_raster,
                               mval = 1.5,
                               file_name,
                               layer) {
  
  pdf(file = paste0(p_output, "plots/", file_name, ".pdf"), 
      width = 10, height = 7.5)
  
  par(mfrow = c(3, 4), 
        oma=c(1,1,0,0), 
        adj = 0,
        cex.main = 1#,
        )
      
  for(i in 1:11) {
    plot(the_raster[[i]][[layer]], 
         main = names(the_raster[i]), breaks = c(1, 2, 3, 4, 7), 
         col = c("dark green", "gold", "light green", "gray"),
         type = "continuous",
         #legend = FALSE,
         mar = c(mval+0.5, mval, mval + 1.2, mval + 2) # bltr   
         )
    }
  
  dev.off()
}


save_3x4_site_plot(the_raster = site_soils_revealed_all,
                   layer = 1,
                   file_name = "soils_revealed_lc_ipcc")

save_3x4_site_plot(the_raster = site_soils_revealed_all,
                   layer = 2, 
                   file_name = "soils_revealed_Y20")

save_3x4_site_plot(the_raster = site_soils_revealed_all,
                   layer = 3, 
                   file_name = "soils_revealed_YSS")

save_3x4_site_plot(the_raster = site_soils_revealed_all,
                   layer = 4, 
                   file_name = "soils_revealed_socref")


save_3x4_site_plot(the_raster = lapply(site_soils_revealed_rewilding_Y20, function(i){i/20}), 
                   file_name = "soils_revealed_Y20_rate")



plot(site_soils_revealed_all[[9]])
plot(site_soils_revealed_all[[9]]$lc_ipcc, type = "classes")
plot(site_soils_revealed_all[[9]]$lc_ipcc, type = "interval", 
     breaks = c(1, 2, 3, 4, 7),
     levels = c("1. forest", "2. crop", "3. grass", "everything else"))

plot(site_soils_revealed_all[[9]]$lc_ipcc, type = "classes")

my_site <- 3
# 1. Forest, 2. Cropland, 3. Grassland, 4. Wetlands, 5. Settlements, 6. Other, 7. Water??
plot(site_soils_revealed_all[[my_site]]$lc_ipcc, breaks = c(1.9, 2.1))
plot(site_soils_revealed_all[[my_site]]$scenario_rewilding_dSOC_Y20, 
     type = "classes")

hist(site_soils_revealed_all[[9]]$scenario_rewilding_dSOC_Y20)




plot(lc$shaanxi$y2015, breaks = c(2.9, 3.1))
plot(lc$shaanxi[[c(1,31)]], breaks = c(2.9, 3.1), legend = F)
plot(lc$nebraska[[c(1,31)]], breaks = c(2.9, 3.1), legend = F)


# lc_ipcc land cover classes are:
# 1. Forest, 2. Cropland, 3. Grassland, 4. Wetlands, 5. Settlements, 6. Other, 7. Water??
# 1. Forest land - This category includes all land with woody vegetation consistent with thresholds used to define forest land in the national GHG inventory, sub-divided into managed and unmanaged, and also by ecosystem type as specified in the IPCC Guidelines. It also includes systems with vegetation that currently fall below, but are expected to exceed, the threshold of the forest land category.
# 2. Cropland - This category includes arable and tillage land, and agro-forestry systems where vegetation falls below the thresholds used for the forest land category, consistent with the selection of national definitions.
# 3. Grassland - This category includes rangelands and pasture land that is not considered as cropland. It also includes systems with vegetation that fall below the threshold used in the forest land category and are not expected to exceed, without human intervention, the threshold used in the forest land category. The category also includes all grassland from wild lands to recreational areas as well as agricultural and silvi-pastural systems, subdivided into managed and unmanaged consistent with national definitions.
# 4. Wetlands - This category includes land that is covered or saturated by water for all or part of the year (e.g., peatland) and that does not fall into the forest land, cropland, grassland or settlements categories. The category can be subdivided into managed and unmanaged according to national definitions. It includes reservoirs as a managed sub-division and natural rivers and lakes as unmanaged sub-divisions.
# 5. Settlements - This category includes all developed land, including transportation infrastructure and human settlements of any size, unless they are already included under other categories. This should be consistent with the selection of national definitions.
# 6. Other land - This category includes bare soil, rock, ice, and all unmanaged land areas that do not fall into any of the other five categories. It allows the total of identified land areas to match the national area, where data are available.
# 7. Chris' assumption: NA values, or water, etc.
```


```{r calc-Y20-mean-rate}

plot(site_soils_revealed_rewilding_Y20[[6]]/20, type = "continuous")

# calculate the mean annual rate of SOC sequestration, by simply dividing the change over 20 years by 20:

site_SOC_Y20_mean_rate <- 
  lapply(1:11, function(i){
    mean_rate <- global(site_soils_revealed_rewilding_Y20[[i]]/20, 
                        fun = "mean", na.rm = TRUE)
    
    tmp_df <- tibble(index = i,
                     site = site_df$site[i]) %>%
      mutate(mean_rate = mean_rate)
    
    tmp_df
  }) %>% bind_rows()


site_soils_revealed_rewilding_Y20[[9]]/20
global(site_soils_revealed_rewilding_Y20[[9]]/20, fun = "mean", na.rm = TRUE) # Mg C / ha / year


```


## Extra


```{r compare-with-hansen}
# compare the carbon removal estimates with those from
# 1. Hansen et al. global forest watch
# 2. Harris et al. 2021 - Nature Climate Change: Global maps of twenty-first century forest carbon fluxes https://www.nature.com/articles/s41558-020-00976-6

```


# End

```{r clean-up}
env_size(ls())

# 
os <- get_sizes(ls())

os %>% 
  summarise(total_env_size = sum(size)) %>% 
  mutate(gb = total_env_size / 1024^3)

os %>% print(n = 20)

rm(list = os$object[c(1:2)])


tmpFiles(current=TRUE, orphan=FALSE, old=FALSE, 
         remove=TRUE)

```

