---
title: "AOH"
author: "Christopher L. Crawford"
output: html_document
editor_options: 
  chunk_output_type: console
---

This is part of the **Biodiversity Impacts of Abandonment** project, developed by Christopher L. Crawford, starting fall of 2021. 
See https://github.com/chriscra/biodiversity_abandonment.

```{r initialize}
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/0_start.R")
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/_util/_util_files.R")
```

```{r clean-up}
os <- get_sizes(ls())

os %>% 
  summarise(total_env_size = sum(size)) %>% 
  mutate(gb = total_env_size / 1024^3)

os
os %>% print(n = 30)

site_pnv_30
rm(list = os$object[c(1:4)])
rm(list = os$object[c(2)])
# rm(list = os$object[c(3:18)])
get(os$object[c(30)])

i
get(os$object[16])

# terra and raster temp files
terra::tmpFiles(current=TRUE, orphan=FALSE, old=FALSE, 
                remove=TRUE)

terra::tmpFiles(current=TRUE, orphan=TRUE, old=TRUE, 
                remove=FALSE)

terra::tmpFiles(current=TRUE, orphan=TRUE, old=TRUE, 
                remove=TRUE)

raster::rasterTmpFile()
raster::showTmpFiles()
raster::removeTmpFiles()

warnings()


```

# AOH 



## {terra} AOH dev (based on Yiwen's script)

```{r load-map-files-AOH}
#### -------- load habitat map ---------- ####

### Loading suitable habitats from IUCN/IIASA #####
# iucnHabitatClass <- raster("~/Dropbox/PostDoc4_Princeton/Species Traits/iucn_habitatclassification_composite_lvl2_ver003_resampled.tif")

# jung_l2 <- rast(paste0(p_dat, "Habitats/Jung_GlobalHabitatTypes/iucn_habitatclassification_composite_lvl2_ver004.tif"))


# if Jung map:
habitat_map <- rast(paste0(p_derived, "site_jung/", site_df$site[site_index], "_jung_l2_30.tif"))

# if Yin et al. 2020 LC maps
habitat_map <- lc[[site_index]][[yr_index]]
plot(habitat_map)

# load elevation raster list

elevation_map <- lapply(1:11, function(i) {
  rast(paste0(p_derived, "elevation/", 
              site_df$site[i], "_srtm_crop.tif")
       )
  })

site_area_ha <- lapply(
  list.files(paste0(p_derived, "site_area_ha"), full.names = TRUE), 
  function(i) rast(i)
)
names(site_area_ha) <- site_df$site

```

```{r aoh-dev}
# create an empty data.frame to store results from the for loop:
species_list[, "binomial"]
species_list[, 3]
aoh_df <- tibble(species = species_list[, "binomial"],
                  IUCN_AOO = NA,
                  IUCN_AOH = NA)



i <- 1
for(i in seq_along(species_list$binomial)) {
  # ------------------------------------------------------------------------- #
  ### starts here ###
  # ------------------------------------------------------------------------- #
  
  # ---- extract species range polygons at the site ---- #
  
x1 <- species_ranges[species_ranges$binomial == paste0(species_list[i, "binomial"]),] # select a subset of species range polygons based on binomial
species_name <- "Lithobates palustris"

x1 <- vert_sites[vert_sites$binomial == "Lithobates palustris", ] %>% 
  st_cast() # update all features to multipolygon, for 


# ---- crop the land cover map in question to the extent of the range map ---- #
tic()
y1 <- terra::crop(#iucnHabitatClass,
  habitat_map[[11]], # site_jung_l2_30[[11]],
  x1) #%>% raster()
toc()

site_area_ha[[site_index]]



# ---- turn the species range polygons (sf) into a raster ---- #
# this involves creating a template raster to match the dimensions of the IUCN Habitat map, 
# and then using fasterize().
# if using this method, must first convert all sf objects to the same type (i.e., multipolygon)
# I can also do this using terra::rasterize(), but it's slightly slower. (~ 1 second for Wisconsin)

tic()
template_raster1 <- raster::raster(
  resolution = terra::res(site_area_ha[[site_index]]),
  ext = raster::extent(terra::ext(site_area_ha[[site_index]])[1:4]),
  ncols = terra::ncol(site_area_ha[[site_index]]),
  nrows = terra::nrow(site_area_ha[[site_index]]))


template_raster <- raster::raster(
  resolution = terra::res(y1),
  ext = raster::extent(terra::ext(y1)[1:4]),
  ncols = terra::ncol(y1),
  nrows = terra::nrow(y1))

x2 <- fasterize(x1, 
                template_raster# 
                # raster(y1)
                ) %>% rast()

x21 <- fasterize(x1,
                template_raster1# 
                # raster(y1)
                ) %>% rast()

toc()

plot(x2)
ext(x2)
ext(lc$wisconsin$y2017)

# writeRaster(x2,
            # filename = paste0(p_tmp, "random_tmp.tif"), 
            # overwrite=TRUE)
# x2 <- rast(paste0(p_tmp, "random_tmp.tif"))


# fasterize is faster than terra::rasterize(), but the step of writing the raster to file, then reloading as SpatRaster takes much longer.
# tic()
# x2t <- terra::rasterize(vect(x1), y1, # must convert sf to spatvector:
#                         #field="", 
#                         #fun = length#, sum = FALSE, 
#                         # filename = paste0(p_derived, "aoh/tmp/rasterize_tmp.tif"), overwrite=TRUE
#           )
# toc()
# 
# plot(x2t)


 # ---- update cell values to mask ---- #

# tic()
# x3 <- calc(x2_r, function(x) {x[!is.na(x)] <- 0; return(x)}) # passes a function setting all of the cell values that are not NAs to 0
# toc()

tic()
x3 <- subst(x2, 1, 0) # change cell value from 1 to 0.
# x3 <- x2 - 1 # can also do this, maybe just very slightly faster
toc()

# Calculate the Area Of Occurrence (AOO), before filtering by habitat and elevation
# expanse() is much faster! But... it doesn't work with large rasters of the extent of some of my sites.

# aoh_df$IUCN_AOO[i] <- expanse(x2, unit = "km") # in km2

print(aoh_df, n = 30)

tic()
x2_area_test <- x3 %>%
  terra::cellSize(., unit = "ha", mask = TRUE) %>% 
  global(fun = "sum", na.rm = TRUE) %>% 
  as.numeric()

x2_area_test
toc()

tic()
x2_area_test1 <- terra::cellSize(x21, unit = "ha", mask = TRUE) %>% 
  global(fun = "sum", na.rm = TRUE)
x2_area_test1
toc()


plot(x2)
plot(x3 + site_area_ha[[site_index]])
tic()
global(x3 + site_area_ha[[site_index]], fun = "sum", na.rm = TRUE)
toc()
tic()
global(x2 * site_area_ha[[site_index]], fun = "sum", na.rm = TRUE)
toc()

x2 * site_area_ha[[site_index]] %>%
  global(., fun = "sum", na.rm = TRUE)


# by calculating cellSize()
tic()
x2_area <- 
  terra::cellSize(x2, unit = "ha", mask = TRUE) %>% 
  global(fun = "sum", na.rm = TRUE)
toc()

aoh_df$IUCN_AOO[i] <- x2_area

site_area_ha[[11]]
plot(site_area_ha[[11]])

# mask the IUCN habitat map to the range raster
y2 <- x3 + y1
# y2 <- app(c(x3, y1), sum) # the same, but slightly slower
# y2 <- terra::mask(x3, y1)

plot(y2)

# ------------------------------------------------------------------------- #
### Habitat Filter ###
# ------------------------------------------------------------------------- #
species_list[i, "binomial"]

z1 <- habitat_prefs %>% 
  filter(binomial == species_name,
         suitability == "Suitable") # extract the habitat classifications for the species in question

suitable_habitat_codes <- iucn_crosswalk %>% 
  filter(code %in% unique(z1$code)) %>%
  # .$lc %>% 
  .$map_code %>% 
  unique() # extract the lc code from my crosswalk that correspond to the IUCN habitat codes

suitable_habitat_rcl <- iucn_crosswalk %>% 
  filter(code %in% unique(z1$code))


# my thoughts on how to do the land cover translation
# I have decided what proportion of "forest" go into what habitat type at each site. I don't know where though, so I'll just attribute this proportionally, evenly across the whole site. So, what I should do is apply this proportionally *after* I have clipped out the suitable habitats. 

# So, I need to build a translator for the IUCN habitat prefs, and then extract by that.
# I can then, in a separate step, multiply by the proportion in question.
# I can calculate the area in each habitat type, and if a species has a subset of one habitat type that is suitable (e.g., grassland, but not savanna or shrubland), I will then adjust the habitat area down by the proportion of my lc "grassland (4)" that is considered the IUCN habitat type grassland at that site. 

tic()
y3 <- 
  classify(y2,
           rcl = select(suitable_habitat_rcl, is = map_code) %>% mutate(becomes = 0),
           othersNA = TRUE,
           filename = paste0(p_tmp, "aoh_tmp.tif"),
           overwrite = TRUE)
toc()  # 1.894  seconds

# calculate area after habitat filter
tic()
y3_area <- 
  terra::cellSize(y3, unit = "ha", mask = TRUE) %>% 
  global(fun = "sum", na.rm = TRUE)
toc()

plot(y3)
# ------------------------------------------------------------------------- #
### Elevation Filter ###
# ------------------------------------------------------------------------- #
elevation_map
elevation_map[[site_index]]

elevation_mask <- elevation_map[[site_index]] + y3
plot(elevation_mask)

y3_r <- raster(elevation_mask)

tic()
y3 <- 
  classify(y2,
           rcl = select(suitable_habitat_rcl, is = map_code) %>% mutate(becomes = 0),
           othersNA = TRUE,
           filename = paste0(p_tmp, "aoh_tmp.tif"),
           overwrite = TRUE)
toc()

elevation_mask
elevation_rcl <- elevation_prefs %>% filter(binomial == species_name)

e1 <- elevation_prefs[elevation_prefs$binomial==paste0(species_list[i,1]), ]

terra::app(y3, )
ele6_t <- elevation_mask
plot(ele6_t)



tic()
ele6_rcl <- classify(elevation_mask, 
                     rcl = tibble(from = el_rcl$elevation_lower,
                                  to = el_rcl$elevation_upper, 
                                  becomes = 0),
                     include.lowest = TRUE, right = TRUE)
toc() # sweet! much faster.

plot(ele6_rcl, colNA = "pink")

# mask the range polygon by the habitat mask and the elevation mask


print(i)
write.csv(aoh_df,"~/Dropbox/PostDoc4_Princeton/Species Traits/FutureAOH.csv")
}
```

```{r aoh-direct-testing}

# cc_AOH_terra <- function(index,
#                        site_index,
#                        year_index,
#                        calc_lc = TRUE) {
  # ------------------------------------------------------------------------- #
  ### starts here ###
  # ------------------------------------------------------------------------- #
  tic.clearlog()
  tic(paste0("run ", index, ":", site_df$site[site_index], ", ", year_index))
  aoh_test_mg
  aoh_test_s
  index <- 3
  site_index <- 9 # 6 = mato_grosso
  year_index <- 2010:2017
  calc_lc <- TRUE
  calc_AOO <- TRUE
  
  species_ranges <- vert_sites %>%
  filter(vert_class != "gard",
         site == site_df$site[site_index]) # filter to just the site in question
  
  species_list <- species_ranges %>% st_drop_geometry() %>%
    select(site, vert_class, binomial) %>% unique() %>%
    arrange(site, vert_class, binomial)

  species_name <- species_list$binomial[index]
  # species_name <- "Lithobates palustris"
  
  habitat_map <- if (calc_lc) {
    lc[[site_index]][[paste0("y", year_index)]]
  } else {
    rast(paste0(p_derived, "site_jung/", site_df$site[site_index], "_jung_l2_30.tif"))
  }
  
  elevation_map <- rast(paste0(p_derived, "elevation/", site_df$site[site_index], "_srtm_crop.tif"))
  
  # ---- extract species range polygons at the site ---- #
  range_sf <- st_cast(species_ranges[species_ranges$binomial == species_name, ]) # select a subset of species range polygons based on binomial, and update all features to multipolygon, for fasterize()
  plot(range_sf$geometry)
  
  # plot(lc[[site_index]][[year_index]])
  plot(habitat_map)
  plot(range_sf$geometry, border = "red", add = TRUE)

  # ---- turn the species range polygons (sf) into a raster ---- #
    
  range_t <- 
    fasterize(range_sf,
              raster::raster(resolution = terra::res(habitat_map),
                             ext = raster::extent(terra::ext(habitat_map)[1:4]))
              ) %>% 
    rast() %>% # convert to SpatRaster 
    subst(1, 0) # update cell values from 1 to 0.
  
  plot(range_t)
  # ------------------------------------------------------------------------- #
  ### Habitat Filter ###
  # ------------------------------------------------------------------------- #
  z1 <- habitat_prefs %>% 
    filter(binomial == species_name,
           suitability == "Suitable") # extract the habitat classifications for the species in question
  
  habitat_prefs %>% 
    filter(binomial == species_name) %>%
    arrange(suitability) %>% print(n = 25)
  
  habitat_details %>% filter(binomial == species_name) %>% .$habitat
  
  # extract the lc codes from my crosswalk that correspond to the IUCN habitat codes
  suitable_habitat_rcl <- iucn_crosswalk %>% 
    filter(code %in% unique(z1$code))
  
  freq(habitat_map)
  iucn_crosswalk %>% print(n = 42)
  plot(site_jung_l2$mato_grosso, breaks = c(105.9,106.1))
  plot(site_jung_l2_30$mato_grosso, breaks = c(105.9,106.1))
  plot(site_jung_l2_30$mato_grosso, breaks = c(506.9,507.1))
  plot(site_jung_l2$mato_grosso, breaks = c(405.9,406.1))
  freq(site_jung_l2_30$mato_grosso)
  
  # reclassify habitat raster to 
  habitat_map1 <- lc[[site_index]][["y2017"]]
  habitat_map <- lc[[8]]#[[paste0("y", 2010:2017)]]
  
  tic()
  habitat_map_rcl <- 
    classify(
      # habitat_map1,
      habitat_map,
      rcl = select(suitable_habitat_rcl, 
                   is = ifelse(calc_lc, "lc", "map_code")
                   ) %>% unique() %>% 
               mutate(becomes = 0),
             othersNA = TRUE,
             # filename = paste0(p_tmp, "aoh_tmp.tif"),
             overwrite = TRUE)
  toc() # 5 seconds for 1, 8.178 s for 3, 11 s for 8, 28 seconds s for all 31
  
  31*5
  28
  plot(habitat_map_rcl[[1:4]])
  
  plot(habitat_map_rcl)
  # ------------------------------------------------------------------------- #
  ### Elevation Filter ###
  # ------------------------------------------------------------------------- #
  elevation_prefs_rcl <- elevation_prefs %>% filter(binomial == species_name)
  
  elevation_map_rcl <- 
    classify(
      elevation_map,
      rcl = tibble(from = elevation_prefs_rcl$elevation_lower,
                   to = elevation_prefs_rcl$elevation_upper,
                   becomes = 0),
      include.lowest = TRUE, right = TRUE)
  
  plot(elevation_map_rcl, colNA = "pink")
  
  # mask the range polygon by the habitat mask and the elevation mask
  plot(range_t)
  tic()
  aoh <- range_t + elevation_map_rcl
  aoh <- aoh + habitat_map_rcl
  toc() # 26 seconds for all 31, # 1.4 for 1 layer 
  

  # ------------------------------------------------------------------------- #
  ### Calculate areas:
  # ------------------------------------------------------------------------- #
  
  # Calculate the Area Of Occurrence (AOO), before filtering by habitat and elevation
  if (calc_AOO) {
    range_aoo_ha <- 
    terra::cellSize(range_t, unit = "ha", mask = TRUE) %>% 
    global(fun = "sum", na.rm = TRUE) %>% .$sum
    }
  
  # Calculate the Area Of Occurrence (AOO), before filtering by habitat and elevation
  tic()
  range_aoh_ha <- 
    terra::cellSize(aoh, unit = "ha", mask = TRUE) %>% 
    global(fun = "sum", na.rm = TRUE) %>% .$sum
  toc() # 1.8 seconds for 1, 8 seconds for 5 layers, 40 s for all 31
  
  toc(log = T)
  
  aoh_tmp <- 
    tibble(site = site_df$site[site_index],
           binomial = species_name,
           year = year_index,
           # IUCN_aoo_ha = range_aoo_ha,
           IUCN_aoh_ha = range_aoh_ha)
  
  if (calc_AOO) {
    aoh_tmp <- aoh_tmp %>%
      mutate(IUCN_aoo_ha = range_aoo_ha)
  }
  
  if (include_time) {
    aoh_tmp <- aoh_tmp %>%
      mutate(time = 
               tic.log(format = F) %>% bind_rows() %>%
               mutate(time = toc - tic) %>% .$time)
  }
  
  # Note: the slight difference between areas before and after habitat filtering is
  # the result of a small amount of 0s added to the Yin et al. 2020 land cover maps. 
  
  cat("calculated AOH for", species_name, "=", range_aoh_ha, "ha", fill = TRUE)
  aoh_tmp

```

```{r aoh-function-testing}

# create an empty data.frame to store results from the for loop:
species_list[, "binomial"]

aoh_df <- tibble(site = site_df$site[site_index],
                 species = species_list[, "binomial"],
                 year = yr_index + 1986,
                 IUCN_aoo_ha = NA,
                 IUCN_aoh_ha = NA)


# things to load:
load(file = paste0(p_derived, "species_ranges/vert_sites.RData"), verbose = TRUE)

# for a specific site, compile list of species
species_list
aoh_df

4000 * 28 /60 / 60 / 11 # hours /11

# what if I do the lc maps in batches, do I save time? 



tic("test1")
toc(log=T)
tic("test2")
toc(log=T)

tic.clearlog()
tic.log(format = T) %>% unlist() 
tic.log(format = F) %>% bind_rows() %>%
  mutate(time = toc - tic) %>% .$time


aoh_test <- lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 11, year_index = 31, calc_lc = FALSE)
}) %>% bind_rows()

seq_along(species_list$binomial)

aoh_test2 <- lapply(1:2, function(i) {
  cc_AOH_terra(index = i, site_index = 11, year_index = 31, calc_lc = FALSE)
}) %>% bind_rows()

aoh_test_mg <- lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 6, year_index = 31, calc_lc = FALSE)
}) %>% bind_rows()


aoh_test_s2 <- lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 9, year_index = 2017, calc_lc = FALSE)
}) %>% bind_rows()

aoh_test_s[1:5,]
aoh_test_s2


aoh_test_lc_s <- lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 9, year_index = 2017, calc_lc = TRUE)
}) %>% bind_rows()
aoh_test_lc_s
aoh_tmp

vert_sites %>% filter(binomial == "Rana chensinensis", 
                      site == "shaanxi" ) %>% 
  st_geometry() %>% 
  plot(add = T, col = "red")

site_sf %>% filter(site == "shaanxi" ) %>% st_geometry() %>% plot()

aoh_test_s1

aoh_test_mg
habitat_details %>% filter(binomial == "Adenomera andreae") %>% .$habitat
habitat_prefs %>% filter(binomial == "Adenomera andreae") %>% .$habitat

synonyms 
species_synonyms %>% filter(binomial == "Adenomera andreae")

aoh_test4 <- 
  lapply(1:11, function(site_index) {
    tmp <- lapply(1, function(i) {
      cc_AOH_terra(index = i, site_index = site_index, year_index = 31, calc_lc = FALSE)
      }) %>% bind_rows()
  }) %>% bind_rows()
  

aoh_test_mult_s <- 
  lapply(3, function(i) {
  cc_AOH_terra(index = i, site_index = 9, year_index = 2015:2017, 
             calc_lc = TRUE, calc_AOO = FALSE, include_time = TRUE)
}) %>% bind_rows()

aoh_test_mult_s %>% tail

aoh_test_mult_s




aoh_tmp
aoh_test_mult_s

aoh_test_s


aoh_test3
aoh_test4

# between 24-32 seconds

# run 1:wisconsin, 31: 29.43 sec elapsed
# calculated AOH for Acris crepitans = 630173.7 ha
# run 2:wisconsin, 31: 32.413 sec elapsed
# calculated AOH for Ambystoma laterale = 1962498 ha
# run 3:wisconsin, 31: 26.02 sec elapsed
# calculated AOH for Ambystoma maculatum = 1260343 ha
# run 4:wisconsin, 31: 24.47 sec elapsed
# calculated AOH for Ambystoma tigrinum = 905840.2 ha
# run 5:wisconsin, 31: 25.846 sec elapsed
# calculated AOH for Anaxyrus americanus = 2938938 ha
# > aoh_test

aoh_test
aoh_df[1:5,]

aoh_test4

write_csv(aoh_test,
          file = paste0(p_derived, "aoh/aoh_df.csv"))

```



```{r remove-0s-from-lc}

# this doesn't really matter! I'm just comparing the AOH anyways...

tic()
lc_clean <- subst(lc[[8]][[1:4]], from = 0, to = NA_real_)
toc()
# 63 seconds for just four layers of the biggest site. 

compareGeom(lc_clean, lc[[9]])

df1 <- freq(lc_clean)
df2 <- freq(lc[[9]][[1:4]])

df1 %>% as_tibble() %>% arrange(value)
df2 %>% as_tibble() %>% arrange(value)

lc_clean <- classify(
      lc[[9]][[1:4]],
      rcl = tibble(from = elevation_rcl$elevation_lower,
                   to = elevation_rcl$elevation_upper,
                   becomes = 0),
      include.lowest = TRUE, right = TRUE)

plot(lc[[9]][[1]], breaks = c(-0.1, 0.1), maxcell = 1e8)



terra::trim()

plot(lc_clean)

tic()
lc_clean2 <- trim(lc[[9]][[1:4]], value = 0)
toc()


df3 <- freq(lc_clean2)

df3 %>% as_tibble() %>% arrange(value)

```

# {data.table} AOH

```{r load-files-for-dt-AOH}
# set parameters:

index <- 3
site_df
site_index <- 3
year_index <- 2011:2017
calc_lc <- TRUE
include_time <- TRUE
range_maps <- species_ranges

# ------------------------------------------------------------------------- #
### load in required elements prior to running the data.table function
# ------------------------------------------------------------------------- # 
# all the loading of the habitat maps before:
tic("load layers")

  hab_dt <- fread(input = paste0(p_dat_derived, "input_data.tables/",
                                 site_df$site[site_index], ".csv"))

  elevation_map <- lapply(1:11, function(i) {
  rast(paste0(p_derived, "elevation/", 
              site_df$site[i], "_srtm_crop.tif")
       )
  })
  
  site_area_ha <- lapply(
    list.files(paste0(p_derived, "site_area_ha"), full.names = TRUE), 
    function(i) rast(i)
    )

  el_area_dt <- spatraster_to_dt(
    spt = c(site_area_ha[[site_index]],
            elevation_map)#, xy_switch = FALSE
    )

  setnames(el_area_dt, 
           old = grep("area", names(el_area_dt), value = T), 
           new = "area_ha")
  
  stopifnot(
    all.equal(hab_dt$x, el_area_dt$x),
    all.equal(hab_dt$y, el_area_dt$y)
    )
  
  # combine hab_dt and el_area_dt into a single data.table
  hab_dt[, ':='(area_ha = el_area_dt$area_ha,
                elevation = el_area_dt$elevation)]
  
  rm(el_area_dt) # to save memory on my machine.

  toc() #


```



```{r compare-results-dt-AOH}
tic("terra method")
aoh_terra_test_mult_s <- 
  lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 9, year_index = 1987:2017, 
             calc_lc = TRUE, calc_AOO = FALSE, include_time = TRUE)
}) %>% bind_rows()
toc()

# tic()
# one_sp <- cc_AOH_terra(index = 3, site_index = 9, year_index = 2017, 
#              calc_lc = TRUE, calc_AOO = FALSE, include_time = TRUE)
# toc()

tic("data.table method")
aoh_dt_test_mult_s <- lapply(1:5, function(i) {
  cc_AOH_data.table(index = i, site_index = 9, year_index = 1987:2017, 
             calc_lc = TRUE, include_time = TRUE)
}) %>% bind_rows()
toc()

# times: 
# terra: 555.635 s
# data.table: 262.04
aoh_terra_test_mult_s$time %>% unique %>% sum /
  aoh_dt_test_mult_s$time %>% unique %>% sum
# 2.11 x faster to do it with data.table

# compare results
aoh_terra_test_mult_s
aoh_dt_test_mult_s %>% 
  select(site, binomial, year, IUCN_aoh_ha, time) %>% unique

# they match
identical(aoh_terra_test_mult_s$IUCN_aoh_ha, aoh_dt_test_mult_s %>% 
  select(site, binomial, year, IUCN_aoh_ha, time) %>% unique %>%
  .$IUCN_aoh_ha)


# 3 three heavy lifts: hab rcl, elevation rcl, and the final masking

# time comparison 124 for terra function vs. 159 for data.table method
# now, having switched the order of the data.table filtering, the data.table method takes closer to 50 seconds.
```

```{r adjust-by-lc-prop}

# what proportion of the area in each of my four land cover codes is in 
# so, if a species 
z1

adj_df <- jung_hab_type_area_df %>%
  filter(site == site_df$site[site_index],
         code %in% unique(z1$code)) %>%
  group_by(lc) %>%
  summarise(adjustment = sum(prop_lc))

jung_hab_type_area_df %>% select(-IUCNLevel) %>%
  filter(site == site_df$site[9])


aoh_dt_test_mult_s
aoh_dt_test_mult_s

aoh_dt_test_mult_s <- aoh_dt_test_mult_s %>% 
  as_tibble() %>% 
  left_join(adj_df, by = "lc") %>% 
  mutate(adj_area_ha = area_ha * adjustment)

aoh_dt_test_mult_s %>% 
  select(-IUCN_aoh_ha) %>%
  left_join(aoh_dt_test_mult_s %>% 
              group_by(site, binomial, year) %>%
              summarise(IUCN_aoh_ha = sum(area_ha),
                        adj_IUCN_aoh_ha = sum(adj_area_ha)),
            by = c("site", "binomial", "year")
  )

df_tmp

```

```{r test-wisc}
# testing with Wisconsin data.table
# FYI it takes about 45 seconds to load all the data required at the start.
hab_dt

# too memory intensive.

tic("terra method")
aoh_terra_test_mult_w <- 
  lapply(1:5, function(i) {
  cc_AOH_terra(index = i, site_index = 11, year_index = 1987:2017, 
             calc_lc = TRUE, calc_AOO = FALSE, include_time = TRUE)
}) %>% bind_rows()
toc()

tic("data.table method")
aoh_dt_test_mult_w <- lapply(1:5, function(i) {
  cc_AOH_data.table(index = i, site_index = 11, year_index = 1987:2017, 
             calc_lc = TRUE, include_time = TRUE)
}) %>% bind_rows()
toc()

aoh_dt_test_mult_w %>% select(site, binomial, time) %>% unique() %>%
  mutate(time_p_run = time/31)


```


## Melting data.tables

Can I gain speed by melting the data.table in order to get the area by year and land cover code in one single data.table call? 
Ultimately, no. 
This method seems to be slower by a factor of 1.3. 
Good to have learned how to melt data.tables, but table this method for now.

```{r melt-dt}
# in order to use the by function correctly, I need to melt the data.table from wide to long format, and have a column for year. 
hab_dt

# add a new index, drop x and y
hab_dt[, key := 1:nrow(.SD)]
hab_dt[, c("x", "y", paste0("y", 1987:2000)) := NULL]

tdt <- hab_dt[1:200, .(key, y2001, y2002, y2003)]

tdt

# reshape

melt_dt <- melt(tdt, id.vars = c("key"), measure.vars = paste0("y", 2001:2003))

obj_size(tdt)
obj_size(melt_dt)


# test with big one:
hab_dt

tic()
hab_dt_melt <- data.table::melt(hab_dt, id.vars = c("key"), measure.vars = paste0("y", 2001:2017))
toc()

obj_size(hab_dt)
obj_size(hab_dt_melt) # three times as big.

# how would I summarize now?
hab_dt_melt


hab_dt

# first, filter by range, elevation, etc.:
hab_dt

hab_filtered_range_el

obj_size(hab_filtered_range_el)

# --------------------- #
# add a key
rm(hab_dt)
hab_filtered_range_el[, key := 1:nrow(.SD)]

# adding a key added this much space:
(3702098608 - 3792393688) / 10^6 # 90 MB!
(3792393688 - 3070033520) / 10^6 # deleting X, Y, elevation, and range saves 722 MB 
obj_size(hab_filtered_range_el) / 10^9 # 3.792 GB

hab_filtered_range_el[, c("x", "y") := NULL]
obj_size(hab_filtered_range_el) # 3.431 GB


hab_filtered_range_el[, c("elevation", "range") := NULL]
obj_size(hab_filtered_range_el) # 3.070 GB


# subset:
obj_size(hab_filtered_range_el)

names(hab_filtered_range_el)
hab_filtered_range_el[, c(paste0("y", 1987:2010)) := NULL]


obj_size(hab_filtered_range_el)

tic()
hab_dt_melt <- data.table::melt(hab_filtered_range_el, 
                                id.vars = c("key", "area_ha"), 
                                measure.vars = paste0("y", 2011:2017))

hab_dt_melt[value %in% habitat_prefs_rcl, 
            sum(area_ha), 
            by = c("variable", "value")]

toc()


tic()
aoh_dt_test_melt_comp_s <- lapply(3, function(i) {
  cc_AOH_data.table(index = i, site_index = 9, year_index = 2011:2017, 
             calc_lc = TRUE, include_time = TRUE)
}) %>% bind_rows()
toc()
aoh_dt_test_melt_comp_s

# 
#     variable value       V1
#  1:    y2011     1 147962.5
#  2:    y2011     2 123306.9
#  3:    y2012     1 150692.8
#  4:    y2012     2 135720.2
#  5:    y2013     1 156040.7
#  6:    y2013     2 135630.5
#  7:    y2014     1 154844.5
#  8:    y2014     2 132604.9
#  9:    y2015     1 156117.8
# 10:    y2015     2 140025.3
# 11:    y2016     1 155746.2
# 12:    y2016     2 145278.5
# 13:    y2017     1 154090.6
# 14:    y2017     2 151717.8

```

```{r time-melt}
hab_dt

# having loaded hab_dt before
tic("full melt time")
species_ranges <- vert_sites %>%
  filter(vert_class != "gard",
         site == site_df$site[site_index]) # filter to just the site in question

species_list <- species_ranges %>% st_drop_geometry() %>%
  select(site, vert_class, binomial) %>% unique() %>%
  arrange(site, vert_class, binomial)

species_name <- species_list$binomial[index]
# species_name <- "Lithobates palustris"
cat("Species name:", species_name, fill = TRUE)

# ---- extract species range polygons at the site ---- #
# select a subset of species range polygons based on binomial, and 
# update all features to multipolygon, for fasterize()
range_sf <- st_cast(species_ranges[species_ranges$binomial == species_name, ]) 

# ---- turn the species range polygons (sf) into a raster ---- #
range_t <- 
  fasterize(range_sf,
            raster::raster(resolution = terra::res(elevation_map),
                           ext = raster::extent(terra::ext(elevation_map)[1:4]))
  ) %>% 
  rast() #%>% # convert to SpatRaster 
# subst(1, 0,
#       filename = paste0(tmp_location, "range_t_tmp.tif"),
#       overwrite = T) # update cell values from 1 to 0.

# plot(range_t)

range_dt <- spatraster_to_dt(spt = range_t)

# a quick test to make sure the x and y columns match, to circumvent the need
# to round x and y to get the data.table::merge() to work correctly.
stopifnot(
  all.equal(hab_dt$x, range_dt$x),
  all.equal(hab_dt$y, range_dt$y)
)

# add range to the data.table as a column
hab_dt[, range := range_dt$layer]

# ------------------------------------------------------------------------- #
### Habitat Filter ###
# ------------------------------------------------------------------------- #
z1 <- habitat_prefs %>% 
  filter(binomial == species_name,
         suitability == "Suitable") # extract the habitat classifications for the species in question

# extract the lc codes from my crosswalk that correspond to the IUCN habitat codes
habitat_prefs_rcl <- 
  iucn_crosswalk %>% 
  filter(code %in% unique(z1$code)) %>%
  select(codes = ifelse(calc_lc, "lc", "map_code")) %>% # select lc class codes, or IUCN habitat map codes, depending on the "calc_lc" switch
  unique() %>% .$codes

# ------------------------------------------------------------------------- #
### Elevation Filter ###
# ------------------------------------------------------------------------- #
elevation_prefs_rcl <- elevation_prefs %>% filter(binomial == species_name)

# ------------------------------------------------------------------------- #
### Calculate AOH, broken down by habitat type ###
# ------------------------------------------------------------------------- #

# subset data.table to only pixels within both species range and elevation range, first:
hab_filtered_range_el <- hab_dt[!is.na(range) &
                                  elevation <= elevation_prefs_rcl$elevation_upper &
                                  elevation >= elevation_prefs_rcl$elevation_lower]



# begin melt chunk:
rm(hab_dt)
hab_filtered_range_el[, key := 1:nrow(.SD)]
hab_filtered_range_el[, c("x", "y", "elevation", "range",
                          paste0("y", 1987:2010)) := NULL]

hab_dt_melt <- data.table::melt(hab_filtered_range_el, 
                                id.vars = c("key", "area_ha"), 
                                measure.vars = paste0("y", 2011:2017))

hab_dt_melt[value %in% habitat_prefs_rcl, 
            sum(area_ha), 
            by = c("variable", "value")]

toc() # 22.604 seconds for just 7 layers, which is less than the original data.table code, which runs through each column individually. Just stick with that code.
```




# Cluster results
```{r 11-test}
aoh_dt_11_test <- read_csv(paste0(p_derived, "aoh/aoh_dt_11_test.csv"))

species_list %>% 
  group_by(site)
```


```{r missing-sp}

# how many did it actually run?
aoh_dt_11_test %>% 
  group_by(site) %>% 
  summarise(n = length(unique(binomial)))

runs_actual <- aoh_dt_11_test %>% 
  select(site, binomial) %>%
  unique()

# what happened to Rana temporaria
runs <- lapply(1:11, function(i) {
  species_list %>%
    filter(site == site_df$site[i]) %>%
    head(n = 10) %>%
    mutate(index = 1:10)}) %>% bind_rows()

runs %>% print(n = 100)
runs %>% select(site, binomial)
runs_actual

missing_sp <- runs %>% 
  filter(!binomial %in% unique(runs_actual$binomial))

aoh_dt_11_test %>% 
  filter(binomial %in% missing_sp$binomial)

species_ranges %>%
  filter(binomial %in% missing_sp$binomial) %>% .[1,] %>%
  st_geometry() %>%
  plot()

aoh_dt_11_test %>% 
  select(site, binomial) %>% 
  group_by(site) %>%
  unique() %>% 
  print(n = 120)

list.files(paste0(p_derived, "aoh/"))

missing_sp
species_list %>% filter(site == site_df$site[site_index]) %>% head(n = 10)

# -------------------------------------- run function ---------------------------------- #
aoh_test_c <- lapply(1:3, function(i) {
  cc_AOH_data.table(index = i, site_index = site_index, year_index = 2011:2017, 
             calc_lc = TRUE, include_time = TRUE,
             hab_dt = hab_dt,
             range_maps = vert_sites)
}) %>% bind_rows()

aoh_test_c %>% filter(binomial == sp_name)
plot(lc[[site_index]][[31]])
plot(range_sf$geometry, add = T, border = "red")
plot(range_t, add = T)
plot(range_t)



# it's due to a mismatch in species names
non_match
missing_sp

non_match %>% arrange(site, binomial) %>% print(n = 100)

species_synonyms %>%
  filter(binomial == sp_name)

species_synonyms %>%
  filter(synonym == "Babina daunchina")


non_match %>%
  filter(binomial == "Bufotes variabilis")



missing_sp
#  site      vert_class binomial                 index
#   <chr>     <chr>      <chr>                    <int>
# 1 belarus   amp        Rana temporaria              9   # due to elevation data entry error
# 2 chongqing amp        Babina daunchina             3   # due to synonym issue
# 3 iraq      bird       Acrocephalus melanopogon     3   # no suitable habitat within the site
# 4 orenburg  amp        Bufotes variabilis           3   # suitability is unknown - removed due to this.
# 5 orenburg  amp        Rana temporaria              8   # due to elevation data entry error


missing_sp$binomial

habitat_prefs %>%
  filter(binomial %in% missing_sp$binomial) %>%
  print(n = 100)

```



```{r why-NA?}
# some values are NA... what causes this?
# this stems from cases where there is no 
aoh_dt_11_test %>% 
  filter(is.na(adj_IUCN_aoh_ha))

# why is the adjustment NA??
sp_name <- "Bufo bufo"
site_index <- 1

aoh_dt_11_test %>%
  filter(site == site_df$site[site_index], binomial == sp_name)


habitat_prefs %>%
  filter(binomial == sp_name) %>%
  arrange(code)

z1 %>% arrange(code) %>% print(n = 30)
# test_codes <- 
  z1 %>%
  left_join(iucn_crosswalk, by = "code") %>%
  select(binomial, code, map_code, lc, name, IUCNLevel) #%>%
  # print(n = 110) %>%
  # .$lc %>% unique

# based on the habitat_prefs, this species finds 1, 2, 3, and 4 suitable.
# but, there are no 14.4 habitat type at the site.. so when I join to adj_df, it gives an NA
aoh_dt_11_test %>%
  filter(site == site_df$site[site_index], binomial == sp_name) %>%
  select(site:area_ha) %>%
  
  

z1$code %>% sort() %>% length
unique(z1$code) %>% length

habitat_prefs_rcl

jung_hab_type_area_df %>%
  filter(site == site_df$site[site_index],
         #code %in% unique(z1$code)
         ) %>%
  arrange(habitat_type)


freq(site_jung_l2_30$belarus)

# the iucn crosswalk includes just those IUCN habitat types that Jung's map includes at my sites.
# based on the way that my adjustment works, I adjust the area of each of the four land cover types based on the proportion of the broader category at each site that is made up of that particular habitat type.


iucn_crosswalk <- read_csv(paste0(p_derived, "iucn_lc_crosswalk.csv"))
print(iucn_crosswalk, n = 100)
jung_hab_type_area_df %>% filter(site == site_df$site[site_index])
z1 %>% arrange(code) %>% print(n = 100)


# fix the NAs in the summarise function
aoh_dt_11_test <- aoh_dt_11_test %>%
  # filter(site == site_df$site[site_index], binomial == sp_name) %>%
  group_by(site, binomial, year) %>% 
  summarise(IUCN_aoh_ha = sum(area_ha),
            adj_IUCN_aoh_ha = sum(adj_area_ha, na.rm = TRUE)) #%>%
  # filter(is.na(adj_IUCN_aoh_ha))
```


```{r plot-aoh-test}
ggplot(data = aoh_dt_11_test #%>% filter(site == "shaanxi")
       ,
                     mapping = aes(x = year, y = adj_IUCN_aoh_ha, color = binomial)) + 
  geom_line() +
  facet_wrap(vars(site), scales = "free")

```


## Della results for all 31 layers
```{r load-31-layer-results}
# aoh_run_date <- "_2021_12_05"
aoh_lc_31_files <- list.files(paste0(p_derived, "aoh"), full.names = T) %>% 
  grep(paste0("aoh_tmp", aoh_run_date), ., value = T)

aoh_31_df <- lapply(aoh_lc_31_files, read_csv) %>% bind_rows()

aoh_31_df

aoh_31_df %>%
  filter(binomial == "Chlidonias hybrida",
         site == "shaanxi")

aoh_31_df %>%
  filter(binomial == "Agamia agami") %>%
  ggplot(mapping = aes(x = year, y = adj_IUCN_aoh_ha)) +
  geom_line()



s_sp <- aoh_31_df %>% 
  filter(site == site_df$site[9],
         # binomial == "Tscherskia triton",
         year == 2017) %>%
  select(site:year, adj_IUCN_aoh_ha) %>% unique() %>%
  .$binomial

species_to_remove
i<-9

missing_sp_31 <- lapply(1:11, function(i){
  sp_run <- aoh_31_df %>% 
    filter(site == site_df$site[i]) %>%
  select(site:year, adj_IUCN_aoh_ha) %>% unique() %>%
  select(site, binomial) %>% unique()
  
  sp_not_run <- species_list %>% filter(site == site_df$site[i]) %>%
    filter(!binomial %in% sp_run$binomial)
  sp_not_run
}) %>% bind_rows()


# number of species at each site:
species_list %>% 
  group_by(site, #vert_class
           ) %>% 
  summarise(num_sp = n())

#######
species_list
species_to_remove

aoh_31_df %>% filter(binomial == "Chlidonias hybrida",
                     site == site_df$site[9])

# e_tmp1 <- 
  aoh_31_df %>% 
  filter(adj_IUCN_aoh_ha == 0) %>%
  arrange(site, binomial, year, lc) %>% 
  select(site, binomial) %>% unique() %>%
  filter(site == site_df$site[3])
  
species_to_remove %>% filter(site == site_df$site[3]) %>% arrange(binomial)
missing_sp_31 %>% filter(site == site_df$site[3]) %>% arrange(binomial)

jung_hab_type_area_df %>% filter(site == site_df$site[1]) %>% arrange(code)
habitat_prefs %>% filter(binomial == "Anthus pratensis",
                         suitability == "Suitable") %>% arrange(code)
elevation_prefs %>% filter(binomial == "Anthus pratensis")
  
species_to_remove[[1]]


species_list %>% filter(site == site_df$site[9]) %>% .$binomial #%>% unique()

missing_sp_tmp <- species_list %>% 
  filter(site == site_df$site[9]) %>% #.$binomial %>%
  filter(!binomial %in% s_sp) %>% .$binomial %>% sort()

# all of these species are present in the habitat_prefs file and have suitable habitat
habitat_prefs %>%
  filter(binomial %in% missing_sp_tmp) %>% #.$binomial %>% unique() %>% sort() #%>% length()
  print(n = 50)

missing_sp_tmp

species_ranges %>%
  filter(binomial == missing_sp_tmp[5]) %>%
  st_geometry() %>%
  plot()

species_list %>% filter(site == site_df$site[9]) %>% print(n = 210)


plot(lc$shaanxi[[31]])

species_ranges %>%
  filter(site == site_df$site[9],
         binomial == missing_sp_tmp[1]) %>%
  st_geometry() %>%
  plot(add = T)

#
site_elevation_range[9,]

for(i in missing_sp_tmp) {
elevation_prefs %>% filter(binomial == i) %>% print()
habitat_prefs %>% filter(binomial == i) %>% print()
}

jung_hab_type_area_df %>% filter(site == site_df$site[9]) %>% arrange(habitat_type)
```

```{r expl-seff}
cat(
  paste("seff", paste0("39004952_", 1:27), collapse = "; "),
  "> text2.txt"
    )
# Use the above to make seff calls to get the full times and memory usage for the full array run
# then copy and paste this output into a 


txt <- read_csv("scripts/ref/seff_out_aoh_abn_lc.csv")
txt <- read_csv("scripts/ref/seff_out_aoh_abn_lc.csv")
txt <- read_csv("scripts/ref/seff_out_max.csv")
txt

seff <- tibble(core_index = 1:18,
               time = str_subset(txt$out, "CPU Utilized"), 
               mem = str_subset(txt$out, "Memory Utilized"),
               state = str_subset(txt$out, "State: ")
               ) %>%
  mutate(time = str_extract(time, "[0-9][0-9]:[0-9][0-9]:[0-9][0-9]"),
         mem = str_extract(mem, "[0-9][0-9].[0-9][0-9]") %>% as.numeric())

seff %>% print(n = 30)

calc_cores

```





# AOH of only Abandoned croplands

```{r species-list-just-2-4}
species_list %>% filter(grepl("bird|mam", vert_class)) %>% select(binomial) %>% unique() %>% nrow()
  
habitat_prefs %>% 
  filter(suitability != "Suitable")


habitat_prefs$binomial %>% unique() %>% length() # 2312
species_ranges$binomial %>% unique() %>% length() # 2312 in species_ranges
species_list$binomial %>% unique() %>% length() # 2187 after filtering by IUCN attributes, filtering out species without suitable habitats, elevations

# 2074 species of the 2312 species unfiltered species_range layer with 2 or 4 as suitable habitat
habitat_prefs %>% 
  filter(suitability == "Suitable",
         lc %in% c(2, 4)) %>% 
  .$binomial %>% unique() %>% length() 


# 1159 of unfiltered species have 2 or 4 listed as a habitat of majorImportance
habitat_prefs %>% 
  filter(suitability == "Suitable",
         majorImportance == "Yes",
         lc %in% c(2, 4)) %>% 
  .$binomial %>% unique() %>% length() 


species_list$binomial %>% unique() %>% length() # 2187 total species in species list

# 2003 species have grassland (2) or forest (4) listed as suitable habitats
species_list %>%
  filter(binomial %in% (habitat_prefs %>% 
                          filter(suitability == "Suitable",
                                 lc %in% c(2, 4)) %>% 
                          .$binomial %>% unique())
         ) %>% 
  .$binomial %>% unique() %>% length()


habitat_prefs$code %>% unique() %>% sort()
site_habitats %>% print(n = 40)

iucn_crosswalk %>% filter(code == "5.1")

# having added map_code to habitat_prefs for more exact filtering and joining...
habitat_prefs
site_habitats
iucn_crosswalk



site_habitats
jung_hab_type_area_df %>% select(habitat_type, code, lc, Coarse_Name, IUCNLevel) %>% unique() %>%
  arrange(habitat_type)


```


## lc of abandonment 

```{r age-abn-mask}
# ------------------------------------------------------------ #
# create a mask of the abandonment age map, excluding ages < 5
plot(age_t[[9]][[31]])

tic()
abn_mask <- lapply(1:11, function(i) {
  abn_mask_tmp <- 
    classify(
      age_t[[i]],
      rcl = tibble(from = 5,
                   to = 30,
                   becomes = 0),
      othersNA = TRUE,
      include.lowest = TRUE, right = TRUE,
      filename = paste0(p_dat_derived, "age_rasters/", run_label, "/",
                        site_df$site[i], "_abn_5_30_mask", run_label,".tif"),
      names = paste0("y", 1987:2017),
      overwrite = TRUE)
})
toc()

abn_mask <- lapply(1:11, function(i){
  rast(paste0(p_dat_derived, "age_rasters/", run_label, "/",
              site_df$site[i], "_abn_5_30_mask", run_label,".tif"))
})

names(abn_mask) <- site_df$site

freq(abn_mask[[site_index]][[31]])

plot(abn_mask$shaanxi[[31]])
plot(lc[[site_index]][[28:31]])


# ------------------------------------------------------------ #
# create a mask of the *potential* abandonment age map, excluding ages < 5
tic()
potential_abn_mask <- lapply(1:11, function(i) {
  potential_abn_mask_tmp <- 
    classify(
      potential_age_t[[i]],
      rcl = tibble(from = 5,
                   to = 30,
                   becomes = 0),
      othersNA = TRUE,
      include.lowest = TRUE, right = TRUE,
      filename = paste0(p_dat_derived, "age_rasters/", run_label, "/",
                        site_df$site[i], "_potential_abn_5_30_mask", run_label,".tif"),
      names = paste0("y", 1987:2017),
      overwrite = TRUE)
})
toc()

potential_abn_mask <- lapply(1:11, function(i){
  rast(paste0(p_dat_derived, "age_rasters/", run_label, "/",
              site_df$site[i], "_potential_abn_5_30_mask", run_label,".tif"))
})

names(potential_abn_mask) <- site_df$site


# ---------------------------------------------------------------- #
# create mask of just 5-30 max_age

tic()
max_age_mask <- lapply(1:11, function(i) {
  max_age_mask_tmp <- 
    classify(
      max_age_t[[i]],
      rcl = tibble(from = 5,
                   to = 30,
                   becomes = 0),
      othersNA = TRUE,
      include.lowest = TRUE, right = TRUE,
      filename = 
        paste0(p_dat_derived, "max_age/", run_label, "/",
              site_df$site[i], "_max_age_5_30_mask", run_label,".tif"),
      names = "max_age_5_30_mask",
      overwrite = TRUE)
})
toc()

plot(max_age_mask[[1]])


max_age_mask <- lapply(1:11, function(i){
  rast(paste0(p_dat_derived, "max_age/", run_label, "/",
              site_df$site[i], "_max_age_5_30_mask", run_label,".tif"))
})
names(max_age_mask) <- site_df$site

```


```{r lcc-of-abn-terra}
# write code to calculate the land cover in each pixel 5 years and older
i <- 9
print(compareGeom(abn_mask[[i]], age_t[[i]]))
print(compareGeom(abn_mask[[i]], lcc[[i]]))

# Calculate the land cover of abandoned pixels for each year

# redoing this with the cleaned version of lc: lcc
tic()
abn_lcc <- lapply(1:11, function(i) {
  # make sure to restrict lc to only 1987:2017 (Nebraska, Wisconsin)
  # i <- 9
  cat("Masking:", site_df$site[i], "...", fill = TRUE)
  tmp <- abn_mask[[i]] + lcc[[i]][[paste0("y", 1987:2017)]]
  
  cat("Writing SpatRaster to file:", site_df$site[i], "...", fill = TRUE)
  writeRaster(tmp, 
              filename = paste0(p_derived, "abn_lcc/",
                        site_df$site[i], "_abn_lcc", run_label, ".tif"), 
              overwrite = TRUE,
              names = names(tmp))
  cat(site_df$site[i], "done!", fill = TRUE)

})
toc()


# reload
abn_lcc <- lapply(1:11, function(i) {
  rast(paste0(p_derived, "abn_lcc/",
              site_df$site[i], "_abn_lcc", run_label, ".tif"))
  })
names(abn_lcc) <- site_df$site


plot(abn_lcc[[9]][[31]])


# check into whether this is the same as abn_lc_rasters as created in "5_biodiversity_dev.Rmd"

tmp_df <- freq(tmp) # some pixels are in cropland... these must have  because these must have 
tmp_df %>% as_tibble() %>% arrange(value) %>% print(n = 100)

raster()

plot(age_t_bins[[site_index]])
test_lc <- terra::mask(x = lc[[site_index]][[31]],
                       mask = age_t_bins[[site_index]],
                       maskvalues = c(1:5), 
                       updatevalue = NA,
                       inverse = TRUE
                       )
plot(test_lc)

plot(lc[[site_index]][[31]])







# ---------------------------------------------------------------- #
# calculate lc of all pixels that were ever abandoned
# ---------------------------------------------------------------- #

max_age_mask

tic()
max_abn_lcc <- lapply(1:11, function(i) {
  # make sure to restrict lc to only 1987:2017 (Nebraska, Wisconsin)
  # i <- 9
  cat("Masking:", site_df$site[i], "...", fill = TRUE)
  tmp <- max_age_mask[[i]] + lcc[[i]][[paste0("y", 1987:2017)]]
  
  cat("Writing SpatRaster to file:", site_df$site[i], "...", fill = TRUE)
  writeRaster(tmp, 
              filename = paste0(p_derived, "abn_lcc/",
                        site_df$site[i], "_max_abn_lcc", run_label, ".tif"), 
              overwrite = TRUE,
              names = paste0("y", 1987:2017))
  cat(site_df$site[i], "done!", fill = TRUE)

})
toc()


# reload
max_abn_lcc <- lapply(1:11, function(i) {
  rast(paste0(p_derived, "abn_lcc/",
              site_df$site[i], "_max_abn_lcc", run_label, ".tif"))
  })
names(max_abn_lcc) <- site_df$site


```

```{r freq-abn-lc}

plot(abn_lc$shaanxi[[1:6]])
abn_lc
tmp <- freq(abn_lc$shaanxi)
i <- 9

nlyr(abn_lc[[i]])
abn_lc[[]]

abn_lc_freq <- lapply(1:11, function(i) {
  # the first five years (1987:1991) are NA, due to abandonment definition.
  tmp <- freq(abn_lc[[i]][[paste0("y", 1992:2017)]]) %>% 
    as_tibble() %>%
    rename(year = layer, lc = value) %>%
    mutate(year = year + 1991,
           site = site_df$site[i]) %>%
    select(site, year, lc, count)
  
  tmp
}
) %>% bind_rows


abn_lcc_freq <- lapply(9, function(i) {
  # the first five years (1987:1991) are NA, due to abandonment definition.
  tmp <- freq(abn_lcc[[paste0("y", 1992:2017)]]) %>% 
    as_tibble() %>%
    rename(year = layer, lc = value) %>%
    mutate(year = year + 1991,
           site = site_df$site[i]) %>%
    select(site, year, lc, count)
  
  tmp
}
) %>% bind_rows

# write to file
write_csv(abn_lc_freq, file = paste0(p_derived, "abn_lc_freq.csv"))

abn_lc_freq

# convert to percentages and plot

abn_lc_freq %>% 
  group_by(site, year) %>%
  summarise(site, year, lc, count,
            total = sum(count)) %>%
  ungroup() %>% 
  mutate(px = count/total * 100) %>%
  # filter(lc == 3) %>%
  ggplot(mapping = aes(x = year, y = px, col = as_factor(lc))) + 
  geom_line() + 
  labs(x = "Year", y = "Percent of all abandoned pixels", col = "Land cover class") +
  facet_wrap(vars(site), scales = "free") + theme(legend.position = "bottom")




ggplot(data = abn_lcc_freq, 
       mapping = aes(x = year, y = area_ha, col = as_factor(lc))) + 
  geom_line() + 
  labs(x = "Year", y = "Area (ha)", col = "Land cover class") +
  # facet_wrap(vars(site), scales = "free") + 
  theme(legend.position = "bottom")

ggplot(data = abn_lcc_freq, 
       mapping = aes(x = year, y = count, col = as_factor(lc))) + 
  geom_line() + 
  labs(x = "Year", y = "Pixels", col = "Land cover class") +
  # facet_wrap(vars(site), scales = "free") + 
  theme(legend.position = "bottom")

```



## Temporal Filtering: land cover maps
```{r explore-tmp-filter}
obj_size(dt)

dt[y1987 > 0, ]

dt <- cc_create_dt()
dt1 <- cc_create_bin() + 1
dt2 <- cc_create_bin() + 2
dt3 <- cc_create_bin() + 3

dt1
dt2
dt3

dt <- rbind(dt1, dt2, dt3)
dt <- dt[, ':='(x = 1:nrow(dt), y = 1:nrow(dt))
                           ][, c("x", "y", paste0("V", 1:15))]

dt[V1 %in% c(2, 3)]



5:(ncol(dt) - 2)
i <- 9


# new filter:

dt <- fread(input = paste0(p_dat_derived, "input_data.tables/",
                           site_df$site[9], ".csv"),
            # select = c("x", "y", "y2017"),
            # nrows = 100000
            )

freq_before <- lapply(1987:2017, function(i){
      tmp <- dt[, .N, by = c(paste0("y", i))][,"year" := i]
      names(tmp) <- c("lc", "pixels", "year")
      tmp
    }) %>% bind_rows()

# for loop
tic()
for(lc_class in 1:4) {
  for (i in 5:(ncol(dt) - 2)) {
    dt[get(names(dt)[i-2]) == lc_class &  # subset to 1-1-0-1-1
         get(names(dt)[i-1]) == lc_class & 
         get(names(dt)[i]) %in% c(1:4)[1:4 != lc_class] & 
         get(names(dt)[i+1]) == lc_class & 
         get(names(dt)[i+2]) == lc_class,
       names(dt)[i] := lc_class # update value
    ]
  }
}
toc() # 103.199 seconds for Shaanxi (4.5x to get time for )


freq_after <- lapply(1987:2017, function(i){
      tmp <- dt[, .N, by = c(paste0("y", i))][,"year" := i]
      names(tmp) <- c("lc", "pixels", "year")
      tmp
    }) %>% bind_rows()

bind_rows(
  freq_before %>% as_tibble() %>% mutate(site = "shaanxi", time = "before"),
  freq_after %>% as_tibble() %>% mutate(site = "shaanxi", time = "after")) %>%
  ggplot(mapping = aes(x = year, y = pixels, col = as_factor(lc))) +
  geom_line() + 
  facet_wrap(vars(time))




# 8-year moving window

dt <- data.table(x = "x", y = "x", rbind(
  c(1, 1, 1, 1, 2, 2, 1, 1, 1, 3, 3, 1, 1, 1, 1, 1, 1),
  c(1, 1, 1, 1, 2, 3, 3, 1, 1, 1, 2, 3, 1, 1, 1, 1, 1),
  c(2, 3, 3, 2, 2, 2, 3, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1),
  c(2, 3, 3, 2, 2, 2, 3, 3, 2, 2, 2, 1, 2, 1, 1, 1, 1),
  c(4, 1, 1, 1, 3, 3, 1, 1, 3, 3, 3, 1, 1, 3, 3, 3, 4),
  c(4, 1, 1, 1, 4, 3, 1, 1, 1, 3, 3, 1, 1, 1, 1, 1, 1))
)

dt
cc_temporal_filter_lc(dt)
dt

dt[(V1 == 1 & V2 == 1) | (V1 == 4 & V2 == 4), ]
dt[(V1 == 1 & V2 == 1 | V1 == 4 & V2 == 4), ]

i <- 7

for(lc_class in 1:4) {
  blip_values <- c(1:4)[1:4 != lc_class]
  
  for (i in 6:(ncol(dt) - 4)) {
  dt[get(names(dt)[i-3]) == lc_class &
       get(names(dt)[i-2]) == lc_class &
       get(names(dt)[i-1]) == lc_class &
       # .e.g., if lc_class is 1, then these are 
       # (V4 == 2 & V5 == 2) | (V4 == 3 & V5 == 3) | (V4 == 4 & V5 == 4)
       ((get(names(dt)[i]) == blip_values[1] & get(names(dt)[i+1]) == blip_values[1]) | 
          (get(names(dt)[i]) == blip_values[2] & get(names(dt)[i+1]) == blip_values[2]) |
          (get(names(dt)[i]) == blip_values[3] & get(names(dt)[i+1]) == blip_values[3])) &
       get(names(dt)[i+2]) == lc_class &
       get(names(dt)[i+3]) == lc_class &
       get(names(dt)[i+4]) == lc_class, 
     
     c(names(dt)[i], 
       names(dt)[i+1]) := lc_class
     ]
  }
}


```


# Final Results

## Processing & Distilling

```{r hab-dt-options}
aoh_type_df # see _util_files.

aoh_type_df$label
```


```{r load-all-AOH-results}
run_label
aoh_run_date # see _util_main.R

list.files(paste0(p_derived, "aoh"), full.names = FALSE) %>%
  grep(".csv", ., value = TRUE) %>%
  # gsub("_2022_04_01", "", .) %>%
  # gsub("_2022_04_08", "", .) %>%
  # gsub("_2022_04_12", "", .) %>%
  gsub("_c[0-9]{1,2}", "", .) %>%
  gsub(".csv", "", .) %>%
  gsub("aoh_tmp_", "", .) %>% 
  unique()
  
aoh_type_df

aoh_types <- aoh_type_df$label[c(4:10)]
aoh_type_ <- aoh_type_df$label[9]

aoh_dates <-
  tibble(aoh_types,
         date = c("_2022_04_01", "_2022_04_01", "_2022_04_08", 
                  "_2022_04_01", "_2022_04_12", 
                  "_2022_04_15|_2022_04_16", "_2022_04_15|_2022_04_16"))

i <- 1

for (i in 1:21) {
list.files(paste0(p_derived, "aoh"), full.names = TRUE) %>%
  grep(aoh_type_, ., value = TRUE) %>%
  grep(filter(aoh_dates, aoh_types == aoh_type_)$date, ., value = TRUE) %>%
  grep(paste0("_c", i, ".csv"), ., value = TRUE) %>%
    print()
}

filter(aoh_dates, aoh_types == aoh_type_)$date

aoh_l <- lapply(aoh_types, 
  function(aoh_type_) {
  lapply(1:21, 
         function(i) {
    read_csv(
      list.files(paste0(p_derived, "aoh"), full.names = TRUE) %>%
        grep(aoh_type_, ., value = TRUE) %>%
        grep(filter(aoh_dates, aoh_types == aoh_type_)$date, ., value = TRUE) %>%
        grep(paste0("_c", i, ".csv"), ., value = TRUE)
      )
           }
    ) %>% 
    bind_rows() %>% 
    mutate(aoh_type = aoh_type_) %>%
    left_join(iucn_status, by = "binomial") %>%
    left_join(species_list, by = c("site", "binomial")) %>%
    left_join(
      select(st_drop_geometry(species_ranges), 
             site, vert_class, binomial, # presence, origin, seasonal, 
             total_range_area, range_size_quantile) %>% unique(),
              by = c("site", "binomial", "vert_class")) %>% 
    left_join(
      habitat_age_req_coded %>% 
        select(binomial, mature_forest_obl, water_obl, coder, common_names),
      by = "binomial")
}) %>% 
  bind_rows() %>%
  
  # create a composite area, which is either area_ha or adj_area_ha, depending on whether the run was lc or IUCN
  # mutate(
  #   aoh = case_when(
  #     grepl("lc", aoh_type) ~ adj_IUCN_aoh_ha,
  #     grepl("iucn", aoh_type) ~ IUCN_aoh_ha),
  #   area = case_when(
  #     grepl("lc", aoh_type) ~ adj_area_ha,
  #     grepl("iucn", aoh_type) ~ area_ha)) %>%
  
  select(aoh_type, vert_class, site, binomial, year, map_code, 
         # lc, 
         season = seasonality, 
         area = area_ha, 
         mature_forest_obl, redlistCategory, 
         # area_ha, 
         IUCN_aoh_ha,
         # adj_IUCN_aoh_ha, adj_area_ha,
         everything())


# write_csv(aoh_l, file = paste0(p_derived, "aoh_l.csv"))
write_parquet(aoh_l, paste0(p_derived, "aoh_l.parquet"))
# aoh_l0 <- read_parquet(paste0(p_derived, "aoh_l0.parquet")) # including abn_lc, abn_iucn, and potential_abn_iucn
aoh_l <- read_parquet(paste0(p_derived, "aoh_l.parquet"))



aoh_species_list <- 
  aoh_l %>% 
  select(#aoh_type,
    vert_class, binomial, 
    redlistCategory, mature_forest_obl,
    total_range_area, range_size_quantile, common_names) %>%
  unique()

write_parquet(aoh_species_list, paste0(p_derived, "aoh_species_list.parquet"))
aoh_species_list <- read_parquet(paste0(p_derived, "aoh_species_list.parquet"))
```


```{r how-many-species?}

# we calculated AOH for this many species: 
species_list %>%
  group_by(vert_class) %>%
  summarise(n_sp = length(unique(binomial)))
528+1495 # 2023 mammals and birds with ranges that intersected with one or more of our sites.


# we found that 1688 species of mammals and birds had non-zero AOH at our sites. 
aoh %>% 
  filter(
    # aoh_type %in% aoh_types[c(1, 3, 6, 7)],
         aoh > 0,
         vert_class != "amp",
         passage_type == "exclude_passage"
         ) %>%
  # select(aoh_type, vert_class, binomial, passage_type) %>%
  group_by(
    aoh_type,
           vert_class, passage_type) %>%
  summarise(n_sp = length(unique(binomial))) %>% # 1688
  group_by(aoh_type, passage_type) %>% summarise(total_mammals_and_birds = sum(n_sp))
  

aoh_trends_by_sp %>% names()
aoh_trends_by_sp %>%
  select(binomial )

# small-ranged species
aoh_trends_by_sp %>% 
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <=\nglobal median",
             range_size_quantile > 0.5 ~ "Range size >\nglobal median"),
           # overall_trend, trend_direction, trend_consistency
           ) %>%
  summarise(n_sp = n())

aoh_trends_by_sp %>% 
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         range_size_quantile <= 0.5) %>%
  select(aoh_type, vert_class, binomial, redlistCategory, overall_trend) %>%
  unique()
  
aoh_species_list %>%
  filter(aoh_type %in% aoh_types[c(1, 3, 6, 7)]) %>% # full, max, crop and crop_potential
  
```


```{r expl-aoh-l}
# number of species, records, etc.
aoh_l %>%
  group_by(aoh_type, vert_class) %>%
  summarise(num_records = n(),
            sp = length(unique(binomial))) %>%
  arrange(vert_class)

# number of records at each site:
aoh_l %>% 
  group_by(aoh_type, vert_class, site) %>%
  summarise(n_sp = length(unique(binomial))) %>%
  group_by(aoh_type, vert_class) %>% summarise(n = sum(n_sp))

# number of species in each model run
aoh_l %>% group_by(aoh_type) %>% summarise(n_sp = length(unique(binomial))) # there are different numbers of species due to variance in the habitats that show up in different parts of sites. 

# the lc runs have more, because they are not restricted to the habitats only in abandoned pixels. The proportional adjustment is based on the habitats that are present in any part of the site, not just the abn.

aoh_l %>% group_by(aoh_type, site) %>% 
  summarise(n_sp = length(unique(binomial))) %>%
  ungroup() %>% group_by(aoh_type) %>% summarise(n_runs = sum(n_sp))

i <- 9

missing_sp_aoh <- lapply(1:11, function(i){
  sp_run <- aoh_l %>% 
    filter(site == site_df$site[i]) %>%
    select(aoh_type:year, aoh) %>% unique() %>%
  select(site, vert_class, binomial) %>% unique()
  
  sp_not_run <- species_list %>% filter(site == site_df$site[i]) %>%
    filter(!binomial %in% sp_run$binomial)
  sp_not_run
}) %>% bind_rows()

missing_sp_aoh

plot(site_sf[3,]$geometry)
species_ranges %>% 
  filter(binomial == "Cettia major") %>%
  st_geometry() %>%
  plot(add = T, border = "red")

aoh_l %>% 
  filter(binomial == "Cettia major")
habitat_prefs  %>% filter(binomial == "Cettia major") %>%
  .$code

iucn_crosswalk %>% 
  filter(code %in% filter(habitat_prefs, binomial == "Cettia major")$code)

jung_hab_type_area_df %>%
  filter(site == "chongqing")

```

Restricting by:
1. seasonality, so that only 1, 2, 3 are considered (Codes are: "Resident" (1), "Breeding" (2), "Non-breeding Season" (3), Passage (4), and Seasonal Occurrence Uncertain (5).)

2. only those map_codes (habitats) that are marked as majorImportance for the species.

3. mature_forest_obl, so that only non-mature forest obligates are included.
4. Abandonment only vs. the entire landscape

```{r filter-suitability-by-season}
# Extract a list of species with some habitat suitabilities with season marked as NA, and some with a code.
# In these contexts, the NA season should be filtered out.
# Note that some species have been directly updated in the creation of "habitat_prefs" [Glaucidium brodiei (collared owlet) and Mustela sibirica (siberian weasel)].
# For species with *only* NA season codes, I'll leave these in, and treat them as suitable in all seasons.

habitat_prefs %>%
  filter(binomial %in% unique(species_list$binomial), 
         !is.na(map_code), suitability == "Suitable") %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  # filter(!(vert_class == "bird" & is.na(season))) %>%
  group_by(season_code, vert_class) %>%
  summarise(n_sp = n()) %>%
  print(n = 30)

# ---------- #
# extract list of species with NA season suitabilities:
sp_w_na_suitabilities <- habitat_prefs %>%
  filter(is.na(season_code), suitability == "Suitable", !is.na(map_code)) %>%
  # select(binomial, season_code) %>% unique() %>%
  .$binomial %>% unique()

# ---------- #
# Extract list of species with some habitat suitabilities with season marked as NA, and some with a code.
# i.e., with more than one habitat suitability season code, one of which is NA
# In these contexts, the NA season should be filtered out.

sp_w_na_suit_and_more <- 
  habitat_prefs %>%
  filter(binomial %in% sp_w_na_suitabilities, suitability == "Suitable", !is.na(map_code)) %>%
  select(binomial, season_code) %>% unique() %>%
  group_by(binomial) %>% summarise(n_sp = n()) %>% arrange(desc(n_sp)) %>%
  filter(n_sp > 1) %>%
  left_join(habitat_age_req_coded %>% select(binomial, common_names, vert_class)) %>%
  .$binomial

# ------------------------------------- #
# extract a list of species with NA season_codes, so that I can make sure to treat them separately.
sp_na_season <- 
  habitat_prefs %>%
  filter(
    !(binomial %in% sp_w_na_suit_and_more & is.na(season_code)), # filter out NA season_codes for species with multiple season codes, one being NA 
    binomial %in% unique(species_list$binomial),
    !is.na(map_code), suitability == "Suitable",
    
    # select those species with na season codes
    is.na(season_code)
    ) %>%
  .$binomial %>% unique()
# 607 species


# ------------------------- #
# My approach is to use a simple inner_join to filter out mismatched combinations of season and habitat, and then manually add back in the species with NA season codes associated with their suitabilities (by binding to it a filtered aoh file with just the above species with NA season codes).

aoh_filter <- 
  aoh_l %>%
  # rename(season_code = season) %>% # must update so that season_code matches
  inner_join(
    habitat_prefs %>% # extract the habitat classifications for the species in question
      filter(suitability == "Suitable", !is.na(map_code)) %>%
      select(binomial, season_code, map_code) %>%
      mutate(season = season_code) # add a new column to 1) match season in aoh, and 2) to retain season_code
    ) %>%
  bind_rows(aoh_l %>% 
              filter(binomial %in% sp_na_season) %>% # to bind back to the inner_joined df
              mutate(season_code = NA)
            )

write_parquet(aoh_filter, paste0(p_derived, "aoh_filter.parquet"))
aoh_filter <- read_parquet(paste0(p_derived, "aoh_filter.parquet"))
```

```{r calc-aoh}
# calculate AOH for multiple conditions: across all habitats and seasons, and excluding passage areas:
aoh_filter

aoh <- lapply(c("include_passage", "exclude_passage"), function(i) {
  
  aoh_filter %>%
    
    # filtering out passage areas:
    # Codes are: "Resident" (1), "Breeding" (2), "Non-breeding Season" (3),
    # Passage (4), and Seasonal Occurrence Uncertain (5).
    {if (i == "exclude_passage") filter(., season %in% c(1, 2, 3)) else .} %>%
    
    # group and sum area to calculate AOH
    group_by(aoh_type, vert_class, site, binomial, year) %>% 
    summarise(aoh = sum(area, na.rm = TRUE)) %>%
    mutate(passage_type = i)
}) %>% bind_rows() %>% ungroup()

# ------------ #
# combine with relevant columns from aoh_l
aoh <- 
  aoh %>% 
  left_join(
    aoh_l %>% 
      select(aoh_type, vert_class, site, binomial, 
             redlistCategory, mature_forest_obl, common_names) %>% 
      unique()
  )


# Add a year0 that starts with 1 for the linear models.
# However, because crop_abn starts in different years, I need to
# extract the first year for each species, join that, and use that to determine year0.

aoh_start_years <-
  aoh %>%
  group_by(aoh_type, vert_class, site, binomial, passage_type) %>%
  summarise(start_year = min(year),
            end_year = max(year)) %>%
  ungroup()


# join and create year0
aoh <-
  aoh %>% 
  left_join(aoh_start_years) %>%
  mutate(year0 = year - start_year + 1)

# previous code
  # # in this case, the full, max_abn, and max_potential_abn runs all start in 1987
  # mutate(year0 = case_when(
  #   grepl("full|max", aoh_type) ~ year - 1986,
  #   grepl("^abn_|^potential", aoh_type) ~ year - 1991
  # ))

aoh %>%
  filter(binomial == "Boana albopunctata")



# create an index for running the linear models,
# one index for each unique species at each site, in each of the aoh runs, with and without passage areas.
run_indices <- 
  aoh %>% 
  arrange(passage_type, aoh_type, vert_class, site, binomial) %>%
  select(aoh_type, vert_class, site, binomial, passage_type,
         common_names, redlistCategory, mature_forest_obl) %>%
  unique() %>% 
  mutate(run_index = 1:n())

# add this index back to the distilled df
aoh <- aoh %>%
  left_join(run_indices)

# save file ----------------- #
run_indices
write_parquet(run_indices, paste0(p_derived, "aoh_run_indices.parquet"))

write_parquet(aoh, paste0(p_derived, "aoh.parquet"))
aoh <- read_parquet(paste0(p_derived, "aoh.parquet"))
run_indices <- read_parquet(paste0(p_derived, "aoh_run_indices.parquet"))






# -------------------------------------------------------- #

# taking stock:
# lots of stuff gets filtered out, which is why these numbers are not 2x each other.
aoh_l %>% select(aoh_type, site, binomial) %>% unique() # 10,739
aoh %>% select(aoh_type, site, binomial) %>% unique() # 8642 * 2
aoh %>% select(aoh_type, site, binomial, passage_type) %>% unique() # 17,266


aoh %>% group_by(aoh_type, site, binomial, vert_class) %>% 
  summarise(n_yr = length(year)) %>%
  filter(n_yr < 62)

species_list %>% nrow() # 4001 unique species - site combinations
aoh_l %>% 
  select(aoh_type, vert_class, site, binomial, 
         redlistCategory, mature_forest_obl, common_names) %>%
  unique() %>% nrow()


aoh$year0 %>% min()

aoh$year %>% summary()
aoh %>% group_by(aoh_type) %>% summarise(min_year = min(year), max_year = max(year))

# ------ extras ------- #

# test
aoh %>% 
  pivot_wider(id_cols = c(aoh_type:year), values_from = aoh, 
              names_from = passage_type, names_prefix = "aoh_") %>%
  mutate(test = include_passage - exclude_passage) %>%
  filter(test < -0.000000001)


# if you want to add it back to aoh_l, you can do this: but don't think this is necessary
aoh_l %>%
  left_join(
    aoh %>% 
      pivot_wider(id_cols = c(aoh_type:year), values_from = aoh, 
                  names_from = passage_type, names_prefix = "aoh_")
    ) %>% 
  select(aoh_type:area, starts_with("aoh"), everything()) %>%
  mutate(aoh_exclude_passage = case_when(
    season == 4 ~ NA_real_,
    TRUE ~ aoh_exclude_passage
  ))
```


```{r pivot-aoh}
aoh %>%
  filter(site == site_df$site[1], binomial == sp_name) %>% #print(n = 124)
  pivot_wider(
    id_cols = c("vert_class", "site", "binomial", 
                "redlistCategory", "year", "mature_forest_obl", "passage_type"),
    names_from = aoh_type, values_from = aoh, names_pref = "aoh_") %>%
  mutate(diff_obs = aoh_full_iucn - aoh_max_abn_iucn, 
         diff_pot = aoh_full_iucn - aoh_max_potential_abn_iucn) %>%
  pivot_longer(cols = c("aoh_full_iucn", "aoh_max_abn_iucn", 
                        "aoh_max_potential_abn_iucn", 
                        "diff_obs", "diff_pot"),
               names_to = "type", values_to = "aoh")
```


## Explore
```{r prelim-plots}
sp_to_plot <- "Agamia agami"
sp_to_plot <- "Certhia familiaris"

aoh %>%
  filter(binomial == sp_to_plot, aoh_type %in% aoh_type_df$label[c(6, 8)]) %>%
  ggplot(mapping = aes(x = year, y = aoh, 
                       col = aoh_type, group = aoh_type
                       )) +
  geom_line() + 
  labs(x = "Year", y = "AOH (ha)", caption = sp_to_plot) +
  facet_wrap(vars(site), scales = "free")



```


```{r example-plots-extracting-trend-abn}

sp_name <- "Certhia familiaris"

cc_plot_aoh_sp_site(binomial = c("Certhia familiaris", "Poecile palustris",
                                 "Agamia agami", "Anser fabalis"), 
                    site_index = c(1:11))

cc_plot_aoh_trend_sp_site(
  binomial = c("Certhia familiaris", "Poecile palustris",
               "Agamia agami", "Anser fabalis"), 
  site_index = c(1:11))


aoh %>% 
  filter(run_index == 3) %>%
  ggplot(mapping = aes(x = year0, y = aoh)) +
  geom_point() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = unique(filter(aoh, run_index == i)$binomial))
  
# ------ #

 habitat_prefs %>% filter(str_detect(binomial, "Poecile palustris")) %>%
  select(binomial, name, season, suitability, map_code)

habitat_age_req_coded %>%
  filter(vert_class == "bird") %>%
  group()
  

# -------------------------------------------------- #
# declining trend

aoh_max_abn_change_df %>%
  left_join(run_indices_max_abn, by = "run_index") %>%
  filter(site == "shaanxi", rel_change < 0)

sp_name2 <- "Anser fabalis"

gg_aoh_example2 <-
  aoh_distill %>%
  filter(site == site_df$site[9], binomial == sp_name2) %>% #print(n = 124)
  pivot_wider(
    id_cols = c("vert_class", "site", "binomial", "redlistCategory", "year", "mature_forest_obl"),
              names_from = aoh_type, values_from = c("aoh", "aoh_no_passage")) %>% #unique() %>% print(n = 100)
  mutate(diff_iucn = aoh_full_iucn - aoh_max_abn_iucn, diff_lc = aoh_full_lc - aoh_max_abn_lc) %>%
  pivot_longer(cols = c("aoh_full_iucn", "aoh_max_abn_iucn", "aoh_full_lc", "aoh_max_abn_lc", "diff_iucn", "diff_lc"),
               names_to = "type", values_to = "aoh") %>%
  # print(n = 80)
  # filter(type %in% c("max_abn", "lc", "diff_max")) %>%
  
  ggplot(mapping = aes(x = year, y = aoh, col = type)) + 
  geom_line(size = 1.5) + 
  labs(x = "Year", y = "AOH (ha)", 
       title = paste(sp_name2, "(Taiga bean goose)"),
       subtitle = site_df$site[9]) +
  scale_color_manual(
    name = "Type",
                     labels = c("diff_iucn" = "Difference, IUCN",
                                "diff_lc" = "Difference, lc",
                                "aoh_full_iucn" = "Landscape, IUCN",
                                "aoh_full_lc" = "Landscape, lc",
                                "aoh_max_abn_iucn" = "Abandonment, IUCN",
                                "aoh_max_abn_lc" = "Abandonment, lc"),
                     values = gg_color_hue(6)
                     )
# save plot
ggsave(plot = gg_aoh_example2,
       filename = paste0(p_output, "plots/aoh/", "aoh_example_species2", aoh_run_date, ".pdf"),
     width = 8, height = 6, units = "in")


  

# What proportion of the change in habitat resulted from abandonment?


```

```{r remove-ag-conversion-signal}
# I need to figure out some way to extract just the signal of cropland -> abandonment
# This means that I need to find an intermediary between
# non-crop > cropland > abandonment

# the current max_abn layers have the full time series for each pixel
# this means that habitat loss at the start, before cropland abandonment is picked up.

# Probably best to do this using data.table. 
# look back at the step in cc_calc_age function to see 

```


## Model 

```{r calc-linear-regression}
# aoh_lm
# aoh_distill %>% filter(run_index == 212)

df_sp_subset <- aoh %>%
  filter(binomial == sp_to_plot, site == "belarus",
         aoh_type %in% aoh_type_df$label[6])


# prelim model
tmp_lm <- lm(aoh ~ year0, data = df_sp_subset)
tidy(tmp_lm)
tmp_lm %>% tidy(., conf.int = TRUE, conf.level = 0.95)
glance(tmp_lm)
augment(tmp_lm)

ggplot(data = df_sp_subset, 
       mapping = aes(x = year0, y = aoh)) +
  geom_point() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = sp_to_plot) + 
  # geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[9]]), na.rm = TRUE))},
  #               mapping = aes(linetype = "Mean Decay Rate"),
  #               color = "blue", size = 1, #linetype = "dashed", 
  #               inherit.aes = FALSE) 
  geom_line(data = augment(tmp_lm), mapping = aes(x = year0, y = .fitted), col = "green", alpha = 0.2)


# ---------- calculate trend for all species ---------- #
# filter(aoh_distill, binomial == sp_to_plot)
# tmp_all <- lm(adj_IUCN_aoh_ha ~ year*binomial - 0, 
#               data = filter(aoh_distill, binomial %in% species_list$binomial[1:5],
#                             site == "belarus"))
# aoh_lm_df <- tidy(tmp_all)



# -------------------
# run simple regression on each species' and extract AOH trend over time.
# -------------------

# ------------------------------------------------------ #
# calculate linear regression for each aoh_type, across all indices for each aoh_type
# ------------------------------------------------------ #
aoh$aoh_type %>% unique()

tic()
lapply(aoh_types, 
       function(aoh_type_) {
         aoh_tmp <- aoh %>% filter(aoh_type == aoh_type_)
         
         # run across aoh_type, site, binomial, passage_type combinations
         
         aoh_lm_tmp <- lapply(
           unique(aoh_tmp$run_index),
           function(i) {
             aoh_tmp %>% 
               filter(run_index == i) %>%
               lm(aoh ~ year0, data = .) %>%
               tidy(., conf.int = TRUE, conf.level = 0.95) %>% 
               mutate(aoh_type = aoh_type_,
                      run_index = i)
             }) %>% bind_rows()
         
         write_parquet(aoh_lm_tmp, paste0(p_derived, "aoh_lm_", aoh_type_,".parquet"))
         
         cat("wrote aoh_lm_tmp for:", aoh_type_, fill = TRUE)
         })
toc()
warnings()

# ------------------------------------------------------ #
# load back in:
# ------------------------------------------------------ #
aoh_lm <- 
  lapply(aoh_types, 
  function(aoh_type_) {read_parquet(paste0(p_derived, "aoh_lm_", aoh_type_,".parquet"))
}) %>% bind_rows()

run_indices
aoh_lm$aoh_type %>% unique()
warnings()

write_parquet(aoh_lm, paste0(p_derived, "aoh_lm.parquet"))

aoh_lm <- read_parquet(paste0(p_derived, "aoh_lm.parquet"))


# old

# tic()
# aoh_lm <- lapply(
#   1:length(unique(aoh$run_index)), 
#   function(i) {
#   aoh %>% 
#     filter(run_index == i) %>%
#     lm(aoh ~ year0, data = .) %>%
#     tidy(., conf.int = TRUE, conf.level = 0.95) %>% 
#     mutate(run_index = i)
# }) %>% bind_rows()
# 
# write_parquet(aoh_lm, paste0(p_derived, "aoh_lm.parquet"))
# toc()

```


```{r aoh-change-df}
# ------------------
# determine the relative trend (percent change in AOH start to end)
# ------------------
aoh_lm <- read_parquet(paste0(p_derived, "aoh_lm.parquet"))

# calculate percent changes
aoh_change_df <-
  aoh_lm %>%
  select(run_index, 
         term, estimate,
         conf.low, conf.high) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope")) %>%
  pivot_wider(id_cols = run_index, 
              values_from = c(estimate, conf.low, conf.high),
              names_from = term, #names_prefix = "",
              ) %>%
  mutate(aoh_start_est = estimate_slope*1 + estimate_intercept,
         aoh_end_est = estimate_slope*31 + estimate_intercept,
         rel_change = ((aoh_end_est/aoh_start_est) - 1),
         rel_change_low = (((conf.low_slope*31 + conf.low_intercept)/
                              (conf.low_slope*1 + conf.low_intercept)) - 1),
         rel_change_high = (((conf.high_slope*31 + conf.high_intercept)/
                               (conf.high_slope*1 + conf.high_intercept)) - 1),
         ) %>%
  left_join(run_indices, by = "run_index")


write_parquet(aoh_change_df, paste0(p_derived, "aoh_change_df.parquet"))

# filter(aoh_distill, !is.na(aoh_no_passage))$run_index %>% unique() %>% sort()

# aoh_lm

hist(aoh_change_df$rel_change)

aoh_change_df %>%
  arrange(rel_change) %>%
  # filter(rel_change < 5 & rel_change > -1) %>%
  .$rel_change %>%
  hist(breaks = 100)
```


```{r aoh-trends}
# determine the direction of trend for each species-site combination
aoh_trends <- 
  aoh_lm %>% 
  left_join(run_indices) %>%
  filter(term == "year0") %>%

  mutate(trend = case_when(
    estimate > 0 & p.value < 0.05 ~ "gain", # Statistically significant gain of AOH
    estimate < 0 & p.value < 0.05 ~ "loss", # Statistically significant loss of AOH
    p.value > 0.05 ~ "no trend" # no significant trend
    )) %>%
  # mutate(trend0 = if_else(estimate > 0, "gain", "loss")) %>%
  # mutate(trend_from_ci = case_when(
  #   sign(conf.low) + sign(conf.high) == -2 ~ "loss",
  #   sign(conf.low) + sign(conf.high) == 2 ~ "gain",
  #   sign(conf.low) + sign(conf.high) < 2 & 
  #     sign(conf.low) + sign(conf.high) > -2 ~ "no trend")
  #   ) %>% 
  # mutate(test = trend == trend_from_ci) %>%
  # select(term, estimate, p.value, conf.low, conf.high, run_index:binomial, contains("trend"), everything()) %>%
  # filter(
  #   p.value > 0.05,
  #   is.na(test)
  #   ) %>% .$trend %>% unique()
  
  select(term:binomial, trend, everything()) %>%
  mutate(aoh_type = fct_relevel(aoh_type, aoh_types[c(6, 7, 3, 5, 1, 2, 4)]),
         obligate_type = case_when(
           mature_forest_obl > 0.5 ~ "mature_forest_obligate",
           mature_forest_obl < 0.5 ~ "not_obligate"))


write_parquet(aoh_trends, paste0(p_derived, "aoh_trends.parquet"))
aoh_trends <- read_parquet(paste0(p_derived, "aoh_trends.parquet"))


```

```{r trend-by-species}
# ---------------------------------------------------- #
# create data.frame with a single row for each species in each aoh type, with the number of trends and the specific trend types they experience (overall_trend):
# ---------------------------------------------------- #
# Extract the number of species with multiple trends per aoh_type:

# Add a column for overall_trend:
# 1. Always winners
# 2. Always losers
# 3. Context dependent

aoh_trends_by_sp <- 
  aoh_trends %>%
  filter(
    #passage_type == "exclude_passage"#, mature_forest_obl < 0.5
    !is.na(trend)) %>%
  select(aoh_type, vert_class, binomial, trend, passage_type) %>% 
  unique() %>% arrange(aoh_type, binomial, trend) %>%
  group_by(aoh_type, vert_class, binomial, passage_type) %>% 
  summarise(n_trends = n(), 
            trend_types = str_c(unique(trend), collapse = "; ")) %>% 
  # arrange(desc(n_trends)) %>%
  ungroup() %>%
  mutate(overall_trend = case_when(
    n_trends == 1 ~ trend_types,
    n_trends == 2 & trend_types == "gain; no trend" ~ "weak gain",
    n_trends == 2 & trend_types == "loss; no trend" ~ "weak loss",
    n_trends == 2 & trend_types == "gain; loss" | n_trends == 3 ~ "context dependent"
  )) %>%
  left_join(aoh_species_list) %>%
  
  # update factor levels
  mutate(
    trend_direction = case_when(
      grepl("gain", overall_trend) ~ "gain",
      grepl("loss", overall_trend) ~ "loss",
      grepl("context", overall_trend) ~ "context dependent",
      grepl("no trend", overall_trend) ~ "no trend"
      ) %>% fct_relevel(c("gain", "loss", "no trend", "context dependent")),
    trend_consistency = case_when(
      n_trends == 1 ~ "consistent",
      grepl("weak", overall_trend) ~ "weak",
      grepl("context", overall_trend) ~ "opposite"
      ) %>% #as_factor() %>% 
      fct_relevel(rev(c("consistent", "weak", "opposite"))),
    
    
    aoh_type = fct_relevel(aoh_type, aoh_types[c(6, 7, 3, 5, 1, 2, 4)]),
    redlistCategory = fct_relevel(redlistCategory, c("Least Concern", "Near Threatened", "Vulnerable", 
                                                     "Endangered", "Critically Endangered", "Data Deficient"))
    )

write_parquet(aoh_trends_by_sp, paste0(p_derived, "aoh_trends_by_sp.parquet"))
aoh_trends_by_sp <- read_parquet(paste0(p_derived, "aoh_trends_by_sp.parquet"))


```


## Trend Changes

```{r trend-changes}
# ----------------------------------------- #
# Q. How many species have no trend or a negative trend at the landscape scale,
# but a positive trend in abandonment?
# ----------------------------------------- #
aoh_trends_by_sp



# ----------------------------------------- #
# Q. How many species have no trend or a negative trend for observed abandonment,
# but a positive trend in potential abandonment?
# ----------------------------------------- #
trend_changes <- 
  aoh_trends %>%
  filter(vert_class != "amp",
         str_detect(aoh_type, "crop"),
         passage_type == "exclude_passage",
         # mature_forest_obl < 0.5
         ) %>%
  pivot_wider(id_cols = c(vert_class, site, binomial),
              values_from = trend,
              names_from = aoh_type) %>%
  # select(contains("crop")) %>% unique()
  mutate(overall_change = case_when(
    crop_abn_iucn == "gain" & crop_abn_potential_iucn == "gain" ~ "no change (gain)",
    crop_abn_iucn == "loss" & crop_abn_potential_iucn == "loss" ~ "no change (loss)",
    crop_abn_iucn == "gain" & crop_abn_potential_iucn == "loss" ~ "gain to loss",
    crop_abn_iucn == "loss" & crop_abn_potential_iucn == "gain" ~ "loss to gain",
    crop_abn_iucn == "loss" & crop_abn_potential_iucn == "no trend" ~ "loss to no trend",
    crop_abn_iucn == "gain" & crop_abn_potential_iucn == "no trend" ~ "gain to no trend",
    crop_abn_iucn == "no trend" & crop_abn_potential_iucn == "no trend" ~ "no change (no trend)",
    crop_abn_iucn == "no trend" & crop_abn_potential_iucn == "loss" ~ "no trend to loss",
    crop_abn_iucn == "no trend" & crop_abn_potential_iucn == "gain" ~ "no trend to gain"
  ) %>% fct_relevel(),
  change_direction = case_when(
    grepl("^no change", overall_change) ~ "no change",
    grepl("to loss$", overall_change) ~ "loss",
    grepl("to gain$", overall_change) ~ "gain",
    grepl("no trend", overall_change) ~ "indeterminate"
  ) %>% fct_relevel("gain", "no change", "indeterminate", "loss")) %>%
  group_by(vert_class, site, 
           # overall_change, 
           change_direction
           ) %>%
  summarise(n_sp = n()) %>% 
  arrange(vert_class, change_direction)
  # .$overall_change %>% as_factor() %>% levels()


trend_changes %>%
  ggplot(mapping = aes(
         x = change_direction,
         y = n_sp,
         fill = vert_class,
         group = vert_class
         )) +
  geom_col(position = position_dodge(preserve = "total"),
           color = "black", size = .25) +
  theme_classic() + 
  labs(x = "Trend Change Direction", y = "Number of Species") +
  # scale_fill_manual(name = "", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)) +
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))



trend_changes %>%
  ggplot(mapping = aes(
         y = change_direction,
         x = n_sp,
         fill = vert_class,
         group = vert_class
         )) +
  geom_col(position = position_dodge(preserve = "total"),
           color = "black", size = .25) +
  theme_classic() + 
  # labs(x = "Trend Change Direction", y = "Number of Species") +
  # scale_fill_manual(name = "", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right") +
    theme(strip.text.y.right = element_text(angle = 0)) +
  facet_grid(rows = vars(site), scales = "free")#, labeller = as_labeller(fancy_labels))

```

```{r *plot-overlapping-lines}

aoh_change_df %>% filter(!is.na(estimate_slope))

df_tmp <-
  aoh_change_df %>% 
  filter(
    # aoh_type == "crop_abn_iucn",
         # site == "shaanxi"
         ) %>%
  select(aoh_type, vert_class, binomial, site, contains("estimate"), 
         passage_type, mature_forest_obl) %>%
  left_join(aoh_start_years) %>%
  mutate(year0_start = 1, year0_end = end_year - start_year + 1) %>%
  # left_join(aoh_trends_by_sp %>% 
  #             select(aoh_type, vert_class, binomial, passage_type,
  #                    overall_trend, trend_direction)) %>%
  left_join(aoh_trends %>% 
              select(aoh_type, site, vert_class, binomial, trend, passage_type)) %>%
  filter(!is.na(trend))

aoh_trends %>% unique()
aoh_trends$term %>% unique()
df_tmp %>% unique()

# mean trend in each trend type:
df_tmp_mean <-
  df_tmp %>%
    filter(
      # aoh_type == i,
           # site == "shaanxi",
           vert_class != "amp"
           ) %>%
  group_by(aoh_type, #vert_class, 
           site, trend, passage_type) %>%
  summarise(mean_slope = mean(estimate_slope, na.rm = TRUE),
            mean_int = mean(estimate_intercept, na.rm = TRUE)
            ) %>% 
    ungroup() %>%
  mutate(start_year = 1, end_year = 31) %>% 
  pivot_longer(cols = contains("year"), values_to = "year") %>%
  mutate(est = year*mean_slope + mean_int)
  

i <- "crop_abn_potential_iucn"

# for (i in aoh_types[c(6, 3, 1, 7, 5)]) {
  
gg_aoh_trend_lines_by_site <-
  lapply(aoh_types[c(6, 3, 1, 7, 5)], function(i) {
  df_tmp %>%
    filter(aoh_type == i,
           !(vert_class == "bird" & mature_forest_obl > 0.5),
           passage_type == "exclude_passage"
           ) %>%
  pivot_longer(cols = contains("year0"), values_to = "year") %>%
  mutate(est = year*estimate_slope + estimate_intercept,
         year = year + start_year - 1) %>%
  
  ggplot(aes(x = year, y = est/10^6, col = trend,
             group = binomial
             )) +
  geom_smooth(method = "lm", se = 0.95,
              mapping = aes(x = year, y = est/10^6, 
                            col = trend, fill = trend, 
                            group = trend),
              linetype = 2, show.legend = FALSE) + 
    geom_line(alpha = 0.15) + 

    # geom_line(data = df_tmp_mean,
    #           mapping = aes(x = year + 1986, y = est/10^6, col = trend,
    #                         # group = interaction(vert_class, trend), linetype = vert_class
    #                         group = trend
    #                         ),
    #           size = 1, linetype = 2
    #           ) +

  theme_classic() + 
  scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
      scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  labs(y = expression("AOH (10"^{6}*" ha)"),
       x = "Year", col = "Trend", fill = "Mean Trend",
       caption = paste0(filter(aoh_type_df, label == i)$p5)) + 
    # scale_linetype_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
  theme(legend.position = c(0.9, 0.125),
        legend.background = element_blank(),
        legend.spacing = unit(-4, units = "mm")
        ) +
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
    
  })

names(gg_aoh_trend_lines_by_site) <- aoh_types[c(6, 3, 1, 7, 5)]


lapply(seq_along(gg_aoh_trend_lines_by_site), function(j) {
  ggsave(gg_aoh_trend_lines_by_site[[j]],
       filename = paste0(p_output, "plots/aoh/", "trend_lines_by_site_",
                         names(gg_aoh_trend_lines_by_site)[j],  aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.75, units = "in")
})


ggplotly(gg_aoh_trend_lines_by_site$crop_abn_iucn)
```

```{r actual-trend-data}

gg_aoh_sp_obs_by_site <-
  lapply(aoh_types[c(6, 3, 1, 7, 5)], function(i) {
  aoh %>%
      filter(aoh_type == i,
             !(vert_class == "bird" & mature_forest_obl > 0.5),
             passage_type == "exclude_passage"
             ) %>%
      left_join(aoh_trends) %>%
      ggplot(aes(x = year, y = aoh/10^6, col = trend,
                 group = binomial
                 )) +
      geom_line(alpha = 0.15) + 
      theme_classic() + 
      scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                         values = palette_du_jour[c(1, 3, 6)]) +
      scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                        values = palette_du_jour[c(1, 3, 6)]) +
      labs(y = expression("AOH (10"^{6}*" ha)"),
           x = "Year", col = "Trend", fill = "Mean Trend",
           caption = paste0(filter(aoh_type_df, label == i)$p5)) + 
      guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
      theme(legend.position = c(0.9, 0.125),
            legend.background = element_blank(),
            legend.spacing = unit(-4, units = "mm")
            ) +
      facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
    })

names(gg_aoh_sp_obs_by_site) <- aoh_types[c(6, 3, 1, 7, 5)]


lapply(seq_along(gg_aoh_sp_obs_by_site), function(j) {
  ggsave(gg_aoh_sp_obs_by_site[[j]],
       filename = paste0(p_output, "plots/aoh/", "aoh_sp_obs_by_site_",
                         names(gg_aoh_sp_obs_by_site)[j],  aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.75, units = "in")
})


ggplotly(gg_aoh_trend_lines_by_site$crop_abn_iucn)
```


# Figures 

## Overall Trends

```{r color-palette}
met.brewer(name = "VanGogh2", 4)
met.brewer(name = colorblind_palettes[24], 4)
met.brewer(name = colorblind_palettes[6], 4)
colorblind_palettes

input_palette <- met.brewer(name = "Kandinsky", 4)[c(1, 4, 3, 2)] # use this one, for now
# input_palette <- met.brewer(name = "Egypt", 4)[c(3, 2, 4, 1)]
# input_palette <- met.brewer(name = "Java", 4)[c(4, 1, 3, 2)]

# set up color palettes:
palette_du_jour <- c(
 "gain" = input_palette[1],
 "weak gain" = alpha(input_palette[1], 0.5),
 "no trend" = input_palette[2],
 "context dependent" = input_palette[3],
 "weak loss" = alpha(input_palette[4], 0.5),
 "loss" = input_palette[4]
)
show_col(palette_du_jour)

palette_labels <- c(
 "gain" = "Gain",
 "weak gain" = "Weak Gain",
 "no trend" = "No Trend",
 "context dependent" = "Opposites",
 "weak loss" = "Weak Loss", 
 "loss" = "Loss"
)


# ---------------------------------------------------------- #
# check whether palette is colorblind friendly
aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class == "bird", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         aoh_type == "crop_abn_iucn",
         overall_trend %in% c("gain", "no trend", "loss")
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = fct_relevel(aoh_type, rev), y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", ) +
  theme_classic() + 
  # scale_x_discrete(labels = aoh_type_labels) +
  # labs(x = "Scale of AOH Calculation", y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "Scale of AOH Calculation", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_grid(rows = vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels)) +
  colorblindr::cvd_grid()

```

```{r set-up-aoh-types-sub}
aoh_types_sub <- aoh_types[c(6, 3, 1)]
threat_statuses <- c("Threatened", "Not Threatened")
```



```{r trend-summary-overall}
# for (i in 1:4) {
#   
#   passage_opt <- filter(plot_filter_options_df, run == i)$passage_opt
#   mature_opt <- filter(plot_filter_options_df, run == i)$mature_opt

gg_aoh_trend_by_vert_aoh_type <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         x = trend_direction,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(2, 1, 3, 4, 5, 6)])
         )) +
  geom_col(color = "black", size = .25) +
  theme_classic() +
 scale_x_discrete(labels = palette_labels) +
  labs(x = "AOH Trend", y = "Number of Species") +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "right",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0, size = 8)) +
  facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", labeller = as_labeller(aoh_type_labels))


ggsave(gg_aoh_trend_by_vert_aoh_type,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_by_vert_aoh_type", aoh_run_date,
                         ".pdf"),
       width = 5.5, height = 5, units = "in")
```


```{r trend-summary-overall-mat-for-obl}
# -------- excluding mature forest obligates ----- ------ #
gg_aoh_trend_by_vert_aoh_type_no_mat <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # mature_forest_obl < 0.5
         ) %>%

  group_by(aoh_type, vert_class, passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%
    filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         x = trend_direction,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(2, 1, 3, 4, 5, 6)])
         )) +
  geom_col(color = "black", size = .25) +
  theme_classic() + 
 scale_x_discrete(labels = palette_labels) +
  labs(x = "AOH Trend", y = "Number of Species") +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "right",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)) +
  facet_grid(
        row = vars(mature_forest_obl), col = vars(aoh_type),
    scales = "free_y", labeller = as_labeller(c(aoh_type_labels, 
  "TRUE" = "Mature Forest \nObligates",
  "FALSE" = "Non-Mature Forest \nObligates")))



ggsave(gg_aoh_trend_by_vert_aoh_type_no_mat,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_overall_by_mature_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 5, units = "in")

# }
```


```{r old-overall-trend-by-sp}
# plot -- number of each trend type:
plot_filter_options_df
i <- 3
for (i in 1:4) {
  
  passage_opt <- filter(plot_filter_options_df, run == i)$passage_opt
  mature_opt <- filter(plot_filter_options_df, run == i)$mature_opt

  
# gg_trend_summary_by_sp_old <-
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         # aoh_type == "max_abn_iucn"
         ) %>%
  {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ggplot(data = .,
       mapping = aes(
         # x = overall_trend, 
         x = trend_direction,
                     y = n_sp,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     # alpha = as_factor(trend_consistency)
                     alpha = trend_consistency %>% fct_rev()
                     )) +
  geom_col(#position = position_dodge2(width = 0.8, preserve = "single")
           ) +
  theme_classic() + 
  scale_alpha_manual(name = "Trend Consistency",
                     labels = c("opposite" = "Opposite",
                                "consistent" = "Consistent",
                                "weak" = "Weak"),
                     values = c("consistent" = 1,
                                "weak" = 0.4,
                                "opposite" = 0.2)
                     ) + 
  theme(legend.position = "right",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)) +
  facet_grid(col = vars(vert_class), rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_by_sp_old,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_sp_old", aoh_run_date, "_",
                         "_", mature_opt,
                         "_", passage_opt,
                         ".pdf"),
       width = 6, height = 5, units = "in")
}

aoh_trends_by_sp$trend_types %>% unique()
```


```{r overall-stacked-percent}
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #

gg_trends_stack_percent <-
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    # x = fct_relevel(aoh_type, rev), y = n_sp,
    y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(
    position = position_fill(rev = TRUE),
    # position = "stack",
    color = "black", ) +
  theme_classic() + 
  # scale_x_discrete(labels = aoh_type_labels) +
  # labs(x = "Scale of AOH Calculation", y = "Proportion of Species") +

  scale_y_discrete(labels = aoh_type_labels) +
  labs(y = "Scale of AOH Calculation", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_grid(rows = vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_trends_stack_percent,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_stacked", aoh_run_date, ".pdf"),
       width = 5.5, height = 3, units = "in")

# ------------------------------------------------------------ #
# No mature forest obligates:
# ------------------------------------------------------------ #
no_mat <-
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # mature_forest_obl < 0.5
         ) %>%
  group_by(aoh_type, vert_class, passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type)

gg_trends_stack_percent_no_mature <-
  gg_trends_stack_percent %+% no_mat + facet_grid(
    rows = vars(mature_forest_obl), cols = vars(vert_class),
    scales = "free_y", 
    labeller = as_labeller(c("bird" = "Birds", 
                             "TRUE" = "Mature Forest\nObligates",
                             "FALSE" = "Non-Mature\nForest Obligates"))
    )

ggsave(gg_trends_stack_percent_no_mature,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_overall_stacked_by_mature_obl", aoh_run_date, ".pdf"),
       width = 5, height = 3, units = "in")



# ------------------------------------------------------------ #
# flipped:
# ------------------------------------------------------------ #
gg_trends_stack_percent_flipped <- 
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = fct_relevel(aoh_type, rev), y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", ) +
  guides(col = "none") +
  theme_classic() + 
  scale_x_discrete(labels = aoh_type_labels) +
  labs(x = "Scale of AOH Calculation", y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "Scale of AOH Calculation", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_wrap(vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))

ggsave(gg_trends_stack_percent_flipped,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_stacked_flipped", aoh_run_date, ".pdf"),
       width = 5, height = 6, units = "in")

```







```{r by-IUCN-category}
aoh_trends_by_sp$aoh_type %>% unique()

# ----------------------------------------------------------------------- #
# Lumped across all sites, threatened vs. non-threatened #
# ----------------------------------------------------------------------- #
gg_trend_summary_by_iucn_status_lumped <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         redlistCategory != "Data Deficient",
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           # redlistCategory,
           threatened = case_when(
             redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
             TRUE ~ "Not Threatened"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         y = threatened, x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "IUCN Status", x = "Proportion of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom") +
      theme(strip.text.y.right = element_text(angle = 0)) +
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels),
               scales = "free")

ggsave(gg_trend_summary_by_iucn_status_lumped,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_lumped", aoh_run_date,
                         ".pdf"),
       width = 6, height = 3.5, units = "in")


# -------------------------------------------------------- #
# Stacked, with number of species:
# -------------------------------------------------------- #
gg_trend_summary_by_iucn_status_lumped_numeric <- 
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         redlistCategory != "Data Deficient",
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           # redlistCategory,
           threatened = case_when(
             redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
             TRUE ~ "Not Threatened"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         x = aoh_type, y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  # geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() +
  scale_x_discrete(labels = aoh_type_labels) + 
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "Number of Species", x = NULL) +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)
      # theme(strip.text.y.right = element_text(angle = 0)
  ) +
    facet_grid(cols = vars(vert_class), rows = vars(threatened), 
               labeller = as_labeller(aoh_type_labels),
               scales = "free")

ggsave(gg_trend_summary_by_iucn_status_lumped_numeric,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_lumped_numeric", aoh_run_date,
                         ".pdf"),
       width = 4.5, height = 5, units = "in")


# ------------------------------------------------------------- #
# individual categories
# -------------------------------------------------------- #
gg_trend_summary_by_iucn_status <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         redlistCategory != "Data Deficient"
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           redlistCategory,
           # threatened = case_when(
           #   redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
           #   TRUE ~ "Not Threatened"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = redlistCategory %>% fct_relevel(), 
         x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "IUCN Status", x = "Proportion of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "right",
        # axis.text.x = element_text(size = 8)
        ) +
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_by_iucn_status,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 4.5, units = "in")




# ----------------------------------------------------------------------- #
# Lumped, threatened vs. non-threatened, by site
# ----------------------------------------------------------------------- #
# gg_trend_summary_by_site <- 
  # lapply(aoh_types_sub, function(i) {



gg_trend_summary_by_iucn_status_lumped_by_site <- 
  lapply(1:2, function(j) {
    lapply(aoh_types_sub, function(i) {
      aoh_trends %>%
        filter(passage_type == "exclude_passage",
               vert_class != "amp", 
               # vert_class == class,
               redlistCategory != "Data Deficient",
               !(vert_class == "bird" & mature_forest_obl > 0.5),
               !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
               !grepl("potential", aoh_type),
               aoh_type == i
               ) %>%
        # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%
        
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened = case_when(
                   redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
                   TRUE ~ "Not Threatened"),
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%
        filter(threatened == threat_statuses[j]) %>%
        
        ggplot(mapping = aes(
         x = vert_class, y = n_sp, #alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         # group = trend
         # group = overall_trend
         )) +
  geom_col(position = position_dodge2(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
 scale_x_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) +
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "Number of Species", x = NULL,
       caption = paste0(threat_statuses[j], " Species: ", filter(aoh_type_df, label == i)$p5)) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  theme(legend.position = c(0.9, 0.15),
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
      theme(strip.text.y.right = element_text(angle = 0)) +
  # facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    # scales = "free_y", labeller = as_labeller(aoh_type_labels))
    facet_wrap(vars(site), ncol = 4,
               scales = "free", labeller = as_labeller(fancy_labels)
               )
    })
    })


lapply(1:2, function(j) {
  lapply(1:3, function(i) {
    ggsave(gg_trend_summary_by_iucn_status_lumped_by_site[[j]][[i]],
           filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_by_site_", 
                             aoh_types_sub[i], "_",
                             gsub(" ", "", threat_statuses[j]), aoh_run_date,
                             ".pdf"),
           width = 6, height = 5, units = "in")
    })
})
```


```{r by-IUCN-category-final}
# --------------------- #
# Main text figure: n species by site, 
# with facet cols for lumped threat status, rows for birds/mammals

i <- "crop_abn_iucn"


gg_aoh_by_iucn_lumped_by_site_bars <- 
  lapply(aoh_types_sub, function(i) {
    aoh_trends %>%
        filter(passage_type == "exclude_passage",
               vert_class != "amp", 
               redlistCategory != "Data Deficient",
               aoh_type == i,
               !(vert_class == "bird" & mature_forest_obl > 0.5)
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened = case_when(
                   redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
                   TRUE ~ "Not Threatened"),
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%
      filter(!is.na(trend)) %>%
      # filter(threatened == threat_statuses[j]) %>%
        
        ggplot(mapping = aes(
         x = n_sp, y = fct_relevel(site, rev), # alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)])),
         # group = trend
         # group = overall_trend
         )) +
  geom_col(
    # position = position_fill(reverse = TRUE), 
    # position = position_stack(reverse = TRUE), 
    position = position_dodge(preserve = "single"#, width = 0.8, padding = 0.2
                               ),
    color = "black", size = .25
    ) +
  theme_classic() + 
 # scale_x_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) +
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
    scale_y_discrete(labels = fancy_labels
                       # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                                   ) + 
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 6, 3)],
                    values = palette_du_jour[c(1, 6, 3)]) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
      # theme(strip.text.y.right = element_text(angle = 0)) +
  facet_grid(
    rows = vars(vert_class), cols = vars(threatened),
    scales = "free", labeller = as_labeller(aoh_type_labels)
    )
    # facet_wrap(vars(site_thr), ncol = 4,
               # scales = "free", #labeller = as_labeller(fancy_labels)
               # )
})

names(gg_aoh_by_iucn_lumped_by_site_bars) <- aoh_types_sub
# gg_aoh_by_iucn_lumped_by_site_bars$max_abn_iucn

lapply(1:3, function(i) {
  ggsave(gg_aoh_by_iucn_lumped_by_site_bars[[i]],
           filename = paste0(p_output, "plots/aoh/",
                             "aoh_by_iucn_lumped_by_site_bars_", 
                             aoh_types_sub[i],
                             aoh_run_date,
                             ".pdf"),
           width = 5, height = 7.5, units = "in")
})

# ------------------------------------------- #
# combine with a overall total bar on the side - this is the final version that goes into the manuscript
# ------------------------------------------- #
i <- "crop_abn_iucn"

j <- 1
threat_statuses


lapply(aoh_types_sub, function(i) {
  
gg_aoh_iucn_overall_tmp <-
  lapply(1:2, function(j) {
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         redlistCategory != "Data Deficient",
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         aoh_type == i
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           threatened = case_when(
             redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
             TRUE ~ "Not Threatened"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
    filter(threatened == threat_statuses[j]) %>%
    # mutate(
      # vert_class = case_when(
    #   vert_class == "mam" ~ "Mammals",
    #   vert_class == "bird" ~ "Birds"),
      # aoh_type = "Overall"
    # ) %>%
  ggplot(mapping = aes(
         x = threatened,# x = aoh_type,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(
    x = NULL, y = NULL
    # x = "IUCN Status", y = "Number of Species"
    ) +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
      scale_x_discrete(labels = c("Threatened" = "Overall",
                                  "Not Threatened" = "Overall")) +
  theme(legend.position = "none", axis.ticks.x = element_blank(),
        plot.background = element_blank()) +
      # theme(strip.text.y.right = element_blank()) +
    facet_grid(cols = vars(threatened), rows = vars(vert_class), 
               scales = "free",
               labeller = as_labeller(c("mam" = "Mammals",
               "bird" = "Birds",
               # "Threatened" = "Threatened", #"Overall",
               # "Not Threatened" = "Not Threatened" #"Overall"  
               "Threatened" = "Thr.",
               "Not Threatened" = "Not Thr."
               ))
               )
})


gg_aoh_by_iucn_lumped_by_site_bars_tmp <-
  aoh_trends %>%
        filter(passage_type == "exclude_passage",
               vert_class != "amp", 
               redlistCategory != "Data Deficient",
               aoh_type == i,
               !(vert_class == "bird" & mature_forest_obl > 0.5)
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened = case_when(
                   redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
                   TRUE ~ "Not Threatened"),
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%
      filter(!is.na(trend)) %>%
        ggplot(mapping = aes(
         x = n_sp, y = fct_relevel(site, rev), # alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)])),
         )) +
  geom_col(
    position = position_dodge(preserve = "single"#, width = 0.8, padding = 0.2
                               ),
    color = "black", size = .25
    ) +
  theme_classic() + 
    scale_y_discrete(labels = fancy_labels
                       # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                                   ) + 
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels,#[c(1, 6, 3)],
                    values = palette_du_jour#[c(1, 6, 3)]
                    ) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
        panel.grid.major.x = element_line(),
        ) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    rows = vars(vert_class), cols = vars(threatened),
    scales = "free", labeller = as_labeller(aoh_type_labels)
    )

ggsave(
  plot_grid(
    plot_grid(
  gg_aoh_by_iucn_lumped_by_site_bars_tmp + theme(strip.text.y.right = element_blank(),
                                                 legend.position = "none") + labs(caption = NULL), 
  # plot_grid(
  gg_aoh_iucn_overall_tmp[[2]] + theme(strip.text.y.right = element_blank()),  
            gg_aoh_iucn_overall_tmp[[1]] + labs(y = NULL),
           # ncol = 2#,
            # rel_widths = c(1, 0.9)
            # ),
  nrow = 1, ncol = 3, 
  align = "h", axis= "b",
  rel_widths = c(3, 0.675, 0.75)
  ),
  ggpubr::get_legend(gg_aoh_trend_by_vert_aoh_type + 
                       guides(fill = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom")),
  nrow = 2, ncol = 1, rel_heights = c(1, 0.07)),
  filename = paste0(p_output, "plots/aoh/",
                    "aoh_IUCN_by_site_combo_",
                    i,
                    aoh_run_date, ".pdf"),
  width = 6.5, height = 7.5, units = "in")

})
```

```{r by-range-size}
# ------------------------------------------------------------- #
# overall - stacked
# ------------------------------------------------------------- #

aoh_trends_by_sp %>% select(binomial, total_range_area, range_size_quantile)

gg_trend_summary_by_range <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # redlistCategory != "Data Deficient",
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <=\nglobal median",
             range_size_quantile > 0.5 ~ "Range size >\nglobal median"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = small, x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         # group = overall_trend
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  # scale_y_discrete(labels = c("small" = "Range size \u2264\nglobal median",
  #                             "big" = "Range size >\nglobal median")) +
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "IUCN Status", x = "Proportion of Species") +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  # facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    # scales = "free_y", labeller = as_labeller(aoh_type_labels))
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels))

ggsave(gg_trend_summary_by_range,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range", aoh_run_date,
                         ".pdf"),
       width = 5.5, height = 5, units = "in")

# ------------------------------------------------------------- #
# overall - side by side
# ------------------------------------------------------------- #

aoh_trends_by_sp %>% select(binomial, total_range_area, range_size_quantile)

gg_trend_summary_by_range_side <-
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # redlistCategory != "Data Deficient",
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         x = vert_class, #group = trend_direction,
         # x = trend_direction, group = vert_class,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         
         )) +
  geom_col(position = position_dodge(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
  scale_x_discrete(labels = aoh_type_labels) +
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(x = "Vert. Class", y = "Number of Species") +
# 
  scale_fill_manual(name = "Trend",
                    labels = palette_labels,
                    values = palette_du_jour) +
  theme(legend.position = "bottom",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
    facet_grid(rows = vars(small), cols = vars(aoh_type),
               scales = "free_y",
               labeller = as_labeller(aoh_type_labels))

ggsave(gg_trend_summary_by_range_side,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_side", aoh_run_date,
                         ".pdf"),
       width = 5.5, height = 5.25, units = "in")


# ------------------------------------------------------------- #
# mature_forest_obligates:
# ------------------------------------------------------------- #
no_mat_by_range_size <- 
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # redlistCategory != "Data Deficient",
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <=\nglobal median",
             range_size_quantile > 0.5 ~ "Range size >\nglobal median"),
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%  
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type)


gg_trend_summary_by_range_no_mature <-
  gg_trend_summary_by_range %+% no_mat_by_range_size + 
  facet_grid(
    cols = vars(mature_forest_obl), rows = vars(aoh_type),
    scales = "free_y", 
    labeller = as_labeller(c(aoh_type_labels, 
                             "TRUE" = "Mature Forest Obligates (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates (Birds)"))
    )

ggsave(gg_trend_summary_by_range_no_mature,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_no_mat_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 5, units = "in")

# ------------------------------------------------------------- #
# by site:
# ------------------------------------------------------------- #

for(i in aoh_types[c(6, 3, 1)]) {
gg_trend_summary_range_by_site1 <-
  aoh_trends %>%
    left_join(aoh_species_list) %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         aoh_type == i,
         # redlistCategory != "Data Deficient",
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site,
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = site, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "IUCN Status", x = "Proportion of Species",
       caption = paste0(filter(aoh_type_df, label == i)$p5)) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(small), rows = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_range_by_site1,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_by_site1_", i, aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")

}


# version 2:
j <- "bird"
for(j in c("mam", "bird")) {
gg_trend_summary_range_by_site2 <-
  aoh_trends %>%
    left_join(aoh_species_list) %>%
  filter(passage_type == "exclude_passage",
         vert_class == j, 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),       
         # redlistCategory != "Data Deficient"
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site,
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = gsub("\n", " ", c(aoh_type_labels, fancy_labels))) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(small), rows = vars(site), 
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
    theme(strip.text.y.right = element_text(angle = 0))


ggsave(gg_trend_summary_range_by_site2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_by_site_",
                         # "no_mat_obl_",
                         j, aoh_run_date,
                         ".pdf"),
       width = 7, height = 7.5, units = "in")

}
```


```{r aoh-trend-distill-old}
# Distill counts of trends:
aoh_trend_counts <-
  aoh_trends %>%
  group_by(aoh_type, vert_class, site, 
           redlistCategory, threatened = redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable"),
           passage_type,
           mature_forest_obl = mature_forest_obl > 0.5, # group by an expression
           trend) %>%
  summarise(trend_count = n())



aoh_trend_counts_by_category <- 
  aoh_trend_counts %>%
  group_by(aoh_type, vert_class, passage_type, mature_forest_obl, trend, 
           # redlistCategory
           threatened# = redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable")
             ) %>%
  summarise(trend_count = sum(trend_count))

  

# plot

aoh_trend_counts_by_category$mature_forest_obl %>% unique()

# aoh_trends %>%
aoh_trend_counts_by_category %>%
  filter(aoh_type == "max_abn_iucn",
         passage_type == "exclude_passage",
         # !is.na(mature_forest_obl)
         mature_forest_obl == FALSE
         ) %>%

  ggplot(data = .,
       mapping = aes(x = threatened, 
                     y = trend_count,
                     # y = y
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = "Red List Category", 
       y = "Number of Species",
       fill = "Vert. Group",
       subtitle = filter(aoh_type_df, label == j)$desc,
       caption = paste0(
         if(passage_opt == "exclude_passage") {
                           paste0("", "excluding passage areas")} else {""},
         if(mature_opt == "exclude_mature_forest_obl") {
           paste0(" | ", "excluding mature forest obligates")} else {""}
                         )
       ) +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss",
                                "no trend" = "No Trend"),
                     values = c("gain" = 1,
                                "loss" = 0.5,
                                "no trend" = 0.2)
                     ) + 
  facet_wrap(vars(threatened), scales = "free")
```


```{r}
aoh_trend_counts %>%
  filter(aoh_type == "max_abn_iucn",
         passage_type == "exclude_passage",
         # !is.na(mature_forest_obl)
         mature_forest_obl == FALSE
         ) %>%

  ggplot(data = .,
       mapping = aes(x = threatened, 
                     y = trend_count,
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  # facet_grid(rows = vars(site), cols = vars(threatened), scales = "free")
  facet_wrap(vars(site#, threatened
                  ), scales = "free")


```

```{r by-site-side-by-side}
# -------------------------------------------------------------------- #
# Side by side ------------------------------------------------------- #
# -------------------------------------------------------------------- #
i <- aoh_types[1]


# for( i in aoh_types[c(6, 3, 1)]) {
gg_trend_summary_by_site <- 
  lapply(aoh_types_sub, function(i) {
    aoh_trends %>%
      filter(!is.na(trend),
             passage_type == "exclude_passage",
             vert_class != "amp", 
             !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
             !grepl("potential", aoh_type),
             aoh_type == i
             # redlistCategory != "Data Deficient"
             ) %>%
      # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%
      
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(
               # x = threatened, y = n_sp,
               x = vert_class, y = n_sp,
               fill = trend #%>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_dodge(preserve = "single"), 
           color = "black", size = .25) +
  theme_classic() + 
  labs(x = NULL, y = "Number of Species", 
       caption = filter(aoh_type_df, label == i)$p5) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_x_discrete(labels = aoh_type_labels) +
  theme(legend.position = c(0.9, 0.125),
        # plot.caption = element_text(vjust = 8)
        # axis.text.x = element_text(size = 8)
        ) +
    facet_wrap(vars(site), labeller = as_labeller(fancy_labels), scales = "free")
    
})

names(gg_trend_summary_by_site) <- aoh_types_sub

lapply(1:3, function(i) {
  ggsave(gg_trend_summary_by_site[[i]],
         filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_", aoh_types_sub[i], aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.25, units = "in")
})


# -------------------------------------------------------------------- #
# No mature forest obligates ----------------------------------------- #
# -------------------------------------------------------------------- #

i <- aoh_types[6]

gg_trend_summary_by_site_mat_obl <- 
  lapply(aoh_types_sub, function(i) {
  aoh_trends %>%
  filter(!is.na(trend),
         passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         aoh_type == i) %>%
  group_by(aoh_type, vert_class, passage_type,
           # mat_obl = mature_forest_obl > 0.5,
           obligate_type,
           site,
           trend) %>%
  filter(!is.na(obligate_type)) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         x = obligate_type, y = n_sp,
         fill = trend #%>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_dodge(preserve = "single"), 
           color = "black", size = .25) +
  theme_classic() + 
  labs(x = NULL, y = "Number of Species",
       caption = filter(aoh_type_df, label == i)$p5) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_x_discrete(labels = c(
    "mature_forest_obligate" = "Mature\nForest\nObligates",
    "not_obligate" = "All Sp. But\nMature Forest\nObligates")) + 
  # scale_x_discrete(labels = str_wrap(c("TRUE" = "Mature Forest Obligates",
                                       # "FALSE" = "Non-Mature Forest Obligates"), width = 10)) +
  theme(legend.position = c(0.9, 0.125),
        # axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)
        ) +

    facet_wrap(vars(site), labeller = as_labeller(fancy_labels), scales = "free")
})

names(gg_trend_summary_by_site_mat_obl) <- aoh_types_sub

lapply(1:3, function(i) {
  ggsave(gg_trend_summary_by_site_mat_obl[[i]],
         filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_mat_obl_", aoh_types_sub[i], aoh_run_date,
                           ".pdf"),
         width = 7, height = 6.5, units = "in")
})
```

```{r overall-plus-by-site-combo}
# filter just birds mature forest obl
aoh_trends_by_sp %>%
  filter(!(vert_class == "bird" & mature_forest_obl > 0.5)) %>%
  select(vert_class) %>% unique()

lapply(aoh_types_sub, function(i) {
  gg_aoh_overall_tmp <-
    aoh_trends_by_sp %>%
    filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         aoh_type == i
         ) %>%
    mutate(vert_class = case_when(
      vert_class == "mam" ~ "Mammals",
      vert_class == "bird" ~ "Birds"),
      aoh_type = "Overall"
    ) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         x = aoh_type, y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour))#[c(2, 1, 3, 4, 5, 6)])
         )) +
  geom_col(position = position_stack(reverse = TRUE), color = "black", size = .25) +
  theme_classic() +
  scale_x_discrete(labels = aoh_type_labels) +
  labs(x = NULL, y = "Number of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  # guides(fill = guide_legend(ncol = 2, nrow = 3)) +
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", #labeller = as_labeller(c(i = "Overall","mam" = "Mammals", "bird" = "Birds"))
    )

  gg_aoh_by_site_tmp <-
    aoh_trends %>%
      filter(!is.na(trend),
             passage_type == "exclude_passage",
             vert_class != "amp",
             !(vert_class == "bird" & mature_forest_obl > 0.5),
             aoh_type == i
             # redlistCategory != "Data Deficient"
             ) %>%
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(
               x = vert_class, y = n_sp,
               fill = trend #%>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_dodge(preserve = "single"), 
           color = "black", size = .25) +
  theme_classic() + 
  labs(x = NULL, y = NULL, 
       caption = paste0(filter(aoh_type_df, label == i)$p5)
       ) +
  scale_fill_manual(name = "Trend",
                    labels = str_wrap(palette_labels, width = 6),#[c(1, 3, 6)],
                    values = palette_du_jour#[c(1, 3, 6)]
                    ) +
  scale_x_discrete(labels = aoh_type_labels) +
    guides(fill = guide_legend(ncol = 2, nrow = 3)) +

  theme(legend.position = c(0.84, 0.1),
        legend.text = element_text(size = 7)) +
  facet_wrap(vars(site), scales = "free", nrow = 4, ncol = 3,
             labeller = as_labeller(fancy_labels))

  ggsave(plot_grid(gg_aoh_overall_tmp,
                   gg_aoh_by_site_tmp,
                   nrow = 1, ncol = 2, 
                   # labels = "auto",
                   align = "h", axis= "b",
                   rel_widths = c(1, 3.3)
                   ),
         filename = paste0(p_output, "plots/aoh/", 
                           "aoh_overall_w_site_combo_",
                           i,
                           aoh_run_date, ".pdf"),
         width = 6, height = 6, units = "in")
})

```



```{r by-site-stacked}
# -------------------------------------------------------------------- #
# Stacked       ------------------------------------------------------ #
# -------------------------------------------------------------------- #

# gg_trend_summary_by_site_stacked <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         # redlistCategory != "Data Deficient"
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site,
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = site, # %>% fct_reorder(n_sp), 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(aoh_type), rows = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_by_site_stacked,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")


# ------------------------------------------------------------ #
# stack 2

gg_trend_summary_by_site_stacked_2 <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = vert_class, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c(aoh_type_labels, fancy_labels)) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(aoh_type), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_2", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")



# ------------------------------------------------------------ #
# stack 3

gg_trend_summary_by_site_stacked_3 <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type %>% fct_relevel(rev), 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = gsub("\n", " ",c(aoh_type_labels, fancy_labels))) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(vert_class), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_3,
       filename = paste0(p_output, "plots/aoh/", 
                         "trend_summary_by_site_stacked_3", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 7.5, units = "in")
```


```{r by-site-stacked-no-mat}
# ------------------------------------------------------------ #
# No mature forest obligates:
# ------------------------------------------------------------ #
no_mat_by_site <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%
  group_by(aoh_type, vert_class, passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           site,
           trend) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type)

gg_trend_summary_by_site_stacked_no_mature <-
  gg_trend_summary_by_site_stacked %+% no_mat_by_site +
  facet_grid(
    rows = vars(mature_forest_obl), cols = vars(aoh_type),
    scales = "free_y",
    labeller = as_labeller(c(aoh_type_labels,
                             "TRUE" = "Mature Forest Obligates (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates (Birds)"))
    )

ggsave(gg_trend_summary_by_site_stacked_no_mature,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_no_mat_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")

gg_trend_summary_by_site_stacked_no_mature2 <-
  no_mat_by_site %>%
  ggplot(mapping = aes(
         y = mature_forest_obl, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("TRUE" = "Mature Forest Obl.", "FALSE" = "Non-Mature Forest Obl.")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(aoh_type), rows = vars(site),
               labeller = as_labeller(c(fancy_labels, aoh_type_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_no_mature2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_no_mat_obl2", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 7.5, units = "in")



```

## Observed vs. Potential

```{r obs-v-pot-overall}
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
gg_trends_obs_v_pot_overall <-
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         grepl("crop", aoh_type),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = aoh_type, y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black") +
  theme_classic() + 
  scale_x_discrete(labels = c("crop_abn_potential_iucn" = "Potential", 
                              "crop_abn_iucn" = "Observed")) +
  labs(x = "Abandonment Scenario", 
       y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "Scale of AOH Calculation", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_grid(cols = vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_trends_obs_v_pot_overall,
       filename = paste0(p_output, "plots/aoh/", 
                         "trend_summary_obs_v_pot_overall", aoh_run_date, 
                         ".pdf"),
       width = 4.5, height = 5, units = "in")


# ------------------------------------------------------------ #
# side by side:
# ------------------------------------------------------------ #
gg_trends_obs_v_pot_overall_dodge <-
  aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         grepl("crop", aoh_type)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = trend_direction, y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    group = trend_direction,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(color = "black") +
  theme_classic() + 
  # scale_x_discrete(labels = c("crop_abn_potential_iucn" = "Potential \nAbandonment", 
  #                             "crop_abn_iucn" = "Observed \nAbandonment")) +
    scale_x_discrete(labels = palette_labels) +
  labs(x = NULL, 
       y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "Scale of AOH Calculation", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 20, vjust = 1, hjust = 1)
        ) +
  facet_grid(
    # cols = vars(aoh_type, vert_class),
    rows = vars(vert_class), cols = vars(aoh_type), 
    scales = "free", labeller = as_labeller(c("crop_abn_potential_iucn" = "Potential \nAbandonment", 
                                              "crop_abn_iucn" = "Observed \nAbandonment",
                                              "mam" = "Mammals",
                                              "bird" = "Birds"
                                              )))


ggsave(gg_trends_obs_v_pot_overall_dodge,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_overall_dodge", aoh_run_date, ".pdf"),
       width = 4, height = 5, units = "in")
```


```{r obs-v-pot-by-site}

# ------------------------------------------------------------ #
gg_trend_summary_obs_v_pot_by_site <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         grepl("crop", aoh_type),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("crop_abn_potential_iucn" = "Potential",
                                              "crop_abn_iucn" = "Observed")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(vert_class), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

gg_trend_summary_obs_v_pot_by_site

ggsave(gg_trend_summary_obs_v_pot_by_site,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_by_site", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 6.5, units = "in")

# ------------------------------------------------------------ #
# side by side
# ------------------------------------------------------------ #
# finish this one:

gg_trend_summary_obs_v_pot_by_site_sbs <-
  lapply(c("bird", "mam"), function(vert_class_) {
    aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         vert_class == vert_class_,
         # !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         grepl("crop", aoh_type)
         ) %>%
      
      # if bird, filter out mature_forest_obl
  {if (vert_class_ == "bird") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>% #filter(site == "mato_grosso")
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = vert_class, 
         y = n_sp, 
         # x = trend, 
         x = aoh_type,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(
    position = position_dodge(preserve = "single"), 
           color = "black", size = .25) +
  theme_classic() + 
  labs(y = "Number of Species", x = "Scenario",
       caption = ifelse(vert_class_ == "bird", "Birds, excluding mature forest obligates", "All Mammals")) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
    
    scale_x_discrete(
    # labels = palette_labels
      labels = c("crop_abn_iucn" = "Observed", "crop_abn_potential_iucn" = "Potential")
    ) +
    # scale_alpha_manual(name = "Scenario", values = c(0.5, 1), 
    #                    labels = c("crop_abn_iucn" = "Observed", "crop_abn_potential_iucn" = "Potential")
    #                    ) +
    
  theme(legend.position = c(0.88, 0.17)) +
    facet_wrap(vars(site), scales = "free",
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))
  })

names(gg_trend_summary_obs_v_pot_by_site_sbs) <- c("bird", "mam")

lapply(c("bird", "mam"), function(vert_class_) {
  ggsave(gg_trend_summary_obs_v_pot_by_site_sbs[[vert_class_]],
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_obs_v_pot_by_site_sbs_", 
                         vert_class_,
                         aoh_run_date,

                         ".pdf"),
       width = 6.5, height = 5.5, units = "in")
})





# ------------------------------------------------------------ #
# mature forest obls
# ------------------------------------------------------------ #
gg_trend_summary_obs_v_pot_by_site_mat_for_obl <-
  aoh_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         grepl("crop", aoh_type)
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           mature_forest_obl = mature_forest_obl > 0.5,
           site, trend) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("crop_abn_potential_iucn" = "Potential",
                                              "crop_abn_iucn" = "Observed")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
  theme(strip.text.y.right = element_text(angle = 0)) + 
  facet_grid(
    cols = vars(mature_forest_obl), rows = vars(site),
    labeller = as_labeller(c(fancy_labels,
                             "TRUE" = "Mature Forest Obligates (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates (Birds)"))
    )

gg_trend_summary_obs_v_pot_by_site_mat_for_obl

ggsave(gg_trend_summary_obs_v_pot_by_site_mat_for_obl,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_by_site_mat_for_obl", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 6.5, units = "in")
```

```{r obs-v-pot-combo}
# ------------------------------------------- #
# combine with a overall total bar on the side - this is the final version that goes into the manuscript
# ------------------------------------------- #
i <- "crop_abn_potential_iucn"

j <- 1
threat_statuses


  
gg_aoh_obs_v_pot_overall_tmp <-
  # lapply(c("crop_abn_iucn", "crop_abn_potential_iucn"), function(i) {
  aoh_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # redlistCategory != "Data Deficient",
         !(vert_class == "bird" & mature_forest_obl > 0.5),
         str_detect(aoh_type, "crop")# == i
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
    mutate(overall = "Overall") %>%
  ggplot(mapping = aes(
         x = aoh_type,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(
    x = NULL, y = NULL
    ) +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  scale_x_discrete(
    # labels = NULL
    labels = c("crop_abn_potential_iucn" = "Pot.",
               "crop_abn_iucn" = "Obs.")
    ) +
  theme(legend.position = "none", axis.ticks.x = element_blank(),
        plot.background = element_blank()) +
      # theme(strip.text.y.right = element_blank()) +
    facet_grid(
      # cols = vars(aoh_type),
      cols = vars(overall),
               rows = vars(vert_class), 
               scales = "free",
               labeller = as_labeller(c("mam" = "Mammals",
               "bird" = "Birds",
               "crop_abn_potential_iucn" = "Pot.",
               "crop_abn_iucn" = "Obs.",
               "Overall" = "Overall"
               ))
               )
# })

# names(gg_aoh_obs_v_pot_overall_tmp) <- c("crop_abn_iucn", "crop_abn_potential_iucn")


gg_aoh_by_obs_v_pot_lumped_by_site_bars_tmp <-
  aoh_trends %>%
        filter(passage_type == "exclude_passage",
               vert_class != "amp", 
               aoh_type %in% c("crop_abn_iucn", "crop_abn_potential_iucn"),
               !(vert_class == "bird" & mature_forest_obl > 0.5)
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site, trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
      filter(!is.na(trend)) %>%
        ggplot(mapping = aes(
         x = n_sp, y = fct_relevel(site, rev), # alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)])),
         )) +
  geom_col(
    position = position_dodge(preserve = "single"#, width = 0.8, padding = 0.2
                               ),
    color = "black", size = .25
    ) +
  theme_classic() + 
    scale_y_discrete(labels = fancy_labels
                       # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                                   ) + 
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels,#[c(1, 6, 3)],
                    values = palette_du_jour#[c(1, 6, 3)]
                    ) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
        panel.grid.major.x = element_line()
        ) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    rows = vars(vert_class), cols = vars(aoh_type),
    # scales = "free", 
    labeller = as_labeller(c("crop_abn_potential_iucn" = "Potential",
                                              "crop_abn_iucn" = "Observed"))
    )

ggsave(
  plot_grid(
    plot_grid(
  gg_aoh_by_obs_v_pot_lumped_by_site_bars_tmp + theme(strip.text.y.right = element_blank(),
                                                 legend.position = "none") + labs(caption = NULL), 
  gg_aoh_obs_v_pot_overall_tmp,
  # plot_grid(
  # gg_aoh_obs_v_pot_overall_tmp[[1]] + theme(strip.text.y.right = element_blank()),  
  # gg_aoh_obs_v_pot_overall_tmp[[2]] + labs(y = NULL),
  
           # ncol = 2#,
            # rel_widths = c(1, 0.9)
            # ),
  nrow = 1, 
  align = "h", axis= "b",
  ncol = 2, rel_widths = c(3, 0.9)
  # ncol = 3, rel_widths = c(3, 0.65, 0.80)
  ),
  ggpubr::get_legend(gg_aoh_trend_by_vert_aoh_type + 
                       guides(fill = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom")),
  nrow = 2, ncol = 1, rel_heights = c(1, 0.07)),
  filename = paste0(p_output, "plots/aoh/",
                    "aoh_obs_v_pot_by_site_combo",
                    aoh_run_date, ".pdf"),
  width = 6, height = 7.5, units = "in")

```


```{r diff-area-2017}
# How does the magnitude of area of habitat gained increase between observed and potential abandonment?

# Comparing the last year of area for each species between crop_abn_iucn and crop_abn_potential_iucn

aoh_p_change_obs_v_pot <-
  aoh %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp",
         str_detect(aoh_type, "crop"),
         !(vert_class == "bird" & mature_forest_obl > 0.5)
         ) %>%
  select(-start_year) %>%
  left_join(aoh_start_years) %>% 
  select(aoh_type:year, end_year, everything()) %>%
  filter(year == end_year) %>%
  left_join(aoh_trends %>% select(aoh_type, vert_class, site, binomial, trend, passage_type)) %>%
  mutate(aoh_type = case_when(
    aoh_type == "crop_abn_iucn" ~ "observed",
    aoh_type == "crop_abn_potential_iucn" ~ "potential"
  )) %>%
  pivot_wider(id_cols = c(
    # aoh_type,
                          vert_class, site, binomial,
                          # year, 
                          passage_type, redlistCategory, 
                          mature_forest_obl), 
              names_from = "aoh_type", values_from = c(aoh, trend)) %>%
  # filter(is.na(aoh_potential))
  mutate(pdiff = 100*(aoh_potential - aoh_observed)/aoh_observed) %>%
  select(vert_class, site, binomial, #year, 
          contains("aoh"), pdiff, contains("trend"), everything()) %>%
  
  # add categories based on trend differences
  mutate(trend_change = case_when(
    trend_observed == "gain" & trend_potential == "gain" ~ "same (gain)",
    trend_observed == "loss" & trend_potential == "loss" ~ "same (loss)",
    trend_observed == "gain" & trend_potential == "loss" ~ "gain to loss",
    trend_observed == "loss" & trend_potential == "gain" ~ "loss to gain",
    trend_observed == "loss" & trend_potential == "no trend" ~ "loss to no trend",
    trend_observed == "gain" & trend_potential == "no trend" ~ "gain to no trend",
    # trend_observed == "no trend" & trend_potential == "no trend" ~ "no change (no trend)",
    trend_observed == "no trend" & trend_potential == "no trend" ~ "same (no trend)",
    trend_observed == "no trend" & trend_potential == "loss" ~ "no trend to loss",
    trend_observed == "no trend" & trend_potential == "gain" ~ "no trend to gain"
  ) %>% fct_relevel(),
  change_direction = case_when(
    grepl("^same", trend_change) ~ "No change",
    grepl("to loss$", trend_change) ~ "Worsen",
    grepl("to gain$", trend_change) ~ "Improve",
    grepl("no trend$", trend_change) ~ "Indeterminate"
  ) %>% fct_relevel("Improve", "No change", "Indeterminate", "Worsen")) 

write_csv(aoh_p_change_obs_v_pot, paste0(p_derived, "aoh_p_change_obs_v_pot.csv"))

aoh_p_change_obs_v_pot_summary <- 
  aoh_p_change_obs_v_pot %>%
  # select(vert_class:binomial, contains("trend"), contains("change")) %>%
  group_by(vert_class, site,
           # trend_observed, trend_potential,
           trend_change,
           change_direction
           ) %>%
  summarise(mean_p_change = mean(pdiff),
            n_sp_in_group = n()) %>%
  arrange(vert_class, change_direction, trend_change)


write_csv(aoh_p_change_obs_v_pot_summary, 
          paste0(p_derived, "aoh_p_change_obs_v_pot_summary.csv"))


aoh_p_change_obs_v_pot_summary %>% print(n = 50)
  
gg_aoh_p_change_obs_v_pot <-
  lapply(c("mam", "bird"), function(vert_class_) {
  aoh_p_change_obs_v_pot_summary %>%
  filter(vert_class == vert_class_) %>%
  ggplot(mapping = aes(x = trend_change, 
                       fill = change_direction,
                       y = mean_p_change,
                       label = n_sp_in_group)) + 
  geom_col() + 
  geom_text(vjust = "inward") +
  # geom_label() +
  labs(x = "Trend Change from Observed to Potential", 
       y = "Mean Percent Change in AOH in last year",
       caption = ifelse(vert_class_ == "mam", "Mammals", "Birds"),
       fill = "Trend Change\nDirection") +
  scale_fill_manual(#labels = palette_labels, 
                    values = met.brewer("Kandinsky", 4)[c(1, 3, 4, 2)]) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        legend.position = c(0.88, 0.12)) +
  facet_wrap(vars(site), scales = "free", labeller = as_labeller(fancy_labels))
})

names(gg_aoh_p_change_obs_v_pot) <- c("mam", "bird")
gg_aoh_p_change_obs_v_pot$bird
gg_aoh_p_change_obs_v_pot$mam

lapply(1:2, function(i) {
  ggsave(gg_aoh_p_change_obs_v_pot[[i]],
       filename = paste0(p_output, "plots/aoh/", "aoh_p_change_obs_v_pot_",
                         names(gg_aoh_p_change_obs_v_pot)[i], aoh_run_date, ".pdf"),
       width = 8, height = 7.5, units = "in")
})









aoh %>% 
  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
         aoh_type == "crop_abn_potential_iucn", passage_type == "exclude_passage") %>%
  print(n = 30)

aoh_start_years %>%
  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
               aoh_type == "crop_abn_potential_iucn")

dff %>%  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
                str_detect(aoh_type, "crop_abn"), passage_type == "exclude_passage")

# Some species have different final years. 
# two options for dealing with this:
# 1) Set NA AOH values to 0, or 2) drop year from id_cols


```



## Old Plots
```{r plot-filter-options-df}

plot_filter_options_df <- tibble(
  run = 1:4,
  passage_opt = c("include_passage", "include_passage", 
                  "exclude_passage", "exclude_passage"),
  mature_opt = c("include_mature_forest_obl", "exclude_mature_forest_obl", 
                  "include_mature_forest_obl", "exclude_mature_forest_obl")
)

# defaults:
passage_opt <- "exclude_passage"
mature_opt <- "exclude_mature_forest_obl"

```


```{r hist-percent-changes}
# --------------------------------------------------------- #
# ---------- plot histogram of percent changes ----------- #
# --------------------------------------------------------- #

aoh_change_df

# i <- 4
# j <- "max_abn_iucn"
for (i in 1:4) {
  
  passage_opt <- filter(plot_filter_options_df, run == i)$passage_opt
  mature_opt <- filter(plot_filter_options_df, run == i)$mature_opt

for (j in aoh_types) {
gg_aoh_percent_change_hist_tmp <-
  aoh_change_df %>%
  filter(
    passage_type == passage_opt,
    aoh_type == j,
    vert_class != "amp",
    rel_change < 4 & 
      rel_change > -4
    ) %>%
  {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  ggplot(mapping = aes(x = rel_change * 100, fill = vert_class)) + 
  geom_histogram(bins = 30
                 ) +
  geom_vline(xintercept = 0, linetype = 2, col = "gray70") +
  theme_classic() +
  labs(x = "Percent change in AOH, 1987 to 2017 (%)", y = "Number of species",
       subtitle = filter(aoh_type_df, label == j)$desc,
       caption = paste0(
         if(passage_opt == "exclude_passage") {
                           paste0("", "excluding passage areas")} else {""},
         if(mature_opt == "exclude_mature_forest_obl") {
           paste0(" | ", "excluding mature forest obligates")} else {""}
                         )
       ) +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  facet_wrap(vars(redlistCategory), scales = "free")

ggsave(gg_aoh_percent_change_hist_tmp,
       filename = paste0(p_plots, "aoh/hist/", "aoh_percent_change_hist", 
                         aoh_run_date, "_", j, 
                         "_", mature_opt,
                         "_", passage_opt,
                         ".pdf"),
       width = 8, height = 5, units = "in")
}
}


```


```{r trend_by_category-increase-decrease}
# --------------------------------------------------------- #

aoh_change_df

# create df of just the increase/decrease trend
aoh_lm %>% 
  left_join(aoh %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(
    passage_type == "exclude_passage",
    term == "year",
    #p.value < 0.05,
    is.na(vert_class)
    # estimate != 0
    )

as.numeric(run_indices$mature_forest_obl) %>% unique()

aoh_lm %>% 
  left_join(run_indices) %>%
  mutate(mature_forest_obl_lgl = mature_forest_obl > 0.5) 

# aoh_trend_counts_by_category

trend_by_category <-
  aoh_lm %>% 
  left_join(run_indices) %>%
  mutate(mature_forest_obl_lgl = mature_forest_obl > 0.5) %>%
  filter(term == "year0",
         p.value < 0.05, # Extract significant slope estimate
         # estimate != 0
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  mutate(trend = if_else(estimate > 0, "gain", "loss"),
         ci_overlap = case_when(
           sign(conf.low) + sign(conf.high) == -2 ~ "loss",
           sign(conf.low) + sign(conf.high) == 2 ~ "gain",
           sign(conf.low) + sign(conf.high) < 2 & 
             sign(conf.low) + sign(conf.high) > -2 ~ "no trend")
         ) %>% 
    
  # if the slope estimate is greater than 0, it's a gain
  group_by(aoh_type, vert_class, 
           # site, 
           redlistCategory,
           passage_type,
           mature_forest_obl_lgl, 
           trend) %>%
  summarise(trend_count = n())


trend_by_category %>% ungroup() %>% 
  group_by(aoh_type, vert_class, redlistCategory, include_passage, trend) %>% summarise(trend_count = n())

trend_by_category %>% arrange(redlistCategory, vert_class) %>% print(n = 31)

trend_by_site <- aoh_trends_combo %>% 
  left_join(run_indices) %>%
  mutate(mature_forest_obl_lgl = mature_forest_obl > 0.5) %>%
  filter(term == "year0",
         p.value < 0.05,
         # mature_forest_obl < 0.5
         # estimate != 0
         ) %>%
  mutate(trend = ifelse(estimate > 0, "gain", "loss")) %>%
  group_by(aoh_type, vert_class, 
           site, 
           # redlistCategory,
           include_passage, mature_forest_obl_lgl, trend) %>%
  summarise(trend_count = n())


# --------------------------------------------------------- #
# ----------------------------------- #
# plot the trend per species
# ----------------------------------- #
# --------------------------------------------------------- #
# see next chunk


# extras

# species with zero estimates
zero_index <- aoh_lm %>% 
  filter(estimate == 0) %>%
  .$run_index %>% unique() %>% sort()

aoh_lm %>% filter(run_index %in% zero_index)

aoh_distill %>% filter(is.na(vert_class))

# na species:
na_vert <- aoh_df %>% 
  # left_join(select(species_list, binomial, vert_class), by = "binomial") %>% 
  filter(is.na(vert_class)) %>%
  select(site, binomial) %>% unique()

species_list %>% filter(binomial %in% na_vert$binomial)


aoh_lm %>% 
  left_join(unique(select(aoh_distill, site, binomial, redlistCategory, run_index, vert_class)), 
            by = "run_index") %>%
    filter(estimate == 0)

species_list %>% filter(binomial == "Anthus pratensis")

select(aoh_distill, site, binomial, redlistCategory, run_index, vert_class) %>% 
    filter(is.na(vert_class))


# ----------------
# diagnostic plots
i

par(mfrow = c(2,2))
aoh_distill %>% 
    filter(run_index == i) %>%
    lm(adj_IUCN_aoh_ha ~ year, 
       data = .) %>% 
  plot(., c(1,2))

#
```

```{r trend-plots}

# --------------------------------------------------------- #
# ----------------------------------- #
# plot the trend per species
# ----------------------------------- #
# --------------------------------------------------------- #
plot_filter_options_df

# i <- 2
i
for(i in 1:4) {
  passage_opt <- filter(plot_filter_options_df, run == i)$passage_opt
  # include_passage_areas <- filter(plot_filter_options_df, run == i)$include_passage_areas
  mature_opt <- filter(plot_filter_options_df, run == i)$mature_opt


# include_passage_areas <- "yes"
# exclude_mature_forest_obl <- "yes"

for (j in aoh_types) {
  
# gg_aoh_trend_by_cat_tmp <-
  # trend_by_category %>%
  # aoh_trends_combo %>% 
  aoh_trends %>%
  left_join(run_indices) %>%
  filter(term == "year0",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%
  mutate(trend = if_else(estimate > 0, "gain", "loss") %>% as_factor()) %>%
  group_by(aoh_type, vert_class, 
           # site, 
           redlistCategory,
           passage_type, trend) %>%
  summarise(trend_count = n()) %>%
  
  filter(aoh_type == j,
         passage_type == passage_opt
         ) %>%

  mutate(y = ifelse(trend == "gain", trend_count, -trend_count)) %>% 
  
  ggplot(data = .,
       mapping = aes(x = redlistCategory, 
                     y = trend_count,
                     # y = y
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = "Red List Category", 
       y = "Number of Species",
       fill = "Vert. Group",
       subtitle = filter(aoh_type_df, label == j)$desc,
       caption = paste0(
         if(passage_opt == "exclude_passage") {
                           paste0("", "excluding passage areas")} else {""},
         if(mature_opt == "exclude_mature_forest_obl") {
           paste0(" | ", "excluding mature forest obligates")} else {""}
                         )
       ) +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(redlistCategory), scales = "free")

# gg_aoh_trend_by_cat_tmp

ggsave(gg_aoh_trend_by_cat_tmp,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_by_iucn_cat", aoh_run_date, "_", j,
                         "_", mature_opt,
                         "_", passage_opt,
                         ".pdf"),
       width = 6, height = 5, units = "in")
}



for (j in aoh_types) {
# trend by site:
gg_aoh_trend_by_site <-
  # trend_by_site %>%
  aoh_trends_combo %>% 
  left_join(run_indices) %>%
  filter(term == "year0",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%
  mutate(trend = if_else(estimate > 0, "gain", "loss") %>% as_factor()) %>%
  group_by(aoh_type, vert_class, 
           site,
           # redlistCategory,
           include_passage, trend) %>%
  summarise(trend_count = n()) %>%
  
  filter(aoh_type == j,
         include_passage == include_passage_areas
         ) %>%

  mutate(y = ifelse(trend == "gain", trend_count, -trend_count)) %>% 

  ggplot( 
       mapping = aes(x = site, 
                     y = trend_count,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = NULL, y = "Number of Species",
       fill = "Vert. Group",
       subtitle = filter(aoh_type_df, label == j)$desc,
       caption = paste0(
         if(passage_opt == "exclude_passage") {
                           paste0("", "excluding passage areas")} else {""},
         if(mature_opt == "exclude_mature_forest_obl") {
           paste0(" | ", "excluding mature forest obligates")} else {""}
                         )
       ) +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(site), scales = "free")

# gg_aoh_trend_by_site

ggsave(gg_aoh_trend_by_site,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_by_site", aoh_run_date, "_", j,
                         "_", mature_opt,
                         "_", passage_opt,
                         ".pdf"),
       width = 7.5, height = 5, units = "in")
}

}
```

```{r result-by-species}
# pivot wide to have a df with a single row for each species, with trend in each scenario.



```


```{r basic-results-numbers}
trend_by_category %>%
  mutate(y = ifelse(trend == "gain", trend_count, -trend_count)) %>%
  filter(vert_class != "amp") %>%
  group_by(trend, redlistCategory) %>%
  summarise(totals = sum(y)) %>%
  arrange(redlistCategory) %>%
  mutate(threatened = ifelse(redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable"), TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(threatened, trend) %>%
  summarise(totals = sum(totals))

60/50


trend_by_site %>%
  filter(vert_class != "amp") %>%
  group_by(vert_class, trend) %>%
  summarise(totals = sum(trend_count))


trend_by_site %>%
  filter(vert_class != "amp") %>%
  group_by(trend) %>%
  summarise(totals = sum(trend_count))
1321/ 854
```


## Basics

```{r number-sp-per-site}

aoh_species_list_by_site <-
  aoh_l %>% 
  # filter(passage_type == "exclude_passage") %>%
  select(#aoh_type,
    vert_class, site, binomial, 
    redlistCategory, mature_forest_obl,
    total_range_area, range_size_quantile, common_names) %>%
  unique()


n_sp_df <-
  aoh_species_list_by_site %>%
  filter(vert_class !="amp") %>%
  group_by(vert_class, site) %>%
  summarise(n_sp = n()) %>% ungroup() 

n_sp_df <- n_sp_df %>%
  left_join(n_sp_df %>% group_by(site) %>% summarise(n_sp_total = sum(n_sp)))


# --------------------------------------------------- #
# threatened:
# --------------------------------------------------- #
sp_threat_palette <- palette_du_jour[c(1,6)]
names(sp_threat_palette) <- c("bird", "mam")

gg_n_sp_by_cat <-
  aoh_species_list_by_site %>%
  filter(vert_class !="amp") %>% 
  mutate(threatened = case_when(
    redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
    redlistCategory %in% c("Near Threatened", "Least Concern") ~ "Not Threatened",
    redlistCategory == "Data Deficient" ~ "Data Deficient"
  )
    ) %>%
  group_by(vert_class, site, threatened) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
    left_join(select(n_sp_df, vert_class, site, n_sp_total),
              by = c("vert_class", "site")) %>% #print(n = 100)
    filter(threatened != "Data Deficient") %>%
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)),
             # fill = threatened, alpha = vert_class,
             alpha = threatened,
             fill = vert_class,
             group = vert_class
             )) +
  geom_col(
    position = position_dodge(width = 0.7, preserve = "total"),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(
    labels = c("bird" = "Birds", "mam" = "Mammals"),
    values = sp_threat_palette,
    ) +
    scale_alpha_manual(values = c(0.5, 1)) +
  labs(x = "Number of Species with AOH", y = NULL,
       alpha = "IUCN Status",
       fill = "Vert. Class") +
  guides(fill = guide_legend(nrow = 2), alpha = guide_legend(reverse = TRUE)) +
  theme(legend.position = c(0.78, 0.75))

ggsave(plot = gg_n_sp_by_cat,
       filename = paste0(p_plots, "richness_by_site_w_category.pdf"),
       width = 4, height = 4, units = "in")



# --------------------------------------------------- #
# faceted
# --------------------------------------------------- #
gg_n_sp_by_cat_facet <- aoh_species_list_by_site %>%
  filter(vert_class !="amp") %>%
  mutate(threatened = case_when(
    redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
    TRUE ~ "Not Threatened")) %>%
  group_by(vert_class, site, threatened) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp)),
             fill = vert_class, group = vert_class)) +
  geom_col(
    position = position_dodge(width = 0.7, preserve = "total"),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(labels = c("mam" = "Mammals", "bird" = "Birds"),
  values = c("black", "gray80")) +
  # scale_fill_manual(
    # labels = c("bird" = "Birds", "mam" = "Mammals"),
    # values = sp_threat_palette
    # ) +
  labs(x = "Number of Species with AOH", y = NULL,
       fill = "Vert. Class") +
  theme(legend.position = "bottom") +
  facet_wrap(vars(threatened), scales = "free_x")

ggsave(plot = gg_n_sp_by_cat_facet,
       filename = paste0(p_plots, "richness_by_site_w_category_facet.pdf"),
       width = 4.5, height = 4.5, units = "in")


  

# --------------------------------------------------- #
# Basic richness plot 
# --------------------------------------------------- #
gg_n_sp <-
  n_sp_df %>% 
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)), 
             fill = vert_class)) +
  geom_col(position = position_dodge(width = 0.7, preserve = "single"),
           width = 0.5,
           color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(labels = c("mam" = "Mammals", "bird" = "Birds"), 
                      values = c("black", "gray80")) + 
  labs(x = "Number of Species with AOH", y = NULL, fill = "Vert. Class") + 
  theme(legend.position = c(0.8, 0.87))

ggsave(plot = gg_n_sp,
       filename = paste0(p_plots, "richness_by_site.pdf"),
       width = 4, height = 4, units = "in")

# --------------------------------------------------- #
# --------------------------------------------------- #








# Composite figure:
world <- ne_countries(scale = "small", returnclass = "sf") #%>% st_make_valid() # can set returnclass to sf or sp.
sf_width <- 0.25
sf_width2 <- 0.1

gg_simple_globe <- 
  ggplot() + 
  # theme_classic() +
  theme_minimal() +
  geom_sf(data = world %>% filter(continent != "Antarctica"), 
          fill = NA, color = "gray50", size = sf_width) +
  geom_sf(data = site_sf, mapping = aes(fill = desc), size = sf_width2) + 
  labs(#subtitle = "Map projection: longlat", 
       x = NULL, y = NULL) +
  theme(legend.position = "none") + 
  geom_label_repel(data = site_sf,
                   aes(label = label, geometry = geometry),
                   stat = "sf_coordinates",
                   min.segment.length = 0.0, segment.alpha = 1,
                   point.padding = 0.2, box.padding = 0.2,
                   label.size = 0.3, color = "black") + 
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", "eqearth")))


ggsave(plot = gg_simple_globe,
       filename = paste0(p_plots, "fig0_new.pdf"),
       width = 5, height = 2.5, units = "in")

i
# construct individual ggplots for each site
for (i in 1:11) {
  assign(
  x = paste0("gg_sp", site_df$label[i]),
  value = 
    n_sp_df %>% 
    filter(site == site_df$site[i]) %>%
    ggplot(aes(x = vert_class, y = n_sp,          
               fill = vert_class, col = vert_class)) +
    geom_col(show.legend = FALSE) + 
    guides(col = "none") +
    theme_classic() +  
    scale_x_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) + 
    ylim(0, max(n_sp_df$n_sp)) + 
    labs(x = NULL, y = "Number of Species", title = site_sf$lab_desc[i])
  )
}
gg_sp_bh

gg_site_locations <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", "natearth2"))) +
  theme(legend.position = "none",
        plot.margin = margin(0, 0, 2, 0, "mm"))

# for testing:
# pan_top <- plot_grid(tp11, tp1, tp10, tp8, nrow = 1)
# pan_l <- plot_grid(tp7, tp6, ncol = 1)
# pan_r <- plot_grid(tp9, tp3, ncol = 1)
# pan_bottom <- plot_grid(tp4, tp2, tp5, nrow = 1, ncol = 3)

# with full rasters, gray background
pan_top <- plot_grid(gg_sp_w, gg_sp_b, gg_sp_v, gg_sp_o, nrow = 1)
pan_l <- plot_grid(gg_sp_n, gg_sp_mg, ncol = 1)
pan_r <- plot_grid(gg_sp_s, gg_sp_c, ncol = 1)
pan_bottom <- plot_grid(gg_sp_g, gg_sp_bh, gg_sp_i, nrow = 1, ncol = 3)

pan_middle <- plot_grid(pan_l, gg_simple_globe, pan_r, 
                        rel_widths = c(1, 6, 1),
          nrow = 1, ncol = 4)

# save composite figure with map
ggsave(plot = plot_grid(NULL, pan_top, pan_middle, pan_bottom, 
                        ncol = 1, nrow = 4,
                        rel_heights = c(0.05, 1, 4, 1)),
       filename = paste0(p_plots, "site_map_w_richness.pdf"),
       width = 14, height = 10, units = "in", dpi = 400
       )


install.packages("patchwork")
library(patchwork)

gg_simple_globe + 
  inset_element(gg_sp_b, left = 0.8, bottom = 0.5, right = 1, top = 1)


gg_simple_globe + gg_sp_b
```


# Extras & oldies

# Old

## Results First pass - December 2021

```{r cluster-results-full-lc}
aoh_lc_df <- lapply(
  list.files(paste0(p_derived, "aoh/old"), full.names = T) %>% 
    grep(paste0("aoh_tmp_2021_12_1[23]"), ., value = T),
  read_csv) %>% 
  bind_rows() %>% 
  left_join(iucn_status, by = "binomial") %>%
  left_join(species_list, by = c("site", "binomial"))



# -------------- join IUCN status, common names ------------- #
iucn_status
# or 
habitat_details

# aoh_lc_df <- aoh_lc_df %>% 
#   left_join(iucn_status, by = "binomial")


missing_sp_31 <- lapply(1:11, function(i){
  sp_run <- aoh_df %>% 
    filter(site == site_df$site[i]) %>%
  select(site:year, adj_IUCN_aoh_ha) %>% unique() %>%
  select(site, binomial) %>% unique()
  
  sp_not_run <- species_list %>% filter(site == site_df$site[i]) %>%
    filter(!binomial %in% sp_run$binomial)
  sp_not_run
}) %>% bind_rows()


# number of species at each site:
species_list %>% 
  group_by(site, 
           vert_class
           ) %>% 
  summarise(num_sp = n())

# number of unique species
species_list %>% 
  group_by(#site, 
           vert_class
           ) %>% 
  summarise(num_sp = n(),
            sp = length(unique(binomial)))
```

```{r load-abn-lc-results}
aoh_abn <- lapply(1:18, function(i) {
  read_csv(paste0(p_derived, "aoh/old/aoh_abn_lc_tmp", "_2021_12_13", "_c", i, ".csv"))
  }
  ) %>% 
  bind_rows() %>% 
  left_join(iucn_status, by = "binomial") %>%
  left_join(species_list, by = c("site", "binomial"))

aoh_max_abn <- lapply(1:18, function(i) {
  read_csv(paste0(p_derived, "aoh/old/aoh_max_abn_lc_tmp", "_2021_12_13", "_c", i, ".csv"))
  }
  ) %>% 
  bind_rows() %>% 
  left_join(iucn_status, by = "binomial") %>%
  left_join(select(species_list, -synonym), by = c("site", "binomial"))


aoh_combo <- bind_rows(aoh_abn %>% mutate(type = "abn"), 
                       aoh_max_abn %>% mutate(type = "max_abn"),
                       aoh_lc_df %>% mutate(type = "lc"))

aoh_combo
```


```{r aoh-l-remove-passage}
# Calculate the AOH under different constraints:

# Restricting by:
# 1. seasonality, so that only 1, 2, 3 are considered (Codes are: "Resident" (1), "Breeding" (2), "Non-breeding Season" (3), Passage (4), and Seasonal Occurrence Uncertain (5).)
species_ranges$seasonal %>% unique()

aoh_l %>%
  filter(season %in% c(1, 2, 3)) %>% # filtering out passage areas:
  group_by(aoh_type, vert_class, site, binomial, year) %>% 
  summarise(aoh_no_passage = sum(area, na.rm = TRUE))
                
# calculate:
aoh_l <- aoh_l %>%
  left_join(
    aoh_l %>% 
      filter(season %in% c(1, 2, 3)) %>% # filtering out passage areas:
      group_by(aoh_type, vert_class, site, binomial, year) %>% 
      summarise(aoh_no_passage = sum(area, na.rm = TRUE)) # make sure to sum area (which is either area_ha or adj_area_ha, depending on whether it is lc or IUCN)
  ) %>% 
  select(aoh_type:aoh, aoh_no_passage, everything()) %>%
  mutate(aoh_no_passage = case_when(
    season == 4 ~ NA_real_,
    TRUE ~ aoh_no_passage
  ))



aoh_l %>%
  select(aoh_type:aoh_no_passage) %>%
  mutate(test = aoh - aoh_no_passage
         # equal = all.equal(.$aoh, .$aoh_no_passage)
         ) %>%
  filter(test < -0.000001)
```


```{r remove-mature-forest-obl}
# 2. mature_forest_obl, so that only non-mature forest obligates are included.


aoh_l %>%
  filter(mature_forest_obl < 0.5)

aoh_l
  group_by(aoh_type, vert_class) %>%
  summarise(num_sp = n(),
            sp = length(unique(binomial))) %>%
  arrange(vert_class)

```

```{r remove-unimportant-habitats}
# TBD

# 3. only those map_codes (habitats) that are marked as majorImportance for the species.
names(aoh_l)

t1 <- aoh_l %>%   
  filter(!is.na(map_code)) %>%
  filter(str_detect(binomial, "Acanthis flammea"), year == 1987, site == "belarus") 

t1 %>% select(binomial, map_code)

# It's complicated. habitat_prefs actually includes majorImportance for each habitat type in non-breeding and breeding seasons. So, I'll need to figure out a way to match the importance to the season code.
habitat_prefs$season %>% unique()

t2 <- habitat_prefs %>%
  filter(!is.na(map_code), 
         # !is.na(majorImportance)
         ) %>%
  # select(binomial, map_code, majorImportance) %>% 
  filter(str_detect(binomial, "Acanthis flammea"))

t3 <- t1 %>% 
  filter(!is.na(map_code)) %>%
  left_join(
    t2 %>% 
      # filter(!is.na(majorImportance)) %>%
      select(binomial, map_code, majorImportance),
    by = c("binomial", "map_code"))

aoh_l_iucn <- aoh_l %>%
  filter(!is.na(map_code)) %>%
  left_join(
    habitat_prefs %>% 
      filter(!is.na(majorImportance)) %>%
      select(binomial, map_code, majorImportance),
    by = c("binomial", "map_code"))
  
aoh_l_iucn$majorImportance %>% unique()


# calculate:
# aoh_l_iucn <-
  aoh_l_iucn %>%
  left_join(
    aoh_l_iucn %>% 
      filter(majorImportance == "Yes") %>% # include only habitats of major importance:
      group_by(aoh_type, vert_class, site, binomial, year) %>% 
      summarise(aoh_majorImportance = sum(area, na.rm = TRUE)) # make sure to sum area (which is either area_ha or adj_area_ha, depending on whether it is lc or IUCN)
  ) %>% 
  select(aoh_type:aoh, aoh_majorImportance, everything()) %>%
  mutate(aoh_majorImportance = case_when(
    majorImportance == "Yes" ~ aoh_majorImportance
  ))

aoh_l_iucn %>% filter(!is.na(aoh_majorImportance)) %>%
  select(aoh, aoh_majorImportance)

aoh_l_iucn %>% filter(str_detect(binomial, "Acanthis flammea"), year == 1987, site == "belarus")
aoh_l %>% filter(str_detect(binomial, "Acanthis flammea"), year == 1987, site == "belarus") 

```
```{r aoh-l-distill}
names(aoh)
names(aoh_l)
# -------------- extract just species and yearly aoh ------------- #
# aoh_l version of aoh_distill:
aoh_distill <- 
  aoh_l %>%
  select(aoh_type, vert_class, site, binomial, redlistCategory, year, 
         aoh, aoh_no_passage, mature_forest_obl, common_names) %>% 
  unique() %>% 
  mutate(year0 = case_when(
    grepl("full|max", aoh_type) ~ year - 1986,
    grepl("^abn_|^potential", aoh_type) ~ year - 1991
  ))

run_indices %>%
  filter(mature_forest_obl != "NA")

aoh_l %>% select(aoh_type, vert_class, site, binomial) %>% unique() %>% nrow()
aoh_distill %>% select(aoh_type, vert_class, site, binomial) %>% unique() %>% nrow()

aoh_l %>% select(mature_forest_obl)




# create an index for running the linear models,
# one index for each unique species at each site, in each of the aoh runs, with and without passage areas.
run_indices <- 
  # aoh_distill %>%
  aoh %>% 
  arrange(aoh_type, vert_class, site, binomial) %>%
  select(aoh_type, vert_class, site, binomial, passage_type,
         common_names, redlistCategory, mature_forest_obl) %>%
  unique() %>% 
  mutate(run_index = 1:n())

# add this index back to the distilled df
aoh_distill <- aoh_distill %>%
  left_join(run_indices)


aoh_distill$run_index %>% unique() %>% sort() %>% tail
aoh_distill %>% select(site, binomial) %>% unique() %>% nrow


write_parquet(aoh_distill, paste0(p_derived, "aoh_distill.parquet"))
aoh_distill <- read_parquet(paste0(p_derived, "aoh_distill.parquet"))
```

### older

```{r prelim-abn-plots}
sp_to_plot <- "Agamia agami"
sp_to_plot <- "Certhia familiaris"

aoh_combo %>%
  filter(#type == "abn", 
         binomial == sp_to_plot) %>%
  ggplot(mapping = aes(x = year, y = adj_IUCN_aoh_ha, col = site)) +
  geom_line() + 
  labs(x = "Year", y = "AOH (ha)", caption = sp_to_plot) +
  facet_wrap(vars(type), scales = "free")


# -------------- extract just species and yearly aoh ------------- #

aoh_combo %>%
  filter(type == "abn") %>% 
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha) %>% 
  unique() %>% 
  # head(n = 10000) %>%
  filter(binomial == sp_to_plot) %>%
  mutate(binomial = as_factor(binomial)) %>%
  ggplot(mapping = aes(x = year, 
                       y = adj_IUCN_aoh_ha, 
                       group = site,
                       col = site
                       )) +
  geom_line() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = sp_to_plot)

aoh_combo %>% filter(type == "lc")


# ---------- calculate trend for all species ---------- #

run_indices_abn <- 
  aoh_combo %>% 
  filter(type == "abn") %>%
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha, vert_class) %>% 
  unique() %>% 
  mutate(year = year - 1991) %>%
  arrange(site, vert_class, binomial) %>%
  select(site, vert_class, binomial) %>% unique() %>% 
  mutate(run_index = 1:n())

dft_abn <- aoh_combo %>% filter(type == "abn") %>%
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha, vert_class) %>% 
  unique() %>% 
  mutate(year = year - 1991) %>%
  left_join(run_indices_abn, by = c("binomial", "site", "vert_class"))

dft_abn$run_index %>% unique() %>% sort() %>% tail
dft_abn %>% select(site, binomial) %>% unique() %>% nrow


# -------------------
# run simple regression on each species' and extract AOH trend over time.
# -------------------
aoh_abn_trends <- lapply(1:length(unique(dft_abn$run_index)), function(i) {
  dft_abn %>% 
    filter(run_index == i) %>%
    lm(adj_IUCN_aoh_ha ~ year, 
       data = .) %>%
    tidy() %>% 
    mutate(run_index = i)
}) %>% bind_rows()

# ------------------
# determine the relative trend (percent change in AOH start to end)
# ------------------

dft_abn %>% 
  filter(run_index == i) %>%
  ggplot(mapping = aes(x = year, y = adj_IUCN_aoh_ha)) +
  geom_point() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = unique(filter(dft_abn, run_index == i)$binomial))
  

# calculate percent changes
aoh_abn_change_df <- 
  aoh_abn_trends %>% #filter(run_index == i) %>%
  select(run_index, term, estimate) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope")) %>%
  pivot_wider(run_index, names_from = term, values_from = estimate) %>%
  mutate(aoh_start = slope*1 + intercept,
         aoh_end = slope*31 + intercept,
         rel_change = ((aoh_end/aoh_start) - 1))

hist(aoh_abn_change_df$rel_change)

aoh_abn_change_df %>%
  arrange(rel_change) %>%
  # filter(rel_change < 5 & rel_change > -1) %>%
  .$rel_change %>%
  hist(breaks = 100)

# --------------------------------------------------------- #
# ---------- plot histogram of percent changes ----------- #
# --------------------------------------------------------- #
gg_aoh_abn_percent_change_hist <-
  aoh_abn_change_df %>% 
  left_join(dft_abn %>% select(run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(!is.na(vert_class),
         # vert_class != "amp",
         rel_change < 2 & rel_change > -2) %>%
  ggplot(mapping = aes(x = rel_change * 100, fill = vert_class)) + 
  geom_histogram(bins = 30
                 ) +
  geom_vline(xintercept = 0, linetype = 2, col = "gray70") +
  theme_classic() +
  labs(x = "Percent change in AOH, 1987 to 2017 (%)", y = "Number of species") +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  facet_wrap(vars(redlistCategory), scales = "free")

gg_aoh_abn_percent_change_hist

ggsave(gg_aoh_abn_percent_change_hist,
       filename = paste0(p_output, "plots/aoh/", "aoh_abn_percent_change_hist", aoh_run_date, ".pdf"),
       width = 8, height = 5, units = "in")


dft_abn %>% filter(run_index == i) %>%
  lm(adj_IUCN_aoh_ha ~ year, data = .) %>%
  augment() %>%
  filter(year %in% c(1, 31))

# --------------------------------------------------------- #


# create df of just the increase/decrease trend
aoh_abn_trends %>% 
  left_join(dft_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         #p.value < 0.05,
         is.na(vert_class)
         # estimate != 0
         )


trend_df_abn <- aoh_abn_trends %>% 
  left_join(dft_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  mutate(trend = ifelse(estimate > 0, "gain", "loss")) %>%
  group_by(redlistCategory, trend, vert_class) %>%
  summarise(trend_count = n())

trend_df_abn %>% arrange(redlistCategory, vert_class) %>% print(n = 31)

trend_by_site_abn <- aoh_abn_trends %>% 
  left_join(dft_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  mutate(trend = ifelse(estimate > 0, "gain", "loss")) %>%
  group_by(site, trend, vert_class) %>%
  summarise(trend_count = n())


# --------------------------------------------------------- #
# ----------------------------------- #
# plot the trend per species
# ----------------------------------- #
# --------------------------------------------------------- #
gg_aoh_abn_trend_by_cat <-
  trend_df_abn %>%
  mutate(y = ifelse(trend == "gain", trend_count, -trend_count)) %>%
  # filter(vert_class) %>%
  
  ggplot(
       mapping = aes(x = redlistCategory, 
                     y = trend_count,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = "Red List Category", y = "Number of Species",
       fill = "Vert. Group") +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(redlistCategory), scales = "free")

gg_aoh_abn_trend_by_cat

ggsave(gg_aoh_abn_trend_by_cat,
       filename = paste0(p_output, "plots/aoh/", "aoh_abn_trend_by_iucn_cat", aoh_run_date, ".pdf"),
       width = 7, height = 5, units = "in")

# trend by site:
gg_aoh_abn_trend_by_site <-
  trend_by_site_abn %>%
  ggplot( 
       mapping = aes(x = site, 
                     y = trend_count,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = NULL, y = "Number of Species",
       fill = "Vert. Group") +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(site), scales = "free")

ggsave(gg_aoh_abn_trend_by_site,
       filename = paste0(p_output, "plots/aoh/", "aoh_abn_trend_by_site", aoh_run_date, ".pdf"),
       width = 8, height = 5, units = "in")

```

```{r prelim-max-abn-plots}
sp_to_plot <- "Agamia agami"
sp_to_plot <- "Certhia familiaris"

unique(aoh_combo$type)

aoh_combo %>%
  filter(#type == "abn", 
         binomial == sp_to_plot) %>%
  ggplot(mapping = aes(x = year, y = adj_IUCN_aoh_ha, col = site)) +
  geom_line() + 
  labs(x = "Year", y = "AOH (ha)", caption = sp_to_plot) +
  facet_wrap(vars(type), scales = "free")


# -------------- extract just species and yearly aoh ------------- #

aoh_combo %>%
  filter(type == "max_abn") %>% 
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha) %>% 
  unique() %>% 
  # head(n = 10000) %>%
  filter(binomial == sp_to_plot) %>%
  mutate(binomial = as_factor(binomial)) %>%
  ggplot(mapping = aes(x = year, 
                       y = adj_IUCN_aoh_ha, 
                       group = site,
                       col = site
                       )) +
  geom_line() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = sp_to_plot)

aoh_combo %>% filter(type == "lc")


# ---------- calculate trend for all species ---------- #

run_indices_max_abn <- 
  aoh_combo %>% 
  filter(type == "max_abn") %>%
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha, vert_class) %>% 
  unique() %>% 
  mutate(year = year - 1986) %>%
  arrange(site, vert_class, binomial) %>%
  select(site, vert_class, binomial) %>% unique() %>% 
  mutate(run_index = 1:n())

dft_max_abn <- aoh_combo %>% filter(type == "max_abn") %>%
  select(site, binomial, redlistCategory, year, adj_IUCN_aoh_ha, vert_class) %>% 
  unique() %>% 
  mutate(year = year - 1986) %>%
  left_join(run_indices_max_abn, by = c("binomial", "site", "vert_class"))

dft_max_abn$run_index %>% unique() %>% sort() %>% tail
dft_max_abn %>% select(site, binomial) %>% unique() %>% nrow


# -------------------
# run simple regression on each species' and extract AOH trend over time.
# -------------------
aoh_max_abn_trends <- lapply(1:length(unique(dft_max_abn$run_index)), function(i) {
  dft_max_abn %>% 
    filter(run_index == i) %>%
    lm(adj_IUCN_aoh_ha ~ year, 
       data = .) %>%
    tidy() %>% 
    mutate(run_index = i)
}) %>% bind_rows()

# ------------------
# determine the relative trend (percent change in AOH start to end)
# ------------------

dft_max_abn %>% 
  filter(run_index == i) %>%
  ggplot(mapping = aes(x = year, y = adj_IUCN_aoh_ha)) +
  geom_point() + 
  geom_smooth(method = "lm", se = 0.95) + 
  labs(x = "Year", y = "AOH (ha)", title = unique(filter(dft_max_abn, run_index == i)$binomial))
  

# calculate percent changes
aoh_max_abn_change_df <- 
  aoh_max_abn_trends %>% #filter(run_index == i) %>%
  select(run_index, term, estimate) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope")) %>%
  pivot_wider(run_index, names_from = term, values_from = estimate) %>%
  mutate(aoh_start = slope*1 + intercept,
         aoh_end = slope*31 + intercept,
         rel_change = ((aoh_end/aoh_start) - 1))

hist(aoh_max_abn_change_df$rel_change)

aoh_max_abn_change_df %>%
  arrange(rel_change) %>%
  # filter(rel_change < 5 & rel_change > -1) %>%
  .$rel_change %>%
  hist(breaks = 100)

# --------------------------------------------------------- #
# ---------- plot histogram of percent changes ----------- #
# --------------------------------------------------------- #
gg_aoh_max_abn_percent_change_hist <-
  aoh_max_abn_change_df %>% 
  left_join(dft_max_abn %>% select(run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(!is.na(vert_class),
         # vert_class != "amp",
         rel_change < 2 & rel_change > -2) %>%
  ggplot(mapping = aes(x = rel_change * 100, fill = vert_class)) + 
  geom_histogram(bins = 30
                 ) +
  geom_vline(xintercept = 0, linetype = 2, col = "gray70") +
  theme_classic() +
  labs(x = "Percent change in AOH, 1987 to 2017 (%)", y = "Number of species") +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  facet_wrap(vars(redlistCategory), scales = "free")

gg_aoh_max_abn_percent_change_hist

ggsave(gg_aoh_max_abn_percent_change_hist,
       filename = paste0(p_output, "plots/aoh/", "aoh_max_abn_percent_change_hist", aoh_run_date, ".pdf"),
       width = 8, height = 5, units = "in")


dft_max_abn %>% filter(run_index == i) %>%
  lm(adj_IUCN_aoh_ha ~ year, data = .) %>%
  augment() %>%
  filter(year %in% c(1, 31))

# --------------------------------------------------------- #


# create df of just the increase/decrease trend
aoh_max_abn_trends %>% 
  left_join(dft_max_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         #p.value < 0.05,
         is.na(vert_class)
         # estimate != 0
         )


trend_df_max_abn <- aoh_max_abn_trends %>% 
  left_join(dft_max_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  mutate(trend = ifelse(estimate > 0, "gain", "loss")) %>%
  group_by(redlistCategory, trend, vert_class) %>%
  summarise(trend_count = n())

trend_df_max_abn %>% arrange(redlistCategory, vert_class) %>% print(n = 31)

trend_by_site_max_abn <- aoh_max_abn_trends %>% 
  left_join(dft_max_abn %>% 
              select(site, run_index, binomial, redlistCategory, vert_class) %>%
              unique(), 
            by = "run_index") %>%
  filter(term == "year",
         p.value < 0.05,
         # estimate != 0
         ) %>%
  mutate(trend = ifelse(estimate > 0, "gain", "loss")) %>%
  group_by(site, trend, vert_class) %>%
  summarise(trend_count = n())


# --------------------------------------------------------- #
# ----------------------------------- #
# plot the trend per species
# ----------------------------------- #
# --------------------------------------------------------- #
gg_aoh_max_abn_trend_by_cat <-
  trend_df_max_abn %>%
  mutate(y = ifelse(trend == "gain", trend_count, -trend_count)) %>%
  # filter(vert_class) %>%
  
  ggplot(
       mapping = aes(x = redlistCategory, 
                     y = trend_count,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = "Red List Category", y = "Number of Species",
       fill = "Vert. Group") +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(redlistCategory), scales = "free")

gg_aoh_max_abn_trend_by_cat

ggsave(gg_aoh_max_abn_trend_by_cat,
       filename = paste0(p_output, "plots/aoh/", "aoh_max_abn_trend_by_iucn_cat", aoh_run_date, ".pdf"),
       width = 7, height = 5, units = "in")

# trend by site:
gg_aoh_max_abn_trend_by_site <-
  trend_by_site_max_abn %>%
  ggplot( 
       mapping = aes(x = site, 
                     y = trend_count,
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = NULL, y = "Number of Species",
       fill = "Vert. Group") +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend\n(p < 0.05)",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss"),
                     values = c("gain" = 1,
                                "loss" = 0.2)
                     ) + 
  facet_wrap(vars(site), scales = "free")

ggsave(gg_aoh_max_abn_trend_by_site,
       filename = paste0(p_output, "plots/aoh/", "aoh_max_abn_trend_by_site", aoh_run_date, ".pdf"),
       width = 8, height = 5, units = "in")

```

# End

```{r seff}
# extract run codes:
list.files("scripts/cluster/slurm_out") %>% 
  grep("aoh_hab*", ., value = TRUE) %>%
  str_extract(., "[0-9]{6,10}_[0-9]{1,2}") %>% #unique()
  paste0("seff ", .) %>%
  paste(., collapse = "; ") %>%
  cat()

1202/60 # 20 minutes for shaanxi


cat(
  paste("seff", paste0("39004952_", 1:27), collapse = "; "),
  "> text2.txt"
    )
# Use the above to make seff calls to get the full times and memory usage for the full array run
# then copy and paste this output into a 

paste("seff", paste0("39537809_", c(1, 7, 8, 10)), collapse = "; ")


txt <- read_csv("scripts/ref/seff_out_5_potential_age.csv")
txt <- read_csv("scripts/ref/seff_out_aoh.csv")
txt <- read_csv("scripts/ref/seff_out_run_1_2.2.csv")

txt %>% print(n = 15)


seff <- tibble(
  # core_index = 1:11,
  job_id = str_subset(txt$out, "^Job ID:"),
  array_id = str_subset(txt$out, "Array Job ID:"),
  time = str_subset(txt$out, "CPU Utilized"), 
  mem_used = str_subset(txt$out, "Memory Utilized"),
  mem_given = str_subset(txt$out, "Memory Efficiency"),
  state = str_subset(txt$out, "State: ")
  ) %>%
  mutate(
    job_id = str_extract(job_id, "[0-9]{6,10}") %>% as.numeric(),
    array_id = str_extract(array_id, "[0-9]{6,10}_[0-9]{1,2}"),
    id = str_extract(array_id, "[0-9]{6,10}_") %>% gsub("_", "", .) %>% as.numeric(),
    array = str_extract(array_id, "_[0-9]{1,2}") %>% gsub("_", "", .) %>% as.numeric(),
    time = str_extract(time, "[0-9][0-9]:[0-9][0-9]:[0-9][0-9]"),
    mem_used = str_extract(mem_used, "[0-9]{2,3}.[0-9][0-9]..."),# %>% as.numeric(),
    mem_used_p = str_extract(mem_given, "[0-9]{1,2}.[0-9][0-9]%"),
    mem_given = str_extract(mem_given, "[0-9]{2,3}.[0-9][0-9] GB") %>% 
      gsub(" GB", "", .) %>% as.numeric(),
    
    file =
      list.files("scripts/cluster/slurm_out") %>%
      grep("aoh_hab*", ., value = TRUE) %>%
      str_subset(array_id),
    label = str_replace(file,
                        paste0("_", array_id, ".txt"), "")
    ) %>%
  select(
    label,
    everything()
    )

seff %>% arrange(array) %>% print(n = 30)
seff %>% filter(grepl("COMPLETED", state)) %>% arrange(array) %>% print(n = 30)

seff %>% select(state) %>% unique()
seff %>% select(label) %>% unique()

seff %>%
  filter(label == "aoh_hab10",
         # !str_detect(state, "CANCELLED")
         ) %>%
  filter(!str_detect(state, "COMPLETED")) %>%
  arrange(array) %>% print(n = 30)

list.files("scripts/cluster/slurm_out") %>% 
      grep("aoh_hab*", ., value = TRUE)

species_list %>% 
  filter(core_index == 1) %>%
  tail( n = 30)

species_list %>% 
  filter(core_index == 1) %>%
  .$binomial %>% grep("Emberiza", .)

seff %>% 
  filter(job_id == "40322150_1")

seff %>% arrange(desc(time))

seff
seff %>%
  filter(grepl("fail", state, ignore.case = TRUE)) %>% arrange(array) %>% print(n = 30)

seff %>%
  select(id) %>% unique()

```

# Latest

```{r AOH-suitability-by-season}
# Do species have seasonal suitabilities?
habitat_prefs$binomial %>% unique() %>% length() # 2312
habitat_prefs %>%
  filter(binomial %in% unique(species_list$binomial), 
         !is.na(map_code), suitability == "Suitable") %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  # filter(!(vert_class == "bird" & is.na(season))) %>%
  group_by(season_code, vert_class) %>%
  summarise(n_sp = n()) %>%
  print(n = 30)

# ok, once I filter this to just suitable habitats, the unknown seasonality and na birds disappear
# 4 season == NA bird entries
# 20 seasonal unknown entries (17 mammals, 3 birds), totaling 6 species.
# unk_sp <-
  habitat_prefs %>%
  filter(binomial %in% unique(species_list$binomial), 
         !is.na(map_code), suitability == "Suitable") %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  left_join(habitat_age_req_coded %>% select(binomial, common_names)) %>%
  filter(
    #!(vert_class == "bird" & is.na(season)),
    is.na(season)
    # grepl("unknown", season, ignore.case = TRUE)
    ) %>%
  select(vert_class, binomial, common_names, name, map_code, season_code) #%>%
  # .$binomial %>% unique()

habitat_prefs %>% 
  filter(binomial %in% unk_sp, !is.na(map_code)) %>% 
  left_join(habitat_age_req_coded %>% select(binomial, common_names)) %>%

  select(binomial, common_names, name, map_code, season) %>%
  print(n = 100)

# what are their habitat descriptions?
habitat_age_req_coded %>% filter(binomial %in% unk_sp) %>%
  select(vert_class, binomial, common_names, habitat)
  

habitat_prefs %>%
  filter(binomial %in% unique(species_list$binomial), !is.na(map_code)) %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>% nrow()
  filter(!(vert_class == "bird" & is.na(season)))

habitat_prefs %>%
  filter(binomial %in% c("Recurvirostra americana", "Glaucidium brodiei"),
         !is.na(map_code))

species_ranges %>% st_drop_geometry() %>% as_tibble() %>%
  filter(binomial %in% c("Recurvirostra americana", "Glaucidium brodiei"))

species_ranges %>% filter(binomial == "Glaucidium brodiei") %>% select(seasonal) %>% plot()

jung_hab_type_area_df %>%
  filter(site == "nebraska") %>%
  arrange(habitat_type)

jung_hab_type_area_df %>%
  filter(site == "chongqing") %>%
  arrange(habitat_type)


species_list %>% nrow() # 4001 (old: 4038)
species_list$binomial %>% unique %>% length # 2187 # number of unique species (after filtering by habitat, elevation)


# number of species in each class at each site
species_list %>% 
  group_by(site, vert_class) %>% 
  summarise(num_sp = n()) 


# If they don't have suitabilities, should I drop them?



# Drop passage areas

species_ranges %>% 
  # st_drop_geometry() %>% 
  filter(binomial %in% unique(species_list$binomial),
         vert_class == "bird",
         binomial == "Catharus swainsoni", 
         site == site_df$site[11]) %>%
  # as_tibble() %>%
  select(
    # site, binomial,
         seasonal) %>%
  plot()


species_list %>% filter(str_detect(binomial, "Catharus swainsoni"))



# testing with the Swainson's Thrush
habitat_prefs %>% 
  filter(str_detect(binomial, "Catharus swainsoni")) %>%
  select(binomial, majorImportance:season, map_code, IUCNLevel) %>%
  arrange(season)



species_ranges$seasonal %>% unique() %>% sort()
habitat_prefs$season %>% unique() %>% sort()
habitat_prefs %>%
  filter(
    # season %in% c("Seasonal Occurrence Unknown","unknown")
    is.na(season), vert_class == "bird"
    )
  

habitat_prefs %>%
  select(binomial, majorImportance:season, map_code, IUCNLevel) %>%
  
  # update season_code:
  # --- Codes are: "Resident" (1), "Breeding" (2), "Non-breeding Season" (3), Passage (4), and Seasonal Occurrence Uncertain (5).
  mutate(season_code = case_when(
    grepl("resident", season, ignore.case = TRUE) ~ 1,
    season %in% c("breeding", "Breeding Season") ~ 2,
    season %in% c("non-breeding", "Non-Breeding Season") ~ 3,
    grepl("passage", season, ignore.case = TRUE) ~ 4,
    grepl("unknown", season, ignore.case = TRUE) ~ 5
    )) %>%
  # filter(season_code == 1) %>%
  select(season_code,season) %>% arrange(season_code) %>% unique()


habitat_prefs

habitat_prefs %>%
  left_join(unique(select(species_list, binomial, vert_class)), by = "binomial") %>%
  filter(vert_class == "bird") %>%
  select(season, suitability) %>% unique() %>% arrange(suitability)

habitat


species_ranges %>%
  filter(vert_class == "bird", binomial == sp_name2)
```


```{r inner-join-suitability-by-season}
aoh_l$aoh_type %>% unique()

tmp_aoh <- aoh_l %>% 
  filter(aoh_type == "max_abn_iucn", #binomial == sp_name, 
         # site == site_df$site[site_index],
         year %in% 2011:2015) %>% 
  select(binomial, year, map_code, season, area) #%>% print(n=200)

# filter to just the combinations of map_code and season_code that are suitable
habitat_combos <- z1 %>% select(binomial, season_code, map_code, IUCNLevel) %>% arrange(season_code, map_code)
habitat_prefs %>% # extract the habitat classifications for the species in question
  filter(suitability == "Suitable", !is.na(map_code)) %>%
  select(binomial, season_code, map_code, IUCNLevel)
  

tmp_aoh %>%
  rename(season_code = season) %>%
  inner_join(z1 %>% select(binomial, season_code, map_code, IUCNLevel))


# ok, now I need to figure out how to get the combo of NA seasons to not drop those AOH areas.

# here's a way to update the NA season_codes to 99
habitat_prefs %>% # extract the habitat classifications for the species in question
  filter(suitability == "Suitable", !is.na(map_code),
         binomial == "Acris crepitans") %>%
  select(binomial, season_code, map_code, IUCNLevel) %>%
  mutate(season_code = case_when(
    is.na(season_code) ~ 99,
    TRUE ~ season_code
  ))

# create a new column showing whether the species has NA season suitabilities
habitat_prefs %>% # extract the habitat classifications for the species in question
  filter(suitability == "Suitable", !is.na(map_code),
         binomial == "Acris crepitans") %>%
  select(binomial, season_code, map_code, IUCNLevel) %>%
  mutate(season_na = is.na(season_code))
```


```{r deal-w-multiple-season-NA}
tmp1 <- habitat_prefs %>% # extract the habitat classifications for the species in question
  filter(suitability == "Suitable", !is.na(map_code),
         binomial == "Acris crepitans")

tmp1 <- rbind(tmp1, tmp1[4,])
tmp1[5, "season_code"] <- 1

sp_w_na_suitabilities <- habitat_prefs %>%
  filter(is.na(season_code)) %>%
  # select(binomial, season_code) %>% unique() %>%
  .$binomial %>% unique()

sp_w_na_suitabilities_gt_1 <- habitat_prefs %>%
  filter(binomial %in% sp_w_na_suitabilities, suitability == "Suitable", !is.na(map_code)) %>%
  select(binomial, season_code) %>% unique() %>%
  group_by(binomial) %>% summarise(n_sp = n()) %>% arrange(desc(n_sp)) %>%
  filter(n_sp > 1) %>%
  left_join(habitat_age_req_coded %>% select(binomial, common_names, vert_class)) %>%
  .$binomial

sp_w_na_suitabilities_gt_1
# "Arctonyx albogularis" # hog badger, exclude NA season (grassland)
# "Canis latrans" # coyote - exclude NA season (urban areas - these are probably suitable, but not large enough to matter for abandonment context)
# "Glaucidium brodiei" # These were shrubland high altitude, but this should be updated to 1
# "Monodelphis americana" # Northern Three-striped Opossum, removed from species_list for lack of habitat in Goias.
# "Mustela sibirica" # Siberian weasel, NA seas is 109 forest, but this should be updated to 1
# "Myotis daubentonii" # Daubenton's Myotis (bat) - this just has two different seasons. No update necessary
habitat_prefs %>% 
  filter(binomial %in% sp_w_na_suitabilities_gt_1, suitability == "Suitable", !is.na(map_code)) %>%
  select(binomial, season_code, map_code, IUCNLevel) %>%
  arrange(binomial, season_code) %>%
  print(n = 40)

habitat_age_req_coded %>% filter(binomial == "Monodelphis americana") # not in the habitat_coded
species_ranges %>% filter(binomial == "Monodelphis americana") %>%
  select(seasonal) %>% plot()
habitat_prefs %>% filter(binomial == "Monodelphis americana")
species_list %>% filter(binomial == "Monodelphis americana") # not in the species list - removed for lack of habitat at Goias
jung_hab_type_area_df %>%
  filter(site == "goias") 
elevation_prefs %>% filter(binomial == "Monodelphis americana")

# five species have habitat preferences that include NA and other codes.


# for these species, I'll fix these codes so that they are changed if they should be included (Glaucidium brodiei (collared owlet) and Mustela sibirica (siberian weasel)) or left alone if they should be excluded with NA season codes.
```


```{r dev-inner-join}
# for these species, I'll fix these codes so that they are changed if they should be included (Glaucidium brodiei (collared owlet) and Mustela sibirica (siberian weasel)) or left alone if they should be excluded with NA season codes.

# Extract list of species with some habitat suitabilities with season marked as NA, and some with a code.
# In these contexts, the NA season should be filtered out.
# Note that some species have been directly updated in the creation of "habitat_prefs" [Glaucidium brodiei (collared owlet) and Mustela sibirica (siberian weasel)].
# For species with *only* NA season codes, I'll leave these in, and treat them as suitable in all seasons.

habitat_prefs %>%
  filter(binomial %in% unique(species_list$binomial), 
         !is.na(map_code), suitability == "Suitable") %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  # filter(!(vert_class == "bird" & is.na(season))) %>%
  group_by(season_code, vert_class) %>%
  summarise(n_sp = n()) %>%
  print(n = 30)

# ---------- #
# extract list of species with NA season suitabilities:
sp_w_na_suitabilities <- habitat_prefs %>%
  filter(is.na(season_code)) %>%
  # select(binomial, season_code) %>% unique() %>%
  .$binomial %>% unique()

# ---------- #
# Extract list of species with some habitat suitabilities with season marked as NA, and some with a code.
# i.e., with more than one habitat suitability season code, one of which is NA
# In these contexts, the NA season should be filtered out.

sp_w_na_suit_and_more <- habitat_prefs %>%
  filter(binomial %in% sp_w_na_suitabilities, suitability == "Suitable", !is.na(map_code)) %>%
  select(binomial, season_code) %>% unique() %>%
  group_by(binomial) %>% summarise(n_sp = n()) %>% arrange(desc(n_sp)) %>%
  filter(n_sp > 1) %>%
  left_join(habitat_age_req_coded %>% select(binomial, common_names, vert_class)) %>%
  .$binomial


# ------------------------------------ #
# now, filter the NA season habitats out for these species.
# exclude na seasons for just these species:

habitat_prefs %>%
  filter(
    !(binomial %in% sp_w_na_suit_and_more & is.na(season_code))) %>% # filter out NA season_codes for species with multiple season codes, one being NA

  filter(binomial %in% unique(species_list$binomial),
         !is.na(map_code), suitability == "Suitable"
         ) %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  # filter(!(vert_class == "bird" & is.na(season))) %>%
  group_by(season_code, vert_class) %>%
  summarise(n_sp = n()) %>%
  print(n = 30)

# above is the number of habitat entries (multiple per species) - below is the number of species with each season_code
habitat_prefs %>%
  filter(
    !(binomial %in% sp_w_na_suit_and_more & is.na(season_code))) %>% # filter out NA season_codes for species with multiple season codes, one being NA
  
  filter(binomial %in% unique(species_list$binomial),
         !is.na(map_code), suitability == "Suitable"
         ) %>%
  left_join(select(species_list, vert_class, binomial) %>% unique()) %>%
  select(binomial, vert_class, season_code) %>% unique() %>%
  # filter(!(vert_class == "bird" & is.na(season))) %>%
  group_by(season_code, vert_class) %>%
  summarise(n_sp = n()) %>%
  print(n = 30)

# ------------------------------------- #
# extract a list of species with NA season_codes, so that I can make sure to treat them separately.
sp_na_season <- 
  habitat_prefs %>%
  filter(
    !(binomial %in% sp_w_na_suit_and_more & is.na(season_code)), # filter out NA season_codes for species with multiple season codes, one being NA 
    binomial %in% unique(species_list$binomial),
    !is.na(map_code), suitability == "Suitable",
    
    # select those species with na season codes
    is.na(season_code)
    ) %>%
  .$binomial %>% unique()
# 607 species

# check that these species *only* have NA season codes
habitat_prefs %>% filter(binomial %in% sp_na_season) %>% select(season_code) %>% unique() # check



# ------------------------- #
# Default approach is to use a simple inner_join, then bind to it a filtered aoh file with just the above species (with NA season codes)

tmp_aoh %>% filter(binomial %in% sp_na_season) # to bind back to the inner_joined df

aoh_l$binomial %>% unique() %>% length() # 2181 species:
aoh_l %>% group_by(aoh_type) %>% summarise(n_sp = length(unique(binomial))) # there are different numbers of species due to variance in the habitats that show up in different parts of sites. 
# the lc runs have more, because they are not restricted to the habitats only in abandoned pixels. The proportional adjustment is based on the habitats that are present in any part of the site, not just the abn.

aoh_l %>% filter(aoh_type == "max_abn_lc") %>% 
  filter(!binomial %in% unique(filter(aoh_l, aoh_type == "max_abn_iucn")$binomial)) %>%
  select(aoh_type:binomial) %>% unique()
  #1939 species:

species_ranges %>%
  filter(binomial == "Acrocephalus scirpaceus", site == "belarus") %>%
  select(seasonal) %>% plot()



tmp_aoh$binomial %>% unique() %>% length() # 1933 species:
tmp_aoh_filter$binomial %>% unique() %>% length() # 1664 species:
aoh_l %>%
  filter(aoh_type == "max_abn_lc")

aoh_filter %>% 
  select(aoh_type) %>%
unique()

aoh_filter <- 
  aoh_l %>%
  # rename(season_code = season) %>% # must update so that season_code matches
  inner_join(
    habitat_prefs %>% # extract the habitat classifications for the species in question
      filter(suitability == "Suitable", !is.na(map_code)) %>%
      select(binomial, season_code, map_code) %>%
      mutate(season = season_code) # add a new column to 1) match season in aoh, and 2) to retain season_code
    ) #%>%
  bind_rows(aoh_l %>% 
              filter(binomial %in% sp_na_season) %>% # to bind back to the inner_joined df
              mutate(season_code = NA)
            )

tmp_aoh_filter$binomial %>% unique() %>% length()



# ******* 

# ok - next steps: 
# add this as a filtering step right after loading the aoh_l layers
# build from this aoh_filter df going forward
# only load in the specific aoh types I'm actually going to use (i.e., IUCN ones)
```


```{r unresolved-hab-during-passage}
# one option is to have habitats for breeding or non-breeding count as suitable during passage
# assuming that passage habitat requirements are the most permissive

# how does this apply to shorebirds?
habitat_age_req_coded %>% filter(water_obl > 0.5, grepl("wisc", site_presence))
habitat_prefs %>% filter(str_detect(binomial, "Actitis macularius"))

habitat_prefs %>% filter(season_code == 4) %>%
  left_join(habitat_age_req_coded %>% select(binomial, water_obl, common_names, site_presence)) %>%
  filter(water_obl > 0.5) %>%
  # select(binomial, common_names, site_presence) %>% unique()
  filter(binomial == "Xenus cinereus") %>%
  select(season_code, map_code, IUCNLevel) %>% arrange(season_code, map_code)

# Not sure.. might be more complicated, but at least it won't apply for now, since I'm excluding passage areas.
```




