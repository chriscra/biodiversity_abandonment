---
title: "Cropland abandonment benefits most birds and mammals but rarely compensates for habitat loss"
author: Christopher L. Crawford,$^a$$^*$, R. Alex Wiebe,$^{b}$ He Yin,$^c$ Volker C. Radeloff,$^d$ and David S. Wilcove$^{a, b}$
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: |
  | $^a$Princeton School of Public and International Affairs, Princeton University, Princeton, NJ
  | $^b$Department of Ecology & Evolutionary Biology, Princeton University, Princeton, NJ
  | $^c$Department of Geography, Kent State University, Kent, OH
  | $^d$SILVIS Lab, Department of Forest & Wildlife Ecology, University of Wisconsin - Madison, Madison, WI
  |
  | $^*$Corresponding Author, ccrawford@princeton.edu, Robertson Hall, Princeton University, Princeton, NJ
output:
  bookdown::html_document2: 
    self_contained: true
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: false
    keep_tex: false
    number_sections: true
    includes:
      in_header: "preamble.tex"
  bookdown::word_document2:
    reference_docx: /Users/christophercrawford/work/projects/writing/scripts/word_style_ref.docx
    number_sections: true
mainfont: Times New Roman
fontsize: 11pt
# linestretch: 1.25
# documentclass: report
editor_options:
  chunk_output_type: console
bibliography: [/Users/christophercrawford/work/library/zotero/zotero_library.bib, packages.bib]
link-citations: yes
csl: nature.csl
urlcolor: blue
linkcolor: blue
citecolor: blue
---

```{r initialize, eval = TRUE, echo = FALSE, include = FALSE}
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/0_start.R")
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/_util/_util_files.R")
```

```{r get-package-citations, eval = FALSE, include = FALSE, echo = FALSE}
knitr::write_bib(x = c(needed_packages, github_packages), 
                 file = paste0(p_proj, 'scripts/packages.bib'))
citation("base")
```

```{r set-tmp-files, include = FALSE}
# see _util_files.R
aoh_ms_tmp_trends
aoh_ms_tmp_trends_by_sp

aoh_ms_tmp_trends %>% filter(is.na(trend))
aoh_ms_tmp_trends_by_sp %>% filter(is.na(overall_trend))

# traits
mod_label # see _util_files.R, Traits: temp files
```

```{r preview-chapter, eval=FALSE, include = FALSE}
rmarkdown::render(
  "scripts/biodiv_abn_MS.Rmd",
  output_file = paste0(p_proj, "writing/drafts/",
                       "Crawford_bd_abn_MS_draft",
                       # "Crawford_bd_abn_MS+SI_draft",
                       format(Sys.Date(), ("_%Y_%m_%d")), ".docx"),
  output_format = bookdown::word_document2(
    reference_docx = "/Users/christophercrawford/work/projects/writing/scripts/word_style_ref.docx",
    number_sections = TRUE,
    global_numbering = TRUE) #,  params = list(doc_type <- "word")
  )


# Save final PDF with SI for submission:
# my_format <- "latex"
# doc_type <- "pdf"
# doc_type <- "word"
rmarkdown::render("scripts/biodiv_abn_MS.Rmd",
                  output_file = paste0(p_proj, "writing/drafts/", "Crawford_bd_abn_MS+SI_draft",
                           format(Sys.Date(), ("_%Y_%m_%d")), ".pdf"),
                  output_format = "bookdown::pdf_document2"#,
                  # params = list()
                  )


# html
# my_format <- "simple"
# rmarkdown::render("scripts/biodiv_abn_MS.Rmd",
#                   output_file = 
#                     paste0(p_proj, "writing/previews/", "Crawford_bd_abn_MS_draft",
#                            format(Sys.Date(), ("_%Y_%m_%d")), ".html"),
#                   # output_format = "bookdown::html_document2",
#                   html_document2(self_contained = TRUE))


# bookdown::preview_chapter(
#   input = "abn_trajectories_ms.Rmd",
#   output_format = "bookdown::word_document2",
#   output_file = paste0("abn_duration_draft", format(Sys.Date(), ("_%Y_%m_%d")), ".docx"),
#   output_dir = paste0(p_proj, "writing/previews"),
#   output_options = 
#     list(reference_docx = "/Users/christophercrawford/work/projects/writing/scripts/word_style_ref.docx"),
#   preview = TRUE)
```

```{r set-chunk-opts, include = FALSE}
# set default chunk options
knitr::opts_chunk$set(
  # out.width = "1\\textwidth",  # if compiling a pdf, include this option
  # comment = NA,
  # fig.width=6, fig.height=6, 
  warning = FALSE, # hide warnings from code chunks
  echo = FALSE # the code itself will NOT be printed with results
  )

options(knitr.table.format = function() {
  if (knitr::is_latex_output())
    "latex" else "simple"
})
```

```{r abstract-stats, include = FALSE}
abs_aoh_tmp <- 
  aoh_ms_tmp_trends_by_sp %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend,
           trend_direction) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  # filter(aoh_type == "crop_abn_iucn") %>%
  ungroup() %>%
  group_by(aoh_type, vert_class) %>%
  mutate(total_sp = sum(n_sp),
         p = 100 * n_sp/total_sp,
         pr = round(p, digits = 1),
         pp = prettyNum(pr, nsmall = 1))


abstract_stats <- list(
  percent_winner_bird_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "crop_abn_iucn", vert_class == "bird",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_bird_pot = abs_aoh_tmp %>% 
    filter(aoh_type == "crop_abn_potential_iucn", vert_class == "bird",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_mam_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "crop_abn_iucn", vert_class == "mam",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_mam_pot = abs_aoh_tmp %>% 
    filter(aoh_type == "crop_abn_potential_iucn", vert_class == "mam",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_bird_max_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "max_abn_iucn", vert_class == "bird",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_mam_max_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "max_abn_iucn", vert_class == "mam",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_bird_full_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "full_iucn", vert_class == "bird",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_winner_mam_full_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "full_iucn", vert_class == "mam",
           overall_trend == "gain") %>% 
    pull(pp),
  
  percent_loss_bird_full_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "full_iucn", vert_class == "bird",
           overall_trend == "loss") %>% 
    pull(pp),
  
  percent_loss_mam_full_obs = abs_aoh_tmp %>% 
    filter(aoh_type == "full_iucn", vert_class == "mam",
           overall_trend == "loss") %>% 
    pull(pp)

)


aoh_ms_tmp_trends_by_sp %>%
  group_by(aoh_type, vert_class, passage_type,
           # overall_trend, 
           trend_direction
           ) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  # filter(aoh_type == "crop_abn_iucn") %>%
  ungroup() %>%
  group_by(aoh_type, vert_class) %>%
  mutate(total_sp = sum(n_sp),
         p = 100 * n_sp/total_sp,
         pr = round(p, digits = 2),
         pp = prettyNum(pr, nsmall = 2)) %>%
  filter(trend_direction == "gain") %>%
  select(aoh_type, vert_class, n_sp, total_sp, pr)
  # slice_max(p) %>% .$pp
  # print(n = 50)

```
```{r get-stats-aoh-stats-main, include = FALSE}
# number of small-ranged birds and mammals
aoh_ms_tmp_trends_by_sp %>% 
  filter(aoh_type == "crop_abn_iucn",
         range_size_quantile < 0.5)

aoh_stat_tmp_by_site_crop <-
  aoh_ms_tmp_trends %>%
      filter(aoh_type == "crop_abn_iucn"
             # redlistCategory != "Data Deficient"
             ) %>%
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
  pivot_wider(names_from = trend, values_from = n_sp) %>%
  mutate(prop_wl = gain/loss) %>% #arrange(desc(gain))
  # select(vert_class, site, prop_wl) %>% 
  arrange(vert_class, prop_wl) 

aoh_stat_tmp_by_site_crop %>% print(n = 22) 
aoh_stat_tmp_by_site_crop %>% group_by(vert_class) %>% slice_min(prop_wl)

# mean by site
aoh_stat_tmp_by_site_crop %>% group_by(vert_class) %>% summarise(mean_prop_wl = mean(prop_wl))

aoh_overall_tmp <-
  aoh_ms_tmp_trends_by_sp %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>% ungroup() %>% #select(aoh_type) %>% unique()
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp), 
         percent = prettyNum(round(100*n_sp/N, digits = 1), nsmall = 1)) %>% ungroup()

aoh_overall_tmp %>% group_by(aoh_type, vert_class, passage_type, trend_direction) %>%
  # select(-c(passage_type, trend_consistency)) %>%
  mutate(n_weak = sum(n_sp), 
         p_weak = prettyNum(round(100*n_weak/N, digits = 2), nsmall = 1)) %>% ungroup() %>%
  filter(
    aoh_type == "crop_abn_iucn",
    # !str_detect(aoh_type, "potential"),
    # trend_consistency == "consistent",
    # trend_direction == "gain",
    # overall_trend == "loss"
    ) 

aoh_stats_main <- list(
  n_gain_bird = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "gain",
                       vert_class == "bird")$n_sp,
  n_gain_bird_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "gain",
                       vert_class == "bird")$percent,
  n_gain_mam = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "gain",
                       vert_class == "mam")$n_sp,
  n_gain_mam_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "gain",
                       vert_class == "mam")$percent,
  n_loss_bird = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "loss",
                       vert_class == "bird")$n_sp,
  n_loss_bird_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "loss",
                       vert_class == "bird")$percent,
  n_loss_mam = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "loss",
                       vert_class == "mam")$n_sp,
  n_loss_mam_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "loss",
                       vert_class == "mam")$percent,
  n_w_gain_bird = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak gain",
                       vert_class == "bird")$n_sp,
  n_w_gain_bird_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak gain",
                       vert_class == "bird")$percent,
  n_w_gain_mam = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak gain",
                       vert_class == "mam")$n_sp,
  n_w_gain_mam_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak gain",
                       vert_class == "mam")$percent,
  n_w_loss_bird = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak loss",
                       vert_class == "bird")$n_sp,
  n_w_loss_bird_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak loss",
                       vert_class == "bird")$percent,
  n_w_loss_mam = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak loss",
                       vert_class == "mam")$n_sp,
  n_w_loss_mam_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "weak loss",
                       vert_class == "mam")$percent,
  n_opposite_bird = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "context dependent",
                       vert_class == "bird")$n_sp,
  n_opposite_bird_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "context dependent",
                       vert_class == "bird")$percent,
  n_opposite_mam = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "context dependent",
                       vert_class == "mam")$n_sp,
  n_opposite_mam_percent = filter(aoh_overall_tmp, 
                       aoh_type == "crop_abn_iucn", overall_trend == "context dependent",
                       vert_class == "mam")$percent,
  
  
  wl_prop_bird_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "crop_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_min = aoh_stat_tmp_by_site_crop %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_min(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_max = aoh_stat_tmp_by_site_crop %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_max(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_iraq = round(aoh_stat_tmp_by_site_crop %>% filter(site == "iraq", vert_class == "bird") %>%
    .$prop_wl, digits = 2)
)


# get specific stats for certain sites:
aoh_ms_tmp_trends %>%
      filter(site == "iraq", vert_class == "bird",
             # aoh_type == "crop_abn_iucn"
             # redlistCategory != "Data Deficient"
             ) %>%
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup()
```


```{r mam-v-birds, include = FALSE}
# ------------------------------------------------------ #
# do mammals have a statistically significantly higher proportion of winners than birds?
# ------------------------------------------------------ #
aoh_ms_tmp_trends_by_sp %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>% ungroup() %>% #select(aoh_type) %>% unique()
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp), 
         percent = prettyNum(round(100*n_sp/N, digits = 2), nsmall = 2)) %>% ungroup() %>%
    filter(aoh_type == "crop_abn_iucn")

# ---------- #
# make a contingency table:
# ---------- #
aoh_ms_tmp_trends_by_sp %>%
  # compare mammals and birds
  filter(aoh_type == "crop_abn_iucn") %>% select(vert_class, overall_trend) %>%
  
  # compare aoh_type
  # filter(str_detect(aoh_type, "crop")) %>% select(aoh_type, overall_trend) %>%
  
  # produce contingency table
  table()

# ---------- #
# calculate proportion of winners (differenced):
# ---------- #
obs_diff_bird_v_mam <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%
  group_by(vert_class) %>%
  summarise(p_gain = mean(overall_trend == "gain")) %>% 
  pull() %>%
  diff()

# ---------- #
# Null hypothesis: mammals and birds have the same proportion of winners and losers
# ---------- #
# In other words, the difference between the two proportions should be 0. 
set.seed(1612)

# ---------- #
# create a null distribution of differences:
# ---------- #
null_bird_v_mam <-
  aoh_ms_tmp_trends_by_sp %>%
  
  # compare mammals and birds
  filter(aoh_type == "crop_abn_iucn", 
         ) %>% 
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  select(vert_class, response) %>%

  infer::specify(response ~ vert_class, success = "gain") %>%
  infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "permute") %>%
  infer::calculate(stat = "diff in props", order = c("mam", "bird"))

# ---------- #
# plot distribution with observed difference in proportions
# ---------- #
# null_bird_v_mam %>%
#   ggplot(aes(x = stat)) + geom_density() + 
#   geom_vline(xintercept = obs_diff_bird_v_mam, col = "red")

# calculate p-value from distribution:
null_bird_v_mam %>%
  summarise(p_value = 2* mean(stat >= obs_diff_bird_v_mam)) %>% 
  pull()

# ---------- #
# Calculate confidence interval around difference
# ---------- #
# create a bootstrapped distribution of differences:
boot_bird_v_mam <- aoh_ms_tmp_trends_by_sp %>%
  
  # compare mammals and birds
  filter(aoh_type == "crop_abn_iucn", overall_trend %in% c("gain", "loss")) %>% 
  mutate(response = case_when(overall_trend == "gain" ~ "gain", 
                              TRUE ~ "non_gain")) %>%
  select(vert_class, response) %>%
  infer::specify(response ~ vert_class, success = "gain") %>%
  # infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "bootstrap") %>%
  infer::calculate(stat = "diff in props", order = c("mam", "bird"))

# Calculate standard errors:
se_bird_v_mam <- boot_bird_v_mam %>% summarise(se = sd(stat)) %>% pull()

# ---------- #
# Confidence interval 
# ---------- #
c(obs_diff_bird_v_mam - 2 * se_bird_v_mam,
  obs_diff_bird_v_mam + 2 * se_bird_v_mam)


# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
# Compare to results with prop.test
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #

aoh_gain_bird_v_mam_tmp <-
  aoh_overall_tmp %>% 
  ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(aoh_type == "crop_abn_iucn", 
         overall_trend == "gain"
         )

# consistent gains only, birds vs. mammals:
# X-squared
p_test_gain_m_v_b <- 
  prop.test(x = aoh_gain_bird_v_mam_tmp$n_sp,
          n = aoh_gain_bird_v_mam_tmp$N)

# ---- proportion of species that lose habitat ----
aoh_loss_bird_v_mam_tmp <-
  aoh_overall_tmp %>% 
  ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(aoh_type == "crop_abn_iucn", 
         overall_trend == "loss"
         )

p_test_loss_m_v_b <- 
  prop.test(x = aoh_loss_bird_v_mam_tmp$n_sp,
          n = aoh_loss_bird_v_mam_tmp$N)


# -----
# now, including weak gains:
aoh_gain_bird_v_mam_incl_weak_tmp <-
  aoh_overall_tmp %>% 
  ungroup() %>%
  group_by(aoh_type, vert_class, passage_type, trend_direction) %>% summarise(n_sp = sum(n_sp)) %>% ungroup() %>%
  
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(aoh_type == "crop_abn_iucn", 
         # overall_trend == "gain"
         trend_direction == "gain" # and flip these on - to include weak trends
         )

# consistent and weak gains, birds vs. mammals:
p_test_gain_m_v_b_incl_weak <- 
  prop.test(
    x = aoh_gain_bird_v_mam_incl_weak_tmp$n_sp,
    n = aoh_gain_bird_v_mam_incl_weak_tmp$N
    )

```

```{r thr-v-non-thr-stat-test, include = FALSE}
# using {infer} to test whether there are statistical differences in proportions of winners and losers for threatened and non-threatened species
aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%
  group_by(aoh_type, vert_class, passage_type,
           threatened,
           overall_trend, trend_consistency, trend_direction) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>% ungroup() %>%
  
  group_by(aoh_type, 
           #vert_class, 
           passage_type, threatened) %>%
  mutate(N = sum(n_sp)) %>% ungroup() %>%
  filter(
    overall_trend == "gain"
    # trend_direction == "gain"
         )

# ---------- #
# make a contingency table:
# ---------- #
aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%

  # compare mammals and birds
  # select(aoh_type:binomial, threatened, overall_trend) %>%
  select(threatened, overall_trend, 
         # vert_class
         ) %>%

  # produce contingency table
  table()

# ---------- #
# calculate proportion of winners (differenced):
# ---------- #
obs_diff_by_iucn <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%
  group_by(aoh_type, threatened) %>%
  summarise(p_gain = mean(overall_trend == "gain"), # strict gains only
            p_gain_w_weak = mean(str_detect(overall_trend, "gain")) # include weak gains
            ) %>% 
  # pull(p_gain_w_weak) %>%
  pull(p_gain) %>%
  diff()

# ---------- #
# Null hypothesis: mammals and birds have the same proportion of winners and losers
# ---------- #
# In other words, the difference between the two proportions should be 0. 
set.seed(1612)

# ---------- #
# create a null distribution of differences:
# ---------- #
null_by_iucn <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%
  
  # compare threatened and non-threatened species, using only strict gains
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  
  # include weak gains
  # mutate(response = case_when(str_detect(overall_trend, "gain") ~ "gain", TRUE ~ "non_gain")) %>%

  
  infer::specify(response ~ threatened, success = "gain") %>%
  infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "permute") %>%
  infer::calculate(stat = "diff in props", order = c("Threatened", "Not Threatened"))


# ---------- #
# plot distribution with observed difference in proportions
# ---------- #
# null_by_iucn %>%
#   ggplot(aes(x = stat)) + geom_density() + 
#   geom_vline(xintercept = obs_diff_by_iucn, col = "red")


# calculate p-value from distribution:
null_by_iucn %>%
  summarise(p_value = 2* mean(stat >= obs_diff_by_iucn)) %>% 
  pull()
# 0.552 when including strict gains only
# 0.088 - still non-significant when including weak gains

# ---------- #
# Calculate confidence interval around difference
# ---------- #
# create a bootstrapped distribution of differences:
boot_by_iucn <- 
  aoh_ms_tmp_trends_by_sp %>%
  filter(aoh_type == "crop_abn_iucn") %>%
  
  # compare mammals and birds
  mutate(
    response = case_when(
      overall_trend == "gain" ~ "gain", # strict only
      # str_detect(overall_trend, "gain") ~ "gain", # including weak gains too
      TRUE ~ "non_gain")) %>%

  infer::specify(response ~ threatened, success = "gain") %>%
  # infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "bootstrap") %>%
  infer::calculate(stat = "diff in props", order = c("Threatened", "Not Threatened"))

# Calculate standard errors:
se_by_iucn <- boot_by_iucn %>% summarise(se = sd(stat)) %>% pull()

# ---------- #
# Confidence interval 
# ---------- #
c(obs_diff_by_iucn - 2 * se_by_iucn,
  obs_diff_by_iucn + 2 * se_by_iucn)

# [1] -0.0768320  0.1767056 # including strict gains only (overlapping with 0)
# [1] 0.01576708 0.19815655 # including weak gains (just barely doesn't overlap with 0, perhaps weakly significant)





# ------------------------------------------ #
# using prop.test()
# ------------------------------------------ #

aoh_gain_by_iucn_tmp <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type,
           threatened,
           overall_trend, trend_consistency,
           trend_direction) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>% ungroup() %>%
  
  group_by(aoh_type, vert_class, passage_type, threatened) %>%
  mutate(N = sum(n_sp)) %>%
  ungroup() %>%
  filter(
    # aoh_type == "crop_abn_iucn", 
         overall_trend == "gain"
         # trend_direction == "gain"
         )

# ------------------------------------ #
# Do threatened species have a statistically significant higher proportion of winners?
# ------------------------------------------ #

aoh_gain_by_iucn_tmp %>% 
  group_by(threatened) %>% 
  summarise(n_sp = sum(n_sp), N = sum(N)) %>%
  pull(n_sp)

p_test_iucn_all <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>% 
              pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>%
              pull(N))


# birds
p_test_iucn_bird <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              filter(vert_class == "bird") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              filter(vert_class == "bird") %>% .$N)

# mammals
p_test_iucn_mam <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              filter(vert_class == "mam") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "crop_abn_iucn") %>%
              filter(vert_class == "mam") %>% .$N)

# ------------------------------------------ #
# now, including weak trends:
# ------------------------------------------ #
aoh_gain_by_iucn_incl_weak_tmp <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type,
           threatened = case_when(
             redlistCategory %in% 
               c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
             TRUE ~ "Not Threatened"),
           # overall_trend, trend_consistency,
           trend_direction) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>% ungroup() %>%
  
  group_by(aoh_type, vert_class, passage_type, threatened) %>%
  mutate(N = sum(n_sp)) %>%
  ungroup() %>%
  filter(aoh_type == "crop_abn_iucn", 
         # overall_trend == "gain"
         trend_direction == "gain"
         )

# birds
p_test_iucn_bird_incl_weak <-
  prop.test(x = aoh_gain_by_iucn_incl_weak_tmp %>% 
              filter(vert_class == "bird") %>% pull(n_sp),
            n = aoh_gain_by_iucn_incl_weak_tmp %>% 
              filter(vert_class == "bird") %>% .$N)

# mammals
p_test_iucn_mam_incl_weak <-
  prop.test(x = aoh_gain_by_iucn_incl_weak_tmp %>% 
              filter(vert_class == "mam") %>% pull(n_sp),
            n = aoh_gain_by_iucn_incl_weak_tmp %>% 
              filter(vert_class == "mam") %>% .$N)




# ------------------------------------------ #
# Compare for calculations 2 and 3
# ------------------------------------------ #

p_test_iucn_all_calc2 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>% 
              pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>%
              pull(N))


p_test_iucn_all_calc3 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>% 
              pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              group_by(threatened) %>% 
              summarise(n_sp = sum(n_sp), N = sum(N)) %>%
              pull(N))


# birds
p_test_iucn_bird_calc2 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              filter(vert_class == "bird") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              filter(vert_class == "bird") %>% .$N)

# mammals
p_test_iucn_mam_calc2 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              filter(vert_class == "mam") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "max_abn_iucn") %>%
              filter(vert_class == "mam") %>% .$N)

# birds
p_test_iucn_bird_calc3 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              filter(vert_class == "bird") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              filter(vert_class == "bird") %>% .$N)

# mammals
p_test_iucn_mam_calc3 <-
  prop.test(x = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              filter(vert_class == "mam") %>% pull(n_sp),
            n = aoh_gain_by_iucn_tmp %>% 
              filter(aoh_type == "full_iucn") %>%
              filter(vert_class == "mam") %>% .$N)

p_test_iucn_bird_calc2
p_test_iucn_mam_calc2
p_test_iucn_bird_calc3
p_test_iucn_mam_calc3

```

```{r obs-v-pot-infer, include = FALSE}
# ----------- #
# exploration
# ----------- #

# contingency table:
aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  droplevels() %>%
  select(aoh_type, vert_class,
         response,
         # overall_trend
         ) %>% 
  table()

# proportion of winners overall


# ---------- #
# calculate proportion of winners (differenced):
# ---------- #
obs_diff_obs_v_pot <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  group_by(aoh_type) %>%
  summarise(p_gain = mean(response == "gain"),
            p_gain_w_weak = mean(str_detect(overall_trend, "gain")), # include weak gains
            p_loss = mean(overall_trend == "loss"),
            n_sp = n()) %>% ungroup() %>%
  pull(p_gain) %>%
  # pull(p_gain_w_weak) %>%
  diff()


# more details:
aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  group_by(aoh_type,
           vert_class, passage_type, overall_trend, trend_direction, trend_consistency
           ) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  arrange(vert_class, aoh_type, trend_direction, overall_trend) %>% 
  group_by(vert_class, aoh_type) %>% 
  mutate(N = sum(n_sp)) %>% ungroup() %>%
  mutate(percent = 100 * n_sp/N) %>% print(n = 30)


# -------------------------------------------------------------------- #
# using {infer} to test whether there are statistical differences in proportions of winners and losers for threatened and non-threatened species


# ---------- #
# Null hypothesis: mammals and birds have the same proportion of winners and losers
# ---------- #
# In other words, the difference between the two proportions should be 0. 
set.seed(22)

# ---------- #
# create a null distribution of differences:
# ---------- #
null_obs_v_pot <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  droplevels() %>%
  
  # compare aoh_types, observed and potential abandonment, using only strict gains
  mutate(response = case_when(overall_trend == "gain" ~ "gain", TRUE ~ "non_gain")) %>%
  
  # include weak gains
  # mutate(response = case_when(str_detect(overall_trend, "gain") ~ "gain", TRUE ~ "non_gain")) %>%

  
  infer::specify(response ~ aoh_type, success = "gain") %>%
  infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "permute") %>%
  infer::calculate(stat = "diff in props", order = c("crop_abn_potential_iucn", "crop_abn_iucn"))


# ---------- #
# plot distribution with observed difference in proportions
# ---------- #
# null_obs_v_pot %>%
  # ggplot(aes(x = stat)) + geom_density() +
  # geom_vline(xintercept = obs_diff_obs_v_pot, col = "red")


# calculate p-value from distribution:
null_obs_v_pot %>%
  summarise(p_value = 2* mean(stat >= obs_diff_obs_v_pot)) %>% 
  pull()
# 0 when including strict gains only - highly significant
# 0.278 - not significant when including weak gains

# ---------- #
# Calculate confidence interval around difference
# ---------- #
# create a bootstrapped distribution of differences:
boot_obs_v_pot <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  droplevels() %>%
  # compare mammals and birds
  mutate(
    response = case_when(
      overall_trend == "gain" ~ "gain", # strict only
      # str_detect(overall_trend, "gain") ~ "gain", # including weak gains too
      TRUE ~ "non_gain")) %>%

  infer::specify(response ~ aoh_type, success = "gain") %>%
  # infer::hypothesize(null = "independence") %>%
  infer::generate(reps = 1000, type = "bootstrap") %>%
  infer::calculate(stat = "diff in props", order = c("crop_abn_potential_iucn", "crop_abn_iucn"))

# Calculate standard errors:
se_obs_v_pot <- boot_obs_v_pot %>% summarise(se = sd(stat)) %>% pull()

# ---------- #
# Confidence interval 
# ---------- #
c(obs_diff_obs_v_pot - 2 * se_obs_v_pot,
  obs_diff_obs_v_pot + 2 * se_obs_v_pot)

# [1] 0.06760623 0.13653579 # including strict gains only (significant, non overlapping with 0)
# [1] -0.01344239  0.04894534 # including weak gains (overlapping with 0, not significant)


```


```{r get-stats-obs-v-pot, include = FALSE}
# relevant files
aoh_p_change_obs_v_pot <- aoh_p_change_obs_v_pot_feols # and
aoh_p_change_obs_v_pot_summary <- aoh_p_change_obs_v_pot_summary_feols

# set up tmp files:
mg_improve_tmp <- 
  aoh_p_change_obs_v_pot_summary %>% 
  filter(site == "mato_grosso", change_direction == "Improve")

aoh_p_change_obs_v_pot_summary %>% 
  filter(site == "mato_grosso")

# basic numbers:
aoh_overall_obs_v_pot_tmp <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  arrange(vert_class, trend_direction, overall_trend, aoh_type) %>% 
    group_by(vert_class, aoh_type) %>% 
    mutate(N = sum(n_sp)) %>% ungroup() %>%
    mutate(percent = 100 * n_sp/N) #%>%  print(n = 100)

aoh_overall_obs_v_pot_tmp %>%
  select(aoh_type, vert_class, overall_trend, n_sp, N) %>%
  pivot_wider(id_cols = c(vert_class, overall_trend, N), 
              names_from = aoh_type, values_from = n_sp) %>%
  mutate(percent_change = 100 * (crop_abn_potential_iucn - crop_abn_iucn) / crop_abn_iucn)

# ------------------
# By site:
# ------------------
aoh_n_by_site_obs_v_pot <-
  aoh_ms_tmp_trends %>%
  filter(str_detect(aoh_type, "crop")) %>%
  group_by(site, aoh_type, vert_class, trend) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  mutate(trend = gsub(" ", "_", trend),
         aoh_type = case_when(str_detect(aoh_type, "potential") ~ "pot",
                              TRUE ~ "obs")) %>%
  group_by(site, aoh_type, vert_class, trend) %>% 
  summarise(n_sp = sum(n_sp)) %>% mutate(total_sp = sum(n_sp)) %>% ungroup() %>%
  pivot_wider(names_from = aoh_type, values_from = n_sp) %>%
  mutate(obs = replace_na(obs, 0), pot = replace_na(pot, 0),
         n_change = pot - obs, 
         abs_n_change = abs(n_change),
         percent_change = round(100 * (pot - obs) / obs, digits = 2))

aoh_n_by_site_obs_v_pot %>%
  filter(#site != "mato_grosso", 
         trend %in% c("gain","loss")) %>% arrange(desc(abs_n_change))


# set up temp files for tables:
n_aoh_trend_changes_by_site_df <-
  aoh_n_by_site_obs_v_pot %>%
  select(site, vert_class, 
         trend, n_change, total_sp) %>%
  pivot_wider(id_cols = c(site, vert_class, total_sp),          
              names_from = trend, values_from = n_change) %>%
  # summarise by vert_class:
  group_by(site) %>%
  summarise(total_sp = sum(total_sp), gain = sum(gain),
            loss = sum(loss), no_trend = sum(no_trend, na.rm = TRUE)) %>%
  arrange(no_trend) %>%
  left_join(site_df %>% select(site, description))


# ------------------------------------------------------------------ #
# set up stats:
obs_v_pot_stats <- list(
  bird_gain_p_test = prop.test(
    x = aoh_overall_obs_v_pot_tmp %>% 
      filter(vert_class == "bird", overall_trend == "gain") %>% pull(n_sp),
    n = aoh_overall_obs_v_pot_tmp %>% 
      filter(vert_class == "bird", overall_trend == "gain") %>% .$N),
  
  mam_gain_p_test = prop.test(
    x = aoh_overall_obs_v_pot_tmp %>% 
      filter(vert_class == "mam", overall_trend == "gain") %>% pull(n_sp),
    n = aoh_overall_obs_v_pot_tmp %>% 
      filter(vert_class == "mam", overall_trend == "gain") %>% .$N),
 
  n_gain_bird_pot = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn",
                       overall_trend == "gain", vert_class == "bird")$n_sp,
  n_gain_bird_pot_percent = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn",
                       overall_trend == "gain", vert_class == "bird")$percent,
  n_gain_mam_pot = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn",
                      overall_trend == "gain", vert_class == "mam")$n_sp,
  n_gain_mam_pot_percent = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn",
                      overall_trend == "gain", vert_class == "mam")$percent,
  n_loss_bird_pot = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn", 
                       overall_trend == "loss", vert_class == "bird")$n_sp,
  n_loss_bird_pot_percent = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn", 
                       overall_trend == "loss", vert_class == "bird")$percent,
  n_loss_mam_pot = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn", 
                      overall_trend == "loss", vert_class == "mam")$n_sp,
  n_loss_mam_pot_percent = filter(aoh_overall_tmp, aoh_type == "crop_abn_potential_iucn", 
                      overall_trend == "loss", vert_class == "mam")$percent,
  
  perc_inc_gain_bird_min = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "gain", vert_class == "bird") %>% 
  select(percent_change) %>% min(),
  perc_inc_gain_bird_max = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "gain", vert_class == "bird") %>% 
  select(percent_change) %>% max(),
  perc_inc_loss_bird_min = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "loss", vert_class == "bird") %>% 
  select(percent_change) %>% min(),
  perc_inc_loss_bird_max = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "loss", vert_class == "bird") %>% 
  select(percent_change) %>% max(),
  
  perc_inc_gain_mam_min = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "gain", vert_class == "mam") %>% 
  select(percent_change) %>% min(),
  perc_inc_gain_mam_max = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "gain", vert_class == "mam") %>% 
  select(percent_change) %>% max(),
  perc_inc_loss_mam_min = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "loss", vert_class == "mam") %>% 
  select(percent_change) %>% min(),
  perc_inc_loss_mam_max = aoh_n_by_site_obs_v_pot %>%
  filter(site != "mato_grosso", trend == "loss", vert_class == "mam") %>% 
  select(percent_change) %>% max(),
  
  mg_n_winner_bird_obs = aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, trend, aoh_type) %>%
  filter(site == "mato_grosso", trend == "gain") %>%
  pivot_wider(values_from = n_sp, names_from = aoh_type) %>%
  filter(vert_class == "bird") %>% .$crop_abn_iucn,
  
  mg_n_winner_bird_pot = aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, trend, aoh_type) %>%
  filter(site == "mato_grosso", trend == "gain") %>%
  pivot_wider(values_from = n_sp, names_from = aoh_type) %>%
  filter(vert_class == "bird") %>% .$crop_abn_potential_iucn,
  
  mg_n_winner_mam_obs = aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, trend, aoh_type) %>%
  filter(site == "mato_grosso", trend == "gain") %>%
  pivot_wider(values_from = n_sp, names_from = aoh_type) %>%
  filter(vert_class == "mam") %>% .$crop_abn_iucn,
  
  mg_n_winner_mam_pot = aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, trend, aoh_type) %>%
  filter(site == "mato_grosso", trend == "gain") %>%
  pivot_wider(values_from = n_sp, names_from = aoh_type) %>%
  filter(vert_class == "mam") %>% .$crop_abn_potential_iucn,
  
  
  mg_improve_n_total = mg_improve_tmp %>% summarise(n = sum(n_sp_in_group)),
  mg_improve_n_bird_no_trend = mg_improve_tmp %>% 
    filter(str_detect(trend_change, "no"), vert_class == "bird") %>% pull(n_sp_in_group),
  
  mg_improve_n_mam_no_trend = mg_improve_tmp %>% 
    filter(str_detect(trend_change, "no"), vert_class == "mam") %>% pull(n_sp_in_group),
  
  mg_improve_n_bird_loss = mg_improve_tmp %>% 
    filter(str_detect(trend_change, "loss"), vert_class == "bird") %>% pull(n_sp_in_group),
  
  mg_improve_n_mam_loss = mg_improve_tmp %>% 
    filter(str_detect(trend_change, "loss"), vert_class == "mam") %>% pull(n_sp_in_group),
  
  mg_improve_mean_p_gain = 
    format(round(
       mg_improve_tmp %>%
            group_by(change_direction) %>% 
            summarise(n_sp = sum(n_sp_in_group),
                      w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>% 
            .$w_mean, digits = 2), nsmall = 2),
  
  mg_worsen_n_bird = aoh_p_change_obs_v_pot_summary %>% 
        filter(site == "mato_grosso", change_direction == "Worsen",
               vert_class == "bird") %>% pull(n_sp_in_group),
  mg_worsen_n_mam = aoh_p_change_obs_v_pot_summary %>% 
        filter(site == "mato_grosso", change_direction == "Worsen",
               vert_class == "mam") %>% pull(n_sp_in_group),
  
  mg_worsen_mean_p_loss = format(round(aoh_p_change_obs_v_pot_summary %>% 
        filter(site == "mato_grosso", change_direction == "Worsen") %>%
            group_by(change_direction) %>% 
            summarise(n_sp = sum(n_sp_in_group),
                      w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>% 
            .$w_mean * -1, digits = 2), nsmall = 2),
  
  # how many species improved trend?
  n_sp_improve_non_mg_bird = aoh_p_change_obs_v_pot %>%
    select(vert_class, site, binomial, contains("change")) %>%
    filter(change_direction == "Improve", site != "mato_grosso") %>%
    select(vert_class, binomial, trend_change, change_direction) %>% unique() %>% 
    group_by(vert_class, change_direction) %>%
    summarise(n_sp = length(unique(binomial))) %>%
    filter(vert_class == "bird") %>% pull(n_sp),
  
  n_sp_improve_non_mg_mam = aoh_p_change_obs_v_pot %>%
    select(vert_class, site, binomial, contains("change")) %>%
    filter(change_direction == "Improve", site != "mato_grosso") %>%
    select(vert_class, binomial, trend_change, change_direction) %>% unique() %>% 
    group_by(vert_class, change_direction) %>%
    summarise(n_sp = length(unique(binomial))) %>%
    filter(vert_class == "mam") %>% pull(n_sp),
  
  n_same_loss_bird = 
    aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>%
    filter(trend_change == "same (loss)", vert_class == "bird") %>% pull(n_sp),
  
  n_same_loss_mam = 
    aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>%
    filter(trend_change == "same (loss)", vert_class == "mam") %>% pull(n_sp),
  
  mean_p_loss_same = round(
    aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>% ungroup() %>%
    filter(trend_change == "same (loss)") %>% 
    summarise(wm = sum(n_sp*w_mean) / sum(n_sp)) %>% 
    .$wm * -1, digits = 2),
  
  mean_p_loss_site_min = round(
    aoh_p_change_obs_v_pot_summary %>%
    filter(trend_change == "same (loss)") %>% 
    ungroup() %>% slice_max(mean_p_change) %>%
      .$mean_p_change * -1, digits = 2),
  
  mean_p_loss_site_max = round(aoh_p_change_obs_v_pot_summary %>%
    filter(trend_change == "same (loss)") %>% 
    ungroup() %>% slice_min(mean_p_change) %>% 
      .$mean_p_change * -1, digits = 2),
  
  mean_p_loss_site_min_bird = round(
    aoh_p_change_obs_v_pot_summary %>%
      filter(trend_change == "same (loss)", vert_class == "bird") %>%
      group_by(vert_class) %>% slice_max(mean_p_change) %>% 
      .$mean_p_change * -1, digits = 2),
  
  mean_p_loss_site_max_bird = round(
    aoh_p_change_obs_v_pot_summary %>% 
      filter(trend_change == "same (loss)", vert_class == "bird") %>%
      group_by(vert_class) %>% slice_min(mean_p_change) %>% 
      .$mean_p_change * -1, digits = 2),
  
  mean_p_loss_site_min_mam = round(
    aoh_p_change_obs_v_pot_summary %>%
      filter(trend_change == "same (loss)", vert_class == "mam") %>%
      group_by(vert_class) %>% slice_max(mean_p_change) %>%
      .$mean_p_change * -1, digits = 2),
  
  mean_p_loss_site_max_mam = round(
    aoh_p_change_obs_v_pot_summary %>%
      filter(trend_change == "same (loss)", vert_class == "mam") %>%
      group_by(vert_class) %>% slice_min(mean_p_change) %>% 
      .$mean_p_change * -1, digits = 2),
  
  
  n_same_gain_bird = 
    aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>%
    filter(trend_change == "same (gain)", vert_class == "bird") %>% pull(n_sp),
  
  n_same_gain_mam = 
    aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>%
    filter(trend_change == "same (gain)", vert_class == "mam") %>% pull(n_sp),
  
  mean_p_gain_same = aoh_p_change_obs_v_pot_summary %>%
    group_by(vert_class, trend_change, change_direction) %>% 
    summarise(n_sp = sum(n_sp_in_group),
              w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
    arrange(vert_class, change_direction) %>% ungroup() %>%
    filter(trend_change == "same (gain)") %>% 
    summarise(wm = sum(n_sp*w_mean) / sum(n_sp)) %>% 
    .$wm %>% round(digits = 2),
  
  mean_p_gain_site_min = aoh_p_change_obs_v_pot_summary %>%
    filter(trend_change == "same (gain)") %>% 
    ungroup() %>% slice_min(mean_p_change) %>% .$mean_p_change %>%
    round(digits = 2),
  mean_p_gain_site_max = aoh_p_change_obs_v_pot_summary %>%
    filter(trend_change == "same (gain)") %>% 
    ungroup() %>% slice_max(mean_p_change) %>% .$mean_p_change %>%
    round(digits = 2)
  )


# ------------------------------------------------- #

# how many species improved trend?
aoh_p_change_obs_v_pot %>%
  select(vert_class, site, binomial, contains("change")) %>%
  filter(change_direction == "Improve", site == "mato_grosso") %>%
  select(vert_class, binomial, trend_change, change_direction) %>% unique() %>% 
  print(n = 30) %>%
  group_by(vert_class, change_direction) %>%
  summarise(n_sp = length(unique(binomial)))

# Number of species with various trends in each scenario:
aoh_ms_tmp_trends %>%
  filter(vert_class == "bird", grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, site, trend) %>%
  summarise(n_sp = n(), ) %>% 
  filter(site != "mato_grosso") %>%
  arrange(trend)

# percent changes in area between scenarios
aoh_p_change_obs_v_pot_summary %>% print(n = 100)

aoh_p_change_obs_v_pot_summary %>% 
  filter(change_direction == "Improve", site != "mato_grosso") %>%
  group_by(vert_class) %>% summarise(sum(n_sp_in_group))

aoh_p_change_obs_v_pot_summary %>%
  group_by(vert_class, 
           trend_change, change_direction) %>% 
  summarise(n_sp = sum(n_sp_in_group),
            w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
  arrange(vert_class, 
          change_direction)


aoh_p_change_obs_v_pot_summary %>% 
  filter(site == "mato_grosso")


# Table of mean percent changes in AOH at end of time series for individual species.
# this contains the mean percent change for winners and losers.
aoh_p_change_obs_v_pot_summary %>%
  group_by(vert_class, change_direction, trend_change) %>% 
  summarise(n_sp = sum(n_sp_in_group),
            w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
  ungroup() %>%
  arrange(vert_class, change_direction) %>%
  group_by(trend_change) %>% 
  summarise(wm = sum(n_sp*w_mean) / sum(n_sp)) %>%
  mutate(wm = round(wm, digits = 2))

aoh_p_change_obs_v_pot_summary



aoh_p_change_obs_v_pot_summary %>%
  group_by(site, vert_class, change_direction, trend_change) %>% 
  summarise(n_sp = sum(n_sp_in_group),
            w_mean = sum(mean_p_change*n_sp_in_group) / n_sp) %>%
  ungroup() %>%
  arrange(vert_class, change_direction) %>%
  group_by(site, trend_change) %>% 
  summarise(wm = sum(n_sp*w_mean) / sum(n_sp)) %>%
  mutate(wm = round(wm, digits = 2)) %>%
  print(n= 100)
```

```{r prop.test-calc-1-2-3, include = FALSE}

# ------------------------------------------------------ #
# does the proportion of winner species statistically differ between calculations?
# ------------------------------------------------------ #

# ------ birds ------ #
aoh_gain_bird_by_calc_tmp <-
  aoh_overall_tmp %>% ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(!str_detect(aoh_type, "potential"),
         overall_trend == "gain", vert_class == "bird")

aoh_loss_bird_by_calc_tmp <-
  aoh_overall_tmp %>% ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(!str_detect(aoh_type, "potential"),
         overall_trend == "loss", vert_class == "bird")

p_test_gain_bird_by_calc12 <- prop.test(
  x = aoh_gain_bird_by_calc_tmp$n_sp[1:2],
  n = aoh_gain_bird_by_calc_tmp$N[1:2]
  )
p_test_gain_bird_by_calc13 <- prop.test(
  x = aoh_gain_bird_by_calc_tmp$n_sp[c(1,3)],
  n = aoh_gain_bird_by_calc_tmp$N[c(1,3)]
  )
p_test_gain_bird_by_calc23 <- prop.test(
  x = aoh_gain_bird_by_calc_tmp$n_sp[2:3],
  n = aoh_gain_bird_by_calc_tmp$N[2:3]
  )
p_test_loss_bird_by_calc12 <- prop.test(
  x = aoh_loss_bird_by_calc_tmp$n_sp[1:2],
  n = aoh_loss_bird_by_calc_tmp$N[1:2]
  )
p_test_loss_bird_by_calc13 <- prop.test(
  x = aoh_loss_bird_by_calc_tmp$n_sp[c(1,3)],
  n = aoh_loss_bird_by_calc_tmp$N[c(1,3)]
  )
p_test_loss_bird_by_calc23 <- prop.test(
  x = aoh_loss_bird_by_calc_tmp$n_sp[2:3],
  n = aoh_loss_bird_by_calc_tmp$N[2:3]
  )

# ------- mammals ------ #
aoh_gain_mam_by_calc_tmp <-
  aoh_overall_tmp %>% ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(!str_detect(aoh_type, "potential"),
         overall_trend == "gain", vert_class == "mam")

aoh_loss_mam_by_calc_tmp <-
  aoh_overall_tmp %>% ungroup() %>%
  group_by(aoh_type, vert_class, passage_type) %>%
  mutate(N = sum(n_sp)) %>%
  filter(!str_detect(aoh_type, "potential"),
         overall_trend == "loss", vert_class == "mam")

p_test_gain_mam_by_calc12 <- prop.test(
  x = aoh_gain_mam_by_calc_tmp$n_sp[1:2],
  n = aoh_gain_mam_by_calc_tmp$N[1:2]
  )
p_test_gain_mam_by_calc13 <- prop.test(
  x = aoh_gain_mam_by_calc_tmp$n_sp[c(1,3)],
  n = aoh_gain_mam_by_calc_tmp$N[c(1,3)]
  )
p_test_gain_mam_by_calc23 <- prop.test(
  x = aoh_gain_mam_by_calc_tmp$n_sp[2:3],
  n = aoh_gain_mam_by_calc_tmp$N[2:3]
  )
p_test_loss_mam_by_calc12 <- prop.test(
  x = aoh_loss_mam_by_calc_tmp$n_sp[1:2],
  n = aoh_loss_mam_by_calc_tmp$N[1:2]
  )
p_test_loss_mam_by_calc13 <- prop.test(
  x = aoh_loss_mam_by_calc_tmp$n_sp[c(1,3)],
  n = aoh_loss_mam_by_calc_tmp$N[c(1,3)]
  )
p_test_loss_mam_by_calc23 <- prop.test(
  x = aoh_loss_mam_by_calc_tmp$n_sp[2:3],
  n = aoh_loss_mam_by_calc_tmp$N[2:3]
  )

```

```{r get-stats-aoh-calc2-3, include = FALSE}
aoh_stat_tmp_by_site_max <-
  aoh_ms_tmp_trends %>%
      filter(aoh_type == "max_abn_iucn") %>%
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
  pivot_wider(names_from = trend, values_from = n_sp) %>%
  mutate(prop_wl = gain/loss) %>% 
  select(vert_class, site, prop_wl) %>% 
  arrange(vert_class, prop_wl) 

aoh_stat_tmp_by_site_max %>% print(n = 22) 
aoh_stat_tmp_by_site_max %>% group_by(vert_class) %>% slice_min(prop_wl)

aoh_stats_max <- list(
  n_gain_bird = filter(aoh_overall_tmp, 
                       aoh_type == "max_abn_iucn", overall_trend == "gain",
                       vert_class == "bird")$n_sp,
  n_gain_mam = filter(aoh_overall_tmp, 
                       aoh_type == "max_abn_iucn", overall_trend == "gain",
                       vert_class == "mam")$n_sp,
  n_loss_bird = filter(aoh_overall_tmp, 
                       aoh_type == "max_abn_iucn", overall_trend == "loss",
                       vert_class == "bird")$n_sp,
  n_loss_mam = filter(aoh_overall_tmp, 
                       aoh_type == "max_abn_iucn", overall_trend == "loss",
                       vert_class == "mam")$n_sp,
  
  wl_prop_bird_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "max_abn_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_min = aoh_stat_tmp_by_site_max %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_min(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_max = aoh_stat_tmp_by_site_max %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_max(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_iraq = round(aoh_stat_tmp_by_site_max %>% filter(site == "iraq", vert_class == "bird") %>%
    .$prop_wl, digits = 2)

)

# ------ entire landscape ------ #
aoh_stat_tmp_by_site_full <-
  aoh_ms_tmp_trends %>%
      filter(aoh_type == "full_iucn") %>%
      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
  pivot_wider(names_from = trend, values_from = n_sp) %>%
  mutate(prop_wl = gain/loss) %>% 
  select(vert_class, site, prop_wl) %>% 
  arrange(vert_class, prop_wl) 

aoh_stat_tmp_by_site_full %>% print(n = 22) 
aoh_stat_tmp_by_site_full %>% group_by(vert_class) %>% slice_min(prop_wl)

aoh_stats_full <- list(
  n_gain_bird = filter(aoh_overall_tmp, 
                       aoh_type == "full_iucn", overall_trend == "gain",
                       vert_class == "bird")$n_sp,
  n_gain_mam = filter(aoh_overall_tmp, 
                       aoh_type == "full_iucn", overall_trend == "gain",
                       vert_class == "mam")$n_sp,
  n_loss_bird = filter(aoh_overall_tmp, 
                       aoh_type == "full_iucn", overall_trend == "loss",
                       vert_class == "bird")$n_sp,
  n_loss_mam = filter(aoh_overall_tmp, 
                       aoh_type == "full_iucn", overall_trend == "loss",
                       vert_class == "mam")$n_sp,
  wl_prop_bird_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_site_sp = aoh_ms_tmp_trends %>%
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>%
    pivot_wider(names_from = trend, values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_bird_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "bird") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             overall_trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_mam_sp_w_weak = aoh_ms_tmp_trends_by_sp %>% 
    filter(aoh_type == "full_iucn") %>%
    group_by(aoh_type, vert_class, passage_type, 
             trend_direction) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    pivot_wider(names_from = contains("trend"), values_from = n_sp) %>%
    mutate(prop_wl = gain/loss) %>% filter(vert_class == "mam") %>%
    .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_min = aoh_stat_tmp_by_site_full %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_min(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_prop_site_max = aoh_stat_tmp_by_site_full %>% filter(site !="iraq") %>% 
    # group_by(vert_class) %>% 
    slice_max(prop_wl) %>% .$prop_wl %>% round(digits = 2),
  
  wl_iraq = round(aoh_stat_tmp_by_site_full %>% filter(site == "iraq", vert_class == "bird") %>%
    .$prop_wl, digits = 2)
)
```

```{r notes, eval = FALSE, include = FALSE}
#  Abstract - 150 words unreferenced
# Main text - 3500 words excluding abstract, methods, references, and figure and table captions

# captions:

6412 - 
  c(136 + 61 + 42 + 69 + 88 + 264)

15942 - 15686


# Intro to 
# Intro is 879 words
# Results are 945 words without traits models...
879 + 945
# let's say I'm able to get the traits models down to 500...
3500 - 879 - 945 - 500
# that leaves me with 1176 for the discussion


# discussion is currently:
2297

731 + # intro
  364 + 440 + 586 + #results 
  2475 # discussion

# 1379 in discussion

731 + # intro
  364 + 440 + 586 + #results 
  # 2077
  1573

3694 - 3500

2077 - 698

# after updates:
693 + # intro
  341 + 360 + 563 + #results 
  # 2077
  1573

# ==================================
# 3468: draft 2/4/2023
184 #abstract, limit is 150

690 + # intro
  1 + 342 + 360 + 199 + 360 + #results 
  1516 # discussion


# =============== revision ===================
# 3688: draft 3/25/2023
185 #abstract, limit is 150

722 + # intro
  1 + 370 + 467 + 191 + 399 + #results 
  1538 # discussion


# Second revision with VCR and RAW edits
177 # abstract

660 + # intro
  1 + 385 + 450 + 598 + # results
  1506 # discussion
# 3600 total

# 43 more!
639 + # intro
  1 + 377 + 438 + 574 + # results
  1468 # discussion
# 3496 total
```


# Abstract {.unnumbered}

Agricultural expansion is causing habitat loss in many regions, but substantial areas of cropland have also been abandoned in recent decades due to demographic shifts, socioeconomic and technological changes, and increased globalization.
Abandoned lands may represent opportunities to restore ecosystems yet variation in the distribution of species and habitats, along with a lack of detailed information on abandonment, have resulted in controversy over whether abandonment will benefit or harm biodiversity.
Here, we use annual land cover maps to estimate habitat changes for 2,023 bird and mammal species at 11 sites across 4 continents for 1987-2017.
We find that most bird (`r abstract_stats$percent_winner_bird_obs`%) and mammal species (`r abstract_stats$percent_winner_mam_obs`%) gain habitat due to cropland abandonment.
However, frequent recultivation diminished these benefits: more species would have benefited (`r abstract_stats$percent_winner_bird_pot`% and `r abstract_stats$percent_winner_mam_pot`% respectively) if recultivation had not occurred.
Furthermore, a substantial proportion of bird (`r abstract_stats$percent_loss_bird_full_obs`%) and mammal species (`r abstract_stats$percent_loss_mam_full_obs`%) experienced net habitat loss due to land clearing for agriculture prior to or concomitant with abandonment.
While abandonment represents a conservation opportunity, limiting recultivation and reducing habitat loss is critical for the future of biodiversity.

# Introduction {.unnumbered}

Habitat loss through the clearing of land for agriculture is the most widespread threat to terrestrial biodiversity [@Tilman2017], and agricultural expansion continues to threaten many ecosystems [@Potapov2022].
Yet agricultural land use change is not unidirectional: amidst continued cropland expansion, hundreds of millions of hectares of agricultural lands have been abandoned around the world since the mid-20^th^ century due to socioeconomic, demographic, and technological changes [@ReyBenayas2007; @Li2017; @Potapov2022; @Chazdon2020].
As agriculture intensifies and rural outmigration, urbanization, and globalization continue, abandonment may accelerate [@Sanderson2018; @Taylor2021], and former agricultural lands may offer low-cost opportunities to restore ecosystems [@Navarro2012], sequester carbon [@Griscom2017; @Yang2020], and recover biodiversity [@Chazdon2020; @Xie2019; @Baumann2020].

However, biodiversity is not guaranteed to benefit when cropland is abandoned.
Spatial and temporal variation in the distribution of abandonment substantially affects biodiversity outcomes because species have unique ranges and habitat requirements.
Furthermore, the recovery of natural ecosystems often requires several decades [@Acevedo-Charry2019; @Isbell2019; @Nerlekar2020].
If succession is interrupted by recultivation, which frequently occurs within a decade or two, these sites are unlikely to accumulate substantial amounts of carbon or biodiversity [@Yin2020; @Crawford2022; @Dara2018].
For these reasons, there is a controversy about the extent to which abandonment can benefit biodiversity [@Queiroz2014; @ReyBenayas2007].

The controversy about the conservation value of abandonment is strongest in Europe, where conservation often focuses on "farmland biodiversity," species that depend on open habitats and low-intensity farmland as a result of Europe's long history of cultivation, loss of natural disturbance regimes, and cultural preferences [@Batary2015; @Fischer2008; @Fischer2012a].
In those settings, abandonment is often considered negatively because it reduces landscape heterogeneity and the amount of open habitats, regardless of the potential for gains for species that could benefit from abandonment [@Queiroz2014; @Navarro2012].
In contrast, abandonment is often viewed positively in Central and South America, where it provides an opportunity for forest habitats to recover [@Queiroz2014].
Given that species have unique responses to land use change [@Sirami2008; @Finch2019], conservationists need to advance our understanding of the effects of abandonment across a wide set of species and across large landscapes covering multiple habitat types.

Though many studies have investigated the effect of abandonment on local biodiversity [@Bowen2007; @Sirami2008; @Uchida2014; @Plieninger2014; @Regos2016; @Isbell2019], few have investigated how abandonment affects biodiversity at the landscape scale across multiple regions of the world.
Crucially, prior studies generally lacked the spatial and temporal resolution required to track abandonment dynamics through time.
Given the highly dynamic nature of abandonment and the importance of regeneration time for ecosystem recovery, these details are critical to understanding the implications for biodiversity^[Daskalova & Kamp 2023 Science].

Recent efforts to improve abandonment mapping from satellite imagery provide annual maps of cropland abandonment with 30-m spatial resolution and annual time steps for many regions across the globe [@Yin2020]. 
Here, we combine high-resolution land-cover time series for 11 sites on four continents [@Yin2020] with range maps and habitat preferences for 2,023 species of birds and mammals to calculate changes in area of habitat (AOH, hereafter "habitat") [@Brooks2019] resulting from cropland abandonment annually from 1987 and 2017.

We address three questions: 
(i) How did cropland abandonment affect habitat availability for individual bird and mammal species, and how does the number of species that gain ("winners") or lose ("losers") habitat differ in each site and for different species traits?
(ii) To what extent did recultivation limit habitat gains following abandonment?
(iii) Did habitat changes resulting directly from abandonment compensate for a) the initial habitat cleared for croplands that were later abandoned or b) cropland expansion that occurred elsewhere in the site?

In answering these questions, we provide the most detailed examination to date of how cropland abandonment affects biodiversity across multiple spatial and temporal scales.
Our analysis demonstrates that cropland abandonment holds the potential to increase habitat area for most bird and mammal species at sites that have recently experienced abandonment, yet these gains rarely compensate for habitat loss that takes place prior to or alongside abandonment.
Moreover, the biodiversity benefits of abandonment are reduced by frequent recultivation of once-abandoned croplands, which limits gains for many species.
Together, these results illuminate the limited but tangible benefits of cropland abandonment for biodiversity and highlight the steps necessary to harness broad agricultural land-use transitions for the benefit of biodiversity.

# Results {.unnumbered}

(ref:caption-global-map-w-wisc) Site locations and a representative example of area of habitat (AOH) trends following cropland abandonment. *a*, locations of our 11 study sites from Yin et al. 2020 @Yin2020 (map adapted from Crawford et al. 2022 [@Crawford2022]). *b*, habitat trends (AOH, in $10^6$ ha) following cropland abandonment for all birds (n = 137) and mammals (n = 54) affected by abandonment in our site in Wisconsin, USA. Trends are grouped and colored according to statistical significance (p < 0.05) and the direction of a species' habitat trend over the course of the time series, with statistically significant increases shown in green, significant declines in gold, and no trend (p > 0.05) in black. Bold lines highlight representative species in each category: *c*, House Wren (*Troglodytes aedon*; photo by Tyler Beames, [ML469603381](https://macaulaylibrary.org/asset/469603381)); *d*, Eastern Meadowlark (*Sturnella magna*; photo by Brad Imhoff, [ML225564911](https://macaulaylibrary.org/asset/225564911)); *e*, Downy Woodpecker (*Dryobates pubescens*; photo by Ryan Brady, [ML304722431](https://macaulaylibrary.org/asset/304722431)).

```{r global-map-w-wisc, fig.cap = '(ref:caption-global-map-w-wisc)'}
knitr::include_graphics(path = paste0(p_proj, "writing/fig_1/wisconsin_example_w_map_v3.pdf"))
```

```{r main-aoh-stats-table, echo = FALSE, message = FALSE, eval = TRUE}

set_flextable_defaults(font.family = "Times New Roman", font.size = 10)
# table for MS:
# A table showing the number of species with the percent of overall in parentheses

aoh_table_tmp1 <- 
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_ms_tmp_trends %>%
  filter(aoh_type %in% c("crop_abn_iucn", "crop_abn_potential_iucn", "max_abn_iucn", "full_iucn")) %>%
    group_by(aoh_type, vert_class, #passage_type, 
             # trend
             overall_trend
             ) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>% 
  mutate(overall_trend = gsub(" ", "_", overall_trend)) %>%
  group_by(aoh_type, vert_class) %>% mutate(n = sum(n_sp)) %>% ungroup() %>%
  mutate(percent = 100*n_sp/n, combo = paste0(n_sp, " (", round(percent, digits = 1), "%)"))

aoh_table_tmp2 <- 
  aoh_table_tmp1 %>%
    pivot_wider(id_cols = c(aoh_type, vert_class), 
                names_from = contains("trend"), values_from = n_sp) %>%
  mutate(win_loss = round(gain/loss, digits = 2),
         win_loss_weak = round((gain + weak_gain) / (loss + weak_loss), digits = 1),
         win_loss = paste0(win_loss, " (", win_loss_weak, ")")) %>%
  select(aoh_type, vert_class, contains("win_loss"))


# print table
aoh_table_tmp1 %>%
  pivot_wider(id_cols = c(aoh_type, vert_class), 
              names_from = contains("trend"), values_from = combo) %>%
  select(aoh_type, vert_class, gain, weak_gain, loss, no_trend, context_dependent, weak_loss) %>%
  arrange(aoh_type) %>%
  left_join(aoh_table_tmp2) %>%
  mutate(vert_class = as_factor(case_when(vert_class == "bird" ~ "Birds", 
                                          vert_class == "mam" ~ "Mammals")),
    aoh_type = case_when(
      aoh_type == "crop_abn_iucn" ~ "1. Abandonment",
      aoh_type == "crop_abn_potential_iucn" ~ "1b. Abandonment, assuming no recultivation",
      aoh_type == "max_potential_abn_iucn" ~ "Net change in abandoned pixels, no recult. (1987-2017)",
      aoh_type == "full_potential_iucn" ~ "Full site, no recult. (1987-2017)",
      aoh_type == "max_abn_iucn" ~ "2. Net change in abandoned croplands (1987-2017)",
      aoh_type == "full_iucn" ~ "3. Entire spatial extent (1987-2017)"      
    )) %>%
  select("AOH Calculation" = aoh_type, "Vert. Class" = vert_class,
         "Gain" = gain, "Loss" = loss,
         "Weak Gain" = weak_gain, "Weak Loss" = weak_loss, 
         "Conflicting" = context_dependent,
         "No Trend" = no_trend, 
         "Gain/Loss Ratio" = win_loss,
         # "Gain/Loss Ratio (incl. weak trends)" = win_loss_weak
         ) %>%
  # {if (doc_type == "word") 
    flextable(.) %>% 
      theme_booktabs(.) %>%
      flextable::footnote(
        ., i = 1, j = 9,
        value = as_paragraph("Ratio in parentheses includes weak trends."),
        ref_symbols = c("1"),
        part = "header", #inline = TRUE, sep = "; "
        ) %>% 
      merge_v(., j = 1) %>%
      # valign(j = 1, valign = "top") %>%
      colformat_double(., digits = 2) %>%
      fontsize(., size = 10, part = "all") %>%
      set_caption(
        ., 
        caption = as_paragraph(
          "Trends in habitat area (AOH) for birds and mammals following cropland abandonment for three spatial and temporal scales: ", 
          as_b("1"), ", habitat changes directly attributable to cropland abandonment (tracking habitat provided by these lands from the year of first cultivation through 2017); ",
          as_b("1b"), ", habitat changes directly attributable to cropland abandonment, assuming no recultivation; ",
          as_b("2"), ", net habitat change in abandoned croplands across the entire temporal extent (1987-2017), accounting for cropland expansion and habitat loss that occurred during the time series but prior to abandonment; ",
          as_b("3"), ", net habitat change across the entire temporal (1987-2017) and spatial extent at each site, accounting for persistent cropland expansion (see visual representation in Fig. 16). Species that occur at multiple sites are listed as \"gain\" when they show consistent and significant (p < 0.05) gains at each site in which they occur. Species with significant gains at some sites and no significant trend (p > 0.05) at others are listed as \"weak gain.\" \"Loss\" and \"weak loss\" follow the same convention. Species that show significant gains at some sites and significant losses at others are listed as \"conflicting.\""),
        html_escape = TRUE) %>%
      autofit(.)
```

## Changes in habitat area resulting from cropland abandonment {.unnumbered}

Overall, we found that most bird (`r aoh_stats_main$n_gain_bird_percent`%) and mammal (`r aoh_stats_main$n_gain_mam_percent`%) species at our sites consistently gained habitat (AOH) from abandonment, experiencing statistically significant (p < 0.05) and positive trends in habitat area everywhere they occurred (Table \@ref(tab:main-aoh-stats-table), Fig. \@ref(fig:aoh-by-site-crop-abn-prop)).
In contrast, only `r aoh_stats_main$n_loss_bird_percent`% of birds and `r aoh_stats_main$n_loss_mam_percent`% of mammals lost habitat consistently across sites due to abandonment (Table \@ref(tab:main-aoh-stats-table), Fig. \@ref(fig:aoh-by-site-crop-abn-prop)).
However, some species exhibited contrasting trends at different sites: `r aoh_stats_main$n_w_gain_bird_percent`% of birds and `r aoh_stats_main$n_w_gain_mam_percent`% of mammals gained habitat at some sites but showed no trend (p > 0.05) at others (i.e., weak gains), while `r aoh_stats_main$n_w_loss_bird_percent`% and `r aoh_stats_main$n_w_loss_mam_percent`% respectively lost habitat at some sites but not others (i.e., weak losses, Table \@ref(tab:main-aoh-stats-table); see Table \@ref(tab:aoh-stats-table-all-obs) for the number of individual species-site trends). 
Additionally, `r aoh_stats_main$n_opposite_bird_percent`% of birds and `r aoh_stats_main$n_opposite_mam_percent`% of mammals exhibited significant gains at some sites and significant losses at others.

The ratio of winners to losers varied among sites, but was always greater than one (Fig. \@ref(fig:aoh-by-site-crop-abn-prop), Table \@ref(tab:aoh-stats-by-site)), except for birds in Iraq (the site with the lowest species richness; Fig. \@ref(fig:richness-by-site)), where `r 100*(1-aoh_stats_main$wl_iraq)`% more species lost than gained habitat (Figs. \@ref(fig:aoh-by-site-crop-abn-prop) and \@ref(fig:aoh-by-site-crop-abn)).
In general, a greater share of mammal species gained habitat than did bird species, both at individual sites (Fig. \@ref(fig:aoh-by-site-stacked)) and overall (Fig. \@ref(fig:aoh-overall-stacked-w-pot)) [two-sample proportion test: $X^2$ (df = `r p_test_gain_m_v_b$parameter`, *N* = `r sum(aoh_gain_bird_v_mam_tmp$N)`) = `r round(p_test_gain_m_v_b$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_m_v_b$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_m_v_b$p.value, digits = 2)))`].
Of the 66 threatened species occurring at our sites (Fig. \@ref(fig:richness-by-site)), `r prettyNum(round(100*p_test_iucn_all$estimate[2], 1), nsmall = 1)`% gained habitat following abandonment (Fig. \@ref(fig:aoh-iucn-by-site-crop-abn)), approximately the same proportion as for non-threatened species [`r prettyNum(round(100*p_test_iucn_all$estimate[1], 1), nsmall = 1)`%; two-sample proportion test: $X^2$ (df = `r p_test_iucn_all$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% .$N %>% sum()`) = `r prettyNum(round(p_test_iucn_all$statistic, digits = 2), nsmall = 2)`, *p* `r ifelse(p_test_iucn_all$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_all$p.value, digits = 2)))`].
Only nine small-ranged species (3 birds and 6 mammals with ranges smaller than the global median) occurred at our sites, out of which eight gained habitat (Fig. \@ref(fig:aoh-by-range)).

```{r effect-size-stats, include = FALSE}
# three stats to report
# 1. overall change in AOH
# 2. change in AOH as percent of site area
# 3. ratio of AOH

# estimated or observed
# aoh_est_change_tmp_all
# aoh_obs_change_tmp_all
# aoh_obs_change_tmp_all %>% group_by(aoh_type) %>% nest()


# by vert_class and trend
# ----------------------------------------- #
# aoh_obs_change_tmp %>%
aoh_obs_change_tmp_all %>% filter(str_detect(aoh_type, "crop")) %>%
  select(aoh_type, vert_class, site, ratio, binomial, trend) %>%
  group_by(aoh_type, trend, vert_class,
           factor = case_when(ratio >= 2 ~ "doubled",
                              ratio <= 0.5 ~ "halved",
                              TRUE ~ "NA")
           ) %>%
  summarise(num = n()) %>% ungroup() %>%
  group_by(aoh_type, trend, vert_class) %>% mutate(total_sp = sum(num)) %>% ungroup() %>%
  mutate(share = num/total_sp)


# Lumping birds and mammals together:
# ----------------------------------------- #
share_halved_or_doubled_df <-
  # aoh_obs_change_tmp %>%
  aoh_obs_change_tmp_all %>% filter(str_detect(aoh_type, "crop")) %>%
  select(aoh_type, vert_class, site, ratio, binomial, trend) %>%
  group_by(aoh_type, trend, #vert_class,
           factor = case_when(ratio >= 2 ~ "doubled",
                              ratio <= 0.5 ~ "halved",
                              TRUE ~ "NA")
           ) %>%
  summarise(num = n()) %>% ungroup() %>%
  group_by(aoh_type, trend, #vert_class
           ) %>% mutate(total_sp = sum(num)) %>% ungroup() %>%
  mutate(share = round(100*num/total_sp, digits = 1))


# Mean and median AOH changes
# ----------------------------------------- #
mean_effect_size_df <-
  # aoh_obs_change_tmp %>%
  aoh_obs_change_tmp_all %>% filter(str_detect(aoh_type, "crop")) %>%
  filter(window_size == 5) %>%
  group_by(aoh_type, trend) %>%
  summarise(n = n(), 
            mean_change_percent = mean(abs_change_percent_site), 
            median_change_percent = median(abs_change_percent_site),
            mean_ratio = mean(ratio),
            median_ratio = median(ratio)) %>%
  ungroup() %>%
  pivot_longer(cols = contains(c("mean","median")), names_to = "stat") %>%
  mutate(value = round(abs(value), digits = 1)) %>%
  arrange(stat)

mean_effect_size_df %>% print(n= 50)

mean_effect_size_df %>%
  mutate(aoh_type = case_when(str_detect(aoh_type, "potential") ~ "pot",
                              TRUE ~ "obs"),
         measure = case_when(str_detect(stat, "ratio") ~ "ratio",
                             str_detect(stat, "percent") ~ "percent"
                             ),
         stat = case_when(str_detect(stat, "mean") ~ "mean",
                          str_detect(stat, "median") ~ "median")) %>%
    # pivot_wider(id_cols = c(aoh_type, stat), names_from = trend, values_from = value)
    pivot_wider(id_cols = c(stat, measure, trend), names_from = aoh_type, values_from = value)

effect_size_stats_tmp <- list(
  share_doubled_obs = share_halved_or_doubled_df %>% 
    filter(aoh_type == "crop_abn_iucn", trend == "gain", factor == "doubled") %>% pull(share),
  
  share_halved_obs = share_halved_or_doubled_df %>% 
    filter(aoh_type == "crop_abn_iucn", trend == "loss", factor == "halved") %>% pull(share),

  share_doubled_pot = share_halved_or_doubled_df %>% 
    filter(aoh_type == "crop_abn_potential_iucn", trend == "gain", factor == "doubled") %>% pull(share),
  
  share_halved_pot = share_halved_or_doubled_df %>% 
    filter(aoh_type == "crop_abn_potential_iucn", trend == "loss", factor == "halved") %>% pull(share),  

  mean_aoh_gained_percent_obs = mean_effect_size_df %>% 
    filter(aoh_type == "crop_abn_iucn", trend == "gain", stat == "mean_change_percent") %>% pull(value),
    
  mean_aoh_lost_percent_obs = mean_effect_size_df %>% 
    filter(aoh_type == "crop_abn_iucn", trend == "loss", stat == "mean_change_percent") %>% pull(value), 
  
  mean_aoh_gained_percent_pot = mean_effect_size_df %>% 
    filter(aoh_type == "crop_abn_potential_iucn", trend == "gain", stat == "mean_change_percent") %>% pull(value),
    
  mean_aoh_lost_percent_pot = mean_effect_size_df %>% 
    filter(aoh_type == "crop_abn_potential_iucn", trend == "loss", stat == "mean_change_percent") %>% pull(value)
)
```

Though the vast majority of species habitat trends were positive, those with declining trends lost a larger amount of habitat on average (`r effect_size_stats_tmp$mean_aoh_lost_percent_obs`% of site area) than those with increasing trends gained (`r effect_size_stats_tmp$mean_aoh_gained_percent_obs`% of site area; Fig. \@ref(fig:aoh-change-percent-by-trend)).
However, the opposite pattern played out for changes in habitat area relative to that which species had at the beginning of the time series: `r effect_size_stats_tmp$share_doubled_obs`% of winners doubled their habitat (or more), while only `r effect_size_stats_tmp$share_halved_obs`% of losers halved their habitat (or worse; Fig. \@ref(fig:log-ratio-aoh-change-by-site)).

(ref:caption-aoh-by-site-crop-abn-prop) Species responses to cropland abandonment shown as the proportion of bird and mammal species with various trends in area of habitat (AOH). Habitat changes are calculated by tracking habitat provided by abandoned croplands from the year of first cultivation through 2017 (Calculation 1, see Methods). The number of bird and mammal species at each site is listed in x-axis labels, and the total number of species across all sites is shown at far left ("Overall"). The number of species in each trend at each site are shown in Fig. \@ref(fig:aoh-by-site-crop-abn). Observed and modeled habitat (AOH) trends for individual species are shown in Figs. \@ref(fig:aoh-sp-obs-crop-abn) and \@ref(fig:aoh-trend-lines-crop-abn). Trends are labeled according to the conventions listed in Table 1.

```{r aoh-by-site-crop-abn-prop, fig.cap = '(ref:caption-aoh-by-site-crop-abn-prop)'}
# ^[Note: this could be replaced with a stacked proportion figure like Fig. \@ref(fig:aoh-by-site-stacked-crop-abn).]

knitr::include_graphics(path = paste0(
  p_plots, 
  # "aoh/aoh_overall_w_site_combo_crop_abn_iucn",
  "aoh/aoh_overall_w_site_prop_combo_crop_abn_iucn", # proportional
  aoh_run_date, "_no_lab_no_border.pdf"))
```

(ref:caption-aoh-change-percent-by-trend) The distribution of changes in area of habitat (AOH) as a percent of site area for species with gains, losses, and no trend in habitat. Change in AOH was calculated as the difference in mean AOH during the first five years and the last five years of the time series. Note differing y-axis scales. Distributions at each site are shown in Fig. \@ref(fig:aoh-change-percent-by-site).

```{r aoh-change-percent-by-trend, fig.cap = '(ref:caption-aoh-change-percent-by-trend)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_change_percent_site_obs_by_trend_5.pdf"))
```

## Influence of species' traits on response to abandonment {.unnumbered}

```{r traits-stats, include = FALSE, cache = TRUE}
# trait_mod_df <- readRDS(file = paste0(p_derived, "traits/", "trait_mod_df", mod_label, ".rds"))
trait_mod_df <- readRDS(file = paste0(p_derived, "traits/", "trait_mod_df", mod_label, ".rds"))

# Trait model coefficients:
trait_mod_coefs <- 
  trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  select(response, aoh_type, tidy) %>%
  unnest(cols = c(tidy)) %>%
  mutate(
    estimate = case_when(
      response %in% c("binary_gain_v_loss", "log(ratio)") ~ exp(1) ^ estimate,
      TRUE ~ estimate),
    estimate = case_when(p.value < 0.05 ~ estimate),
    estimate = round(estimate, digits = 2),
    response = case_when(response == "binary_gain_v_loss" ~ "binary",
                              response == "abs_change_percent_site" ~ "percent",
                              response == "log(ratio)" ~ "log_ratio")
    )


trait_mod_coefs %>%
  select(aoh_type, response, term, estimate) %>%
  pivot_wider(id_cols = c(aoh_type, term), names_from = "response", values_from = "estimate")
```

To explore which ecological factors are associated with species' responses to cropland abandonment, we fit three linear models using species traits to predict 1) area of habitat trend (gain or loss), 2) magnitude of habitat change (as a percent of site area), and 3) relative change in habitat (the ratio of final to initial AOH).
We found that species habitat preferences (i.e., which habitats can be occupied by a species and are therefore considered "suitable" habitats) had a significant effect on responses to abandonment.
The ability to occupy grassland, forest, or savanna habitats all increased the odds of a species gaining habitat, with grassland suitability (i.e., the ability to occupy abandoned croplands that return to grassland) having the most substantial effect, increasing the odds of being a winner by a factor of `r filter(trait_mod_coefs, response == "binary", str_detect(term, "grassland")) %>% pull(estimate)`, compared to `r filter(trait_mod_coefs, response == "binary", str_detect(term, "forest")) %>% pull(estimate)` and `r filter(trait_mod_coefs, response == "binary", str_detect(term, "savanna")) %>% pull(estimate)` for forest and savanna suitability, respectively (Table \@ref(tab:traits-mod-table-main)).
Grassland and savanna suitability were also associated with larger increases in habitat overall: on average, species that can occupy grasslands and savannas gained an additional area of habitat equal to `r filter(trait_mod_coefs, response == "percent", str_detect(term, "grassland")) %>% pull(estimate)`% and `r filter(trait_mod_coefs, response == "percent", str_detect(term, "sav")) %>% pull(estimate)`% of site area, respectively (a habitat increase of `r filter(trait_mod_coefs, response == "percent", str_detect(term, "grassland")) %>% pull(estimate)`% of site area represents an increase in absolute area of `r filter(trait_mod_coefs, response == "percent", str_detect(term, "grassland")) %>% pull(estimate)` percentage points, e.g., from 10% to `r filter(trait_mod_coefs, response == "percent", str_detect(term, "grassland")) %>% pull(estimate) + 10`% or 2% to `r filter(trait_mod_coefs, response == "percent", str_detect(term, "grassland")) %>% pull(estimate) + 2`%).
Species that occupy grassland and forest habitats saw larger relative increases in habitat area over time (by a factor of `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "grassland")) %>% pull(estimate)` and `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "for")) %>% pull(estimate)` respectively), but species with savanna and shrubland suitability experienced smaller relative changes (reducing habitat area by factors of `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "sav")) %>% pull(estimate)` and `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "shrub")) %>% pull(estimate)` respectively, Table \@ref(tab:traits-mod-table-main)).
Wetland, rocky habitat, and urban area suitability were each associated with losing habitat, but arable land suitability was by far the strongest predictor that a species would lose habitat following abandonment, being associated with a `r filter(trait_mod_coefs, response == "binary", str_detect(term, "arable")) %>% pull(estimate)` factor reduction in the odds of being a winner, an absolute habitat reduction of `r -1 * (filter(trait_mod_coefs, response == "percent", str_detect(term, "arable")) %>% pull(estimate))`% of site area, and a relative reduction in the habitat by a factor of `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "arable")) %>% pull(estimate)`.

Species using a greater number of habitats or with larger ranges had larger increases in habitat area, with species' habitat increasing by `r filter(trait_mod_coefs, response == "percent", str_detect(term, "n_suitable")) %>% pull(estimate)`% of site area for each additional habitat type they could occupy and `r filter(trait_mod_coefs, response == "percent", str_detect(term, "range")) %>% pull(estimate)`% of site area for each order of magnitude increase in range size. 
Tropical species benefited more than temperate species: for each additional degree of latitude the center of a species' range is from the equator, habitat declined by `r -1*(filter(trait_mod_coefs, response == "percent", str_detect(term, "latitude")) %>% pull(estimate))`% of site area.
Range area and latitude were also associated with larger relative gains in habitat.
Preferences for cave or desert habitats, vertebrate class, IUCN threat status, trophic level, and body mass did not have significant associations across any of our models (Table \@ref(tab:traits-mod-table-main)).

```{r traits-mod-table-old, echo = FALSE, message = FALSE, eval = FALSE, include = FALSE}
# Final Three Models:
trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  pull(gt) %>%
  tbl_merge(tab_spanner = c(
    "Binary Trend (gain or loss)",
    "\U0394 AOH / site area (%)",
    "ln(Ratio)"
    )) %>%
  # {if (doc_type == "word") 
    as_flex_table(.) %>%
      flextable::footnote(
        ., i = 1, j = 6, 
        value = as_paragraph("Ratio = AOH", as_sub("end"), " / AOH", as_sub("start")),
        ref_symbols = c("a"),
        part = "header", #inline = TRUE, sep = "; "
        ) %>%
      fontsize(., size = 10, part = "all") %>%
      theme_booktabs(.) %>%
      set_caption(., 
                  # caption = '(ref:caption-traits-mod-table-main)',
                  caption = "Coefficients for three linear models predicting species' response to cropland abandonment with various traits.",
                  html_escape = TRUE) %>%
      autofit(.) 
    # else as_kable_extra(., caption = '(ref:caption-traits-mod-table-main)')}

```

```{r traits-mod-table-main, echo = FALSE, message = FALSE, eval = TRUE}

# coefs:
trait_coefs_tmp <- 
  trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  select(response, tidy) %>%
  unnest(c(tidy)) %>%
  mutate(
    response = case_when(response == "binary_gain_v_loss" ~ "binary",
                         response == "abs_change_percent_site" ~ "percent",
                         response == "log(ratio)" ~ "logratio"),
    # exponentiate log(ratio) coefs
    estimate = case_when(response == "logratio" ~ exp(1)^estimate, 
                         str_detect(response, "binary") ~ exp(1)^estimate, 
                         TRUE ~ estimate)) %>%
    select(-c(std.error, statistic))

# glance:
trait_glance_tmp <-
  trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  select(response, glance) %>%
  unnest(c(glance)) %>%
  mutate(response = case_when(response == "binary_gain_v_loss" ~ "binary",
                              response == "abs_change_percent_site" ~ "percent",
                              response == "log(ratio)" ~ "logratio")) %>%
  pivot_longer(cols = c(-response)) %>%
  select(response, term = name, estimate = value) %>%
  filter(!term %in% c("AIC", "BIC", "r.squared", "statistic", "p.value"))

# =============================================== #
trait_tab_tmp <-
  bind_rows(trait_coefs_tmp, trait_glance_tmp) %>%
  pivot_longer(cols = c(estimate, p.value)) %>%
  pivot_wider(id_cols = term, names_from = c(response, name),
              values_from = value)

# ------------ build final table ------------- #
bind_rows(trait_tab_tmp[1,],
          tibble(term = "Suitable Habitat Types (i.e., Can Occupy)"),
          trait_tab_tmp[2:12, ],
          tibble(term = "vert_class"),
          tibble(term = "vert_classBirds", binary_estimate = 1, 
                 percent_estimate = 0, logratio_estimate = 0),
          trait_tab_tmp[13:14, ],
          tibble(term = "Trophic_level"),
          tibble(term = "Trophic_levelCarnivore", binary_estimate = 1, 
                 percent_estimate = 0, logratio_estimate = 0),
          trait_tab_tmp[15:29, ]) %>% #print(n = 50)
  flextable() %>%
  # flextable::separate_header(., split = "_") %>%
  colformat_double(j = c(2, 4, 6), digits = 2) %>%
  colformat_double(i = ~ grepl("dev|Lik|df.|nobs", term),
                   j = c(2, 4, 6), digits = 0) %>%
  colformat_double(j = c(3, 5, 7), digits = 3) %>%
  bold(~ binary_p.value < 0.05, j = c("binary_p.value", "binary_estimate"), bold = TRUE) %>%
  bold(~ percent_p.value < 0.05, j = c("percent_p.value", "percent_estimate"), bold = TRUE) %>%
  bold(~ logratio_p.value < 0.05, j = c("logratio_p.value", "logratio_estimate"), bold = TRUE) %>%
  compose(~ binary_p.value < 0.001, j = 3, 
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(~ percent_p.value < 0.001, j = 5,
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(~ logratio_p.value < 0.001, j = 7, 
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(i = ~ grepl("mass", term), j = ~term, 
          as_paragraph("log", as_sub("10"), "(Body Mass, g)")) %>%
  compose(i = ~ grepl("range", term), j = ~term, 
          as_paragraph("log", as_sub("10"), "(Global Range Area, km", as_sup("2"), ")")) %>%
  compose(i = ~ grepl("squared", term), j = ~term, 
          as_paragraph("Adjusted R", as_sup("2"))) %>%
  prepend_chunks(i = ~ grepl("Birds|Mammals|vore|occTRUE", term),
                 j = "term", as_chunk("\t")) %>%
  italic(i = ~ grepl("Birds|Mammals|vore|dev|Lik|df|nobs|r.sq|sigma", term),
         ~ term, italic = TRUE) %>%
  labelizor(part= "all", labels = regression_model_flextable_labels) %>%
  add_header_row(values = c(
    "", "Binary Trend\n(gain or loss)", "\U0394 AOH / site area (%)",
    "ln(Ratio)"),
    colwidths = c(1, 2, 2, 2)) %>%
  compose(i = 1, j = 6, part = "header",
          as_paragraph("ln(AOH", as_sub("end"), " / AOH", as_sub("start"), ")")) %>%
  compose(i = 2, j = 2, part = "header", as_paragraph("Odds Ratio")) %>%
  compose(i = 2, j = 6, part = "header", as_paragraph("e", as_sup("Beta"))) %>%
  flextable::footnote(i = c(2), j = c(6),
    value = c(#as_paragraph("OR = Odds Ratio"),
              as_paragraph("Exponentiated coefficient value") #,
              # as_paragraph("Ratio = AOH", as_sub("end"), " / AOH", as_sub("start"))
              ),
   ref_symbols = c("1"), part = "header"#, inline = TRUE, sep = "; "
   ) %>%
  fontsize(., size = 10, part = "all") %>%
  theme_booktabs(.) %>%
  set_caption(.,
              caption = "Regression coefficients for three linear models predicting species' responses to cropland abandonment with various traits.") %>%
  autofit(.) %>%
  hline(i = 25, part = "body")
  

```

## Effects of recultivation on habitat area {.unnumbered}

Many abandoned croplands were recultivated during our study period (38.05% on average across sites @Crawford2022), which affected species area of habitat (AOH) substantially.
Had no recultivation occurred, the percentage of consistent winners would have been `r obs_v_pot_stats$n_gain_bird_pot_percent`% instead of `r aoh_stats_main$n_gain_bird_percent`% for birds and `r obs_v_pot_stats$n_gain_mam_pot_percent`% instead of `r aoh_stats_main$n_gain_mam_percent`% for mammals (Table \@ref(tab:main-aoh-stats-table), Fig. \@ref(fig:aoh-obs-v-pot-by-site); both were statistically significant increases, see SI Section \@ref(si-prop-test-results)).
However, a lack of recultivation would have also slightly increased the number of losers (from `r aoh_stats_main$n_loss_bird_percent`% to `r obs_v_pot_stats$n_loss_bird_pot_percent`% for birds and `r aoh_stats_main$n_loss_mam_percent`% to `r obs_v_pot_stats$n_loss_mam_pot_percent`% for mammals, Table \@ref(tab:main-aoh-stats-table)).

Species in Mato Grosso were most dramatically affected by recultivation, where an additional `r filter(n_aoh_trend_changes_by_site_df, site == "mato_grosso")$gain` species would have gained habitat while only an additional `r filter(n_aoh_trend_changes_by_site_df, site == "mato_grosso")$loss` would have lost habitat were recultivation prevented.
Aside from Chongqing (`r filter(n_aoh_trend_changes_by_site_df, site == "chongqing")$gain` additional winners, `r filter(n_aoh_trend_changes_by_site_df, site == "chongqing")$loss` additional losers) and Nebraska / Wyoming (`r filter(n_aoh_trend_changes_by_site_df, site == "nebraska")$gain` additional winners), all other sites experienced fewer than 3 additional winners or losers in our scenario without recultivation (Fig. \@ref(fig:aoh-obs-v-pot-by-site), Table \@ref(tab:aoh-changes-obs-v-pot)).
Preventing recultivation also would have amplified the magnitude of habitat changes, with both winners gaining and losers losing more habitat (Figs. \@ref(fig:aoh-p-change-obs-v-pot-bird)-\@ref(fig:aoh-p-change-obs-v-pot-mam)).
This effect was more intense for losers, who lost `r obs_v_pot_stats$mean_p_loss_same`% more habitat on average, while winners only gained `r obs_v_pot_stats$mean_p_gain_same`% more habitat on average.

## Abandonment in the context of broader land cover changes {.unnumbered}

Thus far, we have examined whether abandonment results in more or less habitat relative to actively cultivated cropland (Calculation 1, Table \@ref(tab:main-aoh-stats-table), Fig \@ref(fig:aoh-sample-trajectories)).
However, the original land cover at the beginning of our study period is another important consideration when evaluating the magnitude of benefits from abandonment.
Accordingly, we examine whether the benefits of abandonment could compensate for (i) the initial habitat loss prior to the cultivation of croplands that were later abandoned (Calculation 2) or (ii) habitat loss that occurred elsewhere due to cropland expansion (Calculation 3)?
In other words, did abandonment return habitat levels on abandoned croplands to their pre-cultivation baseline (i.e., relative to the start of the time series), or make up for cropland expansion taking place elsewhere at the site?
When considering the net habitat change after incorporating these other land use change processes, the ratio of winners to losers became much less favorable (Fig. \@ref(fig:aoh-overall)): more bird species lost habitat than gained it, and about equal numbers of mammals lost as gained (Table \@ref(tab:main-aoh-stats-table), Figs. \@ref(fig:aoh-overall-stacked-w-pot) and \@ref(fig:aoh-overall-w-pot)).
Both declines in the share of winning species were statistically significant (see SI Section \@ref(si-prop-test-results)).

While more species lost than gained habitat at all sites when factoring in both cropland abandonment and expansion (Fig. \@ref(fig:aoh-by-site-stacked)), these increases were most pronounced in Mato Grosso, Brazil, where less cropland abandonment and much more cropland expansion occurred than at the other sites (see site-specific results in Figs. \@ref(fig:aoh-by-site-max-abn) and \@ref(fig:aoh-by-site-full)).
Our sites in Bosnia & Herzegovina; Chongqing, China; Gois, Brazil; and Iraq also had ratios of winners to losers that were less than one after accounting for cropland expansion, but the other sites had narrowly favorable ratios (particularly for mammal species).
Similarly, a greater share of threatened species lost habitat when factoring in cropland expansion prior to or concomitant with abandonment, but not statistically more so than non-threatened species (Fig. \@ref(fig:aoh-by-iucn-lumped)).
Limiting recultivation would have reduced the number of losing species in both of these broader habitat calculations, and would have resulted in a favorable ratio of winners to losers even after factoring in habitat clearing for agriculture prior to abandonment (Calculations 2 and 3; Figs. \@ref(fig:aoh-overall-stacked-w-pot) and \@ref(fig:aoh-overall-w-pot)).
However, limiting recultivation would have had a positive but much smaller effect when considering habitat changes through the entire spatial extent (Calculation 3).

(ref:caption-aoh-overall) The number of bird and mammal species with various trends in area of habitat (AOH) across our 11 study sites from 1987-2017. Columns correspond to three different habitat calculations: *1*, habitat changes due to cropland abandonment (from first cultivation through 2017), accounting for recultivation; *1b*, habitat changes from abandonment, assuming no recultivation; *2*, net habitat changes in abandoned croplands across the entire temporal extent (1987-2017), accounting for habitat cleared for agriculture prior to abandonment; and *3*, habitat changes across the entire spatial extent at each site (1987-2017). Results for all habitat (AOH) calculations are shown as proportions in Fig. \@ref(fig:aoh-overall-stacked-w-pot) and raw counts in Fig. \@ref(fig:aoh-overall-w-pot). Site-specific proportions are shown in Fig. \@ref(fig:aoh-by-site-stacked) and raw counts are shown for habitat calculations 1b, 2, and 3 in Figs. \@ref(fig:aoh-by-site-crop-abn-potential), \@ref(fig:aoh-by-site-max-abn), and \@ref(fig:aoh-by-site-full), respectively.

```{r aoh-overall, fig.cap = '(ref:caption-aoh-overall)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_trend_by_vert_aoh_type", aoh_run_date,
  "_incl_pot",
  ".pdf"))
```

# Discussion {.unnumbered}

Increasing rates of global cropland abandonment are reshaping agricultural landscapes around the world.
Our study, the first multi-continental assessment of the biodiversity impacts of cropland abandonment, shows that abandonment *per se* increases habitat for the majority of bird and mammal species (Fig \@ref(fig:aoh-by-site-crop-abn-prop)).
These gains largely reflect species' habitat preferences, such that species that can occupy forests and grasslands were more likely to gain habitat, and species that occupy arable land were most likely to lose habitat. 
This reflects how abandonment affects the availability of specific habitat types, and in turn which species are affected.
Species with larger ranges, ranges closer to the equator, or the ability to use a greater number of habitats were more likely to gain habitat due to abandonment.
Overall, a greater share of bird species experienced declines in habitat following abandonment than mammals (Fig \@ref(fig:aoh-by-site-crop-abn-prop), Table \@ref(tab:main-aoh-stats-table)), though most birds and mammals still gained habitat overall.
The overall proportion of winners did not differ significantly for threatened versus non-threatened species (Fig. \@ref(fig:aoh-iucn-by-site-crop-abn)) nor for large- versus small-ranged species (Fig. \@ref(fig:aoh-by-range)).
From a conservation perspective, it is encouraging that the majority of threatened and small-ranged species, which are often considered to be of greatest conservation concern, experienced gains in habitat.

However, habitat gains from abandonment were not uniform across species and sites, and abandonment rarely compensated for habitat lost due to cropland expansion, regardless of whether these newly cultivated croplands were subsequently abandoned or not.
Most concerningly, habitat gains from abandonment were dampened by frequent recultivation: the ephemerality of abandonment reduced both the overall share of species with increasing trends (Figs. \@ref(fig:aoh-overall) and \@ref(fig:aoh-obs-v-pot-by-site), Table \@ref(tab:aoh-changes-obs-v-pot)) and the magnitude of habitat gained per species during our study period (Fig. \@ref(fig:aoh-change-percent-by-trend-obs-v-pot)).
This suggests that, despite the clear potential for abandonment to generate habitat for bird and mammal species, expectations for abandonment to reverse trends for declining species will need to be tempered because most landscapes are still experiencing habitat loss coupled with recultivation.

Our sites represented nine different biomes where differences in species communities, species richness, and the distributions of habitats produced unique responses to abandonment (Fig. \@ref(fig:site-biomes)).
In our three sites in the tropics (Figs. \@ref(fig:global-map-w-wisc)a and \@ref(fig:site-biomes)), we found the highest number of winning species, led by Mato Grosso and Gois, Brazil (Table \@ref(tab:aoh-stats-by-site); Fig. \@ref(fig:aoh-by-site-crop-abn)).
Tropical sites also showed the largest overall benefits from abandonment, with the highest absolute numbers of species gaining habitat due to high species richness in the tropics and the high sensitivity of many tropical species to habitat modification (i.e., a smaller fraction of the tropical species in our sites can persist in artificial habitats compared to temperate species; see Figs. \@ref(fig:p-arable-suitability) and \@ref(fig:latitude-v-arable-suitability)).
However, we note that Mato Grosso experienced the least cropland abandonment of any site and thus remained dominated by habitat loss, which led to relatively small gains in habitat (one or two orders of magnitude less for individual species than in other sites, whether area is measured in absolute terms or as a percent of site extent; Fig. \@ref(fig:aoh-sp-obs-crop-abn)) and the greatest share of species with losing trends when accounting for land cover changes throughout the site (Fig. \@ref(fig:aoh-by-site-stacked)).
Though less speciose, our sites in temperate grassland biomes (Volgograd, Russia; Orenburg, Russia / Uralsk, Kazakhstan; Nebraska / Wyoming, USA) had among the highest shares of winners overall ($\geq 80$%; Table \@ref(tab:aoh-stats-by-site), Fig. \@ref(fig:aoh-by-site-crop-abn-prop)).
Interestingly, Iraq showed the most unfavorable response to abandonment, with the highest proportion of species declining following abandonment of any site (Fig. \@ref(fig:aoh-by-site-crop-abn-prop), Table \@ref(tab:aoh-stats-by-site)).
This may be due to the relative refuge provided by croplands amidst a harsh desert environment or Iraq's long history of human cultivation [@Balter2007; @Batary2015].

Our finding of overall positive outcomes of abandonment contrast with much of the existing literature on biodiversity and abandonment.
A review of existing studies [@Queiroz2014] showed that most site-specific studies reported that abandonment had negative effects on biodiversity overall. 
However, these outcomes substantially varied by taxonomic focus, biodiversity metrics, agricultural system, and whether biodiversity changes were framed in terms of the conservation value of pre-abandonment landscapes (i.e., farmland biodiversity) or post-abandonment ecosystems (i.e., regenerating through secondary succession).
Research perspectives on abandonment also varied by region (with predominantly negative views of abandonment in Europe and Asia), potentially the result of differences in conservation focus (e.g., which species are considered, and at what scale), or geographic differences in biodiversity responses [@Queiroz2014].

Our multi-continental results echo the heterogeneous species responses shown in prior studies [@Sirami2008;@Regos2016], but provide a more positive assessment of abandonment overall.
We found more species benefiting from abandonment than suffering from it in 10 of the 11 sites we studied across four continents.
Though lacking sites in Western or Central Europe, where previous studies have shown abandonment-related biodiversity declines, our results indicate that negative responses to abandonment (e.g., Iraq) may be regionally restricted.
Notably, even species inhabiting open habitats like grasslands and savannas benefited from abandonment at our sites, contrary to concerns that they might typically be "losers" in land abandonment scenarios.
However, the benefits of abandonment are typically overshadowed by cropland expansion at each site and by recultivation of abandoned sites, which our results show can produce overall declines despite gains from abandonment.
Though habitat regeneration following abandonment would benefit most birds and mammals at almost all of our sites, species that stand to lose habitat from this process should be monitored, and when necessary, incorporated into conservation planning efforts to ameliorate habitat losses, with particular attention given to the maintenance of open habitats that support threatened or rare species.

Our study has a few limitations.
First, we analyzed remotely-sensed land cover data interpolated to specific habitat types as delineated by IUCN [@IUCN2021] and BirdLife International [@BirdLife2021], which do not provide a reliable proxy for habitat quality, particularly when quality is related to post-abandonment regeneration time (e.g., not distinguishing intact old-growth forests from young secondary forests).
Abandoned agricultural land can become suitable habitat for species associated with natural ecosystems, but regeneration can take many decades to achieve a species richness or community composition comparable to an intact ecosystem [@Acevedo-Charry2019; @Isbell2019; @Nerlekar2020].
We manually excluded species that require habitats older than 30 years (the length of our study period).
However, if post-abandonment successional habitats are protected from recultivation, species that require old-growth habitats are also likely to benefit from abandonment, while species characteristic of earlier successional stages are likely to decline or disappear.

Second, post-abandonment habitats will not be uniformly suitable for species, even as a function of age.
Several factors affect the speed and success of natural regeneration [@Chazdon2016], including legacies of cultivation (e.g., invasive plants, residual pesticides, etc.), proximity of source populations of plants and animals, and changes to natural disturbance regimes (e.g., fire).
These environmental characteristics and differences in dispersal ability among bird and mammal species will affect which species actually occupy and persist at a given abandoned site.
Regeneration of grasslands and other open habitats is especially hard to forecast, as such habitats are frequently maintained through grazing or fire.
When these disturbances are absent, as is common following cropland abandonment, shrub and tree regrowth may dominate over grasses [@ReyBenayas2007; @Nerlekar2020; @VanderZanden2017].

Third, while birds and mammals are commonly used as general indicators for biodiversity [@Westgate2017], other taxonomic groups may respond to abandonment in different ways, particularly following the abandonment of certain types of croplands.
For example, the abandonment of rice paddy agriculture in Japan has been associated with large declines in the abundance and species richness of many fish, amphibian, and plant species, alongside moderate increases of bird and mammal species [@Koshida2018].
We excluded amphibians and reptiles from our study due to greater uncertainty about their distributions and habitat requirements, but these taxa deserve future study.
Finally, although our study sites covered four continents, they were restricted in area, and we therefore could not assess how cropland abandonment affected habitat availability across the full range of any species.
Whole-range information would be required to estimate changes in global extinction risk and population trends.

By connecting high-resolution time-series data on cropland abandonment with species-specific distribution and habitat data for the first time, we find that cropland abandonment produced substantial gains in habitat for a majority of bird and mammal species over a 30-year period in 11 sites spread over four continents.
After accounting for the unique responses of individual species, we show that abandonment represents an opportunity to increase habitat availability for most bird and mammal species, including species of conservation concern.
Yet despite these encouraging results, our analysis of abandonment in the context of cropland expansion and broader land cover changes reinforce an inconvenient truth in conservation: habitat loss due to agriculture remains a fundamental threat to species around the world.
Even in regions with substantial amounts of cropland abandonment, potential gains in habitat were limited by recultivation and outweighed by habitat losses from cropland expansion.
In order to unlock the conservation potential of abandoned croplands, policymakers will need to create incentives and community initiatives to prevent the recultivation of abandoned croplands and sustain and enhance habitat gains, while stopping further losses of natural and semi-natural ecosystems.
Doing so will be critical to slowing and ultimately reversing biodiversity loss.

# Methods {.unnumbered}

## Abandonment maps and definitions {.unnumbered}

Our analysis was based on 30-m annual land cover time series [@Yin2020] produced for 11 sites from 1987-2017 (Figs. \@ref(fig:lc-1987) and \@ref(fig:lc-2017)).
These sites, ranging from `r round(min(area_summary_df$total_site_area_ha_2017/10^6), digits = 2)` million to `r round(max(area_summary_df$total_site_area_ha_2017/10^6), digits = 2)` million ha (Mha) in area, were selected to represent areas with documented histories of cropland abandonment and cover a range of biomes across four continents, including drylands, temperate regions, and the sub-tropic and wet tropics (Fig. \@ref(fig:global-map-w-wisc)a).
We excluded three of the 14 sites mapped by Yin et al. [@Yin2020] due to low classification accuracy, following Crawford et al. [@Crawford2022].
The time series mapped four land cover classes at high accuracy (average overall accuracy of $85\pm4$% [@Yin2020]): (i) cropland, (ii) herbaceous vegetation (e.g., grassland), (iii) woody vegetation (e.g., forest), and (iv) non-vegetation (e.g., water, barren, or urban land).
Previous work [@Crawford2022] mapped abandoned croplands by identifying periods of non-cropland (i.e., herbaceous or woody vegetation) that followed periods of cultivation and remained non-cropland for five or more consecutive years, following a commonly used five-year abandonment definition designed to exclude short-term fallow cycles [@FAO2016].
We used these abandonment maps to identify all pixels that were abandoned at least once during the time series (which we refer to as "abandoned pixels;" Figs. \@ref(fig:abn-lc-1987) and \@ref(fig:abn-lc-2017)).

## Calculating area of habitat from species range maps and habitat preferences {.unnumbered}

We calculated each species' area of habitat (AOH [@Brooks2019], sometimes referred to as "suitable habitat" or simply "habitat"), defined as the total area of a species' range that falls within suitable habitat types and elevations.
We sourced range maps for all bird and mammal species from Birdlife International [@BirdLife2021] and the IUCN [@IUCN2021], respectively, and extracted habitat and elevation preferences from individual IUCN assessments.
We excluded marine species and species classified as "Extinct" (EX) or "Extinct in the Wild" (EW), and only considered areas where species were considered extant and either "native" or "reintroduced," leaving 1,495 bird and 528 mammal species (2,023 total) with ranges overlapping at least one of our 11 sites.
For species with range maps delineated by season, we only consider areas where species are resident, breeding, or non-breeding (we exclude passage areas for migratory species).
For these species, we only considered those habitats marked as "suitable" in the relevant season associated with that portion of the range.
After filtering these species by elevation and seasonally-specific habitat preferences, the number of bird and mammal species with habitat within at least one site fell to 1,688 (1,175 birds and 513 mammals), with 1,533 being directly affected by abandonment (1,035 birds and 498 mammals).

We defined species as "threatened" when assessed by the IUCN as "Vulnerable," "Endangered," or "Critically Endangered," and "not threatened" when assessed as "Near Threatened" or "Least Concern."
Species assessed as "Data Deficient" are excluded from any analysis of threat status.
We classified a species as "small-ranged" if their total global range area (extent of occurrence) fell below the global median (following Jenkins et al. [@Jenkins2013]).
Because species' habitat preferences listed in IUCN assessments do not account for the successional age of the habitat, we conservatively excluded from our analysis all species that require mature habitats in at least one season.
Forest-dwelling bird and mammal species were classified as mature forest obligates if they required habitats older than 30 years (i.e., the maximum age of abandoned croplands during our time series), according to habitat descriptions listed in IUCN assessments and individual species accounts in The Handbook of the Birds of the World [@BOW2022] and The Handbook of the Mammals of the World [@HMW2019].
This resulted in the exclusion of 187 species of birds and 33 species of mammals, leaving 855 and 467 mammals total in our analyses.
The number of species at each site is shown according to threat status, habitat age requirements, and range size in Figs. \@ref(fig:richness-by-site) and \@ref(fig:richness-by-site-small).

## Translating from land cover to IUCN habitat types {.unnumbered}

Because AOH is calculated from habitat, not land cover, we translated the Yin et al. @Yin2020 land cover maps to match the IUCN's listed habitat types using a 100-m global map of IUCN habitat types for 2015 [@Jung2020a], resampled to 30-m resolution to match our land cover maps.
First, we developed a simple crosswalk between the generalized land cover types (e.g., forest) mapped by Yin et al. [@Yin2020] and the specific IUCN Level 2 habitat types (e.g., temperate forest), based on how each habitat type would likely be classified from satellite imagery (see Table \@ref(tab:iucn-crosswalk-table)).
Because this crosswalk delineates "one to many" relationships (i.e., one land cover class could be multiple IUCN habitat types), we next assigned individual pixels of land cover to the most common corresponding IUCN habitat type within the surrounding pixels in the Jung et al. [@Jung2020a] habitat map (see SI Section \@ref(si-habitat-assignment)).

## Calculating area of habitat across multiple temporal and spatial scales {.unnumbered}

To isolate the direct effect of cropland abandonment on habitat availability (i.e., the change from cropland to abandoned cropland), we first calculated the area of habitat provided by pixels that were abandoned at some point during the time series ("Calculation 1;" Figs. \@ref(fig:abn-lc-1987)-\@ref(fig:abn-lc-2017)). 
For this calculation, we excluded any habitat provided by these pixels before each pixel's first year of cultivation during the time series.
Accordingly, we considered only habitat provided by croplands when they were actively cultivated, abandoned, or, where appropriate, recultivated (see Fig. \@ref(fig:aoh-sample-trajectories)).

In order to compare the effect of abandonment on habitat availability with that of overall habitat loss and land cover change at each site, we calculated habitat area (AOH) in two additional ways (Fig. \@ref(fig:aoh-sample-trajectories)).
Calculation 2 considered changes in habitat that took place exclusively in pixels that experienced abandonment at some point during the time series (following Calculation 1), but tracked changes across our entire time series, from 1987 through 2017.
This allowed us to consider the habitat contributions of abandonment relative to the 1987 baseline, accounting for any land cover that was cleared for agriculture prior to abandonment.

Finally, we calculated AOH for each species for the entire 1987-2017 time series and the entirety of our sites ("Calculation 3;" Figs. \@ref(fig:lc-1987)-\@ref(fig:lc-2017)).
This calculation placed abandonment into the context of broader land cover change dynamics at each site and allowed us to consider the extent to which abandonment compensated for cropland expansion taking place alongside of abandonment.

Previously, Crawford et al. [@Crawford2022] showed that while substantial abandonment occurred at our eleven study sites (8.76 Mha of croplands were abandoned one or more times from 1987-2017), this abandonment was relatively short-lived and subject to high rates of recultivation (only 6.06 Mha of croplands remained abandoned as of 2017, with a mean age of 14.22 years).
In order to calculate the impact of recultivation on abandonment's effect on AOH, we also applied a scenario of "recultivation prevention" in which no recultivation took place after abandonment (following Crawford et al. [@Crawford2022]) to each of our three calculations of AOH.
In these scenarios, abandoned croplands were left abandoned from the year of initial abandonment through the end of the time series.

## Summarizing habitat area trends {.unnumbered}

We extracted trends in habitat area (AOH) over time for each bird and mammal species at each site by conducting linear regressions that predicted AOH as a function of year (converting raw AOH observations, shown in Fig. \@ref(fig:aoh-sp-obs-crop-abn), into trend lines, shown in Fig. \@ref(fig:aoh-trend-lines-crop-abn)).
In order to account for temporal autocorrelation present in individual species' trends in AOH (Fig. \@ref(fig:dw-stat)), we calculated the standard errors around the coefficient estimates with the Newey-West estimator [@Newey1987], a method designed to account for temporal autocorrelation and heteroskedasticity, using the fixest R package [@R-fixest].

AOH trends for a given species were classified as either gains or losses of habitat over time when slope coefficients were positive or negative, respectively, and statistically significant ($p<0.05$, i.e., the 95% confidence interval of the slope coefficient did not overlap with zero). 
We refer to these species as "winners" and "losers," respectively.
Species with AOH slopes that were not statistically significant ($p\geq0.05$) at a given site were classified as having "no trend."

When species occurred at multiple sites, there were sometimes contrasting trends.
Species with a significant trend at one or more sites, but no significant trend at other sites, were considered to have a "weak" trend overall ("weak gains" or "weak losses," depending on the direction of the relevant significant trend).
Species with significant gains at one or more sites and significant losses at others were considered to have "conflicting" trends, where the impact of abandonment is context dependent.

When reporting magnitudes of AOH changes, we provide two primary measures for each species at each site: 1) the magnitude of AOH change measured as a percent of site area ($100*(AOH_{end} - AOH_{start})/sitearea$, Figs. \@ref(fig:aoh-change-percent-by-trend) and \@ref(fig:aoh-change-percent-by-site)) and 2) the relative AOH change measured as the ratio of final to initial AOH, natural log-transformed ($ln(AOH_{end} / AOH_{start})$, Fig \@ref(fig:log-ratio-aoh-change-by-site)).
Both measures were calculated using the mean AOH value for the first five and last five years of the time series, in order to minimize the influence of annual variation.
We also report distributions of the absolute change in AOH ($AOH_{end} - AOH_{start}$; Fig. \@ref(fig:aoh-change-by-site)), the untransformed ratio change in AOH (Fig. \@ref(fig:ratio-aoh-change-by-site)), and the slope coefficients estimated from linear regressions (Fig. \@ref(fig:aoh-slope-percent-by-site)).

## Species traits and the effect of abandonment on AOH {.unnumbered}

We fitted three linear models using species traits to predict 1) the AOH trend (binary, gain or loss), 2) the magnitude of AOH change (% of site area), and 3) the relative AOH change (natural log transformed).
We extracted trophic level and body mass variables from a database of species traits for mammals and birds [@Etard2020] and combined them with variables derived from individual IUCN assessments [@BirdLife2021; @IUCN2021], including habitat preferences (suitability of various IUCN Level 1 habitats), habitat breadth (counting the number of suitable IUCN Level 2 habitats, following Etard et al. @Etard2020), vertebrate class, threat status, global range size, and range latitude (i.e., "tropicality," measured as the absolute latitude of the centroid of a species range).
We extracted arable and urban land suitabilities from the artificial terrestrial habitat category and did not include the suitability of marine habitats as predictors.
To account for differences in the magnitude of abandonment at each site, we also included the percentage of each site that was abandoned during the time series, derived from Crawford et al. @Crawford2022.
The binary trend response variable was fit with a logistic regression, using Rs core glm() function with the binomial family, and the AOH magnitude response variables with a standard linear regression.
Model diagnostics were conducted through visual assessment of residual vs. fitted value plots (Fig. \@ref(fig:traits-model-resid-v-fitted)) and Q-Q plots (Fig. \@ref(fig:traits-model-qq)).
See SI Section \@ref(si-traits) for additional details.

## Data processing {.unnumbered}

We analyzed spatial data (maps of land cover, abandonment, IUCN habitat types, species ranges, and elevation), IUCN assessment data, and resulting area of habitat data in RStudio version 2022.2.1.461 [-@RStudio], using R version 4.1.2 (2021-11-01) [-@R-base], using the terra [@R-terra], data.table [@R-data.table], and tidyverse [@R-tidyverse] packages.
Models were fit using the fixest package and R's base statistical functions.

<!-- RStudio version `r rstudioapi::versionInfo()$version` [@RStudio], using `r R.Version()$version.string` [@R-base] -->

# Acknowledgements {.unnumbered}

We thank the following researchers at the University of Wisconsin-Madison, who generously shared the land cover maps that made our analysis possible: A Brando, J Buchner, D Helmers, BG Iuliano, NE Kimambo, KE Lewiska, E Razenkova, A Rizayeva, N Rogova, SA Spawn-Lee, and Y Xie.
We thank the Drongos research group for advice and companionship.
We thank T Bearpark and U Srinivasan for invaluable statistical advice, and D Liang for advice on our traits analysis.
Our analysis would not be possible without the dedication of the IUCN, BirdLife International, and numerous individual experts who contributed to species assessments.
We thank the Macaulay Library at the Cornell Lab of Ornithology for licensing the photos in Fig. \@ref(fig:global-map-w-wisc).
Analyses were performed using Princeton Research Computing resources at Princeton University.
This research was supported by the High Meadows Foundation (DSW) and the NASA Land Cover and Land Use Change Program (Grant no. 80NSSC18K0343, to VCR, HY), and contributes to the Global Land Programme (<https://glp.earth/>).

## Author contributions {.unnumbered}

CLC curated data and designed and conducted data analysis, with feedback from co-authors (RAW, HY, VCR, and DSW).
CLC cleaned species data, with assistance from RAW in classifying Neotropical bird species. 
CLC produced figures, and wrote initial draft, with all authors contributing to subsequent revisions.

## Competing interests {.unnumbered}

The authors declare no competing interests.

## Data and code availability {.unnumbered}

The annual land cover maps [@Yin2020] and abandonment maps [@Crawford2022] that were the foundation for our analysis are archived at Zenodo (<https://doi.org/10.5281/zenodo.5348287>). 
Code to replicate these analyses is available on GitHub at <https://github.com/chriscra/biodiversity_abandonment>.
Bird and mammal range maps are available upon request from BirdLife International (<http://datazone.birdlife.org/species/requestdis>) and IUCN (<https://www.iucnredlist.org/resources/spatial-data-download>), respectively.
Species assessment data (including habitat and elevation preferences) are freely available from IUCN (<https://www.iucnredlist.org/>).
The 2015 global map of IUCN habitat types developed by Jung et al. [@Jung2020a] is freely available at <https://zenodo.org/record/4058819>.

# References {.unnumbered}

::: {#refs}
:::

\newpage

<!-- \beginsupplement -->

# Supplementary information
<!-- {.unnumbered} -->

\tableofcontents
\listoftables
\listoffigures

<!-- \newpage -->

## Assigning land cover to habitat types {#si-habitat-assignment}

We developed a method for assigning pixels in our coarse land cover classes to finer habitat types to match the habitats used by the IUCN to describe species' habitat preferences.
This process was based on a 2015 map of IUCN habitat types at 100-m resolution produced by @Jung2020a based on a dynamic crosswalk between the Copernicus land cover maps and the IUCN habitat types.
We in turn developed a simple crosswalk between our coarse land cover types and the finer IUCN habitat types mapped by @Jung2020a, as shown in Table \@ref(tab:iucn-crosswalk-table). 
But because there was not perfect spatial overlap between our land cover maps and the 2015 habitat map, we developed a method for assigning our pixels of land cover to the nearest habitat type on the @Jung2020a map that matched the broad category according to our crosswalk.
We first extracted only those pixels with habitat types that fell into each of our four land cover classes, and used a focal filter to assign habitat types to empty pixels based on the most common (i.e., modal) habitat type within the surrounding nine-pixel neighborhood (using the function `terra::focal(fun = "modal")`).
This produced four maps of potential habitat types for each pixel corresponding to each coarse land cover type.
We then masked each of these potential habitat types maps by the corresponding land cover pixels in each year at each site, producing maps of the likely habitat type for each pixel of land cover, in each year.
We then combined these four back together again to produce a map of habitat types at each site in each year, which served as input for our calculation of area of habitat (AOH). 
See maps below.

### Allocating savanna and shrubland habitats to land cover classes {#si-savanna-shrubland-jac}

Allocating the finer scale IUCN habitat types to our coarse land cover classes was straightforward for forests, grasslands, non-vegetation habitat types, and arable land, but less so for savanna and shrubland habitats, which are intermediate between entirely open grasslands and closed forests.
We considered shrubland and savanna habitat types to be a subset of our woody vegetation (i.e., forest) and herbaceous vegetation (i.e., grassland) land cover classes, respectively.
Because these habitats occupy intermediate zone between land cover classes, we conducted a sensitivity analysis to assess similarity between land cover and reclassified habitat maps under the full range of possible categorizations (Fig. \@ref(fig:jung-crosswalk-jac).
We found similar levels of spatial overlap across all possible categorizations, so we categorized these habitats to match how they would be classified directly from satellite imagery.

According to @Jung2020a, sites with significant area classified as shrubland include: Belarus (14%), Bosnia & Herzegovina (7%), Wisconsin (9%), Iraq, Nebraska, and Shaanxi (1-2%), and Chongqing, Volgograd, and Orenburg (~0.5%).
Sites with significant area in savanna include: Goias (69%), Chongqing (19%), and Mato Grosso (10%).

Our default approach was to classify savanna and shrubland habitats as grassland and forest land cover respectively, but we explored the consequences of alternative classifications by testing spatial similarity between the resulting reclassified maps. 
We calculated Jaccard similarity between our @Yin2020 land cover maps (for the year 2015) and the @Jung2020a habitat maps (for the year 2015) when reclassifying savanna and shrubland habitats as either forest or grassland.
The Jaccard similarity index is a measure of spatial similarity (i.e., overlap) between two sets, defined as the proportion of shared elements, or the intersection divided by the union (Equation \@ref(eq:jaccard-equation)) [@Legendre2012]:

\begin{equation}
J(a,b) = \frac{a\cap b}{a\cup b} (\#eq:jaccard-equation)
\end{equation}

We tested the full range of reclassifications, and the Jaccard similarity between the reclassified maps are shown in Fig. \@ref(fig:jung-crosswalk-jac).
Based on these results, we classified savanna as grassland. 
For shrubland, there was variation in similarity between land cover maps under these different reclassification rules, but no clear trend.
As a result, we conservatively consider shrubland habitats to be a subset of forest land cover, given that shrublands are most spectrally similar to forests from a remote sensing perspective.

<!-- We found that: -->

<!-- 1. At the three sites with significant amounts of shrublands (Belarus, Bosnia & Herzegovina, and Wisconsin) - which are all in forested biomes - the similarity between grassland maps increases when shrublands are considered grasslands (as do forest maps). The gold and black bars look basically the same for these three sites, which means that the increase is due to the shrub -> grassland crosswalk; the crosswalk for savanna does not seem to matter, likely because there is very little savanna at these sites. This pattern also holds for Iraq, which had about 2% shrubland (compared to 49% desert, 42% cropland, 4% grassland, and 2% urban). -->

<!-- 2. Sites with significant area in savanna (Goias, Mato Grosso, and Chongqing, though I know this isnt really savanna) show greater similarity when savanna is classed as grassland, not as forest (this makes sense, given that these sites likely have a greater distinction between true forest and savanna). The green and gold bars are the same, signifying that the shrubland decision doesnt matter much (because there is so little shrubland there). -->

<!-- 3. The four remaining sites - Nebraska, Orenburg, Shaanxi, and Volgograd - are all in grassland/steppe biomes, where the majority of the site is classified as grassland. At these places, the similarity is higher when shrubland is classified as forest (shown by the green and gray bars being higher). These increases are pretty small, however, and there is relatively little shrubland at any of these sites (max. 1.4% at Nebraska) -->

<!-- # Extended Results -->

## Results of statistical tests comparing proportion of winners and losers by species group {#si-prop-test-results}

Throughout this analysis, we used two-sample Z-tests to test whether for equality between proportions of winner species (or loser species) for groups of interest, and applied Yates' continuity correction.
Mammals and birds showed statistically significant differences in the proportion of both winner and loser species following abandonment.
Mammals showed a significantly higher proportion of species that were winners (reported in main text), and also a significantly lower proportion of species that were losers [$X^2$ (df = `r p_test_loss_m_v_b$parameter`, *N* = `r sum(aoh_gain_bird_v_mam_tmp$N)`) = `r round(p_test_loss_m_v_b$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_m_v_b$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_m_v_b$p.value, digits = 2)))`].

When comparing the proportion of winner species between threatened and non-threatened species (including both mammals and birds), we found that the difference between these two proportions was not statistically significant [two-sample proportion test: $X^2$ (df = `r p_test_iucn_all$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% filter(aoh_type == "crop_abn_iucn") %>% .$N %>% sum()`) = `r round(p_test_iucn_all$statistic, digits = 2)`, *p* `r ifelse(p_test_iucn_all$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_all$p.value, digits = 2)))`].
This pattern held for Calculation 2 [two-sample proportion test: $X^2$ (df = `r p_test_iucn_all_calc2$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% filter(aoh_type == "max_abn_iucn") %>% .$N %>% sum()`) = `r round(p_test_iucn_all_calc2$statistic, digits = 2)`, *p* `r ifelse(p_test_iucn_all_calc2$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_all_calc2$p.value, digits = 2)))`] and Calculation 3 [two-sample proportion test: $X^2$ (df = `r p_test_iucn_all_calc3$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% filter(aoh_type == "full_abn_iucn") %>% .$N %>% sum()`) = `r round(p_test_iucn_all_calc3$statistic, digits = 2)`, *p* `r ifelse(p_test_iucn_all_calc3$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_all_calc3$p.value, digits = 2)))`].


This was also the case for birds [$X^2$ (df = `r p_test_iucn_bird$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% filter(vert_class == "bird") %>% .$N %>% sum()`) = `r round(p_test_iucn_bird$statistic, digits = 2)`, *p* `r ifelse(p_test_iucn_bird$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_bird$p.value, digits = 2)))`] and mammals [$X^2$ (df = `r p_test_iucn_mam$parameter`, *N* = `r aoh_gain_by_iucn_tmp %>% filter(vert_class == "mam") %>% .$N %>% sum()`) = `r round(p_test_iucn_mam$statistic, digits = 2)`, *p* `r ifelse(p_test_iucn_mam$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_iucn_mam$p.value, digits = 2)))`] individually.
When looking at individual IUCN statuses, we found a similar weak pattern, given that the number of species in each category was relatively low (Fig. \@ref(fig:aoh-by-iucn)).

To understand the effect of recultivation on species' responses to abandonment, we compared the proportion of species with increasing trends in AOH to the potential proportion in a scenario in which no recultivation took place.
The proportions of winners showed statistically significant increases when recultivation did not take place, for both birds [$X^2$ (df = `r obs_v_pot_stats$bird_gain_p_test$parameter`, *N* = `r aoh_overall_obs_v_pot_tmp %>% filter(vert_class == "bird", overall_trend == "gain") %>% .$N %>% sum()`) = `r round(obs_v_pot_stats$bird_gain_p_test$statistic, digits = 2)`, *p* `r ifelse(obs_v_pot_stats$bird_gain_p_test$p.value < 0.01,"< 0.01", paste0("= ", round(obs_v_pot_stats$bird_gain_p_test$p.value, digits = 2)))`] and mammals [$X^2$ (df = `r obs_v_pot_stats$mam_gain_p_test$parameter`, *N* = `r aoh_overall_obs_v_pot_tmp %>% filter(vert_class == "mam", overall_trend == "gain") %>% .$N %>% sum()`) = `r round(obs_v_pot_stats$mam_gain_p_test$statistic, digits = 2)`, *p* `r ifelse(obs_v_pot_stats$mam_gain_p_test$p.value < 0.01, "< 0.01", paste0("= ", round(obs_v_pot_stats$mam_gain_p_test$p.value, digits = 2)))`]


We also compared proportions of winners and losers across three calculations of AOH with progressively wider temporal and spatial scope (see Fig. \@ref(fig:aoh-sample-trajectories)).
For birds, the difference between proportion of consistent winners was statistically significant between Calculation 1 and 2 [two-sample proportion test: $X^2$ (df = `r p_test_gain_bird_by_calc12$parameter`, *N* = `r aoh_gain_bird_by_calc_tmp$N[1:2] %>% sum()`) = `r round(p_test_gain_bird_by_calc12$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_bird_by_calc12$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_bird_by_calc12$p.value, digits = 2)))`], Calculation 1 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_gain_bird_by_calc13$parameter`, *N* = `r aoh_gain_bird_by_calc_tmp$N[c(1,3)] %>% sum()`) = `r round(p_test_gain_bird_by_calc13$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_bird_by_calc13$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_bird_by_calc13$p.value, digits = 2)))`], and Calculation 2 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_gain_bird_by_calc23$parameter`, *N* = `r aoh_gain_bird_by_calc_tmp$N[2:3] %>% sum()`) = `r round(p_test_gain_bird_by_calc23$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_bird_by_calc23$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_bird_by_calc23$p.value, digits = 2)))`].
For mammals, the difference between the proportion of consistent winners was statistically significant for Calculation 1 and 2 [two-sample proportion test: $X^2$ (df = `r p_test_gain_mam_by_calc12$parameter`, *N* = `r aoh_gain_mam_by_calc_tmp$N[1:2] %>% sum()`) = `r round(p_test_gain_mam_by_calc12$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_mam_by_calc12$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_mam_by_calc12$p.value, digits = 2)))`] and Calculation 1 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_gain_mam_by_calc13$parameter`, *N* = `r aoh_gain_mam_by_calc_tmp$N[c(1,3)] %>% sum()`) = `r round(p_test_gain_mam_by_calc13$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_mam_by_calc13$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_mam_by_calc13$p.value, digits = 2)))`], but not for Calculation 2 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_gain_mam_by_calc23$parameter`, *N* = `r aoh_gain_mam_by_calc_tmp$N[2:3] %>% sum()`) = `r round(p_test_gain_mam_by_calc23$statistic, digits = 2)`, *p* `r ifelse(p_test_gain_mam_by_calc23$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_gain_mam_by_calc23$p.value, digits = 2)))`].

The proportions of consistent losers also showed significant differences for birds between Calculation 1 and 2 [two-sample proportion test: $X^2$ (df = `r p_test_loss_bird_by_calc12$parameter`, *N* = `r aoh_loss_bird_by_calc_tmp$N[1:2] %>% sum()`) = `r round(p_test_loss_bird_by_calc12$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_bird_by_calc12$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_bird_by_calc12$p.value, digits = 2)))`] and Calculation 1 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_loss_bird_by_calc13$parameter`, *N* = `r aoh_loss_bird_by_calc_tmp$N[c(1,3)] %>% sum()`) = `r round(p_test_loss_bird_by_calc13$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_bird_by_calc13$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_bird_by_calc13$p.value, digits = 2)))`], but not for Calculation 2 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_loss_bird_by_calc23$parameter`, *N* = `r aoh_loss_bird_by_calc_tmp$N[2:3] %>% sum()`) = `r round(p_test_loss_bird_by_calc23$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_bird_by_calc23$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_bird_by_calc23$p.value, digits = 2)))`].
We found the same pattern for mammals, where the difference between proportion of consistent winners was statistically significant for all pairs of calculations: Calculation 1 and 2 [two-sample proportion test: $X^2$ (df = `r p_test_loss_mam_by_calc12$parameter`, *N* = `r aoh_loss_mam_by_calc_tmp$N[1:2] %>% sum()`) = `r round(p_test_loss_mam_by_calc12$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_mam_by_calc12$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_mam_by_calc12$p.value, digits = 2)))`] and Calculation 1 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_loss_mam_by_calc13$parameter`, *N* = `r aoh_loss_mam_by_calc_tmp$N[c(1,3)] %>% sum()`) = `r round(p_test_loss_mam_by_calc13$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_mam_by_calc13$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_mam_by_calc13$p.value, digits = 2)))`], but not for Calculation 2 and 3 [two-sample proportion test: $X^2$ (df = `r p_test_loss_mam_by_calc23$parameter`, *N* = `r aoh_loss_mam_by_calc_tmp$N[2:3] %>% sum()`) = `r round(p_test_loss_mam_by_calc23$statistic, digits = 2)`, *p* `r ifelse(p_test_loss_mam_by_calc23$p.value < 0.01,"< 0.01", paste0("= ", round(p_test_loss_mam_by_calc23$p.value, digits = 2)))`].

## Extra results

This effect was more intense for losers, who on average lost `r effect_size_stats_tmp$mean_aoh_lost_percent_obs`% of site area (reducing individual AOH by a factor of `r mean_effect_size_df %>% filter(str_detect(aoh_type, "pot"), stat == "mean_ratio", trend == "loss") %>% pull(value)`), compared to average winner gains of `r effect_size_stats_tmp$mean_aoh_gained_percent_obs`% of site area (increasing by an average factor of `r mean_effect_size_df %>% filter(str_detect(aoh_type, "pot"), stat == "mean_ratio", trend == "gain") %>% pull(value)`), when no recultivation took place.

## Trends in Mato Grosso, Brazil {#si-mato-grosso}

Limiting recultivation in Mato Grosso would have affected a large number of species given this site's high species richness.
Here, `r obs_v_pot_stats$mg_improve_n_total` additional species showed significant gains in habitat in our scenario of potential abandonment (Calculation 1P), transitioning from either no trend (`r obs_v_pot_stats$mg_improve_n_bird_no_trend` birds and `r obs_v_pot_stats$mg_improve_n_mam_no_trend` mammals) or from significant losses (`r obs_v_pot_stats$mg_improve_n_bird_loss` birds and `r obs_v_pot_stats$mg_improve_n_mam_loss` mammals) for observed abandonment (Calculation 1).
On average, each of these species gained `r obs_v_pot_stats$mg_improve_mean_p_gain`% more AOH by the end of the time series in the scenario of potential abandonment (Calculation 1P) than was actually observed (Calculation 1).
For comparison, only `r obs_v_pot_stats$n_sp_improve_non_mg_bird` bird and `r obs_v_pot_stats$n_sp_improve_non_mg_mam` mammal species across all sites outside of Mato Grosso changed to significant gains in our scenario of potential abandonment.
Meanwhile, `r obs_v_pot_stats$mg_worsen_n_bird` bird and `r obs_v_pot_stats$mg_worsen_n_mam` mammal species at Mato Grosso had their AOH trend worsen under our potential abandonment scenario (Calculation 1P), with AOH declining by `r obs_v_pot_stats$mg_worsen_mean_p_loss`% on average relative to observed abandonment (Calculation 1).


## Traits {#si-traits}

### Expanded methods

TBD: Table of model predictor variables, definitions, and data sources (at He's suggestion).


### Expanded results

To explore the ecological factors that may affect species responses to cropland abandonment, we fit three linear models using a variety species traits to predict 1) the AOH trend (binary, gain or loss), 2) the AOH change as a percent of site area, and 3) the ratio of AOH at the start and end of the time series (natural log transformed).
These three models respectively provide insights on the association of species traits on 1) the likelihood of species experiencing statistically significant gains in habitat following cropland abandonment, 2) the overall magnitude of those changes, and 3) the magnitude of those changes relative to pre-existing habitat.

Our model predicting binary AOH trend showed that forest, savanna, and grassland habitat suitabilities all increased the odds of a species experiencing habitat gains following abandonment, with grassland suitability being by far the most consequential (increasing the odds ratio by a factor of 7.52, compared to factors of 2.46 and 1.60 for forest and savanna suitability respectively; Table \@ref(tab:traits-mod-table-main)). 
In contrast, arable land suitability was far and away the most consequential predictor that a species would lose habitat following abandonment, being associated with a 99% decline in the odds of being a winner.
Wetlands suitability also reduced the likelihood of gaining habitat, with the odds of being a winner declining by 37%.
When including no trend species, more generalist species (i.e., with a greater number of level 2 suitable habitats) are more likely to be winners than non-winners and less likely to be losers than non-losers (Table \@ref(tab:traits-mod-table-binary)): for each additional IUCN Level 2 suitable habitat, the odds of being a winner over a non-winner increased by 6%.
This coefficient was not statistically significant in our primary model.
A range of factors were associated with a species being more likely not to have a statistically significant trend in any direction, including savanna and shrubland suitability, and greater distance from the equator.
Species in sites that experienced more abandonment were less likely to have no trend. 
In this model, rocky, caves, and desert habitats did not have significant associations, nor did vertebrate class, IUCN threat status, trophic level, body mass, or range area.

Binary model additional results:
When including no trend species, more generalist species (i.e., with a greater number of level 2 suitable habitats) are more likely to be winners than non-winners and less likely to be losers than non-losers (Table \@ref(tab:traits-mod-table-binary)): for each additional IUCN Level 2 suitable habitat, the odds of being a winner over a non-winner increased by 6%.
This coefficient was not statistically significant in our primary model.
A range of factors were associated with a species being more likely to not have a statistically significant trend in any direction, including savanna and shrubland suitability, and greater distance from the equator (Table \@ref(tab:traits-mod-table-binary)).
Species in sites that experienced more abandonment were less likely to have no trend. 

When considering the magnitude of AOH changes as a percent of site area, the associations of traits and response to abandonment shifted slightly.
Similar to the binary trend model, species with grassland and savanna suitability saw greater increases in AOH change, adding an additional 3.1% and 1.66% of site area as habitat following abandonment, whereas arable land suitability was associated with declines in AOH of 4.66% of site area.
Forest suitability did not have a significant association with AOH magnitude, nor did shrubland, wetlands, rocky, waves, desert, or urban suitability, nor vertebrate class, threat status, trophic level, or body mass. 
This is likely due to the fact that much less of abandoned cropland in our sites ended up in these types of habitats relative to grassland and savanna.
Species with a greater number of suitable habitats and larger ranges saw increases in AOH, of an additional 0.11% of site area for each additional suitable habitat, and 0.23% of site area for each increase in range size by a factor of e (~2.71). 
The more temperate a species range, the less their AOH increased, with the change in AOH declining by 0.02% of site area for each additional degree of latitude the center of their range moved away from the equator.
Species in sites that experienced relatively more abandonment also gained relatively more habitat. 
Each percentage point increase in abandonment as a share of each site was associated with an increase in AOH of 0.15% of site area.

Forest and grassland suitability resulted in relatively greater gains in AOH, leading to AOH change ratios that were 1.19 and 1.26 times greater than without these suitabilities, respectively (raising $e$ to the power of the coefficient value).
On the other hand, savanna and shrubland suitability resulted in smaller ratio changes in AOH, multiplying these ratios by factors of 0.75 and 0.92 respectively. 
The same thing was the case for rocky and urban habitat suitability, reducing ratios by 14 and 11% respectively. 
This is likely due to the fact that there was simply less savanna and shrubland habitat in abandoned croplands overall.
Like the other models, arable land suitability substantially reduced the change in AOH over time, resulting in ratios of ending AOH to starting AOH that were 77% smaller than expected. 
Patterns for range area, tropicality, and abandonment extent matched those in the model predicting the change in AOH as a percent of site area, with larger ratios for species with larger ranges, species in sites with more abandonment, and species with ranges closer to the equator.

Modeled trait associations are not markedly different when assuming no recultivation took place ("potential abandonment" scenarios).

Habitat breadth, or the number of habitats a species finds suitable for survival, was positively associated with increases in AOH following abandonment, likely because these species were less constrained by what types of habitats returned on abandoned croplands.

The lack of significance for forest habitat in the overall magnitude of AOH, and the reduction in AOH ratio for savanna and shrubland habitat suitability, may be simply due to the fact that much less of abandoned cropland in our sites ended up in these types of habitats relative to grassland and savanna (e.g., much less abandonment transitioned into forest at our sites; Crawford et al. 2022, Fig. S23).

Species in sites that experienced relatively more abandonment also gained relatively more habitat. 
Each percentage point increase in abandonment as a share of each site was associated with an increase in AOH of `r filter(trait_mod_coefs, response == "percent", str_detect(term, "max_abn")) %>% pull(estimate)`% of site area and an increasing the relative gain in AOH by a factor of `r filter(trait_mod_coefs, response == "log_ratio", str_detect(term, "max_abn")) %>% pull(estimate)`.

### Additional model specification

Whether arable land is suitable habitat for a species is the strongest predictor of whether a species will gain or lose habitat following cropland abandonment.
When excluding arable land and urban land suitability as predictors in our models, a range of other predictors become statistically significant, including habitat breadth, vertebrate class, and trophic level (Table \@ref(tab:traits-mod3-table)).
For example, when excluding arable land suitability as a predictor in the binary models, savanna drops out, as does wetlands, and habitat breadth, vertebrate class, trophic level, range area, tropicality, and abandonment extent now start playing a role.
However, in this constrained model, the direction on the coefficients for habitat breadth change sign, such that more generalist species are now associated with losing AOH.
While it is possible that this represents a true relationship, meaning that more generalist species are more likely to lose habitat as a result of abandonment, it may be more likely that these newly significant coefficients rather reflect aspects of traits that are (poor) proxy indications for whether a species occurs in arable lands.


```{r trait-extra-text, include = FALSE, eval = FALSE}


### Discussion

# Add paragraph explaining why we might expect predictor variables might work in specific ways (i.e., tropicality, body mass, range size, specialization, etc.).
# 
# Species with larger ranges were associated with greater relative and absolute gains in AOH, another straightforward 
# closer to the equator (tropicality)
```


\newpage

# Supplemental Tables

```{r aoh-stats-table-all-obs, echo = FALSE, message = FALSE, eval = TRUE}
# table for MS:
# A table showing the number of species with the percent of overall in parentheses

# doc_type_ <- "pdf"

aoh_table_all_obs_tmp1 <- 
  # aoh_ms_tmp_trends_by_sp %>%
  aoh_ms_tmp_trends %>%
    filter(aoh_type %in% 
             c("crop_abn_iucn", "crop_abn_potential_iucn", 
               "max_abn_iucn", "full_iucn")) %>%
    group_by(aoh_type, vert_class, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(vert_class, aoh_type) %>% 
  mutate(trend = gsub(" ", "_", trend)) %>%
  group_by(aoh_type, vert_class) %>% mutate(n = sum(n_sp)) %>% ungroup() %>%
  mutate(percent = 100*n_sp/n, combo = paste0(n_sp, " (", round(percent, digits = 2), "%)"))

aoh_table_all_obs_tmp2 <- 
  aoh_table_all_obs_tmp1 %>%
    pivot_wider(id_cols = c(aoh_type, vert_class), 
                names_from = contains("trend"), values_from = n_sp) %>%
  mutate(win_loss = gain/loss) %>%
  select(aoh_type, vert_class, contains("win_loss"))


# print kable
aoh_table_all_obs_tmp1 %>%
  pivot_wider(id_cols = c(aoh_type, vert_class), 
              names_from = contains("trend"), values_from = combo) %>%
  # select(c(1:5, 8, 6:7)) %>%
  
  arrange(aoh_type) %>%
  left_join(aoh_table_all_obs_tmp2) %>%
  mutate(
    vert_class = as_factor(case_when(vert_class == "bird" ~ "Birds", 
                                     vert_class == "mam" ~ "Mammals")),
    aoh_type = case_when(
      aoh_type == "crop_abn_iucn" ~ "1. Abandonment",
      
      aoh_type == "crop_abn_potential_iucn" ~ "1b. Abandonment, assuming no recultivation",
      aoh_type == "max_abn_iucn" ~ "2. Net change in abandoned croplands (1987-2017)",
      aoh_type == "full_iucn" ~ "3. Entire spatial extent (1987-2017)"
    )) %>%
  select("AOH Calculation" = aoh_type, "Vert. Class" = vert_class,
         "Gain" = gain, #"Weak Gain" = weak_gain,
         "Loss" = loss, #"Weak Loss" = weak_loss, 
         "No Trend" = no_trend, #"Conflicting" = context_dependent, 
         "Gain/Loss Ratio" = win_loss) %>%
  flextable(.) %>%
  theme_booktabs(.) %>%
  merge_v(., j = 1) %>%
  # valign(., j = 1, valign = "top") %>%
  colformat_double(., digits = 2) %>%
  set_caption(.,
              caption = "Number of bird and mammals with various trends in area of habitat (AOH), when accounting for each species' trend at each site. AOH was calculated across four spatial and temporal scales: 1) AOH changes directly attributable to cropland abandonment (from the year of first cultivation through 2017), 1b) AOH changes from abandonment, assuming no recultivation, 2) net AOH changes in abandoned croplands across the entire temporal extent (1987-2017), accounting for cropland expansion and habitat loss that occurred during the tie series but prior to abandonment, 3) net AOH changes across the entire temporal (1987-2017) and spatial extent at each site, accounting for persisten cropland expansion.",
              html_escape = TRUE) %>%
  fontsize(., size = 10, part = "all") %>%
  autofit(.)
```

```{r aoh-stats-by-site, echo = FALSE, message = FALSE, eval = TRUE}
# ----------------------------------------------------------------- #
aoh_table_by_site_tmp1 <-
  aoh_ms_tmp_trends %>%
    # filter(str_detect(aoh_type, "crop")) %>%
    group_by(site, aoh_type, vert_class, trend) %>%
    summarise(n_sp = n()) %>% ungroup() %>%
    arrange(site, vert_class, aoh_type) %>%
  mutate(trend = gsub(" ", "_", trend)) %>%
  group_by(aoh_type, site, vert_class) %>% mutate(total_sp = sum(n_sp)) %>% ungroup()

# add overall stats
aoh_table_by_site_tmp1 <- 
  aoh_table_by_site_tmp1 %>%
  bind_rows(
    aoh_table_by_site_tmp1 %>%
      group_by(site, aoh_type, trend) %>% summarise(n_sp = sum(n_sp)) %>% ungroup() %>%
      group_by(site, aoh_type) %>% mutate(total_sp = sum(n_sp)) %>% ungroup() %>%
      mutate(vert_class = "overall")
    ) %>%
  mutate(percent = 100*n_sp/total_sp, combo = paste0(n_sp, " (", round(percent, digits = 2), "%)"))

# aoh_table_by_site_tmp1 %>%
#   filter(aoh_type == "crop_abn_iucn", vert_class == "overall") %>%
#   select(site, vert_class, trend, percent) %>%
#   arrange(desc(percent)) %>% print(n = 25)

aoh_table_by_site_tmp2 <-
  aoh_table_by_site_tmp1 %>%
    pivot_wider(id_cols = c(site, aoh_type, vert_class),
                names_from = contains("trend"), values_from = n_sp) %>%
  mutate(win_loss = gain/loss) %>%
  select(site, aoh_type, vert_class, contains("win_loss"))


# print Table
aoh_table_by_site_tmp1 %>%
  pivot_wider(id_cols = c(site, aoh_type, vert_class, 
                          total_sp
                          ), 
              names_from = contains("trend"), 
              values_from = c(combo)
              ) %>%
  left_join(site_df %>% select(site, description)) %>% 
  left_join(aoh_table_by_site_tmp2) %>%
  filter(aoh_type %in% c(
    # "max_abn_iucn", "full_iucn",
        "crop_abn_iucn"
    )) %>%
  arrange(site, vert_class) %>%
  mutate(
    vert_class = as_factor(case_when(
      vert_class == "bird" ~ "Birds", vert_class == "mam" ~ "Mammals", vert_class == "overall" ~ "Overall")),
    aoh_type = case_when(
      aoh_type == "crop_abn_iucn" ~ "Abandonment",
      aoh_type == "crop_abn_potential_iucn" ~ "Assuming no recultivation",
      aoh_type == "max_abn_iucn" ~ "Net change in abandoned lands (1987-2017)",
      aoh_type == "full_iucn" ~ "Full site"
      )) %>%
  select("Site" = description, 
         # "AOH Calculation" = aoh_type,
         "Vert. Class" = vert_class,
         "Gain" = gain, #"Weak Gain" = weak_gain,
         "Loss" = loss, #"Weak Loss" = weak_loss, 
         "No Trend" = no_trend, #"Conflicting" = context_dependent, 
         "Gain/Loss Ratio" = win_loss
         ) %>%
  flextable(.) %>% 
  theme_booktabs(.) %>% 
  merge_v(., j = c(1,2,3)) %>%
  valign(., j = 1, valign = "top") %>%
  colformat_double(., digits = 2) %>%
  fontsize(., size = 10, part = "all") %>%
  set_caption(.,
              caption = "Number of bird and mammal species with statistically significant gains or losses in AOH following cropland abandonment at each site.",
              html_escape = TRUE) %>%
  autofit(.)
```

```{r aoh-changes-obs-v-pot, echo = FALSE, message = FALSE, eval = TRUE}

# table of change in winners and losers by site and vert class:
n_aoh_trend_changes_by_site_df %>% 
  select("Site" = description, 
         "\U0394 Gain" = gain, #"Weak Gain" = weak_gain,
         "\U0394 Loss" = loss, #"Weak Loss" = weak_loss, 
         "\U0394 No Trend" = no_trend, #"Conflicting" = context_dependent, 
         "Site Richness" = total_sp
  ) %>%
  flextable(.) %>% 
  theme_booktabs(.) %>% 
  merge_v(., j = c(1)) %>%
  valign(., j = 1, valign = "top") %>%
  # colformat_double(., digits = 2) %>%
  fontsize(., size = 10, part = "all") %>%
  set_caption(.,
              caption = "Number of additional species with statistically significant increasing or decreasing trends in AOH for a scenario in which no abandoned croplands were recultivated.",
              html_escape = TRUE) %>%
  autofit(.)

```


(ref:caption-iucn-crosswalk-table) Crosswalk between land cover classes in Yin et al. (2020) and IUCN habitat types mapped by Jung et al. (2020).

```{r iucn-crosswalk-table, echo = FALSE, message = FALSE, eval = TRUE}
iucn_crosswalk %>%
  left_join(tibble(lc = 1:4, 
                   lc_name = c("Non-vegetation", "Woody veg. (Forest)",
                               "Cropland", "Herbaceous veg. (Grassland)"))
            ) %>%
  arrange(lc) %>%
  select("Land cover code" = lc, 
         "Land cover class" = lc_name,
         "IUCN habitat" = IUCNLevel,
         "IUCN map code" = map_code) %>%
  
  # {if (doc_type == "word") 
    flextable(.) %>% 
      theme_booktabs(.) %>%
      merge_v(., j = c(1, 2)) %>%
      valign(., j = c(1, 2), valign = "top") %>%

      set_caption(.,
                  # caption = '(ref:caption-iucn-crosswalk-table)',
                  caption = "Crosswalk between land cover classes in Yin et al. (2020) and IUCN habitat types mapped by Jung et al. (2020).",
                  html_escape = TRUE) %>%
      fontsize(., size = 10, part = "all") %>%
      autofit(.)
  #   else kbl(., 
  #            caption = '(ref:caption-iucn-crosswalk-table)',
  #            align = "r",
  #            format = "latex",
  #            booktabs = TRUE,
  #            longtable = TRUE,
  #            ) %>%
  #     kableExtra::kable_styling(
  #       # latex_options = "scale_down"
  #       latex_options = c("hold_position", "repeat_header")) %>%
  #     # row_spec(11, hline_after = TRUE) %>%
  #     # row_spec(12, bold = TRUE) %>%
  #     column_spec(1, width = "2cm") %>%
  #     column_spec(2, width = "4cm") %>%
  #     column_spec(3, width = "6cm") %>%
  #     column_spec(4, width = "2cm")
  # }

  
```


(ref:caption-traits-mod-table-binary) Trait model coefficients for binary trend response variables.

```{r traits-mod-table-binary, echo = FALSE, message = FALSE, eval = TRUE}
# Binary trends, one observation per species per site:
trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_trend_gain", "binary_gain_v_loss",
                         "binary_trend_loss", "binary_trend_no_trend")) %>%
  arrange(response) %>%
  pull(gt) %>%
  tbl_merge(tab_spanner = c("Gain / Loss", "Gain / Non-Gain", 
                          "Loss / Non-Loss", "No Trend / Trend")) %>%
    as_flex_table(.) %>% 
    theme_booktabs(.) %>%
    set_caption(.,
                # caption = '(ref:caption-traits-mod-table-binary)',
                caption = "Trait model coefficients for binary trend response variables. Model descriptions correspond to the how trends were coded (i.e., Gain / Loss corresponding to 1 / 0).",
                html_escape = TRUE) %>%
      fontsize(., size = 10, part = "all") %>%
      autofit(.)

```

(ref:caption-traits-mod-table-magnitude) Trait model coefficients for binary trend response variables.

```{r traits-mod-table-magnitude, echo = FALSE, message = FALSE, eval = FALSE}
# change in AOH, absolute and as percent of site area:
trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("abs_change", "abs_change_percent_site", 
                         "ratio", "log(ratio)")) %>%
  pull(gt) %>%
  tbl_merge(tab_spanner = c("\U0394 AOH (ha)", "\U0394 AOH / site area (%)", 
                            "Ratio", "ln(Ratio)")) %>%
    as_flex_table(.) %>%
      theme_booktabs(.) %>%
      flextable::footnote(
        ., i = 1, j = c(6,8), 
        value = as_paragraph("Ratio = AOH", as_sub("end"), " / AOH", as_sub("start")),
        ref_symbols = c("a"),
        part = "header", #inline = TRUE, sep = "; "
        ) %>%
      set_caption(.,
        # caption = '(ref:caption-traits-mod-table-magnitude)',
        caption = "Trait model coefficients for binary trend response variables.",
        html_escape = TRUE) %>%
      fontsize(., size = 10, part = "all") %>%
      autofit(.)

```

(ref:caption-traits-mod-table-slope) Trait model coefficients for slope response variables.

```{r traits-mod-table-slope, echo = FALSE, message = FALSE, eval = TRUE}
trait_mod_df %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("slope", "slope_prop_site*10^4")) %>%
  pull(gt) %>%
  tbl_merge(tab_spanner = c("Slope", "Slope/Site Area (%/100)")) %>%
    as_flex_table(.) %>%
      theme_booktabs(.) %>%
      set_caption(.,
        # caption = '(ref:caption-traits-mod-table-slope)',
        caption = "Trait model coefficients for slope response variables.",
        html_escape = TRUE) %>%
      fontsize(., size = 10, part = "all") %>%
      autofit(.)

```


```{r traits-mod3-table-old, eval = FALSE, include = FALSE, echo = FALSE, message = FALSE, cache = TRUE}
readRDS(file = paste0(p_derived, "traits/", "trait_mod_df_mod3.rds")) %>%
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  pull(gt) %>%
  tbl_merge(tab_spanner = c(
    "Binary Trend (gain or loss)",
    "\U0394 AOH / site area (%)",
    "ln(Ratio)"
    )) %>%
    as_flex_table(.) %>%
      theme_booktabs(.) %>%
      flextable::footnote(
        ., i = 1, j = c(6), 
        value = as_paragraph("Ratio = AOH", as_sub("end"), " / AOH", as_sub("start")),
        ref_symbols = c("a"),
        part = "header", #inline = TRUE, sep = "; "
        ) %>%
      set_caption(.,
        caption = "Trait model coefficients for primary response variables, but excluding arable and urban land suitability as predictor variables.",
        html_escape = TRUE) %>%
      fontsize(., size = 10, part = "all") %>%
      autofit(.)
```

```{r traits-mod3-table, eval = TRUE, echo = FALSE, message = FALSE, cache = TRUE}

trait_mod_df_mod3 <- readRDS(file = paste0(p_derived, "traits/", "trait_mod_df_mod3.rds"))

# coefs:
trait_coefs_mod3_tmp <- 
  trait_mod_df_mod3 %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  select(response, tidy) %>%
  unnest(c(tidy)) %>%
  mutate(
    response = case_when(response == "binary_gain_v_loss" ~ "binary",
                         response == "abs_change_percent_site" ~ "percent",
                         response == "log(ratio)" ~ "logratio"),
    # exponentiate log(ratio) coefs
    estimate = case_when(response == "logratio" ~ exp(1)^estimate, 
                         str_detect(response, "binary") ~ exp(1)^estimate, 
                         TRUE ~ estimate)) %>%
    select(-c(std.error, statistic))

# glance:
trait_glance_mod3_tmp <-
  trait_mod_df_mod3 %>% 
  filter(aoh_type == "crop_abn_iucn", 
         response %in% c("binary_gain_v_loss", "abs_change_percent_site", "log(ratio)")) %>%
  select(response, glance) %>%
  unnest(c(glance)) %>%
  mutate(response = case_when(response == "binary_gain_v_loss" ~ "binary",
                              response == "abs_change_percent_site" ~ "percent",
                              response == "log(ratio)" ~ "logratio")) %>%
  pivot_longer(cols = c(-response)) %>%
  select(response, term = name, estimate = value) %>%
  filter(!term %in% c("AIC", "BIC", "r.squared", "statistic", "p.value"))

# =============================================== #
trait_tab_mod3_tmp <-
  bind_rows(trait_coefs_mod3_tmp, trait_glance_mod3_tmp) %>%
  pivot_longer(cols = c(estimate, p.value)) %>%
  pivot_wider(id_cols = term, names_from = c(response, name),
              values_from = value)

# ------------ build final table ------------- #
bind_rows(trait_tab_mod3_tmp[1,],
          tibble(term = "Suitable Habitat Types (i.e., Can Occupy)"),
          trait_tab_mod3_tmp[2:10, ],
          tibble(term = "vert_class"),
          tibble(term = "vert_classBirds", binary_estimate = 1, 
                 percent_estimate = 0, logratio_estimate = 0),
          trait_tab_mod3_tmp[11:12, ],
          tibble(term = "Trophic_level"),
          tibble(term = "Trophic_levelCarnivore", binary_estimate = 1, 
                 percent_estimate = 0, logratio_estimate = 0),
          trait_tab_mod3_tmp[13:27, ]) %>% #print(n = 50)
  flextable() %>%
  # flextable::separate_header(., split = "_") %>%
  colformat_double(j = c(2, 4, 6), digits = 2) %>%
  colformat_double(i = ~ grepl("dev|Lik|df.|nobs", term),
                   j = c(2, 4, 6), digits = 0) %>%
  colformat_double(j = c(3, 5, 7), digits = 3) %>%
  bold(~ binary_p.value < 0.05, j = c("binary_p.value", "binary_estimate"), bold = TRUE) %>%
  bold(~ percent_p.value < 0.05, j = c("percent_p.value", "percent_estimate"), bold = TRUE) %>%
  bold(~ logratio_p.value < 0.05, j = c("logratio_p.value", "logratio_estimate"), bold = TRUE) %>%
  compose(~ binary_p.value < 0.001, j = 3, 
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(~ percent_p.value < 0.001, j = 5,
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(~ logratio_p.value < 0.001, j = 7, 
          as_paragraph(as_chunk('<0.001'))) %>%
  compose(i = ~ grepl("range", term), j = ~term, 
          as_paragraph("ln(Global Range Area, km", as_sup("2"), ")")) %>%
  compose(i = ~ grepl("squared", term), j = ~term, 
          as_paragraph("Adjusted R", as_sup("2"))) %>%
  prepend_chunks(i = ~ grepl("Birds|Mammals|vore|occTRUE", term),
                 j = "term", as_chunk("\t")) %>%
  italic(i = ~ grepl("Birds|Mammals|vore|dev|Lik|df|nobs|r.sq|sigma", term),
         ~ term, italic = TRUE) %>%
  labelizor(part= "all", labels = regression_model_flextable_labels) %>%
  add_header_row(values = c(
    "", "Binary Trend\n(gain or loss)", "\U0394 AOH / site area (%)",
    "ln(Ratio)"),
    colwidths = c(1, 2, 2, 2)) %>%
  compose(i = 1, j = 6, part = "header",
          as_paragraph("ln(AOH", as_sub("end"), " / AOH", as_sub("start"), ")")) %>%
  compose(i = 2, j = 2, part = "header", as_paragraph("Odds Ratio")) %>%
  compose(i = 2, j = 6, part = "header", as_paragraph("e", as_sup("Beta"))) %>%
  flextable::footnote(i = c(2), j = c(6),
    value = c(#as_paragraph("OR = Odds Ratio"),
              as_paragraph("Exponentiated coefficient value") #,
              # as_paragraph("Ratio = AOH", as_sub("end"), " / AOH", as_sub("start"))
              ),
   ref_symbols = c("1"), part = "header"#, inline = TRUE, sep = "; "
   ) %>%
  fontsize(., size = 10, part = "all") %>%
  theme_booktabs(.) %>%
  set_caption(.,
              caption = "Trait model coefficients for primary response variables, but excluding arable and urban land suitability as predictor variables.") %>%
  autofit(.) %>%
  hline(i = 23, part = "body")
  
```


\newpage

# Supplemental Figures

(ref:caption-richness-by-site) Species richness, or the number of species with some area of habitat (AOH) affected by abandonment at each site, shown for species assessed by the IUCN as threatened ("Vulnerable," "Endangered," or "Critically Endangered") or non-threatened ("Least Concern", "Near Threatened"). Species classified as "Data Deficient" are excluded. Lighter shaded bars correspond to birds and mammals manually classified as "mature forest obligates," species that require forest habitats >30 years in age and were excluded from our primary analyses.

```{r richness-by-site, fig.cap = '(ref:caption-richness-by-site)'}
knitr::include_graphics(path = paste0(
  p_plots, "richness_by_site_w_iucn_cat_and_mat.pdf"))
```

(ref:caption-richness-by-site-small) Species richness, or the number of species with some area of habitat (AOH) affected by abandonment at each site, shown according to global range size. Lighter shaded bars correspond to birds and mammals manually classified as "mature forest obligates", species that require forest habitats >30 years in age and were excluded from our primary analyses. Note that the one mature forest bird species in Shaanxi, China and two non-obligate mammals in Gois, Brazil are assessed by the IUCN as threatened.

```{r richness-by-site-small, fig.cap = '(ref:caption-richness-by-site-small)'}
knitr::include_graphics(path = paste0(
  p_plots, "richness_by_site_w_iucn_cat_and_small.pdf"))
```

(ref:caption-site-biomes) Biomes at each site, derived from Ecoregions2017 [@Dinerstein2017]. Reproduced from Crawford et al. [@Crawford2022].

```{r site-biomes, fig.cap = '(ref:caption-site-biomes)', echo=FALSE}
knitr::include_graphics(path = "/Users/christophercrawford/work/projects/abandonment_trajectories/output/plots/biomes2017_by_site.pdf")
```

(ref:caption-lc-1987) Land cover as of the year 1987, shown for all pixels at each site [@Crawford2022].

```{r lc-1987, fig.cap = '(ref:caption-lc-1987)'}
knitr::include_graphics(path = paste0(p_plots, "land_cover_1987.pdf"))
```

(ref:caption-lc-2017) Land cover as of the year 2017, shown for all pixels at each site [@Crawford2022].

```{r lc-2017, fig.cap = '(ref:caption-lc-2017)'}
knitr::include_graphics(path = paste0(p_plots, "land_cover_2017.pdf"))
```

(ref:caption-abn-lc-1987) Land cover as of the year 1987, shown for all pixels that were abandoned at least once during the time series [@Crawford2022].

```{r abn-lc-1987, fig.cap = '(ref:caption-abn-lc-1987)'}
knitr::include_graphics(path = paste0(p_plots, "abn_land_cover_1987.pdf"))
```

(ref:caption-abn-lc-2017) Land cover as of the year 2017, shown for all pixels that were abandoned at least once during the time series [@Crawford2022].

```{r abn-lc-2017, fig.cap = '(ref:caption-abn-lc-2017)'}
knitr::include_graphics(path = paste0(p_plots, "abn_land_cover_2017.pdf"))
```

(ref:caption-jung-l1) IUCN Habitat types (Level 1), derived from @Jung2020a, for each of our 11 sites from @Yin2020.

```{r jung-l1, fig.cap = '(ref:caption-jung-l1)'}
knitr::include_graphics(path = paste0(p_plots, "habitats/jung_l1_sites_colors_no_buff.pdf"))
```

(ref:caption-jung-l2) IUCN Habitat types (Level 2), derived from @Jung2020a, for each of our 11 sites from @Yin2020. See associated caption in Fig \@ref(fig:jung-l2-legend).

```{r jung-l2, fig.cap = '(ref:caption-jung-l2)'}
knitr::include_graphics(path = paste0(p_plots, "habitats/jung_l2_sites_colors_no_buff.pdf"))
```

(ref:caption-jung-l2-legend) Legend for IUCN Habitat types (Level 2) shown in Fig. \@ref(fig:jung-l2), derived from @Jung2020a.

```{r jung-l2-legend, fig.cap = '(ref:caption-jung-l2-legend)'}
knitr::include_graphics(path = paste0(p_plots, "habitats/jung_l2_legend_gg.pdf"))
```

(ref:caption-jung-crosswalk-jac) Jaccard similarity between the 2015 @Yin2020 land cover maps and the 2015 @Jung2020a habitat maps when reclassifying savanna and shrubland habitats as either forest or grassland.

```{r jung-crosswalk-jac, fig.cap = '(ref:caption-jung-crosswalk-jac)'}
knitr::include_graphics(path = paste0(p_plots, "crosswalk_jaccard.pdf"))
```

(ref:caption-aoh-sample-trajectories) An illustration of the pixels included in each of our three AOH calculations. Land cover trajectories are shown for 10 hypothetical pixels (y-axis), with land cover for each year shown in colors (x-axis). The first six of these pixels are classified as having been "abandoned" for a least a portion of our time series based on our definition, and the last four are not, as indicated by labels at far right. Portions of each pixel's trajectory that are excluded from each calculation are denoted by dotted lines and lighter colors. Calculation 1 (left) includes only habitat provided by abandoned pixels, excluding land cover in those pixels prior to cultivation. Calculation 2 (middle) includes only abandoned pixels but includes habitat in each year (thus factoring in pre-abandonment habitat loss). Calculation 3 (right) includes all pixels for the full time series (thus factoring in habitat loss elsewhere at the site). See text for details.

```{r aoh-sample-trajectories, fig.cap = '(ref:caption-aoh-sample-trajectories)'}
knitr::include_graphics(path = paste0(p_plots, "methods/sample_trajectories_horiz.pdf"))
```

(ref:caption-aoh-sp-obs-crop-abn) Observed AOH for all bird and mammals species at each site. AOH is calculated for only pixels that were abandoned at least once, from the year of first cultivation through 2017 (Calculation 1). Each individual species' trend is visualized with transparency, so that darker trend lines indicate many species with overlapping trends.

```{r aoh-sp-obs-crop-abn, fig.cap = '(ref:caption-aoh-sp-obs-crop-abn)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_crop_abn_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-trend-lines-crop-abn) AOH trends for all bird and mammals species occurring at each site, derived from linear regressions of AOH (Fig. \@ref(fig:aoh-sp-obs-crop-abn)) as a function of time. AOH is calculated for only pixels that were abandoned at least once, from the year of first cultivation through 2017 (Calculation 1).

```{r aoh-trend-lines-crop-abn, fig.cap = '(ref:caption-aoh-trend-lines-crop-abn)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_lines_by_site_crop_abn_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-sp-obs-crop-abn-potential) AOH over time for all bird and mammals species occurring at each site, for our scenario of potential abandonment (Calculation 1P). AOH is calculated for only pixels that were abandoned at least once, from the year of first cultivation through 2017, with the additional assumption that no recultivation occurs and abandonment persists from the year of initial abandonment through 2017.

```{r aoh-sp-obs-crop-abn-potential, fig.cap = '(ref:caption-aoh-sp-obs-crop-abn-potential)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_crop_abn_potential_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-sp-obs-max-abn) Observed AOH over time for all bird and mammals species occurring at each site (Calculation 2). AOH is calculated for only pixels that were abandoned at least once, including habitat changes resulting from land cover changes occurring prior to cultivation (i.e., for the full time series, 1987-2017).

```{r aoh-sp-obs-max-abn, fig.cap = '(ref:caption-aoh-sp-obs-max-abn)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_max_abn_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-sp-obs-max-abn-potential) Observed AOH over time for all bird and mammals species occurring at each site, for our scenario of potential abandonment (Calculation 2P). AOH is calculated for only pixels that were abandoned at least once, including habitat changes resulting from land cover changes occurring prior to cultivation (i.e., for the full time series, 1987-2017).

```{r aoh-sp-obs-max-abn-potential, fig.cap = '(ref:caption-aoh-sp-obs-max-abn-potential)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_max_potential_abn_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-sp-obs-full) Observed AOH over time for all bird and mammals species occurring at each site (Calculation 3). AOH is calculated for all pixels in the entire landscape were abandoned at least once, from the year of first cultivation through 2017.

```{r aoh-sp-obs-full, fig.cap = '(ref:caption-aoh-sp-obs-full)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_full_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-sp-obs-full-potential) Observed AOH over time for all bird and mammals species occurring at each site, for our scenario of potential abandonment (Calculation 3P). AOH is calculated for all pixels in the entire landscape were abandoned at least once, from the year of first cultivation through 2017.

```{r aoh-sp-obs-full-potential, fig.cap = '(ref:caption-aoh-sp-obs-full-potential)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_sp_obs_by_site_full_potential_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-overall-stacked) Overall proportion of trend types across sites, for birds and mammals, for three AOH calculations (Calculation 1, top row, cropland abandonment only; Calculation 2, middle row, abandonment 1987-2017; and Calculation 3, bottom row, entire landscape 1987-2017).

```{r aoh-overall-stacked, eval = FALSE, include = FALSE, fig.cap = '(ref:caption-aoh-overall-stacked)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_stacked", aoh_run_date,".pdf"))
```

(ref:caption-aoh-overall-stacked-w-pot) Overall proportion of species with each AOH trend type across all sites, for birds and mammals, for three AOH Calculations (1, cropland abandonment only; 2, abandonment 1987-2017; and 3, the entire landscape 1987-2017), for both observed and potential abandonment.

```{r aoh-overall-stacked-w-pot, fig.cap = '(ref:caption-aoh-overall-stacked-w-pot)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_trend_overall_by_aoh_type_w_pot_stacked",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-overall-w-pot) Number of bird and mammal species with various trends in AOH during our time series, including scenarios of potential abandonment. Columns correspond to three scales of AOH calculation, for observed and potential abandonment. From left to right, these columns show: only abandoned pixels, from first cultivation through 2017 (observed, Calculation 1, and potential, Calculation 1P); only abandoned pixels, from 1987-2017 (observed, Calculation 2, and potential, Calculation 2P); and the entire landscape at each site, from 1987-2017 (Calculation 3). Site-specific results for potential abandonment Calculations 1P, 2P, and 3P are shown in Figs. \@ref(fig:aoh-by-site-crop-abn-potential), \@ref(fig:aoh-by-site-max-abn-potential), and \@ref(fig:aoh-by-site-full-potential), respectively.

```{r aoh-overall-w-pot, fig.cap = '(ref:caption-aoh-overall-w-pot)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_trend_overall_by_aoh_type_w_pot", aoh_run_date,".pdf"))
```

(ref:caption-aoh-obs-v-pot-by-site-prop) The proportion of species with various trends in AOH at each site comparing observed abandonment with a scenario in which no recultivation took place ("Potential"). Totals for all sites combined are shown at bottom. Counts at each site are shown in Fig. \@ref(fig:aoh-obs-v-pot-by-site). Differences in the magnitude of AOH gained or lost are shown in Figs. \@ref(fig:aoh-p-change-obs-v-pot-bird) and \@ref(fig:aoh-p-change-obs-v-pot-mam).

```{r aoh-obs-v-pot-by-site-prop, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site-prop)'}
# Previously included in main text.

knitr::include_graphics(path = paste0(
  p_plots, "aoh/",
  # "aoh_obs_v_pot_by_site_prop_combo",
  "aoh_obs_v_pot_by_site_prop_w_overall_bottom",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-obs-v-pot-by-site) The number of species with various trends in AOH for observed abandonment (Calculation 1) and our scenario of potential abandonment without recultivation (Calculation 1P). Site totals are shown on the left and overall totals are shown on the right, with birds on the top half and mammals on the bottom half. Differences in the magnitude of AOH gained or lost are shown in Figs. \@ref(fig:aoh-p-change-obs-v-pot-bird) and \@ref(fig:aoh-p-change-obs-v-pot-mam).

```{r aoh-obs-v-pot-by-site, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site)'}
knitr::include_graphics(path = paste0(
  p_plots, 
  "aoh/aoh_obs_v_pot_by_site_combo",
  aoh_run_date,".pdf"))
# aoh_obs_v_pot_by_site_prop_combo
```

(ref:caption-aoh-overall-mature-for-obl) Number of bird species with various AOH trend types across all sites, shown for mature forest obligate and non-obligate birds.

```{r aoh-overall-mature-for-obl, fig.cap = '(ref:caption-aoh-overall-mature-for-obl)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_trend_overall_by_mature_obl",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-stacked) Proportion of species at each site with each trend in AOH, shown across three scales of AOH calculation.

```{r aoh-by-site-stacked, fig.cap = '(ref:caption-aoh-by-site-stacked)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/trend_summary_by_site_stacked_3",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-stacked-crop-abn) Proportion of species at each site with each trend in AOH, shown for abandonment only.

```{r aoh-by-site-stacked-crop-abn, fig.cap = '(ref:caption-aoh-by-site-stacked-crop-abn)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/trend_summary_by_site_proportion_stacked_crop_abn_iucn",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-crop-abn) Number of bird and mammal species with various trends in AOH in abandoned pixels starting from the year of first cultivation and running through 2017 (Calculation 1; see Methods). Species counts are shown for individual sites and summed across all sites ("Overall" at left). Observed AOH and modeled trends for individual species are shown in Figs. \@ref(fig:aoh-sp-obs-crop-abn) and \@ref(fig:aoh-trend-lines-crop-abn).

```{r aoh-by-site-crop-abn, fig.cap = '(ref:caption-aoh-by-site-crop-abn)'}
knitr::include_graphics(path = paste0(
  p_plots, 
  "aoh/aoh_overall_w_site_combo_crop_abn_iucn",
  # "aoh/aoh_overall_w_site_prop_combo_crop_abn_iucn" # proportional
  aoh_run_date, ".pdf"))
```

(ref:caption-aoh-by-site-crop-abn-potential) Number of species that gain or lose AOH over time across sites, for Calculation 1P (including only pixels that were abandoned during the time series, calculated from the first year of cultivation through 2017, for our scenario of "potential abandonment"). Observed AOH for individual species are shown in Fig. \@ref(fig:aoh-sp-obs-crop-abn-potential).

```{r aoh-by-site-crop-abn-potential, fig.cap = '(ref:caption-aoh-by-site-crop-abn-potential)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_overall_w_site_combo_crop_abn_potential_iucn",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-max-abn) Number of species by AOH trend type across sites, for AOH Calculation 2 (only abandoned pixels, calculated for 1987-2017). Observed AOH for individual species are shown in Fig. \@ref(fig:aoh-sp-obs-max-abn).

```{r aoh-by-site-max-abn, fig.cap = '(ref:caption-aoh-by-site-max-abn)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_overall_w_site_combo_max_abn_iucn",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-max-abn-potential) Number of species by AOH trend type across all sites, for Calculation 2P (only abandoned pixels, calculated for 1987-2017, for our scenario of "potential abandonment"). Observed AOH for individual species are shown in Fig. \@ref(fig:aoh-sp-obs-max-abn-potential).

```{r aoh-by-site-max-abn-potential, fig.cap = '(ref:caption-aoh-by-site-max-abn-potential)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_overall_w_site_combo_max_potential_abn_iucn",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-full) Number of species by AOH trend type across all sites, for Calculation 3 (full site extent, from 1987-2017). Observed AOH for individual species are shown in Figs. \@ref(fig:aoh-sp-obs-full).

```{r aoh-by-site-full, fig.cap = '(ref:caption-aoh-by-site-full)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_overall_w_site_combo_full_iucn",
  aoh_run_date,".pdf"))
```


(ref:caption-aoh-by-site-full-potential) Number of species by AOH trend type across all sites, for Calculation 3P (full site extent, from 1987-2017, for our scenario of "potential abandonment"). Observed AOH for individual species are shown in Fig. \@ref(fig:aoh-sp-obs-full-potential).

```{r aoh-by-site-full-potential, fig.cap = '(ref:caption-aoh-by-site-full-potential)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_overall_w_site_combo_full_potential_iucn",
  aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-site-mature-for-obl) Proportion of species with various trends in AOH at each site, shown for mature forest obligate and non-obligate birds, across three scales of AOH calculation.

```{r aoh-by-site-mature-for-obl, fig.cap = '(ref:caption-aoh-by-site-mature-for-obl)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_by_site_stacked_no_mat_obl",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-iucn-by-site-crop-abn) The number of threatened and not threatened bird and mammal species with various trends in AOH in abandoned pixels from cultivation through 2017 (Calculation 1).  Site totals are shown on the left, and overall totals are shown on the right, with birds on the top half and mammals on the bottom half. Site specific results for Calculations 2 and 3 are shown in Figs. \@ref(fig:aoh-iucn-by-site-max-abn) and \@ref(fig:aoh-iucn-by-site-full) respectively. Overall results for Calculations 1, 2, and 3 are shown in Fig. \@ref(fig:aoh-by-iucn-lumped), and for individual IUCN categories in Fig. \@ref(fig:aoh-by-iucn).

```{r aoh-iucn-by-site-crop-abn, fig.cap = '(ref:caption-aoh-iucn-by-site-crop-abn)'}
knitr::include_graphics(path = paste0(
  p_plots, "aoh/aoh_IUCN_by_site_combo_crop_abn_iucn",
  aoh_run_date, ".pdf"))
```

(ref:caption-aoh-iucn-by-site-max-abn) The number of species with various trends in AOH, calculated in abandoned pixels from 1987-2017 (Calculation 2), separated into species classified by the IUCN as "threatened" ("Vulnerable," "Endangered," or "Critically Endangered") or "not threatened" ("Near Threatened" or "Least Concern"). Species classified as "Data Deficient" are excluded. Site totals are shown on the left, and overall totals are shown on the right, with birds on the top half and mammals on the bottom half.

```{r aoh-iucn-by-site-max-abn, fig.cap = '(ref:caption-aoh-iucn-by-site-max-abn)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_IUCN_by_site_combo_max_abn_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-iucn-by-site-full) The number of species with various trends in AOH, calculated for the entire landscape at each site from 1987-2017 (Calculation 3), separated into species classified by the IUCN as "threatened" ("Vulnerable," "Endangered," or "Critically Endangered") or "not threatened" ("Near Threatened" or "Least Concern"). Species classified as "Data Deficient" are excluded. Site totals are shown on the left, and overall totals are shown on the right, with birds on the top half and mammals on the bottom half.

```{r aoh-iucn-by-site-full, fig.cap = '(ref:caption-aoh-iucn-by-site-full)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_IUCN_by_site_combo_full_iucn",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-iucn-lumped) Proportion of species with various trends in AOH, shown for species classified by the IUCN as "threatened" ("Vulnerable," "Endangered," or "Critically Endangered") or "not threatened" ("Near Threatened" or "Least Concern"). Species classified as "Data Deficient" are excluded.

```{r aoh-by-iucn-lumped, fig.cap = '(ref:caption-aoh-by-iucn-lumped)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_by_IUCN_status_lumped",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-iucn) Proportion of species with a given trend in AOH by IUCN Red List Status, for each of our three AOH calculations.

```{r aoh-by-iucn, fig.cap = '(ref:caption-aoh-by-iucn)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_by_IUCN_status",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-obs-v-pot-overall) Proportion of species with each AOH trend, for both observed abandonment (Calculation 1) and a scenario of potential abandonment assuming no recultivation (Calculation 1P).

```{r aoh-obs-v-pot-overall, fig.cap = '(ref:caption-aoh-obs-v-pot-overall)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_obs_v_pot_overall",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-p-change-obs-v-pot-bird) Percent change in area of habitat at the end of the time series between observed and potential abandonment, for bird species only. Relative change in trend between scenarios is shown in color and the number of species in each group is shown in numeric annotation on bars. (See Fig. \@ref(fig:aoh-p-change-obs-v-pot-mam) for a corresponding figure for mammals.)

```{r aoh-p-change-obs-v-pot-bird, fig.cap = '(ref:caption-aoh-p-change-obs-v-pot-bird)'}
knitr::include_graphics(path = paste0(p_plots,
                                      "aoh/aoh_p_change_obs_v_pot_bird",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-p-change-obs-v-pot-mam) Percent change in area of habitat at the end of the time series between observed and potential abandonment, for bird species only. Relative change in trend between scenarios is shown in color and the number of species in each group is shown in numeric annotation on bars. (See Fig. \@ref(fig:aoh-p-change-obs-v-pot-bird) for a corresponding figure for birds.)

```{r aoh-p-change-obs-v-pot-mam, fig.cap = '(ref:caption-aoh-p-change-obs-v-pot-mam)'}
knitr::include_graphics(path = paste0(p_plots,
                                      "aoh/aoh_p_change_obs_v_pot_mam",
                                      aoh_run_date,".pdf"))
```

<!-- Obviated by the combo figure above -->
<!-- (ref:caption-aoh-obs-v-pot-by-site-bird) Number of bird species with various trends in AOH for scenarios of observed vs. potential abandonment, shown for each site. Mature forest obligate birds are excluded. -->

<!-- ```{r aoh-obs-v-pot-by-site-bird, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site-bird)'} -->
<!-- knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_trend_obs_v_pot_by_site_sbs_bird", -->
<!--                                       aoh_run_date,".pdf")) -->
<!-- ``` -->

<!-- (ref:caption-aoh-obs-v-pot-by-site-mam) Number of mammals species with various trends in AOH for scenarios of observed vs. potential abandonment, shown for each site. -->

<!-- ```{r aoh-obs-v-pot-by-site-mam, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site-mam)'} -->
<!-- knitr::include_graphics(path = paste0(p_plots, "aoh/aoh_trend_obs_v_pot_by_site_sbs_mam", -->
<!--                                       aoh_run_date,".pdf")) -->
<!-- ``` -->

<!-- (ref:caption-aoh-obs-v-pot-by-site-stacked) Proportion of species with various AOH trends for scenarios of observed vs. potential abandonment, shown for each site -->

<!-- ```{r aoh-obs-v-pot-by-site-stacked, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site-stacked)'} -->
<!-- knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_obs_v_pot_by_site", -->
<!--                                       aoh_run_date,".pdf")) -->
<!-- ``` -->

(ref:caption-aoh-obs-v-pot-by-site-mature-for-obl) AOH for observed (Calculation 1) vs. potential abandonment (Calculation 1P), by site and AOH scale, shown for mature forest obligate and non-obligate birds.

```{r aoh-obs-v-pot-by-site-mature-for-obl, fig.cap = '(ref:caption-aoh-obs-v-pot-by-site-mature-for-obl)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_obs_v_pot_by_site_mat_for_obl",
                                      aoh_run_date,".pdf"))
```

(ref:caption-aoh-by-range) Number of species with a given trend in AOH over time, across all sites, grouped by range size. Small-ranged species (with global ranges smaller than the global median range size) are shown in the top row, and species with ranges larger than the global median are shown in the bottom row. The lone small-ranged species that lost habitat following abandonment is the Iraq babbler, *Argya altirostris*.

```{r aoh-by-range, fig.cap = '(ref:caption-aoh-by-range)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/trend_summary_by_range_side",
                                      aoh_run_date,".pdf"))
```

(ref:caption-dw-stat) Durbin-Watson statistics for trends of AOH for Calculation 1, tracking AOH in abandoned croplands only. Calculated using the car package [R-car].

```{r dw-stat, fig.cap = '(ref:caption-dw-stat)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/dw_stat_crop_abn_iucn",
                                      aoh_run_date,".pdf"))
```


(ref:caption-habitat-age-profile) Habitat age profile, showing the proportion of abandoned croplands according to age as of 2017. This corresponds to the proportion of abandoned croplands that are theoretically suitable habitat for species with different habitat age requirements, based on how long each cropland has been abandoned. For example, a species that requires habitat that is at least 20 years old would only find 25% of abandoned croplands in Shaanxi / Shanxi Provinces, China, to be suitable as of 2017.

```{r habitat-age-profile, fig.cap = '(ref:caption-habitat-age-profile)'}
knitr::include_graphics(path = paste0(p_plots, "habitat_age_profile_2017.pdf"))
```


## Effect size

(ref:caption-aoh-change-percent-by-trend-obs-v-pot) The distribution of changes in area of habitat (AOH) as a percent of total area, shown for observed abandonment and a scenario of abandonment assuming no recultivation took place. Changes in AOH are calculated using the mean AOH during the first and last 5 years of the time series. Percent changes in AOH calculated with and without recultivation for individual species are shown in Figs. \@ref(fig:aoh-p-change-obs-v-pot-bird) and \@ref(fig:aoh-p-change-obs-v-pot-mam).

```{r aoh-change-percent-by-trend-obs-v-pot, fig.cap = '(ref:caption-aoh-change-percent-by-trend-obs-v-pot)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_change_percent_site_obs_by_trend_obs_v_pot5.pdf"))
```

(ref:caption-aoh-change-percent-by-site) The distribution of changes in area of habitat (AOH) as a percent of total area at each site. Changes in AOH are calculated using the mean AOH during the first and last 5 years of the time series.

```{r aoh-change-percent-by-site, fig.cap = '(ref:caption-aoh-change-percent-by-site)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_change_percent_site_obs_by_site_5.pdf"))
```

(ref:caption-aoh-change-by-site) The distribution of changes in area of habitat (AOH) at each site. Changes in AOH are calculated using the mean AOH during the first and last 5 years of the time series.

```{r aoh-change-by-site, fig.cap = '(ref:caption-aoh-change-by-site)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_abs_change_obs_5.pdf"))
```

(ref:caption-log-ratio-aoh-change-by-site) The distribution of the relative change in AOH ("ratio") of final AOH to starting AOH, shown on a log10 scale. Changes in AOH are calculated using the mean AOH during the first and last 5 years of the time series. Dashed lines show thresholds representing a halving (left) or a doubling (right) of AOH.

```{r log-ratio-aoh-change-by-site, fig.cap = '(ref:caption-log-ratio-aoh-change-by-site)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_ratio_obs_log_scale5.pdf"))
```

(ref:caption-ratio-aoh-change-by-site) The distribution of the relative change in AOH ("ratio") of final AOH to starting AOH, shown untransoformed. Changes in AOH are calculated using the mean AOH during the first and last 5 years of the time series.

```{r ratio-aoh-change-by-site, fig.cap = '(ref:caption-ratio-aoh-change-by-site)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_ratio_obs_5.pdf"))
```

(ref:caption-aoh-slope-percent-by-site) The distribution of estimated slope coefficients from linear regressions of AOH over time, with the rate of change presented as a percent of site area per year.

```{r aoh-slope-percent-by-site, fig.cap = '(ref:caption-aoh-slope-percent-by-site)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/effect_size/hist_aoh_slope_percent_site.pdf"))
```


## Traits

(ref:caption-p-suitable-by-habitat) Habitat suitabilities for bird and mammal species according to IUCN.

```{r p-suitable-by-habitat, fig.cap = '(ref:caption-p-suitable-by-habitat)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/prop_sp_w_habitat_suitability.pdf"))
```

(ref:caption-p-arable-suitability) Proportion of bird and mammal species for which arable land provides suitable habitat (gold) compared across sites, shown together with the proportion of species with statistically significant increasing trends in AOH (green).

```{r p-arable-suitability, fig.cap = '(ref:caption-p-arable-suitability)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/prop_sp_w_arable_suitability.pdf"))
```

(ref:caption-latitude-v-arable-suitability) Distribution of range centroid latitude shown according to whether arable land is listed as suitable habitat by the IUCN. Boxplot notches represent a 95% confidence interval around the median, calculated as the median  1.58 * Interquartile Range / sqrt(n). Notches that do not overlap provide strong evidence that medians differ.

```{r latitude-v-arable-suitability, fig.cap = '(ref:caption-latitude-v-arable-suitability)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/", 
                                      "arable_suitability_v_latitude", ".pdf"))
```


(ref:caption-p-gain-by-n-suitable) Proportion of bird and mammal species with significant gains in AOH following cropland abandonment from 1987-2017, shown according to the number of IUCN Level 2 habitats listed as suitable by IUCN. This measure follows the "habitat breadth" measure developed by @Etard2020. Number of species in each group are shown above each bar.

```{r p-gain-by-n-suitable, fig.cap = '(ref:caption-p-gain-by-n-suitable)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/", 
                                      "n_suitable_habitats_lvl2_p_gain_combo", ".pdf"))
```

(ref:caption-trend-by-order) Proportion of bird and mammal species with significant gains in AOH following cropland abandonment from 1987-2017, shown by taxonomic order.

```{r trend-by-order, fig.cap = '(ref:caption-trend-by-order)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/taxonomic_order_p_gain.pdf"))
```

(ref:caption-trend-by-family-birds) Proportion of bird species with significant gains in AOH following cropland abandonment from 1987-2017, shown by taxonomic family.

```{r trend-by-family-birds, fig.cap = '(ref:caption-trend-by-family-birds)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/taxonomic_family_p_gain_bird.pdf"))
```

(ref:caption-trend-by-family-mammals) Proportion of mammal species with significant gains in AOH following cropland abandonment from 1987-2017, shown by taxonomic family.

```{r trend-by-family-mammals, fig.cap = '(ref:caption-trend-by-family-mammals)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/taxonomic_family_p_gain_mam.pdf"))
```

(ref:caption-traits-model-resid-v-fitted) Diagnostic Residual vs. Fitter plots for various specifications of logistic and linear regression models predicting AOH response with various species traits. See regression coefficients in Tables \@ref(tab:traits-mod-table-binary)-\@ref(tab:traits-mod-table-slope).

```{r traits-model-resid-v-fitted, fig.cap = '(ref:caption-traits-model-resid-v-fitted)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/model_diagnostics_resid_v_fitted_combo",
                                      mod_label, ".pdf"))
```

(ref:caption-traits-model-qq) Diagnostic Q-Q plots for various specifications of logistic and linear regression models predicting AOH response with various species traits. See regression coefficients in Tables \@ref(tab:traits-mod-table-binary)-\@ref(tab:traits-mod-table-slope).

```{r traits-model-qq, fig.cap = '(ref:caption-traits-model-qq)'}
knitr::include_graphics(path = paste0(p_plots, "aoh/traits/model_diagnostics_qq_combo",
                                      mod_label, ".pdf"))
```

