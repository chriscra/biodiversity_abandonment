---
title: "Figures"
author: "Christopher L. Crawford"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script is part of the **Effects of cropland abandonment on biodiversity** project, developed by Christopher L. Crawford (chris.L.crawford@gmail.com) at Princeton University beginning in Fall 2021.
See https://github.com/chriscra/biodiversity_abandonment.



```{r initialize}
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/0_start.R")
source("/Users/christophercrawford/work/projects/biodiversity_abn/scripts/_util/_util_files.R")
```

```{r clean-up}
os <- get_sizes(ls())

os %>% 
  summarise(total_env_size = sum(size)) %>% 
  mutate(gb = total_env_size / 1024^3)

os
os %>% print(n = 30)

# rm(list = os$object[c(1:2)])

get(os$object[16])

# terra and raster temp files
terra::tmpFiles(current=TRUE, orphan=FALSE, old=FALSE, 
                remove=TRUE)

terra::tmpFiles(current=TRUE, orphan=TRUE, old=TRUE, 
                remove=FALSE)

terra::tmpFiles(current=TRUE, orphan=TRUE, old=TRUE, 
                remove=TRUE)

raster::rasterTmpFile()
raster::showTmpFiles()
raster::removeTmpFiles()

warnings()
```

Note: we restrict all scenarios (Calc. 1 - cropland abandonment only, Calc. 2 - abandoned lands, starting from 1987, and Calc. 3 - full landscape, entire spatial and temporal scal) to the same set of species, so that comparisons are consistent.
There are some species (e.g., the neotropical otter *Lontra longicaudis* and the Amazon river dolphin *Inia geoffrensis*) that do not have any habitat that is affected by abandonment.
In these cases, their only habitat shows up in the full landscape scenario.

# Overall Trends

```{r test-color-palette}
# see _util_misc.R

# ---------------------------------------------------------- #
# check whether palette is colorblind friendly
aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class == "bird", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         aoh_type == "crop_abn_iucn",
         overall_trend %in% c("gain", "no trend", "loss")
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = fct_relevel(aoh_type, rev), y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", ) +
  theme_classic() + 
  # scale_x_discrete(labels = aoh_type_labels) +
  # labs(x = "AOH Scenario", y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "AOH Scenario", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_grid(rows = vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels)) +
  colorblindr::cvd_grid()

```


```{r set-up-tmp-files-options}
# see _util_files.R
aoh_ms_tmp_trends
aoh_ms_tmp_trends_by_sp

aoh_types_sub <- aoh_types[c(6, 3, 1)]
threat_statuses <- c("Threatened", "Not Threatened")


plot_filter_options_df <- tibble(
  run = 1:4,
  passage_opt = c("include_passage", "include_passage", 
                  "exclude_passage", "exclude_passage"),
  mature_opt = c("include_mature_forest_obl", "exclude_mature_forest_obl", 
                  "include_mature_forest_obl", "exclude_mature_forest_obl")
)

# defaults:
passage_opt <- "exclude_passage"
mature_opt <- "exclude_mature_forest_obl"

```

```{r *fig3}
# formerly figure 4 before final accepted version of manuscript

lapply(c("pdf", "png"), function(file_type_) {
  ggsave(
    aoh_ms_tmp_trends_by_sp %>%  
      filter(
        # !aoh_type %in% c("max_potential_abn_iucn", "full_potential_iucn"),
        !grepl("potential", aoh_type)
        ) %>%
      group_by(aoh_type, vert_class, passage_type,
               overall_trend, trend_direction, trend_consistency) %>%
      summarise(n_sp = n()) %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = trend_direction, y = n_sp,
                           fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(1, 2, 6, 5, 3,
                                                                                         4)]))) +
      geom_col(color = "black", size = .25, position = position_stack(reverse = TRUE)) +
      theme_classic() +
      scale_x_discrete(labels = palette_labels) +
      scale_y_continuous(n.breaks = 6) +
      labs(x = NULL, #"AOH Trend", 
           y = "Number of Species") +
      
      scale_fill_manual(name = "AOH Trend", 
                        labels = palette_labels,
                        values = palette_du_jour) + 
      theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 335, vjust = 1, 
                                       hjust = 0, size = 8),
            panel.spacing.x = unit(0.4, "cm"),
            legend.box.spacing = unit(0, "mm")
            ) +
      guides(fill = guide_legend(nrow = 2)) +
      facet_grid(
        # col = vars(vert_class), rows = vars(aoh_type),
        row = vars(vert_class), col = vars(aoh_type),
        scales = "free_y", 
        # labeller = as_labeller(aoh_type_labels)
        labeller = as_labeller(c(
          crop_abn_iucn = "1a. Abandonment\n(cultivation-2017)",
          crop_abn_potential_iucn = "1b. Abandonment,\nno recultivation\n(cultivation-2017)",
          max_abn_iucn = "2a. Net change in\nabandoned crop-\nlands (1987-2017)",
          full_iucn = "3a. Entire\nspatial extent\n(1987-2017)",
          bird = "Birds", mam = "Mammals"))
        ),
    filename = paste0(
      p_output, 
      "figures/figure_4.", file_type_
      # "plots/aoh/", "aoh_trend_by_vert_aoh_type", aoh_run_date, "_ppt", ".pdf"
      ),
    # width = 5.8, height = 4, # with Calc. 1b
    width = 4.5, height = 4,
    units = "in")
})



# alternative version for Nature Sustainability:

# narrow:
ggsave(
  aoh_ms_tmp_trends_by_sp %>%  
      filter(
        # !aoh_type %in% c("max_potential_abn_iucn", "full_potential_iucn"),
        !grepl("potential", aoh_type)
        ) %>%
      group_by(aoh_type, vert_class, passage_type,
               overall_trend, trend_direction, trend_consistency) %>%
      summarise(n_sp = n()) %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = trend_direction, y = n_sp,
                           fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(1, 2, 6, 5, 3,
                                                                                         4)]))) +
      geom_col(color = "black", size = .25, position = position_stack(reverse = TRUE)) +
      theme_classic() +
      scale_x_discrete(labels = palette_labels) +
      scale_y_continuous(n.breaks = 6) +
      labs(x = NULL, #"AOH Trend", 
           y = "Number of Species") +
      
      scale_fill_manual(name = "AOH\nTrend", 
                        labels = gsub(" ", "\n", palette_labels),
                        values = palette_du_jour) + 
      theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 330, vjust = 1, 
                                       hjust = 0, size = 8),
            panel.spacing.x = unit(0.05, "cm"),
            legend.box.spacing = unit(0, "mm")
            ) +
      guides(fill = guide_legend(nrow = 2)) +
      facet_grid(
        # col = vars(vert_class), rows = vars(aoh_type),
        row = vars(vert_class), col = vars(aoh_type),
        scales = "free_y", 
        # labeller = as_labeller(aoh_type_labels)
        labeller = as_labeller(c(
          crop_abn_iucn = "Calculation 1a",
          max_abn_iucn = "Calculation 2a",
          full_iucn = "Calculation 3a",
          bird = "Birds", mam = "Mammals"))
        ),
    filename = paste0(p_output, "figures/figure_4_narrow.pdf"),
    height = 95, width = 88, units = "mm")


# wide:
ggsave(
  aoh_ms_tmp_trends_by_sp %>%  
      filter(
        # !aoh_type %in% c("max_potential_abn_iucn", "full_potential_iucn"),
        !grepl("potential", aoh_type)
        ) %>%
      group_by(aoh_type, vert_class, passage_type,
               overall_trend, trend_direction, trend_consistency) %>%
      summarise(n_sp = n()) %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = trend_direction, y = n_sp,
                           fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(1, 2, 6, 5, 3,
                                                                                         4)]))) +
      geom_col(color = "black", size = .25, position = position_stack(reverse = TRUE)) +
      theme_classic() +
      scale_x_discrete(labels = palette_labels) +
      scale_y_continuous(n.breaks = 6) +
      labs(x = NULL, #"AOH Trend", 
           y = "Number of Species") +
      
      scale_fill_manual(name = "AOH Trend", 
                        labels = gsub(" ", "\n", palette_labels),
                        values = palette_du_jour) + 
      theme(legend.position = "right",
            axis.text.x = element_text(angle = 335, vjust = 1, 
                                       hjust = 0, size = 8),
            panel.spacing.x = unit(0.4, "cm"),
            legend.box.spacing = unit(0, "mm")
            ) +
      guides(fill = guide_legend(ncol = 1)) +
      facet_grid(
        # col = vars(vert_class), rows = vars(aoh_type),
        row = vars(vert_class), col = vars(aoh_type),
        scales = "free_y", 
        # labeller = as_labeller(aoh_type_labels)
        labeller = as_labeller(c(
          # crop_abn_iucn = "Calculation 1a.\nAbandonment\n(cultivation-2017)",
          # max_abn_iucn = "Calculation 2a.\nNet change in abandoned\ncroplands  (1987-2017)",
          # full_iucn = "Calculation 3a.\nEntire spatial\nextent (1987-2017)",
          crop_abn_iucn = "Calculation 1a",
          max_abn_iucn = "Calculation 2a",
          full_iucn = "Calculation 3a",
          bird = "Birds", mam = "Mammals"))
        ),
    filename = paste0(p_output, "figures/figure_4_wide.pdf"),
    height = 87, width = 170, units = "mm")
```

```{r trend-summary-overall}
aoh_types

# include potential abandonment scenarios for calculations 2 and 3
# gg_aoh_trend_by_vert_aoh_type <-
gg_aoh_trend_by_vert_aoh_type_without_pot <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(
    # binomial %in% (filter(species_list, site != "mato_grosso") %>% .$binomial %>% unique()), # exclude species only found in Mato Grosso
    
    # turn the following two lines on/off or off/on to switch from including potential scenarios for all calculations or not
    # !aoh_type %in% c("max_potential_abn_iucn", "full_potential_iucn"), 
    !grepl("potential", aoh_type)
    ) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(x = trend_direction, y = n_sp,
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(1, 2, 6, 5, 3, 4)]))) +
  geom_col(color = "black", size = .25, position = position_stack(reverse = TRUE)) +
  theme_classic() +
 scale_x_discrete(labels = palette_labels) +
  scale_y_continuous(n.breaks = 6) +
  labs(x = NULL, #"AOH Trend", 
       y = "Number of Species") +

  scale_fill_manual(name = "AOH Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 335, vjust = 1, 
                                   hjust = 0, size = 8),
        panel.spacing.x = unit(0.4, "cm"),
        legend.box.spacing = unit(0, "mm")
        ) +
    guides(fill = guide_legend(nrow = 2)) +
  facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", 
    # labeller = as_labeller(aoh_type_labels)
    labeller = as_labeller(c(crop_abn_iucn = "1. Abandonment\n(cultivation-2017)",
                             crop_abn_potential_iucn = "1b. Abandonment,\nno recultivation\n(cultivation-2017)",
                             max_abn_iucn = "2. Net change in\nabandoned crop-\nlands (1987-2017)",
                             full_iucn = "3. Entire\nspatial extent\n(1987-2017)",
                             bird = "Birds", mam = "Mammals"))
    )


ggsave(gg_aoh_trend_by_vert_aoh_type_without_pot,
       filename = paste0(p_output, "plots/aoh/",
                         "aoh_trend_by_vert_aoh_type", 
                         aoh_run_date,
                         "_without_pot",
                         ".pdf"),
       width = 4.5, height = 4, units = "in")


# ------------------------------------------------------ #
# exclude species in Mato Grosso
gg_aoh_trend_by_vert_aoh_type_wo_mg <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(
    binomial %in% (filter(species_list, site != "mato_grosso") %>% .$binomial %>% unique()), # exclude species only found in Mato Grosso
    !aoh_type %in% c("max_potential_abn_iucn", "full_potential_iucn"),
    !grepl("potential", aoh_type)
    ) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(x = trend_direction, y = n_sp,
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(1, 2, 6, 5, 3, 4)]))) +
  geom_col(color = "black", size = .25, position = position_stack(reverse = TRUE)) +
  theme_classic() +
 scale_x_discrete(labels = palette_labels) +
  scale_y_continuous(n.breaks = 6) +
  labs(x = NULL, #"AOH Trend", 
       y = "Number of Species") +

  scale_fill_manual(name = "AOH Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 335, vjust = 1, 
                                   hjust = 0, size = 8),
        panel.spacing.x = unit(0.4, "cm"),
        legend.box.spacing = unit(0, "mm")
        ) +
    guides(fill = guide_legend(nrow = 2)) +
  facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", 
    # labeller = as_labeller(aoh_type_labels)
    labeller = as_labeller(c(crop_abn_iucn = "1. Abandonment\n(cultivation-2017)",
                             crop_abn_potential_iucn = "1b. Abandonment,\nno recultivation\n(cultivation-2017)",
                             max_abn_iucn = "2. Net change in\nabandoned crop-\nlands (1987-2017)",
                             full_iucn = "3. Entire\nspatial extent\n(1987-2017)",
                             bird = "Birds", mam = "Mammals"))
    )


ggsave(gg_aoh_trend_by_vert_aoh_type_wo_mg,
       filename = paste0(p_output, "plots/aoh/",
                         "aoh_trend_by_vert_aoh_type", 
                         aoh_run_date,
                         "_wo_mg",
                         ".pdf"),
       width = 6.5, height = 4, units = "in")

```


```{r trend-summary-overall-mat-for-obl}
# -------- excluding mature forest obligates ----- ------ #

gg_aoh_trend_by_vert_aoh_type_no_mat <-
  aoh_feols_trends_by_sp %>%
  # aoh_trends_by_sp %>% # added July 2023, for reproducing dissertation figure.
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         # vert_class == "bird", # added July 2023, for reproducing dissertation figure.
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # mature_forest_obl < 0.5
         ) %>%

  group_by(aoh_type,
           # vert_class,
           passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%
    filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(#vert_class, 
          aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         x = trend_direction,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(2, 1, 3, 4, 5, 6)])
         )) +
  geom_col(color = "black", size = .25) +
  theme_classic() + 
 scale_x_discrete(labels = palette_labels) +
  labs(x = "AOH Trend", y = "Number of Species") +

  scale_fill_manual(name = "Trend",
                    values = palette_du_jour,
                    labels = palette_labels,
                    # limits = names(palette_labels) # added July 2023, for reproducing dissertation figure.
                    ) + 
  theme(legend.position = "right", 
        axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)) +
  facet_grid(
        row = vars(mature_forest_obl), col = vars(aoh_type),
    scales = "free_y", labeller = as_labeller(c(aoh_type_labels, 
  "TRUE" = "Mature Forest \nObligates",
  "FALSE" = "Non-Mature Forest \nObligates")))


ggsave(gg_aoh_trend_by_vert_aoh_type_no_mat,
       filename = paste0(p_output, 
                         "plots/aoh/",
                         # "plots_dis/aoh/",
                         "aoh_trend_overall_by_mature_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 5, units = "in")


```


```{r overall-stacked-percent}
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
aoh_trends_by_sp %>%
  select(aoh_type) %>% unique()


gg_trends_stack_percent <-
  aoh_trends_by_sp %>% filter(aoh_type != "abn_iucn", vert_class != "amp", passage_type == "exclude_passage", mature_forest_obl < 0.5) %>%
  # aoh_ms_tmp_trends_by_sp %>%
  filter(!grepl("potential", aoh_type)) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", ) +
  theme_classic() + 

  scale_y_discrete(labels = aoh_type_labels) +
  labs(y = "AOH Scenario", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, 
                    values = palette_du_jour) + 
  theme(legend.position = "right") +
  facet_grid(rows = vars(vert_class),
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_trends_stack_percent,
       filename = paste0(p_output, 
                         # "plots/aoh/",
                         "plots_dis/aoh/",
                         "trend_summary_stacked", aoh_run_date, ".pdf"),
       width = 5.5, height = 3, units = "in")

# ------------------------------------------------------------ #
# No mature forest obligates:
# ------------------------------------------------------------ #
no_mat <-
  aoh_feols_trends_by_sp %>%
# aoh_trends_by_sp %>%
  filter(passage_type == passage_opt,
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # mature_forest_obl < 0.5
         ) %>%
  group_by(aoh_type, vert_class, passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type)

gg_trends_stack_percent_no_mature <-
  gg_trends_stack_percent %+% no_mat + facet_grid(
    rows = vars(mature_forest_obl), cols = vars(vert_class),
    scales = "free_y", 
    labeller = as_labeller(c("bird" = "Birds", "mam" = "Mammals",
                             "TRUE" = "Mature Forest\nObligates",
                             "FALSE" = "Non-Mature\nForest Obligates"))
    )

ggsave(gg_trends_stack_percent_no_mature,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_overall_stacked_by_mature_obl", aoh_run_date, ".pdf"),
       width = 7.5, height = 3, units = "in")



# ------------------------------------------------------------ #
# flipped:
# ------------------------------------------------------------ #
gg_trends_stack_percent_flipped <-
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_trends_by_sp %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = fct_relevel(aoh_type, rev), y = n_sp,
    # y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", ) +
  guides(col = "none") +
  theme_classic() + 
  scale_x_discrete(labels = aoh_type_labels) +
  labs(x = "AOH Scenario", y = "Proportion of Species") +

  # scale_y_discrete(labels = aoh_type_labels) +
  # labs(y = "AOH Scenario", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  facet_wrap(vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))

ggsave(gg_trends_stack_percent_flipped,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_stacked_flipped", aoh_run_date, ".pdf"),
       width = 5, height = 6, units = "in")

```







```{r by-IUCN-category}

# ----------------------------------------------------------------------- #
# Lumped across all sites, threatened vs. non-threatened #
# ----------------------------------------------------------------------- #
gg_trend_summary_by_iucn_status_lumped <-
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_trends_by_sp %>%
  filter(redlistCategory != "Data Deficient",
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           # redlistCategory,
           threatened,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         y = threatened, x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "IUCN Status", x = "Proportion of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom") +
      theme(strip.text.y.right = element_text(angle = 0)) +
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels),
               scales = "free")

ggsave(gg_trend_summary_by_iucn_status_lumped,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_lumped", aoh_run_date,
                         ".pdf"),
       width = 6, height = 3.5, units = "in")


# -------------------------------------------------------- #
# Stacked, with number of species:
# -------------------------------------------------------- #
gg_trend_summary_by_iucn_status_lumped_numeric <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(redlistCategory != "Data Deficient",
         !grepl("potential", aoh_type)
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           # redlistCategory,
           threatened,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         x = aoh_type, y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  # geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() +
  scale_x_discrete(labels = aoh_type_labels) + 
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "Number of Species", x = NULL) +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)
      # theme(strip.text.y.right = element_text(angle = 0)
  ) +
    facet_grid(cols = vars(vert_class), rows = vars(threatened), 
               labeller = as_labeller(aoh_type_labels),
               scales = "free")

ggsave(gg_trend_summary_by_iucn_status_lumped_numeric,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_lumped_numeric", aoh_run_date,
                         ".pdf"),
       width = 4.5, height = 5, units = "in")


# ------------------------------------------------------------- #
# individual categories
# -------------------------------------------------------- #
gg_trend_summary_by_iucn_status <-
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_trends_by_sp %>%
  filter(!grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn"
         redlistCategory != "Data Deficient"
         ) %>%
  # {if (mature_opt == "exclude_mature_forest_obl") filter(., mature_forest_obl < 0.5) else .} %>%

  group_by(aoh_type, vert_class, passage_type, 
           redlistCategory,
           # threatened,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = redlistCategory %>% fct_relevel(), 
         x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "IUCN Status", x = "Proportion of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "right",
        # axis.text.x = element_text(size = 8)
        ) +
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_by_iucn_status,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 4.5, units = "in")




# ----------------------------------------------------------------------- #
# Lumped, threatened vs. non-threatened, by site
# ----------------------------------------------------------------------- #

gg_trend_summary_by_iucn_status_lumped_by_site <- 
  lapply(1:2, function(j) {
    lapply(aoh_types_sub, function(i) {
      aoh_ms_tmp_trends %>%
      # aoh_trends %>%
        filter(redlistCategory != "Data Deficient",
               !grepl("potential", aoh_type),
               aoh_type == i
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened,
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%
        filter(threatened == threat_statuses[j]) %>%
        
        ggplot(mapping = aes(
         x = vert_class, y = n_sp, #alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         # group = trend
         # group = overall_trend
         )) +
  geom_col(position = position_dodge2(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
 scale_x_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) +
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "Number of Species", x = NULL,
       caption = paste0(threat_statuses[j], " Species: ", filter(aoh_type_df, label == i)$p5)) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  theme(legend.position = c(0.9, 0.15),
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
      theme(strip.text.y.right = element_text(angle = 0)) +
  # facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    # scales = "free_y", labeller = as_labeller(aoh_type_labels))
    facet_wrap(vars(site), ncol = 4,
               scales = "free", labeller = as_labeller(fancy_labels)
               )
    })
    })


lapply(1:2, function(j) {
  lapply(1:3, function(i) {
    ggsave(gg_trend_summary_by_iucn_status_lumped_by_site[[j]][[i]],
           filename = paste0(p_output, "plots/aoh/", "trend_summary_by_IUCN_status_by_site_", 
                             aoh_types_sub[i], "_",
                             gsub(" ", "", threat_statuses[j]), aoh_run_date,
                             ".pdf"),
           width = 6, height = 5, units = "in")
    })
})
```


```{r by-IUCN-category-final}
# --------------------- #
# n species by site, with facet cols for lumped threat status, rows for birds/mammals

gg_aoh_by_iucn_lumped_by_site_bars <- 
  lapply(aoh_types_sub, function(i) {
    aoh_ms_tmp_trends %>%
      # aoh_trends %>%
        filter(redlistCategory != "Data Deficient",
               aoh_type == i
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened,
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%

      ggplot(mapping = aes(
         x = n_sp, y = fct_relevel(site, rev), # alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)])),
         # group = trend
         # group = overall_trend
         )) +
  geom_col(
    position = position_dodge(preserve = "single"),
    color = "black", size = .25
    ) +
  theme_classic() + 
    scale_y_discrete(labels = fancy_labels) + 
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 6, 3)],
                    values = palette_du_jour[c(1, 6, 3)]) +
  theme(legend.position = "bottom") +
  facet_grid(
    rows = vars(vert_class), cols = vars(threatened),
    scales = "free", labeller = as_labeller(aoh_type_labels)
    )
})

names(gg_aoh_by_iucn_lumped_by_site_bars) <- aoh_types_sub


lapply(1:3, function(i) {
  ggsave(gg_aoh_by_iucn_lumped_by_site_bars[[i]],
           filename = paste0(p_output, "plots/aoh/",
                             "aoh_by_iucn_lumped_by_site_bars_", 
                             aoh_types_sub[i],
                             aoh_run_date,
                             ".pdf"),
           width = 5, height = 7.5, units = "in")
})

# ------------------------------------------- #
# combine with a overall total bar on the side - this is the final version that goes into the manuscript
# ------------------------------------------- #

lapply(aoh_types_sub, function(i) {
  
gg_aoh_iucn_overall_tmp <-
  lapply(1:2, function(j) {
  aoh_ms_tmp_trends_by_sp %>%
      # aoh_trends_by_sp %>%
  filter(redlistCategory != "Data Deficient",
         aoh_type == i
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           threatened,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
    filter(threatened == threat_statuses[j]) %>%
   
  ggplot(mapping = aes(
         x = threatened,# x = aoh_type,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         )) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(
    x = NULL, y = NULL
    # x = "IUCN Status", y = "Number of Species"
    ) +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
      scale_x_discrete(labels = c("Threatened" = "Overall",
                                  "Not Threatened" = "Overall")) +
      scale_y_continuous(n.breaks = 8) +

  theme(legend.position = "none", axis.ticks.x = element_blank(),
        plot.background = element_blank()) +
    facet_grid(cols = vars(threatened), rows = vars(vert_class), 
               scales = "free",
               labeller = as_labeller(c("mam" = "Mammals",
               "bird" = "Birds",
               "Threatened" = "Thr.",
               "Not Threatened" = "Not Thr."
               ))
               )
})


gg_aoh_by_iucn_lumped_by_site_bars_tmp <-
  aoh_ms_tmp_trends %>%
  # aoh_trends %>%
        filter(redlistCategory != "Data Deficient",
               aoh_type == i) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 threatened,
                 trend) %>%
        summarise(n_sp = n()) %>% ungroup() %>%
        arrange(vert_class, aoh_type) %>%
        mutate(site_thr = paste0(site, "\n", threatened)) %>%
      filter(!is.na(trend)) %>%
        ggplot(mapping = aes(
         x = n_sp, y = fct_relevel(site, rev), # alpha = threatened,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)])),
         )) +
  geom_col(
    position = position_dodge(preserve = "single"#, width = 0.8, padding = 0.2
                               ),
    color = "black", size = .25
    ) +
  theme_classic() + 
    scale_y_discrete(labels = fancy_labels
                       # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                                   ) + 
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend",
                    labels = palette_labels,#[c(1, 6, 3)],
                    values = palette_du_jour#[c(1, 6, 3)]
                    ) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
        panel.grid.major.x = element_line(),
        ) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    rows = vars(vert_class), cols = vars(threatened),
    scales = "free", labeller = as_labeller(aoh_type_labels)
    )



ggsave(
  plot_grid(
    plot_grid(
  gg_aoh_by_iucn_lumped_by_site_bars_tmp + theme(strip.text.y.right = element_blank(),
                                                 legend.position = "none") + labs(caption = NULL), 
  # plot_grid(
  gg_aoh_iucn_overall_tmp[[2]] + theme(strip.text.y.right = element_blank()),  
            gg_aoh_iucn_overall_tmp[[1]] + labs(y = NULL),
           # ncol = 2#,
            # rel_widths = c(1, 0.9)
            # ),
  nrow = 1, ncol = 3, 
  align = "h", axis= "b",
  rel_widths = c(3, 0.675, 0.75)
  ),
  ggpubr::get_legend(gg_aoh_trend_by_vert_aoh_type + 
                       guides(fill = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom")),
  nrow = 2, ncol = 1, rel_heights = c(1, 0.07)),
  filename = paste0(p_output, "plots/aoh/",
                    "aoh_IUCN_by_site_combo_",
                    i,
                    aoh_run_date, ".pdf"),
  width = 6.5, height = 7.5, units = "in")

})
```

```{r by-range-size}
# ------------------------------------------------------------- #
# overall - stacked
# ------------------------------------------------------------- #

aoh_ms_tmp_trends_by_sp %>%
# aoh_trends_by_sp %>% 
  select(binomial, total_range_area, range_size_quantile)

gg_trend_summary_by_range <-
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_trends_by_sp %>%
  filter(!grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <=\nglobal median",
             range_size_quantile > 0.5 ~ "Range size >\nglobal median"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = small, x = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)),
         # group = overall_trend
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  # scale_y_discrete(labels = c("small" = "Range size \u2264\nglobal median",
  #                             "big" = "Range size >\nglobal median")) +
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(y = "IUCN Status", x = "Proportion of Species") +
  # labs(x = "AOH Trend", y = "Proportion of Species") +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
  # facet_grid(
    # col = vars(vert_class), rows = vars(aoh_type),
    # scales = "free_y", labeller = as_labeller(aoh_type_labels))
    facet_grid(rows = vars(aoh_type), cols = vars(vert_class), labeller = as_labeller(aoh_type_labels))

ggsave(gg_trend_summary_by_range,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range", aoh_run_date,
                         ".pdf"),
       width = 5.5, height = 5, units = "in")

# ------------------------------------------------------------- #
# overall - side by side
# ------------------------------------------------------------- #

gg_trend_summary_by_range_side <-
  aoh_ms_tmp_trends_by_sp %>%
  # aoh_trends_by_sp %>%
  filter(
    # passage_type == "exclude_passage",
         # vert_class != "amp", 
         # redlistCategory != "Data Deficient",
         # !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         # mature_forest_obl < 0.5
         ) %>%

  group_by(aoh_type, vert_class, passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
         mapping = aes(x = vert_class, y = n_sp,
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour)))) +
  geom_col(position = position_dodge(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
  scale_x_discrete(labels = aoh_type_labels) +
  # scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  labs(x = "Vert. Class", y = "Number of Species") +
# 
  scale_fill_manual(name = "Trend",
                    labels = palette_labels,
                    values = palette_du_jour) +
  theme(legend.position = "bottom",
            # axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0)
        ) +
    facet_grid(rows = vars(small), cols = vars(aoh_type),
               scales = "free_y",
               labeller = as_labeller(aoh_type_labels))

ggsave(gg_trend_summary_by_range_side,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_side", aoh_run_date,
                         ".pdf"),
       width = 5.5, height = 5.25, units = "in")


# ------------------------------------------------------------- #
# mature_forest_obligates:
# ------------------------------------------------------------- #
no_mat_by_range_size <- 
  aoh_feols_trends_by_sp %>%
  # aoh_ms_tmp_trends_by_sp %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%

  group_by(aoh_type, #vert_class, 
           passage_type, 
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <=\nglobal median",
             range_size_quantile > 0.5 ~ "Range size >\nglobal median"),
           mature_forest_obl = mature_forest_obl > 0.5,
           overall_trend, trend_direction, trend_consistency) %>%  
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(#vert_class, 
          aoh_type)


gg_trend_summary_by_range_no_mature <-
  gg_trend_summary_by_range %+% no_mat_by_range_size + 
  facet_grid(
    cols = vars(mature_forest_obl), rows = vars(aoh_type),
    scales = "free_y", 
    labeller = as_labeller(c(aoh_type_labels, 
                             "TRUE" = "Mature Forest Obligates (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates (Birds)"))
    )

ggsave(gg_trend_summary_by_range_no_mature,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_no_mat_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 5, units = "in")

# ------------------------------------------------------------- #
# by site:
# ------------------------------------------------------------- #

for(i in aoh_types[c(6, 3, 1)]) {
gg_trend_summary_range_by_site1 <-
  aoh_ms_tmp_trends %>%
  # aoh_trends %>%
    left_join(aoh_species_list) %>%
  filter(aoh_type == i) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site,
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(y = site, x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "IUCN Status", x = "Proportion of Species",
       caption = paste0(filter(aoh_type_df, label == i)$p5)) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(small), rows = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_range_by_site1,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_by_site1_", i, aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")

}


# version 2:
j <- "bird"
for(j in c("mam", "bird")) {
gg_trend_summary_range_by_site2 <-
  aoh_ms_tmp_trends %>%
  # aoh_trends %>%
    left_join(aoh_species_list) %>%
  filter(vert_class == j, 
         !grepl("potential", aoh_type)) %>%

  group_by(aoh_type, vert_class, passage_type, 
           site,
           small = case_when(
             range_size_quantile <= 0.5 ~ "Range size <= global median",
             range_size_quantile > 0.5 ~ "Range size > global median"),
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = gsub("\n", " ", c(aoh_type_labels, fancy_labels))) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(small), rows = vars(site), 
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
    theme(strip.text.y.right = element_text(angle = 0))


ggsave(gg_trend_summary_range_by_site2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_range_by_site_",
                         # "no_mat_obl_",
                         j, aoh_run_date,
                         ".pdf"),
       width = 7, height = 7.5, units = "in")

}
```

```{r aoh-trend-distill-old}
# Distill counts of trends:
aoh_trend_counts <-
  aoh_feols_trends %>%
  # aoh_ms_tmp_trends %>%
  # aoh_trends %>% # old, lm
  group_by(aoh_type, vert_class, site, 
           redlistCategory, threatened = redlistCategory %in% c("Critically Endangered", "Endangered", "Vulnerable"),
           passage_type,
           mature_forest_obl = mature_forest_obl > 0.5, # group by an expression
           trend) %>%
  summarise(trend_count = n()) %>% 
  ungroup()




aoh_trend_counts_by_category <-
  aoh_trend_counts %>%
  group_by(aoh_type, vert_class, passage_type, mature_forest_obl, trend, threatened) %>%
  summarise(trend_count = sum(trend_count)) %>% 
  ungroup()

  

# plot

aoh_trend_counts_by_category$mature_forest_obl %>% unique()
aoh_trend_counts_by_category %>% select(vert_class, mature_forest_obl) %>% unique()

# aoh_trends %>%
aoh_trend_counts_by_category %>%
  filter(aoh_type == "max_abn_iucn",
         passage_type == "exclude_passage",
         # !is.na(mature_forest_obl)
         mature_forest_obl == FALSE
         ) %>%

  ggplot(data = .,
       mapping = aes(x = threatened, 
                     y = trend_count,
                     # y = y
                     # group = as_factor(trend), 
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  labs(x = "Red List Category", 
       y = "Number of Species",
       fill = "Vert. Group",
       subtitle = filter(aoh_type_df, label == j)$desc,
       caption = paste0(
         if(passage_opt == "exclude_passage") {
                           paste0("", "excluding passage areas")} else {""},
         if(mature_opt == "exclude_mature_forest_obl") {
           paste0(" | ", "excluding mature forest obligates")} else {""}
                         )
       ) +
  guides(col = "none") +
  theme_classic() + 
  scale_alpha_manual(name = "Trend",
                     labels = c("gain" = "Gain",
                                "loss" = "Loss",
                                "no trend" = "No Trend"),
                     values = c("gain" = 1,
                                "loss" = 0.5,
                                "no trend" = 0.2)
                     ) + 
  facet_wrap(vars(threatened), scales = "free")



aoh_trend_counts %>%
  filter(aoh_type == "max_abn_iucn",
         passage_type == "exclude_passage",
         # !is.na(mature_forest_obl)
         mature_forest_obl == FALSE
         ) %>%

  ggplot(data = .,
       mapping = aes(x = threatened, 
                     y = trend_count,
                     fill = vert_class,
                     col = vert_class,
                     alpha = as_factor(trend)
                     )) +
  geom_col(position = position_dodge2(width = 0.8, preserve = "single")) + 
  # facet_grid(rows = vars(site), cols = vars(threatened), scales = "free")
  facet_wrap(vars(site#, threatened
                  ), scales = "free")


```

```{r by-site-side-by-side}
# -------------------------------------------------------------------- #
# Side by side ------------------------------------------------------- #
# -------------------------------------------------------------------- #

gg_trend_summary_by_site <-
  lapply(aoh_types_sub, function(i) {
    aoh_ms_tmp_trends %>%
      filter(!grepl("potential", aoh_type),
             aoh_type == i) %>%

      group_by(aoh_type, vert_class, passage_type, 
               site,
               trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = vert_class, y = n_sp, fill = trend)) +
      geom_col(position = position_dodge(preserve = "single"), 
               color = "black", size = .25) +
      theme_classic() + 
      labs(x = NULL, y = "Number of Species", 
           caption = filter(aoh_type_df, label == i)$p5) +
      scale_fill_manual(name = "Trend",
                        labels = palette_labels[c(1, 3, 6)],
                        values = palette_du_jour[c(1, 3, 6)]) +
      scale_x_discrete(labels = aoh_type_labels) +
      theme(legend.position = c(0.9, 0.125)) +
      facet_wrap(vars(site), labeller = as_labeller(fancy_labels), scales = "free")
    })

names(gg_trend_summary_by_site) <- aoh_types_sub

lapply(1:3, function(i) {
  ggsave(gg_trend_summary_by_site[[i]],
         filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_", aoh_types_sub[i], aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.25, units = "in")
})


# -------------------------------------------------------------------- #
# No mature forest obligates ----------------------------------------- #
# -------------------------------------------------------------------- #

gg_trend_summary_by_site_mat_obl <- 
  lapply(aoh_types_sub, function(i) {
  aoh_feols_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         aoh_type == i) %>%
  group_by(aoh_type, 
           # vert_class, 
           passage_type,
           # mat_obl = mature_forest_obl > 0.5,
           obligate_type,
           site,
           trend) %>%
  filter(!is.na(obligate_type)) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  arrange(#vert_class, 
          aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         # x = threatened, y = n_sp,
         x = obligate_type, y = n_sp,
         fill = trend #%>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_dodge(preserve = "single"), 
           color = "black", size = .25) +
  theme_classic() + 
  labs(x = NULL, y = "Number of Species",
       caption = filter(aoh_type_df, label == i)$p5) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_x_discrete(labels = c(
    "mature_forest_obligate" = "Mature\nForest\nObligates",
    "not_obligate" = "All Sp. But\nMature Forest\nObligates")) + 
 
  theme(legend.position = c(0.9, 0.125)) +
    facet_wrap(vars(site), labeller = as_labeller(fancy_labels), scales = "free")
})

names(gg_trend_summary_by_site_mat_obl) <- aoh_types_sub

lapply(1:3, function(i) {
  ggsave(gg_trend_summary_by_site_mat_obl[[i]],
         filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_mat_obl_", aoh_types_sub[i], aoh_run_date,
                           ".pdf"),
         width = 7, height = 6.5, units = "in")
})
```

```{r overall-plus-by-site-combo}
lapply(
  aoh_types[c(6,3,1,7,5,8)],
  # "crop_abn_iucn",
  function(i) {
    
    gg_aoh_overall_tmp <-
      aoh_ms_tmp_trends_by_sp %>%
      filter(aoh_type == i) %>%
      mutate(vert_class = case_when(vert_class == "mam" ~ "Mammals", vert_class == "bird" ~ "Birds"),
             aoh_type = "Overall") %>%
      group_by(aoh_type, vert_class, passage_type, overall_trend, trend_direction, trend_consistency) %>%
      summarise(n_sp = n()) %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = aoh_type, y = n_sp, 
                           fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                           )) +
      geom_col(position = position_stack(reverse = TRUE), color = "black", size = .25) +
      theme_classic() +
      scale_x_discrete(labels = aoh_type_labels) +
      scale_y_continuous(breaks = seq(from = 0, to = 1000, by = 100)) +
      labs(x = NULL, y = "Number of Species") +
      scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
      theme(legend.position = "none", axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
      facet_grid(row = vars(vert_class), col = vars(aoh_type), scales = "free_y")
    
    gg_aoh_by_site_tmp <-
      aoh_ms_tmp_trends %>%
      filter(aoh_type == i) %>%
      group_by(aoh_type, vert_class, passage_type, site, trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = vert_class, y = n_sp, fill = trend)) +
      geom_col(position = position_dodge(preserve = "single"), color = "black", size = .25, 
               show.legend = TRUE) +
      theme_classic() + 
      labs(x = NULL, y = NULL) +
       scale_fill_manual(name = "AOH Trend",
                    labels = str_wrap(palette_labels, width = 6)[c(1,6,3,2,5,4)],
                    # labels = palette_labels[c(1,6,3,2,5,4)],
                    values = palette_du_jour, drop = TRUE,
                    limits = names(palette_du_jour)[c(1,6,3,2,5,4)]) +
      scale_x_discrete(labels = aoh_type_labels) +
      guides(fill = guide_legend(ncol = 2, nrow = 3)) +
      theme(legend.position = c(0.84, 0.1), legend.text = element_text(size = 7)) +
      facet_wrap(vars(site), scales = "free", nrow = 4, ncol = 3, labeller = as_labeller(fancy_labels))
  
  ggsave(plot_grid(gg_aoh_overall_tmp, gg_aoh_by_site_tmp,
                   nrow = 1, ncol = 2, align = "h", axis= "b",
                   rel_widths = c(1, 3.3)
                   ),
         filename = paste0(p_output, "plots/aoh/", "aoh_overall_w_site_combo_",
                           i, aoh_run_date, 
                           "_no_lab",
                           ".pdf"),
         width = 6, height = 6, units = "in")
})
```

```{r *fig2-overall-trends-by-site}
# formerly chunk "overall-plus-by-site-prop-combo"
# producing file named: 
# paste0(p_output, "plots/aoh/", "aoh_overall_w_site_prop_combo_",
#         i, aoh_run_date, "_no_lab", "_no_border", ".pdf")

lapply(
  c("pdf", "png"), function(file_type_) {
  # aoh_types[c(6,3,1,7,5,8)],
  # "crop_abn_iucn", 
  # function(i) {
  
  gg_aoh_overall_tmp <-
    aoh_ms_tmp_trends_by_sp %>%
    filter(aoh_type == i) %>%
    mutate(vert_class = case_when(
      vert_class == "mam" ~ "Mammals",
      vert_class == "bird" ~ "Birds"),
      aoh_type = "Overall"
    ) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  arrange(vert_class, aoh_type) %>% 
  group_by(aoh_type, vert_class) %>% mutate(n_total = sum(n_sp)) %>% ungroup() %>% mutate(p_sp = n_sp/n_total) %>%
  ggplot(data = ., mapping = aes(x = aoh_type, y = n_sp, 
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour))
         )) +
  geom_col(
    position = position_stack(reverse = TRUE),
    color = "black", size = .25) +
  theme_classic() +
  scale_x_discrete(labels = aoh_type_labels) + 
  scale_y_continuous(breaks = seq(from = 0, to = 1000, by = 100)) +
  labs(x = NULL, y = "Number of Species") +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_blank(),
        strip.clip = "on",
        panel.margin = unit(0, "lines"),
        plot.margin = unit(c(0,0,0,2), "mm"),
        
        # strip.placement = "inside"#,
        strip.text = element_text(vjust = -2)
        ) +
  facet_grid(#switch = "y",
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", #labeller = as_labeller(c(i = "Overall","mam" = "Mammals", "bird" = "Birds"))
    )

  gg_aoh_by_site_prop_tmp <-
    aoh_ms_tmp_trends %>%
      filter(aoh_type == i) %>%
      group_by(aoh_type, vert_class, passage_type, site, trend) %>%
      summarise(n_sp = n()) %>% ungroup() %>%
      group_by(aoh_type, vert_class, passage_type, site) %>%
      mutate(total_sp = sum(n_sp)) %>% ungroup() %>%
      mutate(vert_class = case_when(vert_class == "bird" ~ "Birds", vert_class == "mam" ~ "Mammals"),
             vert_class = paste0(vert_class, "\n(n = ", total_sp, ")")) %>%
      arrange(vert_class, aoh_type) %>%
      ggplot(mapping = aes(x = vert_class, y = n_sp/total_sp,
                           # label = total_sp, 
                           fill = trend
                           )) +
      geom_col(
        position = position_dodge(preserve = "single"),
        color = "black", size = .25,
        show.legend = TRUE) +
      # geom_text(size = 3.5, nudge_y = -0.05) +
      
      theme_classic() + 
      labs(x = NULL, y = "Proportion of species", 
           # caption = paste0(filter(aoh_type_df, label == i)$p5)
           ) +
      scale_fill_manual(name = "AOH Trend",
                        labels = str_wrap(palette_labels, width = 6)[c(1,6,3,2,5,4)],
                        values = palette_du_jour, 
                        limits = names(palette_du_jour)[c(1,6,3,2,5,4)]) +
      scale_y_continuous(limits = c(0, 1), n.breaks = 6) + 
      # scale_x_discrete(labels = aoh_type_labels) +
      guides(fill = guide_legend(ncol = 2, nrow = 3)) +
      facet_wrap(vars(site), scales = "free", nrow = 4, ncol = 3,
                 labeller = as_labeller(fancy_labels)) +
      theme(legend.position = c(0.835, 0.0985), 
            legend.background = element_blank(),
            legend.text = element_text(size = 7),
            legend.title = element_text(size = 9),
            strip.background = element_blank(), 
            strip.text = element_text(hjust = 0, 
                                      # vjust = 0
                                      ),
            )
    
  ggsave(plot_grid(gg_aoh_overall_tmp,
                   gg_aoh_by_site_prop_tmp,
                   nrow = 1, ncol = 2, 
                   # labels = "auto",
                   align = "h", axis= "b",
                   rel_widths = c(1, 3.6)
                   ),
         filename = paste0(
           p_output,
           "figures/figure_2", ".", file_type_
           # "plots/aoh/", 
           # "aoh_overall_w_site_prop_combo_",
           # i, aoh_run_date, 
           # "_no_lab",
           # "_no_border",
           # ".pdf"
           ),
         width = 6, height = 6, units = "in")
})
```



```{r by-site-proportion-stacked}

lapply(
  # aoh_types[c(6,3,1,7,5,8)],
  "crop_abn_iucn",
  function(i) {
    ggsave(
      aoh_ms_tmp_trends %>%
        filter(#!grepl("potential", aoh_type),
               aoh_type == i
               ) %>%
        group_by(aoh_type, vert_class, passage_type, 
                 site,
                 trend) %>%
        summarise(n_sp = n()) %>%
        arrange(vert_class, aoh_type) %>%
        left_join(arable_gg_site_order_tmp) %>%

        ggplot(data = .,
               mapping = aes(y = site %>% fct_reorder(p_gain), 
                             x = n_sp,
                             fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)]))
                             )) +
        geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
        geom_vline(xintercept = 0.5, col = "gray70", linetype = 2) +

        theme_classic() + 
        labs(y = NULL, x = "Proportion of Species",
             caption = paste0(filter(aoh_type_df, label == i)$p5)
             ) +
        scale_fill_manual(name = "Trend",
                          labels = palette_labels[c(1, 3, 6)],
                          values = palette_du_jour[c(1, 3, 6)]) +
        scale_y_discrete(labels = fancy_labels) + 
        scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
        # theme(legend.position = "bottom") +
        facet_grid(
          # cols = vars(aoh_type), 
          cols = vars(vert_class),
          labeller = as_labeller(aoh_type_labels)),
      filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_proportion_stacked_", 
                        i, aoh_run_date, ".pdf"),
      width = 6, height = 4, units = "in"
      )
})
```


```{r by-site-stacked}
# -------------------------------------------------------------------- #
# Stacked       ------------------------------------------------------ #
# -------------------------------------------------------------------- #

gg_trend_summary_by_site_stacked <-
  aoh_ms_tmp_trends %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site,
           trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  # left_join(arable_gg_site_order_tmp) %>%
  ggplot(data = .,
       mapping = aes(y = site, x = n_sp,
                     fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
                     )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  geom_vline(xintercept = 0.5, col = "gray70", linetype = 2) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
  facet_grid(cols = vars(aoh_type), rows = vars(vert_class), labeller = as_labeller(aoh_type_labels))


ggsave(gg_trend_summary_by_site_stacked,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")


# ------------------------------------------------------------ #
# stack v2

gg_trend_summary_by_site_stacked_2 <-
  aoh_ms_tmp_trends %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = vert_class, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  geom_vline(xintercept = 0.5, col = "gray70", linetype = 2) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c(aoh_type_labels, fancy_labels)) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(aoh_type), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_2", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")



# ------------------------------------------------------------ #
# stack v3

gg_trend_summary_by_site_stacked_3 <-
  aoh_ms_tmp_trends %>%
  filter(!grepl("potential", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type %>% fct_relevel(rev), 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  geom_vline(xintercept = 0.5, col = "gray70", linetype = 2) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  # scale_y_discrete(labels = gsub("\n", " ",c(aoh_type_labels, fancy_labels))) + 
  scale_y_discrete(labels = c(aoh_type_labels_minimal, fancy_labels)) +
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(vert_class), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_3,
       filename = paste0(p_output, "plots/aoh/", 
                         "trend_summary_by_site_stacked_3", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 7.5, units = "in")
```


```{r by-site-stacked-no-mat}
# ------------------------------------------------------------ #
# No mature forest obligates:
# ------------------------------------------------------------ #
no_mat_by_site <-
  aoh_feols_trends %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type)
         ) %>%
  group_by(aoh_type,
           # vert_class,
           passage_type,
           mature_forest_obl = mature_forest_obl > 0.5,
           site,
           trend) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  arrange(
    # vert_class, 
    aoh_type)

gg_trend_summary_by_site_stacked_no_mature <-
  gg_trend_summary_by_site_stacked %+% no_mat_by_site +
  facet_grid(
    rows = vars(mature_forest_obl), cols = vars(aoh_type),
    scales = "free_y",
    labeller = as_labeller(c(aoh_type_labels,
                             "TRUE" = "Mature Forest Obligates (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates (Birds)"))
    )

ggsave(gg_trend_summary_by_site_stacked_no_mature,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_no_mat_obl", aoh_run_date,
                         ".pdf"),
       width = 6, height = 7.5, units = "in")

gg_trend_summary_by_site_stacked_no_mature2 <-
  no_mat_by_site %>%
  ggplot(mapping = aes(
         y = mature_forest_obl, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("TRUE" = "Mature Forest Obl.", "FALSE" = "Non-Mature Forest Obl.")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(aoh_type), rows = vars(site),
               labeller = as_labeller(c(fancy_labels, aoh_type_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_by_site_stacked_no_mature2,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_by_site_stacked_no_mat_obl2", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 7.5, units = "in")

```

### Observed vs. Potential

```{r obs-v-pot-overall}
# ------------------------------------------------------------ #
# ------------------------------------------------------------ #
gg_trends_obs_v_pot_overall <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    x = aoh_type, y = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(position = position_fill(rev = TRUE), color = "black") +
  theme_classic() + 
  scale_x_discrete(labels = c("crop_abn_potential_iucn" = "Potential", 
                              "crop_abn_iucn" = "Observed")) +
  labs(x = "Abandonment Scenario", 
       y = "Proportion of Species") +
  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right") +
  facet_grid(cols = vars(vert_class), 
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_trends_obs_v_pot_overall,
       filename = paste0(p_output, "plots/aoh/", 
                         "trend_summary_obs_v_pot_overall", aoh_run_date, 
                         ".pdf"),
       width = 4.5, height = 4, units = "in")


# ------------------------------------------------------------ #
# side by side:
# ------------------------------------------------------------ #
gg_trends_obs_v_pot_overall_dodge <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(x = trend_direction, y = n_sp,
                       group = trend_direction,
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(color = "black") +
  theme_classic() + 
  scale_x_discrete(labels = palette_labels) +
  labs(x = NULL, y = "Number of Species") +
  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 20, vjust = 1, hjust = 1)
        ) +
  facet_grid(
    rows = vars(vert_class), cols = vars(aoh_type), 
    scales = "free", labeller = as_labeller(c("crop_abn_potential_iucn" = "Potential Abandonment", 
                                              "crop_abn_iucn" = "Observed Abandonment",
                                              "mam" = "Mammals",
                                              "bird" = "Birds"
                                              )))


ggsave(gg_trends_obs_v_pot_overall_dodge,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_overall_dodge", aoh_run_date, ".pdf"),
       width = 4, height = 5, units = "in")
```


```{r obs-v-pot-by-site}

# ------------------------------------------------------------ #
gg_trend_summary_obs_v_pot_by_site <-
  aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("crop_abn_potential_iucn" = "Potential",
                                              "crop_abn_iucn" = "Observed")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
    facet_grid(cols = vars(vert_class), rows = vars(site),
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))

ggsave(gg_trend_summary_obs_v_pot_by_site,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_by_site", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 6.5, units = "in")

# ------------------------------------------------------------ #
# side by side
# ------------------------------------------------------------ #

gg_trend_summary_obs_v_pot_by_site_sbs <-
  lapply(c("bird", "mam"), function(vert_class_) {
      aoh_ms_tmp_trends %>%
  filter(vert_class == vert_class_, grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(y = n_sp, x = aoh_type,
                     fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)]))
                     )) +
  geom_col(position = position_dodge(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "Number of Species", x = "Scenario",
       caption = ifelse(vert_class_ == "bird", "Birds", "Mammals")) +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
    
  scale_x_discrete(labels = c("crop_abn_iucn" = "Observed", "crop_abn_potential_iucn" = "Potential")) +
  theme(legend.position = c(0.88, 0.17)) +
    facet_wrap(vars(site), scales = "free",
               labeller = as_labeller(c(aoh_type_labels, fancy_labels))) +
  theme(strip.text.y.right = element_text(angle = 0))
  })

names(gg_trend_summary_obs_v_pot_by_site_sbs) <- c("bird", "mam")

lapply(c("bird", "mam"), function(vert_class_) {
  ggsave(gg_trend_summary_obs_v_pot_by_site_sbs[[vert_class_]],
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_obs_v_pot_by_site_sbs_", 
                         vert_class_,
                         aoh_run_date,

                         ".pdf"),
       width = 6.5, height = 5.5, units = "in")
})


# ------------------------------------------ #
# both bids and mammals together:
ggsave(
  aoh_ms_tmp_trends %>%
  filter(grepl("crop", aoh_type)) %>%
  group_by(aoh_type, vert_class, passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(y = n_sp, x = aoh_type,
                       fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)]))
                     )) +
  geom_col(position = position_dodge(preserve = "single"), color = "black", size = .25) +
  theme_classic() + 
  labs(y = "Number of Species", x = "Scenario") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
    
  scale_x_discrete(labels = c("crop_abn_iucn" = "Observed", "crop_abn_potential_iucn" = "Potential")) +
  theme(legend.position = c(0.85, 0.12)) +
  facet_wrap(vars(site, vert_class), scales = "free",
             ncol = 6,
             labeller = as_labeller(c(aoh_type_labels, cap_labels))
             ),
  filename = paste0(p_output, "plots/aoh/", "aoh_trend_obs_v_pot_by_site_sbs_both_vert", 
                    aoh_run_date, ".pdf"),
       width = 8, height = 5.5, units = "in")


# ------------------------------------------------------------ #
# mature forest obls
# ------------------------------------------------------------ #
gg_trend_summary_obs_v_pot_by_site_mat_for_obl <-
  aoh_feols_trends %>%
  filter(vert_class != "amp",
         passage_type == "exclude_passage",
         grepl("crop", aoh_type)) %>%
  group_by(aoh_type, 
           # vert_class, 
           passage_type, 
           mature_forest_obl = mature_forest_obl > 0.5,
           # obligate_type,
           site, trend) %>%
  filter(!is.na(mature_forest_obl)) %>%
  summarise(n_sp = n()) %>%
  # arrange(vert_class, aoh_type) %>%
  ggplot(data = .,
       mapping = aes(
         y = aoh_type, 
         x = n_sp,
         fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 3, 6)])),
         )) +
  geom_col(position = position_fill(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(y = NULL, x = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  scale_y_discrete(labels = c("crop_abn_potential_iucn" = "Potential",
                                              "crop_abn_iucn" = "Observed")) + 
  scale_x_continuous(labels = c("0", "0.25", "0.5", "0.75", "1")) +
  theme(legend.position = "bottom") +
  theme(strip.text.y.right = element_text(angle = 0)) + 
  facet_grid(
    cols = vars(mature_forest_obl), 
    rows = vars(site),
    labeller = as_labeller(c(fancy_labels, "TRUE" = "Mature Forest Obligates",# (Birds)",
                             "FALSE" = "Non-Mature Forest Obligates"# (Birds)"
                             ))
    )

gg_trend_summary_obs_v_pot_by_site_mat_for_obl

ggsave(gg_trend_summary_obs_v_pot_by_site_mat_for_obl,
       filename = paste0(p_output, "plots/aoh/", "trend_summary_obs_v_pot_by_site_mat_for_obl", aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 6.5, units = "in")
```

```{r obs-v-pot-combo}
# ------------------------------------------- #
# combine with a overall total bar on the side - this is the final version that goes into the manuscript/supplement
# ------------------------------------------- #
i <- "crop_abn_potential_iucn"

j <- 1
threat_statuses


gg_aoh_obs_v_pot_overall_tmp <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  group_by(aoh_type, vert_class, passage_type, 
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
    mutate(overall = "Overall") %>%
  ggplot(mapping = aes(x = aoh_type, y = n_sp,
                       fill = overall_trend %>% fct_relevel(names(palette_du_jour)))) +
  geom_col(position = position_stack(rev = TRUE), color = "black", size = .25) +
  theme_classic() + 
  labs(x = NULL, y = NULL) +
  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  scale_x_discrete(labels = c("crop_abn_potential_iucn" = "Pot.",
                              "crop_abn_iucn" = "Obs.")) +
  scale_y_continuous(breaks = seq(from = 0, to = 1000, by = 100)) +
  theme(legend.position = "none", axis.ticks.x = element_blank(),
        plot.background = element_blank()) +
  facet_grid(cols = vars(overall),
             rows = vars(vert_class), 
             scales = "free",
             labeller = as_labeller(c("mam" = "Mammals",
                                      "bird" = "Birds",
                                      "crop_abn_potential_iucn" = "Pot.",
                                      "crop_abn_iucn" = "Obs.",
                                      "Overall" = "Overall"
                                      ))
             )

gg_aoh_by_obs_v_pot_lumped_by_site_bars_tmp <-
  aoh_ms_tmp_trends %>%
  filter(aoh_type %in% c("crop_abn_iucn", "crop_abn_potential_iucn")) %>%
  group_by(aoh_type, vert_class, #passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
    group_by(aoh_type, vert_class, site) %>% mutate(n = sum(n_sp)) %>%
    ungroup() %>% mutate(p = n_sp/n) %>%
    
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
    # x = p,
    # y = aoh_type,
    x = n_sp,
    y = fct_relevel(site, rev),
    fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)]))
                       )) +  
  geom_col(position = position_dodge(preserve = "single"),
           color = "black", size = .25) +
  theme_classic() + 
  scale_y_discrete(labels = c(fancy_labels, "crop_abn_potential_iucn" = "Potential",
      "crop_abn_iucn" = "Observed"),
                   # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                   ) + 
  labs(x = "Number of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels,#[c(1, 6, 3)],
                    values = palette_du_jour#[c(1, 6, 3)]
                    ) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
        panel.grid.major.x = element_line(),
        ) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    rows = vars(vert_class), cols = vars(aoh_type),
    # rows = vars(site), cols = vars(vert_class),
    labeller = as_labeller(c(
      fancy_labels,
      # aoh_type_labels,
      "crop_abn_potential_iucn" = "Potential",
      "crop_abn_iucn" = "Observed",
      "bird" = "Birds",
      "mam" = "Mammals"))
    )

ggsave(
  plot_grid(
    plot_grid(
  gg_aoh_by_obs_v_pot_lumped_by_site_bars_tmp + 
    theme(strip.text.y.right = element_blank(),
          legend.position = "none") + labs(caption = NULL), 
  gg_aoh_obs_v_pot_overall_tmp,
  nrow = 1, 
  align = "h", axis= "b",
  ncol = 2, rel_widths = c(3, 0.9)),
  ggpubr::get_legend(gg_aoh_trend_by_vert_aoh_type + 
                       guides(fill = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom")),
  nrow = 2, ncol = 1, rel_heights = c(1, 0.07)),
  filename = paste0(p_output, "plots/aoh/",
                    "aoh_obs_v_pot_by_site_combo",
                    aoh_run_date, ".pdf"),
  width = 6, height = 7.5, units = "in")


# -------------------------------------------------- #
# now, with proportions:
gg_aoh_by_obs_v_pot_lumped_by_site_bars_prop_tmp <-
  aoh_ms_tmp_trends %>%
  filter(aoh_type %in% c("crop_abn_iucn", "crop_abn_potential_iucn")) %>%
  group_by(aoh_type, vert_class, #passage_type, 
           site, trend) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
    group_by(aoh_type, vert_class, site) %>% mutate(n = sum(n_sp)) %>%
    ungroup() %>% mutate(p = n_sp/n) %>%
    
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
    x = p,
    y = fct_relevel(aoh_type, rev),
    # x = n_sp,
    # y = fct_relevel(site, rev),
    fill = trend %>% fct_relevel(names(palette_du_jour[c(1, 6, 3)]))
                       )) +  
  geom_col(position = position_dodge(preserve = "single"),
           color = "black", size = .25) +
  theme_classic() + 
  scale_y_discrete(labels = c(fancy_labels, "crop_abn_potential_iucn" = "Potential", "crop_abn_iucn" = "Observed"),
                   # gsub("\n", " ",c(aoh_type_labels, fancy_labels))
                   ) + 
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.2),
                     limits = c(0,1)) +
  labs(x = "Proportion of Species", y = NULL,
       caption = filter(aoh_type_df, label == i)$p5) +
  # labs(x = "AOH Trend", y = "Proportion of Species") +
  scale_fill_manual(name = "Trend",
                    labels = palette_labels,#[c(1, 6, 3)],
                    values = palette_du_jour#[c(1, 6, 3)]
                    ) +
  theme(legend.position = "bottom",#c(0.9, 0.15),
        panel.grid.major.x = element_line(),
        strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)
        ) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    # rows = vars(vert_class), cols = vars(aoh_type),
    rows = vars(site), cols = vars(vert_class),
    labeller = as_labeller(c(
      fancy_labels,
      # aoh_type_labels,
      "crop_abn_potential_iucn" = "Potential",
      "crop_abn_iucn" = "Observed",
      "bird" = "Birds",
      "mam" = "Mammals"))
    )


ggsave(
  plot_grid(
    plot_grid(
  gg_aoh_by_obs_v_pot_lumped_by_site_bars_prop_tmp + 
    theme(strip.text.y.right = element_blank(),
          legend.position = "none") + labs(caption = NULL), 
  gg_aoh_obs_v_pot_overall_tmp,
  nrow = 1, 
  align = "h", axis= "b",
  ncol = 2, rel_widths = c(3, 0.9)),
  ggpubr::get_legend(gg_aoh_trend_by_vert_aoh_type + 
                       guides(fill = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom")),
  nrow = 2, ncol = 1, rel_heights = c(1, 0.07)),
  filename = paste0(p_output, "plots/aoh/",
                    "aoh_obs_v_pot_by_site_prop_combo",
                    aoh_run_date, ".pdf"),
  width = 6, height = 7.5, units = "in")



# --------------------------------------------------------- #
# Third version, with the overall proportions included as a "site" at bottom
# --------------------------------------------------------- #
gg_aoh_obs_v_pot_overall_tmp2 <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(str_detect(aoh_type, "crop")) %>%
  group_by(aoh_type, vert_class, passage_type, 
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  group_by(aoh_type, vert_class) %>% mutate(total_sp = sum(n_sp)) %>% ungroup() %>%
  arrange(vert_class, aoh_type) %>%
  mutate(site = "overall",
         p = n_sp / total_sp,
         trend = case_when(
           trend_direction == "context dependent" ~ "no trend",
           TRUE ~ as.character(trend_direction))) %>%
  select(aoh_type, site, vert_class, trend, 
         overall_trend, n_sp, total_sp, p) %>%
  ggplot(mapping = aes(y = fct_relevel(aoh_type, rev), x = p,
                       group = overall_trend, fill = overall_trend %>% fct_relevel(names(palette_du_jour)))) +
  geom_col(position = position_dodge(), color = "black", size = .25) +
  theme_classic() + 
  labs(x = "Proportion of Species", y = NULL) +
  scale_fill_manual(name = "Trend", labels = palette_labels,
                    values = palette_du_jour) + 
  scale_y_discrete(labels = c("crop_abn_potential_iucn" = "Potential",
                              "crop_abn_iucn" = "Observed")) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.2),
                     limits = c(0,1)) +
  guides(fill = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        strip.text.y.right = element_text(size = 8, angle = 0,
                                          hjust = 0, vjust = 0),
        panel.grid.major.x = element_line()) +
  facet_grid(rows = vars(site), cols = vars(vert_class), 
             scales = "free",
             labeller = as_labeller(c("overall" = "All sites combined")))

# save figure:
ggsave(
  plot_grid(
    gg_aoh_by_obs_v_pot_lumped_by_site_bars_prop_tmp + 
      # guides(fill = guide_legend(ncol = 1)) +
      theme(legend.position = "none") +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank()) +
      labs(caption = NULL, x = NULL),
    gg_aoh_obs_v_pot_overall_tmp2 + 
      theme(
        legend.position = "bottom",
        strip.text.x = element_blank()),
    ncol = 1, rel_heights = c(1, 0.35),
    align = "v", axis = "lr")
  ,

  filename = paste0(p_output, "plots/aoh/",
                    "aoh_obs_v_pot_by_site_prop_w_overall_bottom",
                    aoh_run_date, ".pdf"),
  width = 6.2, height = 7, units = "in")

```


```{r diff-area-2017}
# How does the magnitude of area of habitat gained increase between observed and potential abandonment?

# Comparing the last year of area for each species between crop_abn_iucn and crop_abn_potential_iucn

# aoh_p_change_obs_v_pot_ols <-
#aoh_p_change_obs_v_pot_feols <-
  aoh %>%
  filter(passage_type == "exclude_passage",
         vert_class != "amp",
         str_detect(aoh_type, "crop"),
         mature_forest_obl < 0.5,
         # exclude all species not affected by abandonment:
         binomial %in% unique(
           aoh_feols_trends_by_sp %>%
             filter(aoh_type == "crop_abn_iucn", 
                    passage_type == "exclude_passage",
                    vert_class != "amp", mature_forest_obl < 0.5) %>%
             pull(binomial))
         ) %>%
  select(-start_year) %>%
  # left_join(aoh_start_years) %>% 
  select(aoh_type:year, end_year, everything()) %>%
  filter(year == end_year) %>%
  left_join(
    # aoh_trends %>% # ols
    aoh_feols_trends %>%  # feols, with Newey-West estimated standard errors
      filter(passage_type == "exclude_passage",
         vert_class != "amp",
         str_detect(aoh_type, "crop"),
         mature_forest_obl < 0.5,
         
         # exclude all species not affected by abandonment:
         binomial %in% unique(
           aoh_feols_trends_by_sp %>%
             filter(aoh_type == "crop_abn_iucn", 
                    passage_type == "exclude_passage",
                    vert_class != "amp", mature_forest_obl < 0.5) %>%
             pull(binomial))) %>%
      select(aoh_type, vert_class, site, binomial, trend, passage_type)
    ) %>%
  mutate(aoh_type = case_when(
    aoh_type == "crop_abn_iucn" ~ "observed",
    aoh_type == "crop_abn_potential_iucn" ~ "potential"
  )) %>%
  pivot_wider(id_cols = c(
    # aoh_type,
    vert_class, site, binomial,
    # year, 
    passage_type, redlistCategory, 
    mature_forest_obl), 
    names_from = "aoh_type", values_from = c(aoh, trend)) %>%
  # filter(is.na(aoh_potential))
  mutate(pdiff = 100*(aoh_potential - aoh_observed)/aoh_observed) %>%
  select(vert_class, site, binomial, #year, 
          contains("aoh"), pdiff, contains("trend"), everything()) %>%
  
  # add categories based on trend differences
  mutate(trend_change = case_when(
    trend_observed == "gain" & trend_potential == "gain" ~ "same (gain)",
    trend_observed == "loss" & trend_potential == "loss" ~ "same (loss)",
    trend_observed == "gain" & trend_potential == "loss" ~ "gain to loss",
    trend_observed == "loss" & trend_potential == "gain" ~ "loss to gain",
    trend_observed == "loss" & trend_potential == "no trend" ~ "loss to no trend",
    trend_observed == "gain" & trend_potential == "no trend" ~ "gain to no trend",
    # trend_observed == "no trend" & trend_potential == "no trend" ~ "no change (no trend)",
    trend_observed == "no trend" & trend_potential == "no trend" ~ "same (no trend)",
    trend_observed == "no trend" & trend_potential == "loss" ~ "no trend to loss",
    trend_observed == "no trend" & trend_potential == "gain" ~ "no trend to gain"
  ) %>% fct_relevel(),
  change_direction = case_when(
    grepl("^same", trend_change) ~ "No change",
    grepl("to loss$", trend_change) ~ "Worsen",
    grepl("to gain$", trend_change) ~ "Improve",
    grepl("no trend$", trend_change) ~ "Indeterminate"
  ) %>% fct_relevel("Improve", "No change", "Indeterminate", "Worsen")) 

write_csv(aoh_p_change_obs_v_pot_ols, paste0(p_derived, "aoh_p_change_obs_v_pot_ols.csv"))
write_csv(aoh_p_change_obs_v_pot_feols, paste0(p_derived, "aoh_p_change_obs_v_pot_feols.csv"))



# produce summary, switching between ols and feols (including NW)
# aoh_p_change_obs_v_pot_summary_ols <- 
#     aoh_p_change_obs_v_pot_ols %>%
aoh_p_change_obs_v_pot_summary_feols <-
  aoh_p_change_obs_v_pot_feols %>%

  # select(vert_class:binomial, contains("trend"), contains("change")) %>%
  group_by(vert_class, site,
           # trend_observed, trend_potential,
           trend_change,
           change_direction
           ) %>%
  summarise(mean_p_change = mean(pdiff),
            n_sp_in_group = n()) %>%
  arrange(vert_class, change_direction, trend_change)


write_csv(aoh_p_change_obs_v_pot_summary_ols, paste0(p_derived, "aoh_p_change_obs_v_pot_summary_ols.csv"))
write_csv(aoh_p_change_obs_v_pot_summary_feols, paste0(p_derived, "aoh_p_change_obs_v_pot_summary_feols.csv"))


aoh_p_change_obs_v_pot_summary_feols %>% print(n = 50)

gg_aoh_p_change_obs_v_pot_feols <-
  lapply(c("mam", "bird"), function(vert_class_) {
  aoh_p_change_obs_v_pot_summary_feols %>%
  filter(vert_class == vert_class_) %>%
  ggplot(mapping = aes(x = trend_change, 
                       fill = fct_relevel(change_direction, c("Improve", "No change", 
                                                              "Indeterminate", "Worsen")),
                       y = mean_p_change,
                       label = n_sp_in_group)) + 
  geom_col() + 
  geom_text(vjust = "inward") +
  # geom_label() +
  labs(x = "Trend Change from Observed to Potential", 
       y = "Mean Percent Change in AOH in last year",
       caption = ifelse(vert_class_ == "mam", "Mammals", "Birds"),
       fill = "Trend Change\nDirection") +
  scale_fill_manual(#labels = palette_labels, 
                    values = met.brewer("Kandinsky", 4)[c(1, 3, 4, 2)]) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        legend.position = c(0.88, 0.12)) +
  facet_wrap(vars(site), scales = "free", labeller = as_labeller(fancy_labels))
})

names(gg_aoh_p_change_obs_v_pot_feols) <- c("mam", "bird")
gg_aoh_p_change_obs_v_pot_feols$bird
gg_aoh_p_change_obs_v_pot_feols$mam

lapply(1:2, function(i) {
  ggsave(gg_aoh_p_change_obs_v_pot_feols[[i]],
       filename = paste0(p_output, "plots_dis/aoh/", "aoh_p_change_obs_v_pot_",
                         names(gg_aoh_p_change_obs_v_pot_feols)[i], aoh_run_date, ".pdf"),
       width = 8, height = 7.5, units = "in")
})




# ----------------------------------------------------------------- #
# ------ reproducing 2022 figures for dissertation printing ------- #
# ----------------------------------------------------------------- #
gg_aoh_p_change_obs_v_pot_ols <-
  lapply(c("mam", "bird"), function(vert_class_) {
  aoh_p_change_obs_v_pot_summary_ols %>%
  filter(vert_class == vert_class_) %>%
  ggplot(mapping = aes(x = trend_change, 
                       fill = fct_relevel(change_direction, c("Improve", "No change", 
                                                              "Indeterminate", "Worsen")),
                       y = mean_p_change,
                       label = n_sp_in_group)) + 
  geom_col() + 
  geom_text(vjust = "inward") +
  labs(x = "Trend Change from Observed to Potential", 
       y = "Mean Percent Change in AOH in last year",
       caption = ifelse(vert_class_ == "mam", "Mammals", "Birds"),
       fill = "Trend Change\nDirection") +
  scale_fill_manual(values = met.brewer("Kandinsky", 4)[c(1, 3, 4, 2)]) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        legend.position = c(0.88, 0.12)) +
  facet_wrap(vars(site), scales = "free", labeller = as_labeller(fancy_labels))
})

names(gg_aoh_p_change_obs_v_pot_ols) <- c("mam", "bird")

lapply(1:2, function(i) {
  ggsave(gg_aoh_p_change_obs_v_pot_ols[[i]],
       filename = paste0(p_output, "plots_dis/aoh/", "aoh_p_change_obs_v_pot_",
                         names(gg_aoh_p_change_obs_v_pot_ols)[i], aoh_run_date, ".pdf"),
       width = 8, height = 7.5, units = "in")
})

# ----------------------------------------------------------------- #
# ----------------------------------------------------------------- #
# ----------------------------------------------------------------- #



aoh %>% 
  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
         aoh_type == "crop_abn_potential_iucn", passage_type == "exclude_passage") %>%
  print(n = 30)

aoh_start_years %>%
  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
               aoh_type == "crop_abn_potential_iucn")

dff %>%  filter(site == "belarus", str_detect(binomial, "Acrocephalus scho"),
                str_detect(aoh_type, "crop_abn"), passage_type == "exclude_passage")

# Some species have different final years. 
# two options for dealing with this:
# 1) Set NA AOH values to 0, or 2) drop year from id_cols


```

```{r obs-v-pot-all-scenarios}
# -------------------------------------------------------- #
# Now, including potential abandonment in these scenarios:
# -------------------------------------------------------- #

gg_aoh_trend_overall_by_aoh_type_w_pot <-
# gg_aoh_trend_overall_by_aoh_type_w_pot_wo_mg <-
  aoh_ms_tmp_trends_by_sp %>%
  filter(
    # binomial %in% unique(pull(filter(species_list, site != "mato_grosso"), binomial)), # all species excluding those only found in Mato Grosso
    ) %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%
  ggplot(mapping = aes(
         x = trend_direction,
         y = n_sp,
         fill = overall_trend %>% fct_relevel(names(palette_du_jour)[c(2, 1, 3, 4, 5, 6)])
         )) +
  geom_col(color = "black", size = .25) +
  theme_classic() +
 scale_x_discrete(labels = palette_labels) +
  labs(x = "AOH Trend", y = "Number of Species") +

  scale_fill_manual(name = "Trend", 
                    labels = palette_labels,
                    values = palette_du_jour) + 
  theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 340, vjust = 1, hjust = 0, size = 8)) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_grid(
    row = vars(vert_class), col = vars(aoh_type),
    scales = "free_y", 
    labeller = as_labeller(aoh_type_labels))


ggsave(gg_aoh_trend_overall_by_aoh_type_w_pot,
       filename = paste0(p_output, "plots/aoh/",
                         "aoh_trend_overall_by_aoh_type_w_pot", aoh_run_date,
                         ".pdf"),
       width = 8, height = 5, units = "in")

ggsave(gg_aoh_trend_overall_by_aoh_type_w_pot_wo_mg,
       filename = paste0(p_output, "plots/aoh/",
                         "aoh_trend_overall_by_aoh_type_w_pot", aoh_run_date,
                         "_wo_mg",
                         ".pdf"),
       width = 8, height = 5, units = "in")

# ---------------------------------------------------------------- #
# Stacked
# ---------------------------------------------------------------- #
gg_aoh_trend_overall_by_type_w_pot_stack <-
  aoh_ms_tmp_trends_by_sp %>%
  group_by(aoh_type, vert_class, passage_type,
           overall_trend, trend_direction, trend_consistency) %>%
  summarise(n_sp = n()) %>%
  arrange(vert_class, aoh_type) %>%

  ## plot
  ggplot(mapping = aes(
    y = fct_relevel(aoh_type, rev), x = n_sp,
    fill = overall_trend %>% fct_relevel(names(palette_du_jour))
                       )) +
  geom_col(
    position = position_fill(rev = TRUE),
    # position = "stack",
    color = "black", ) +
    geom_vline(xintercept = 0.5, col = "red", linetype = 2) +
  theme_classic() + 
  scale_y_discrete(labels = c(
    # aoh_type_labels
    "full_iucn" = "Full site\n(1987-2017)", 
    "full_potential_iucn" = "Full site, no recultivation\n(1987-2017)", 
    "max_abn_iucn" = "Net change in abandoned\nland (1987-2017)",
    "max_potential_abn_iucn" = "Net change in abandoned land,\nno recultivation (1987-2017)",
    "crop_abn_iucn" = "Abandonment\n(cultivation-2017)",
    "crop_abn_potential_iucn" = "Abandonment, no recultivation\n(cultivation-2017)"
    )) +
  labs(y = "AOH Scenario", x = "Proportion of Species") +

  scale_fill_manual(name = "Trend", labels = palette_labels, values = palette_du_jour) + 
  theme(legend.position = "right") +
  facet_grid(rows = vars(vert_class), #rows = vars(aoh_type), 
             scales = "free", labeller = as_labeller(aoh_type_labels))


ggsave(gg_aoh_trend_overall_by_type_w_pot_stack,
       filename = paste0(p_output, "plots/aoh/", "aoh_trend_overall_by_aoh_type_w_pot_stacked", aoh_run_date, ".pdf"),
       width = 6, height = 4.25, units = "in")
```

```{r site-specific-figs}
aoh_trends$aoh_type %>% unique()

lapply(
  list(
    c(3,9),
    c(1,8,10),
    c(4,6),
    c(2,5),
    c(7,11)
    ), function(i) {
      ggsave(  
        aoh_ms_tmp_trends %>%
          filter(
            # !grepl("potential", aoh_type),
            site %in% site_df$site[i]
            # site == "iraq"
            ) %>%
          group_by(aoh_type, vert_class, passage_type, site, trend) %>%
          summarise(n_sp = n()) %>% ungroup() %>%
          arrange(vert_class, aoh_type) %>%
          ggplot(mapping = aes(y = aoh_type %>% fct_relevel(rev), 
                               x = n_sp, fill = trend)) +
          geom_col(position = position_dodge(preserve = "single"), 
                   color = "black", size = .25) +
          theme_classic() + 
          labs(y = NULL, x = "Number of Species") +
          scale_fill_manual(name = "Trend",
                            labels = palette_labels[c(1, 3, 6)],
                            values = palette_du_jour[c(1, 3, 6)]) +
          scale_y_discrete(labels = aoh_type_labels) +
          theme(legend.position = "right") +
          facet_grid(rows = vars(vert_class), cols = vars(site),
                     labeller = as_labeller(c(aoh_type_labels, fancy_labels)), scales = "free"),
        
        filename = paste0(p_output, "plots/aoh/", 
                          "aoh_all_types_by_site_group_", 
                          paste0(i, collapse = "_"),
                          aoh_run_date, ".pdf"),
        width = 7, height = 7.5, units = "in")
      })
```

# AOH Trend Line Plots

```{r *estimated-AOH-trend-lines}

aoh_change_df %>% filter(!is.na(estimate_slope))

df_tmp <-
  aoh_change_df %>% 
  filter(est_type == "estimate"
         # aoh_type == "crop_abn_iucn",
         # site == "shaanxi"
         ) %>%
  select(aoh_type, vert_class, binomial, site, slope, intercept,
         passage_type, mature_forest_obl,
         start_year, end_year) %>%
  mutate(year0_start = 1, year0_end = end_year - start_year + 1) %>%

  left_join(aoh_feols_trends %>% select(aoh_type, site, vert_class, binomial, trend, passage_type)) %>%
  filter(!is.na(trend)) %>%
    arrange(aoh_type, vert_class, site, binomial)

aoh_est_change_tmp_all %>%
  filter()

aoh_trends %>% unique()
aoh_trends$term %>% unique()
df_tmp %>% unique()

# mean trend in each trend type:
df_tmp_mean <-
  df_tmp %>%
    filter(
      # aoh_type == i,
           # site == "shaanxi",
           vert_class != "amp"
           ) %>%
  group_by(aoh_type, #vert_class, 
           site, trend, passage_type) %>%
  summarise(mean_slope = mean(estimate_slope, na.rm = TRUE),
            mean_int = mean(estimate_intercept, na.rm = TRUE)
            ) %>% 
    ungroup() %>%
  mutate(start_year = 1, end_year = 31) %>% 
  pivot_longer(cols = contains("year"), values_to = "year") %>%
  mutate(est = year*mean_slope + mean_int)
  
# for testing
# i <- "crop_abn_potential_iucn"

gg_aoh_trend_lines_by_site <-
  lapply(aoh_types[c(6, 3, 1, 7, 5, 8)], function(i) {
  df_tmp %>%
    filter(aoh_type == i,
           mature_forest_obl < 0.5,
           passage_type == "exclude_passage"
           ) %>%
  pivot_longer(cols = contains("year0"), values_to = "year") %>%
  mutate(est = year*slope + intercept,
         year = year + start_year - 1) %>%
  
  ggplot(aes(x = year, y = est/10^6, col = trend, group = binomial)) +
  geom_smooth(method = "lm", se = 0.95,
              mapping = aes(x = year, y = est/10^6, 
                            col = trend, fill = trend, 
                            group = trend),
              linetype = 2, show.legend = FALSE) + 
    geom_line(alpha = 0.15) + 

  theme_classic() + 
  scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
      scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  labs(y = expression("AOH (10"^{6}*" ha)"),
       x = "Year", col = "Trend", fill = "Mean Trend") + 
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5, order = 1))) +
  theme(legend.position = c(0.9, 0.125),
        legend.background = element_blank(),
        legend.spacing = unit(-4, units = "mm")
        ) +
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
    
  })

names(gg_aoh_trend_lines_by_site) <- aoh_types[c(6, 3, 1, 7, 5, 8)]


lapply(seq_along(gg_aoh_trend_lines_by_site), function(j) {
  ggsave(gg_aoh_trend_lines_by_site[[j]],
       filename = paste0(p_output, "plots/aoh/", "trend_lines_by_site_",
                         names(gg_aoh_trend_lines_by_site)[j],  aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.5, units = "in")
})


ggplotly(gg_aoh_trend_lines_by_site$crop_abn_iucn)


# 

# ------------------------------------ #
# trends for one site - wisconsin
# ------------------------------------ #
gg_aoh_trend_lines_wisc_crop <-
  df_tmp %>%
    filter(aoh_type == "crop_abn_iucn", site == "wisconsin",
           mature_forest_obl < 0.5,
           passage_type == "exclude_passage"
           ) %>%
  pivot_longer(cols = contains("year0"), values_to = "year") %>%
  mutate(est = year*slope + intercept,
         year = year + start_year - 1) %>%
  
  ggplot(aes(x = year, y = est/10^6, col = trend,
             group = binomial
             )) +
    geom_line(alpha = 0.15) + 


  theme_classic() + 
  scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
      scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  labs(y = expression("AOH (10"^{6}*" ha)"),
       x = "Year", col = "Trend", fill = "Mean Trend",
       # caption = paste0(filter(aoh_type_df, label == i)$p5)
       ) + 
    # scale_linetype_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
  theme(
    #legend.position = c(0.9, 0.125),
        legend.background = element_blank(),
        legend.spacing = unit(-4, units = "mm")
        ) +
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
  


ggsave(gg_aoh_trend_lines_wisc_crop,
       filename = paste0(p_output, "plots/aoh/", "fpo_trend_lines_wisc_crop",  aoh_run_date,
                         ".pdf"),
       width = 4.5, height = 3.5, units = "in")
  
ggsave(gg_aoh_trend_lines_wisc_crop + geom_smooth(method = "lm", se = 0.95,
              mapping = aes(x = year, y = est/10^6,
                            col = trend, fill = trend,
                            group = trend),
              linetype = 2, show.legend = FALSE, alpha = 0.2),
       filename = paste0(p_output, "plots/aoh/", "fpo_trend_lines_wisc_crop_w_means",  aoh_run_date,
                         ".pdf"),
       width = 4.5, height = 3.5, units = "in")

```

```{r observed-AOH-trend-lines}

gg_aoh_sp_obs_by_site <-
  lapply(aoh_types[c(6, 3, 1, 7, 5, 8)], function(i) {
  aoh %>%
      filter(aoh_type == i,
             
             # exclude all species not affected by abandonment:
             binomial %in% unique(aoh_feols_trends_by_sp %>%
                                    filter(aoh_type == "crop_abn_iucn", passage_type == "exclude_passage",
                                           vert_class != "amp", mature_forest_obl < 0.5) %>%
                                    pull(binomial)),
             passage_type == "exclude_passage", # exclude passage areas from AOH calculations
             vert_class != "amp",
             mature_forest_obl < 0.5
             ) %>%
      left_join(aoh_feols_trends) %>% #select(trend)
      ggplot(aes(x = year, y = aoh/10^6, col = trend, group = binomial)) +
      geom_line(alpha = 0.15) + 
      theme_classic() + 
      scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                         values = palette_du_jour[c(1, 3, 6)]) +
      # scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
      #                   values = palette_du_jour[c(1, 3, 6)]) +
      labs(y = expression("AOH (10"^{6}*" ha)"),
           x = "Year", col = "Trend", fill = "Mean Trend",
           # caption = paste0(filter(aoh_type_df, label == i)$p5)
           ) + 
      guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5, order = 1))) +
      theme(legend.position = c(0.9, 0.125),
            legend.background = element_blank(),
            legend.spacing = unit(-4, units = "mm")
            ) +
      facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
    })

aoh_feols_trends$trend %>% as_factor()

names(gg_aoh_sp_obs_by_site) <- aoh_types[c(6, 3, 1, 7, 5, 8)]


lapply(seq_along(gg_aoh_sp_obs_by_site), function(j) {
  ggsave(gg_aoh_sp_obs_by_site[[j]],
       filename = paste0(p_output, "plots/aoh/", "aoh_sp_obs_by_site_",
                         names(gg_aoh_sp_obs_by_site)[j],  aoh_run_date,
                         ".pdf"),
       width = 6.5, height = 5.5, units = "in")
})


# -------------------------------------------------------------- #
# Explore using plotly, for interactive plots
# -------------------------------------------------------------- #

ggplotly(gg_aoh_sp_obs_by_site$crop_abn_iucn)

aoh_trends %>% 
  filter(str_detect(binomial, "Agropsar"),
         aoh_type == "crop_abn_iucn", site == "shaanxi"
         )

# just shaanxi
ggplotly(
  aoh %>%
  filter(aoh_type == "crop_abn_iucn", site == "shaanxi",
         vert_class == "bird",
         mature_forest_obl < 0.5,
         passage_type == "exclude_passage"
         ) %>%
  left_join(aoh_trends) %>%
  ggplot(aes(x = year, y = aoh/10^6, col = trend,
             group = binomial
             )) +
  geom_line(alpha = 0.15) + 
  theme_classic() + 
  scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                     values = palette_du_jour[c(1, 3, 6)]) +
  scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                    values = palette_du_jour[c(1, 3, 6)]) +
  labs(y = expression("AOH (10"^{6}*" ha)"),
       x = "Year", col = "Trend", fill = "Mean Trend",
       caption = paste0(filter(aoh_type_df, label == i)$p5)) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
  theme(legend.position = c(0.9, 0.125),
        legend.background = element_blank(),
        legend.spacing = unit(-4, units = "mm")
        ) +
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
)


# ------------------------------------ #
# trends for one site - wisconsin
# ------------------------------------ #
gg_aoh_sp_obs_wisc_crop <-
  aoh %>%
      filter(aoh_type == "crop_abn_iucn",
             site == "wisconsin",
             # exclude all species not affected by abandonment:
             binomial %in% unique(aoh_feols_trends_by_sp %>%
                                    filter(aoh_type == "crop_abn_iucn", passage_type == "exclude_passage",
                                           vert_class != "amp", mature_forest_obl < 0.5) %>%
                                    pull(binomial)),
             passage_type == "exclude_passage", # exclude passage areas from AOH calculations
             vert_class != "amp",
             mature_forest_obl < 0.5
             ) %>%
      left_join(aoh_feols_trends) %>%
      ggplot(aes(x = year, y = aoh/10^6, col = trend, group = binomial)) +
      geom_line(alpha = 0.15) + 
      theme_classic() + 
      scale_color_manual(labels = palette_labels[c(#1, 
                                                   3, 6, 1)],
                         values = palette_du_jour[c(#1, 
                                                    3, 6, 1)]) +
      labs(y = expression("AOH (10"^{6}*" ha)"),
           x = "Year", col = "Trend", fill = "Mean Trend") + 
      guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
      theme(#legend.position = c(0.9, 0.125),
        # legend.position = "none",
            legend.background = element_blank(),
            legend.spacing = unit(-4, units = "mm")
            ) +
      facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(fancy_labels))
  
ggplotly(gg_aoh_sp_obs_wisc_crop)

ggsave(gg_aoh_sp_obs_wisc_crop,
       filename = paste0(p_output, "plots/aoh/", "fpo_sp_obs_wisc_crop",  aoh_run_date,
                         ".pdf"),
       width = 4.5, height = 3.5, units = "in")
  

gg_aoh_sp_obs_wisc_crop_plus1 <-
  gg_aoh_sp_obs_wisc_crop + 
    geom_line(data = aoh %>%
                filter(binomial == "Sturnella magna",
                       aoh_type == "crop_abn_iucn", site == "wisconsin",
                       mature_forest_obl < 0.5, passage_type == "exclude_passage") %>%
                left_join(aoh_feols_trends), 
              mapping = aes(x = year, y = aoh/10^6),
              col = "#ce9642", size = 2) 

gg_aoh_sp_obs_wisc_crop_plus2 <- 
  gg_aoh_sp_obs_wisc_crop_plus1 + 
    geom_line(data = aoh %>%
                filter(
                  binomial == "Dryobates pubescens",
                  # binomial == "Setophaga pinus",
                       aoh_type == "crop_abn_iucn", site == "wisconsin",
                       mature_forest_obl < 0.5, passage_type == "exclude_passage") %>%
                left_join(aoh_feols_trends), 
              mapping = aes(x = year, y = aoh/10^6),
              col = "#3b7c70", size = 2) 

gg_aoh_sp_obs_wisc_crop_plus3 <-
  gg_aoh_sp_obs_wisc_crop_plus2 + 
    geom_line(data = aoh %>%
                filter(binomial == "Troglodytes aedon",
                       aoh_type == "crop_abn_iucn", site == "wisconsin",
                       mature_forest_obl < 0.5, passage_type == "exclude_passage") %>%
                left_join(aoh_trends), 
              mapping = aes(x = year, y = aoh/10^6),
              col = "#3b3a3e", size = 2)

aoh_feols_trends %>%
  filter(site == "wisconsin", trend == "no trend", vert_class == "bird") %>%
  select(binomial, common_names) %>% unique() %>% print(n = 50)
    
ggsave(gg_aoh_sp_obs_wisc_crop_plus1,
       filename = paste0(p_output, "plots/aoh/", "fpo_sp_obs_wisc_crop_plus1",  aoh_run_date,
                         ".pdf"),
       width = 3.5, height = 3.5, units = "in")

ggsave(gg_aoh_sp_obs_wisc_crop_plus2,
       filename = paste0(p_output, "plots/aoh/", "fpo_sp_obs_wisc_crop_plus2",  aoh_run_date,
                         ".pdf"),
       width = 3.5, height = 3.5, units = "in")

ggsave(gg_aoh_sp_obs_wisc_crop_plus3,
       filename = paste0(p_output, "plots/aoh/", "fpo_sp_obs_wisc_crop_plus3",  aoh_run_date,
                         ".pdf"),
       width = 3.5, height = 3.5, units = "in")

ggsave(gg_aoh_sp_obs_wisc_crop_plus3,
       filename = paste0(p_output, "plots/aoh/", "wisconsin_example_sp_trajectories_highlight",  aoh_run_date, ".pdf"),
       width = 4.5, height = 3.5, units = "in")

ggsave(gg_aoh_sp_obs_wisc_crop_plus3 + theme(legend.position = "bottom"),
       filename = paste0(p_output, "plots/aoh/", "wisconsin_example_sp_trajectories_highlight",  aoh_run_date, "_bot.pdf"),
       width = 3.5, height = 4, units = "in")
```


```{r compare-case-one-site}
aoh_types[c(6, 3, 1)]
gg_compare_cases_one_site <-
  aoh %>%
    filter(site == "shaanxi",
           vert_class == "bird",
           aoh_type %in% aoh_types[c(6, 3, 1)],
           mature_forest_obl < 0.5,
           passage_type == "exclude_passage"
           ) %>%
    mutate(aoh_type = fct_relevel(aoh_type, aoh_types[c(6, 3, 1)])) %>%
    left_join(aoh_trends) %>%
    ggplot(aes(x = year, y = aoh/10^6, col = trend,
               group = binomial
               )) +
    geom_line(alpha = 0.15) + 
    theme_classic() + 
    scale_color_manual(labels = palette_labels[c(1, 3, 6)],
                       values = palette_du_jour[c(1, 3, 6)]) +
    scale_fill_manual(labels = palette_labels[c(1, 3, 6)],
                      values = palette_du_jour[c(1, 3, 6)]) +
    labs(y = expression("AOH (10"^{6}*" ha)"),
         x = "Year", col = "Trend", fill = "Mean Trend",
         caption = paste0(filter(aoh_type_df, label == i)$p5)) + 
    guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, order = 1))) +
    theme(
      # legend.position = c(0.9, 0.125),
      legend.position = "bottom",
      legend.background = element_blank(),
      # legend.spacing = unit(-4, units = "mm")
      ) +
    facet_grid(cols = vars(aoh_type), scales = "free_y", 
               labeller = as_labeller(c(fancy_labels, aoh_type_labels)))
  

ggplotly(gg_compare_cases_one_site + theme(legend.position = "none"))

```

# Effect Sizes

```{r eff-size-tmp-files}
# estimated effect sizes:
aoh_est_change_tmp_all # estimated effect sizes, for all aoh_types
aoh_est_change_tmp # estimated effect sizes, for only crop_abn_iucn
# see _util_files.R, Traits temp files


# observed effect sizes:
# this is named with "_plots" in order to distinguish from the tmp file in "traits.Rmd"
# aoh_obs_change_tmp_all (contains all aoh_types), and aoh_obs_change_tmp (only crop_abn_iucn) are subset to window_size == 5, whereas the temp tibble below contains all windows.

aoh_start_end_l_tmp_plots <-
  aoh_start_end_l %>%
  filter(aoh_type == "crop_abn_iucn", 
         str_detect(passage_type, "excl"),
         vert_class != "amp", mature_forest_obl < 0.5) %>%
  left_join(taxonomy_df) %>%
  left_join(select(etard_updated,
                   #dataset, etard_id, 
                   vert_class, binomial, Body_mass_g, Trophic_level),
            by = c("vert_class", "binomial")
  ) %>%
  left_join(aoh_mod_tmp_trends_by_sp_all %>% 
              select(binomial, total_range_area) %>%
              unique()) %>%
  left_join(centroids_df) %>%
  # add habitat specialities
  left_join(habitat_occurrence_df) %>%
  mutate(max_abn_extent_div_site_area = 
           area_ever_abn_ha / total_site_area_ha_2017,
         abs_change_percent_site = abs_change_as_prop_site_area * 100,
         binary_trend_gain = case_when(trend == "gain" ~ 1, TRUE ~ 0),
         binary_trend_loss = case_when(trend == "loss" ~ 1, TRUE ~ 0),
         binary_trend_no_trend = case_when(trend == "no trend" ~ 1, TRUE ~ 0),
         
         # create a binary variable with 1 for gain, 0 for loss, and NA for no trend
         binary_gain_v_loss = case_when(trend == "gain" ~ 1, trend == "loss" ~ 0)
  ) %>%
  arrange(aoh_type, vert_class, site, passage_type, run_index)

aoh_obs_change_tmp_all # observed effect sizes, for all aoh_types
aoh_obs_change_tmp # observed effect sizes, for only crop_abn_iucn
aoh_start_end_l_tmp_plots %>% filter(window_size == 5)

```

```{r plot-aoh-change-est}

# --------------------------------------------------------------- #
# ------------ absolute AOH change, by site (estimated) --------- #
# --------------------------------------------------------------- #

# gg_abs_change_by_site <-
  aoh_est_change_tmp %>%
  ggplot() + 
  # geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +

  geom_histogram(aes(x = abs_change/10^3, fill = trend, group = trend), bins = 50, col = "black") +
  geom_vline(data = aoh_est_change_tmp %>%
               filter(
                 # site != "mato_grosso", 
                      trend != "no trend") %>%
               group_by(trend, site) %>%
               summarise(n = n(), mean = mean(abs_change), median = median(abs_change)) %>%
               pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
             mapping = aes(xintercept = value/10^3, linetype = Statistic, col = trend), size = 0.75) +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = expression("Change in AOH (10"^{3}*" ha)"), y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_abs_change_by_site, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_abs_change_est_by_site_annotated.pdf"),
  width = 7, height = 8.5, units = "in")


# --------------------------------------------------------------- #
# ------------ absolute AOH change, by trend -------------------- #
# --------------------------------------------------------------- #
gg_abs_change_by_trend <-
  aoh_est_change_tmp %>%
      ggplot() +
      # geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = abs(abs_change)/10^6, fill = trend, group = trend), bins = 50, col = "black", 
                     size = 0.5) +
    geom_vline(data = aoh_est_change_tmp %>% 
               group_by(trend, vert_class) %>%
               summarise(n = n(), mean = mean(abs_change), median = median(abs_change)) %>% 
               pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(), 
               mapping = aes(xintercept = abs(value)/10^6, linetype = Statistic), 
             size = 0.75, alpha = 0.5) +
      facet_grid(rows = vars(trend), cols = vars(vert_class),
                 scales = "free",
                 labeller = as_labeller(aoh_type_labels)) +
      theme_classic() +
    scale_x_continuous(guide = "axis_minor", minor_breaks = seq(from = 0.1, to = 1.2, by = 0.1)) +
            
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = expression("Absolute change in AOH (10"^{6}*" ha)"), y = "Count") + 
      theme(legend.position = "right", ggh4x.axis.ticks.length.minor = rel(2/3))

ggsave(gg_abs_change_by_trend,
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_abs_change_est_by_trend_free_annotated.pdf"),
    width = 7, height = 5, units = "in")

# --------------------------------------------------------------- #
# ------------ AOH change as percent of site area, by trend ----- #
# --------------------------------------------------------------- #
# gg_abs_change_as_percent_site_area_by_trend <-
  aoh_est_change_tmp %>%
      ggplot() +
      # geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = abs(abs_change_as_prop_site_area) * 100, fill = trend, group = trend), bins = 50, col = "black", size = 0.5) +
      facet_grid(rows = vars(trend), cols = vars(vert_class),
                 scales = "free",
                 labeller = as_labeller(aoh_type_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = "Change in AOH as a percent of site area (%)", y = "Count") + 
      theme(legend.position = "bottom")

ggsave(gg_abs_change_as_percent_site_area_by_trend,
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_abs_change_est_as_percent_site_area_by_trend.pdf"),
    width = 7, height = 6, units = "in")


# --------------------------------------------------------------- #
# ------------ absolute AOH change per year --------------------- #
# --------------------------------------------------------------- #

gg_abs_change_per_year <- 
  aoh_est_change_tmp %>%
  ggplot() + 
  geom_histogram(aes(x = abs_change_per_yr, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Change in AOH (ha) per year", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_abs_change_per_year, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_abs_change_est_per_year.pdf"),
  width = 7, height = 8.5, units = "in")

# --------------------------------------------------------------- #
# ------------ absolute AOH change as percent of site area --------------------- #
# --------------------------------------------------------------- #

gg_abs_change_as_percent_site_area <- 
  aoh_est_change_tmp %>%
  ggplot() + 
  geom_histogram(aes(x = abs_change_as_prop_site_area * 100, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Change in AOH as a percent of site area (%)", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_abs_change_as_percent_site_area, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_abs_change_est_as_percent_site_area.pdf"),
  width = 7, height = 8.5, units = "in")


# --------------------------------------------------------------- #
# ------------ proportional change in AOH ----------------------- #
# --------------------------------------------------------------- #

gg_prop_change <- 
  aoh_est_change_tmp %>%
  ggplot() + 
  geom_histogram(aes(x = prop_change, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Proportional change in AOH", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_prop_change, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_prop_change_est.pdf"),
  width = 7, height = 8.5, units = "in")



# --------------------------------------------------------------- #
# -------- proportional change in AOH, constrained -------------- #
# --------------------------------------------------------------- #
aoh_est_change_tmp %>% 
  select(run_index, vert_class, site, trend, contains("change")) %>% 
  filter(abs(prop_change) < 5)

gg_prop_change_constrained <- 
  aoh_est_change_tmp %>% 
  select(run_index, vert_class, site, trend, contains("change")) %>% 
  filter(abs(prop_change) < 10) %>%
  ggplot() + 
  geom_histogram(aes(x = prop_change, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Proportional change in AOH", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_prop_change_constrained, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_prop_change_est_constrained.pdf"),
  width = 7, height = 8.5, units = "in")



# --------------------------------------------------------------- #
# ------------ ratio change in AOH ------------------------------ #
# --------------------------------------------------------------- #
gg_ratio_change <-
  aoh_est_change_tmp %>%
  ggplot() + 
  geom_histogram(aes(x = ratio_change, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Ratio of ending AOH to starting AOH", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_ratio_change, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_ratio_change_est.pdf"),
  width = 7, height = 8.5, units = "in")

# --------------------------------------------------------------- #
# ------------ ratio change in AOH, constrained ----------------- #
# --------------------------------------------------------------- #
gg_ratio_change_constrained <-
  aoh_est_change_tmp %>%
  filter(abs(ratio_change) < 10) %>%
  ggplot() + 
  geom_histogram(aes(x = ratio_change, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Ratio of ending AOH to starting AOH", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

ggsave(
  gg_ratio_change_constrained, 
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_ratio_change_est_constrained.pdf"),
  width = 7, height = 8.5, units = "in")


# ----------------------------------------------------------------- #
# Explore negative ratio winner species
# ----------------------------------------------------------------- #

aoh_est_change_tmp %>%
  filter(abs(ratio_change) < 10, site == "belarus") %>%
  ggplot() + 
  geom_histogram(aes(x = ratio_change, fill = trend, group = trend), bins = 50, col = "black") +
  theme_classic() +
  # scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  labs(x = "Ratio of ending AOH to starting AOH", y = "Count") + 
  theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
  facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels))

aoh_est_change_tmp %>%
  filter(abs(ratio_change) < 10, site == "belarus") %>%
  select(site, aoh_type, passage_type, binomial, mature_forest_obl, aoh_start_est, aoh_end_est, trend, ratio_change)

# for this reason, the proportion, ratio, etc., only make sense when derived directly from observations fromthe start and end of the time series.
```

```{r plot-aoh-change-obs}

# --------------------------------------------------------------- #
# ------------ observed absolute AOH change --------------------- #
# --------------------------------------------------------------- #

lapply(c(1, 5, 10, 15), function(i) {
  ggsave(
    aoh_start_end_l_tmp_plots %>% 
      filter(window_size == i) %>%
      ggplot() + 
      geom_histogram(aes(x = abs_change/ 10^3, fill = trend, group = trend), bins = 50, col = "black") +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
      labs(x = expression("Absolute change in observed AOH (10"^{3}*" ha)"), y = "Count",
           caption = paste0("Window size: ", i)) + 
      theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)),
    
      # gg_abs_change_obs, 
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_abs_change_obs_", i, ".pdf"),
    width = 7, height = 8.5, units = "in")
  })

# --------------------------------------------------------------- #
# ------------ proportional change in observed AOH -------------- #
# --------------------------------------------------------------- #
# apply across multiple window sizes:
constrain_ <- TRUE
i <- 5
lapply(c("TRUE", "FALSE"), function (constrain_) {
  lapply(c(1, 5, 10, 15
           ), function(i) {
    ggsave(
      aoh_start_end_l_tmp_plots %>% 
        filter(window_size == i) %>%
        { if (constrain_) filter(., abs(prop_change) < 30) else .} %>%
        ggplot() + 
        geom_histogram(aes(x = prop_change, fill = trend, group = trend), bins = 100, col = "black") +
        theme_classic() +
        scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
        labs(x = "Proportional change in observed AOH", y = "Count",
             caption = paste0("Comparing mean values in first ", i, " and last ", i, " years")) + 
        theme(legend.position = "bottom", 
              strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
        facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)),
      filename = paste0(p_output, "plots/aoh/effect_size/", "hist_prop_change_obs_", 
                        {if(constrain_) "constrained_" else ""},
                        i, ".pdf"),
      width = 7, height = 8.5, units = "in")
    })
})



# --------------------------------------------------------------- #
# ------------ ratio change in observed AOH --------------------- #
# --------------------------------------------------------------- #
# apply across multiple window sizes:
lapply(c("TRUE", "FALSE"), function (constrain_) {
  lapply(c(1, 5, 10, 15), function(i) {
  ggsave(
    aoh_start_end_l_tmp_plots %>% 
      filter(window_size == i) %>%
      { if (constrain_) filter(., abs(ratio) < 25) else .} %>%
      
      ggplot() + 
      geom_histogram(aes(x = ratio, fill = trend, group = trend), bins = 100, col = "black") +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], 
                        values = palette_du_jour[c(1, 3, 6)]) + 
      labs(x = "Ratio of ending AOH to starting AOH (observed)", 
           y = "Count", caption = paste0("Comparing mean values in first ", i, " and last ", i, " years")) + 
      # scale_x_continuous() +
      scale_x_continuous(trans = "log10") +
      theme(legend.position = "bottom", 
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
      facet_grid(site ~ ., scales = "free", 
                 labeller = as_labeller(fancy_labels)),
    
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_ratio_obs_",
                      {if(constrain_) "constrained_" else ""},
                      i, ".pdf"),
    width = 7, height = 8.5, units = "in")
    })
  })

# --------------------------------------------------------------- #
# ------- ratio change in observed AOH, shown on log10 scale ---- #
# --------------------------------------------------------------- #
# apply across multiple window sizes:

lapply(
  # c(1, 
    5
    # , 10, 15)
  , function(i) {
  ggsave(
    aoh_start_end_l_tmp_plots %>% 
      filter(window_size == i) %>%
      ggplot() + 
      geom_histogram(aes(x = ratio, fill = trend, group = trend), bins = 100, col = "black") +
      geom_vline(xintercept = c(0.5, 2), linetype = "dashed") +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], 
                        values = palette_du_jour[c(1, 3, 6)]) + 
      labs(
        x = expression(AOH["end"]~"/"~AOH["start"]~(shown~on~a~log["10"]~scale)),
        y = "Number of Species", 
        caption = paste0("Comparing mean AOH values for first and last ", i, " years")
        ) + 
      scale_x_continuous(trans = "log10", breaks = c(0.1, 0.2, 0.5, 1, 2, 5, 10, 50, 100)) +
      theme(legend.position = "bottom", 
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)),
    
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_ratio_obs_log_scale",
                      i, ".pdf"),
    width = 7, height = 8.5, units = "in")
    })


# --------------------------------------------------------------- #
# ------------ log ratio change in observed AOH --------------------- #
# --------------------------------------------------------------- #
# apply across multiple window sizes:
# lapply(c("TRUE", "FALSE"), function (constrain_) {
#   lapply(c(1, 5, 10, 15), function(window_size_) {
#   ggsave(
# window_size_ <- 5
# constrain_ <- FALSE
    aoh_start_end_l_tmp_plots %>% 
      filter(window_size == window_size_) %>%
      { if (constrain_) filter(., abs(ratio) < 25) else .} %>%
      
      ggplot() + 
      geom_histogram(aes(
        # x = ratio, 
        x = log(ratio),
        # x = log10(ratio),
        fill = trend, group = trend), bins = 100, col = "black") +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], 
                        values = palette_du_jour[c(1, 3, 6)]) + 
      labs(x = "Natural Log Ratio of ending AOH to starting AOH (observed)", 
           y = "Count", caption = paste0("Comparing mean values in first ", window_size_, " and last ", window_size_, " years")) + 
      # scale_x_continuous(trans = "log10") +
      theme(legend.position = "bottom", 
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
      facet_grid(site ~ ., scales = "free", 
                 labeller = as_labeller(fancy_labels))#,
  #   
  #   filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_log_ratio_obs_",
  #                     {if(constrain_) "constrained_" else ""},
  #                     window_size_, ".pdf"),
  #   width = 7, height = 8.5, units = "in")
  #   })
  # })


# --------------------------------------------------------------- #
# -------- change in observed AOH as a percent of site area -------- #
# --------------------------------------------------------------- #
# By site
lapply(c(1, 5, 10, 15), function(window_size_) {
  ggsave(
  aoh_start_end_l_tmp_plots %>% 
    filter(window_size == window_size_) %>%
    ggplot() + 
    geom_histogram(aes(x = abs_change_percent_site, fill = trend, group = trend), bins = 100, col = "black") +
    geom_vline(data = aoh_start_end_l_tmp_plots %>%
                 filter(window_size == window_size_, trend != "no trend") %>%
                 group_by(trend, site) %>%
                 summarise(n = n(), mean = mean(abs_change_percent_site), 
                           median = median(abs_change_percent_site)) %>%
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
               mapping = aes(xintercept = value, linetype = Statistic, col = trend), size = 0.75) +
    theme_classic() +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = "Change in AOH (% of site area)", y = "Count", 
         caption = paste0("Comparing mean values in first ", window_size_, " and last ", window_size_, " years")) + 
    theme(legend.position = "bottom", strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
    facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)),

  filename = paste0(p_output, "plots/aoh/effect_size/", 
                    "hist_aoh_change_percent_site_obs_by_site_", 
                    window_size_, ".pdf"),
  width = 7, height = 8.5, units = "in")
})

# 
window_size_ <- 5
# ------------------------------------------------------ #
# AOH Change as a percent of site area, by trend
# ------------------------------------------------------ #
lapply(c(1, 5, 10, 15), function(window_size_) {
  ggsave(
  aoh_start_end_l_tmp_plots %>% 
    filter(window_size == window_size_) %>%
    ggplot() + 
    geom_histogram(aes(x = abs_change_percent_site, fill = trend, group = trend), 
                   # position = position_dodge(),
                   bins = 50, col = "black") +
    geom_vline(data = aoh_start_end_l_tmp_plots %>%
                 filter(window_size == window_size_, #trend != "no trend"
                        ) %>%
                 group_by(trend, 
                          vert_class
                          ) %>%
                 summarise(n = n(), mean = mean(abs_change_percent_site), 
                           median = median(abs_change_percent_site)) %>%
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
               mapping = aes(col = trend,
                 # x = value, y = 0, shape = Statistic
                 xintercept = value, linetype = Statistic
                 ), 
               # size = 3
               size = 0.75
               ) +
    theme_classic() +
    scale_x_continuous(n.breaks = 10) +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = "Change in AOH (% of site area)", y = "Number of Species-Site Trends", 
         caption = paste0("Comparing mean values in first ", window_size_, " and last ", window_size_, " years")
         ) + 
    theme(legend.position = "bottom") +
    facet_grid(
      trend ~ vert_class,
      # rows = vars(vert_class),
               scales = "free", labeller = as_labeller(aoh_type_labels)),

  filename = paste0(p_output, "plots/aoh/effect_size/", 
                    "hist_aoh_change_percent_site_obs_by_trend_", 
                    window_size_, ".pdf"),
  width = 7, height = 5, units = "in")
})



# ------------------------------------------------------ #
# AOH Change ratio, by trend
# ------------------------------------------------------ #
lapply(c(1, 5, 10, 15), function(window_size_) {
  ggsave(
  aoh_start_end_l_tmp_plots %>% 
    filter(window_size == window_size_) %>%
    ggplot() + 
    geom_vline(xintercept = c(0.5, 2), linetype = "dashed", col = "red") +
    geom_histogram(aes(x = ratio, fill = trend, group = trend), 
                   # position = position_dodge(),
                   bins = 50, col = "black") +
    geom_vline(data = aoh_start_end_l_tmp_plots %>%
                 filter(window_size == window_size_) %>%
                 group_by(trend, vert_class) %>%
                 summarise(n = n(), mean = mean(ratio), 
                           median = median(ratio)) %>%
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
               mapping = aes(col = trend,
                 # x = value, y = 0, shape = Statistic
                 xintercept = value, linetype = Statistic
                 ), 
               # size = 3
               size = 0.75
               ) +
    theme_classic() +
    scale_fill_manual(name = "AOH Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    scale_color_manual(name = "AOH Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    labs(
        x = expression(AOH["end"]~"/"~AOH["start"]~(shown~on~a~log["10"]~scale)),
        y = "Number of Species-Site Trends", 
         caption = paste0("Comparing mean values in first ", window_size_, " and last ", window_size_, " years")
        ) + 
      scale_x_continuous(trans = "log10", 
                         breaks = c(0.1, 0.2, 0.5, 1, 2, 5, 10, 25, 50, 100),
                         labels = c("0.1", "0.2", "0.5", "1", "2",
                                    "5", "10", "25", "50", "100")
                         ) +
        theme(legend.position = "bottom") +
    facet_grid(
      trend ~ vert_class,
      # rows = vars(vert_class),
               scales = "free", labeller = as_labeller(aoh_type_labels)),

  filename = paste0(p_output, "plots/aoh/effect_size/", 
                    "hist_aoh_change_ratio_obs_by_trend_", 
                    window_size_, ".pdf"),
  width = 7, height = 5.5, units = "in")
})





# comparing observed and potential abandonment
lapply(5, #c(1, 5, 10, 15),
       function(window_size_) {
  ggsave(
  aoh_obs_change_tmp_all %>% 
    filter(str_detect(aoh_type, "crop"), trend != "no trend") %>%
    ggplot() + 
    geom_histogram(aes(x = abs_change_percent_site,
                       fill = trend, group = aoh_type,
                       # alpha = fct_relevel(aoh_type, rev)
                       ),
                   bins = 50, col = "black",
                   position = "identity") +
    # geom_density_ridges2(stat = "binline", scale = 0.95,
    #                      aes(x = abs_change_percent_site,
    #                         y = aoh_type,
    #                         fill = trend#, group = aoh_type
    #                    # alpha = fct_relevel(aoh_type, rev)
    #                    )) +
    geom_vline(data = aoh_obs_change_tmp_all %>%
                 filter(str_detect(aoh_type, "crop"), trend != "no trend") %>%
                 group_by(aoh_type, trend, vert_class) %>%
                 summarise(n = n(), mean = mean(abs_change_percent_site), 
                           median = median(abs_change_percent_site)) %>%
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>%
                 ungroup(),
               mapping = aes(col = trend,
                 # x = value, y = aoh_type, shape = Statistic
                 xintercept = value, linetype = Statistic
                 ), 
               # col = "black", size = 3
               size = 0.75
               ) +
    theme_classic() +
    scale_x_continuous(n.breaks = 10) +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = "Change in AOH (% of site area)", y = "Count", 
         caption = paste0("Comparing mean values in first and last ", 5, " years")) + 
    theme(legend.position = "bottom") +
    facet_grid(
      # aoh_type ~ vert_class,
      rows = vars(trend, aoh_type),
      # rows = vars(trend),
      cols = vars(vert_class),
      # rows = vars(vert_class),
               scales = "free", labeller = as_labeller(c(
                 "Mammals" = "Mammals", "Birds" = "Birds", 
                 "crop_abn_iucn" = "Observed\nabandonment",
                 "crop_abn_potential_iucn" = "Without\nrecultivation",
                 aoh_type_labels
                 ))),

  filename = paste0(p_output, "plots/aoh/effect_size/",
                    "hist_aoh_change_percent_site_obs_by_trend_obs_v_pot",
                    window_size_, ".pdf"),
  width = 7, height = 5.5, units = "in")
})


```


```{r primary-effect-size-fig-former-fig3}
# formerly figure 3, developed in the chunk above "plot-aoh-change-obs", producing files named:
# "plots/aoh/effect_size/", "hist_aoh_change_percent_site_obs_by_trend_", window_size_, ".pdf"
# now, included in supplement as Fig. S36.

# ------------------------------------------------------ #
# AOH Change as a percent of site area, by trend
# ------------------------------------------------------ #
lapply(c("pdf", "png"), function(file_type_) {
  ggsave(
  aoh_start_end_l_tmp_plots %>% 
    filter(window_size == 5) %>%
    ggplot() + 
    geom_histogram(aes(x = abs_change_percent_site, fill = trend, group = trend), 
                   bins = 50, col = "black") +
    geom_vline(data = aoh_start_end_l_tmp_plots %>%
                 filter(window_size == 5) %>%
                 group_by(trend, 
                          vert_class
                          ) %>%
                 summarise(n = n(), mean = mean(abs_change_percent_site), 
                           median = median(abs_change_percent_site)) %>%
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
               mapping = aes(col = trend,
                             xintercept = value, linetype = Statistic
                 ), 
               size = 0.75
               ) +
    theme_classic() +
    scale_x_continuous(n.breaks = 10) +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = "Change in AOH (% of site area)", y = "Number of Species-Site Trends") + 
    theme(legend.position = "bottom") +
    facet_grid(
      trend ~ vert_class,
      scales = "free", labeller = as_labeller(aoh_type_labels)),

  filename = paste0(
    p_output, 
    "figures/figure_3",
    ".", file_type_
    # "plots/aoh/effect_size/", "hist_aoh_change_percent_site_obs_by_trend_", 
    # window_size_, ".pdf"
    ),
  width = 7, height = 5, units = "in")
})
```

```{r model-slopes}

# --------------------------------------------------------------- #
# ---- model slopes from ols regression with Newey-West estimator #
# --------------------------------------------------------------- #
ggsave(
  aoh_feols_trends %>%
    filter(aoh_type == "crop_abn_iucn",
           vert_class != "amp",
           passage_type == "exclude_passage",
           mature_forest_obl < 0.5) %>%
    ggplot() + 
    geom_histogram(aes(x = estimate / 10^3, fill = trend), bins = 100, col = "black") + 
    theme_classic() +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], 
                      values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = expression("AOH slope (10"^{3}*" ha / year) estimated from OLS regression"),
         y = "Count") + 
    scale_x_continuous() +
    theme(legend.position = "bottom", 
          strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
    facet_grid(rows = vars(site), scales = "free", 
               labeller = as_labeller(fancy_labels)),
    
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_slope_est",
                      ".pdf"),
  width = 7, height = 8.5, units = "in")


# --------------------------------------------------------------- #
# ---- model slopes, as a percent of site area --------------- #
# --------------------------------------------------------------- #
ggsave(
  aoh_est_change_tmp %>%
    ggplot() + 
    geom_histogram(aes(
      x = 100 * slope / total_site_area_ha_2017,
      fill = trend), bins = 100, col = "black") + 
    theme_classic() +
    scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], 
                      values = palette_du_jour[c(1, 3, 6)]) + 
    labs(x = expression("AOH slope (% site area per year)"), y = "Count") + 
    scale_x_continuous() +
    theme(legend.position = "bottom", 
          strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)) +
    facet_grid(rows = vars(site), scales = "free", 
               labeller = as_labeller(fancy_labels)),

  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_aoh_slope_percent_site", ".pdf"),
  width = 7, height = 8.5, units = "in")
```

In the following chunk, I plot the factor change in observed AOH.
This means the proportional change in AOH over the course of the time series, using the simple comparison of mean AOH in the first x years and the last x years. 
A factor of 6 means that the AOH has a 600% increase, or is 700% the original amount - this equates to a factor of 7 times larger at the end of the time series.
For declines in AOH, the absolute change is negative.

```{r factor-change}
# --------------------------------------------------------------- #
# ------------ factor change in observed AOH (i.e., negative values are 1/proportion) -------------- #
# --------------------------------------------------------------- #

aoh_start_end_l_tmp_plots %>% filter(window_size == 5)

# ---------------- by site ---------- #
lapply(c(1, 5, 10, 15), function(i) {
  ggsave(
    aoh_start_end_l_tmp_plots %>% 
      filter(window_size == i,
             abs(ratio_mod) < 15) %>%
      ggplot() +
      geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = ratio_mod, fill = trend, group = trend), bins = 50, binwidth = 0.5, 
                     # closed = "left",  center = 0,
                     col = "black", size = 0.5
                     ) +
      geom_vline(data = aoh_start_end_l_tmp_plots %>% 
                   filter(window_size == i, !is.na(trend), trend != "no trend") %>%
                   group_by(trend, site) %>%
                   summarise(n = n(), mean = mean(ratio_mod), median = median(ratio_mod)) %>%
                   pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(),
                 mapping = aes(xintercept = value, linetype = Statistic, col = trend), size = 0.75) +
      # scale_x_continuous(breaks = seq(from = -20, to = 20, by = 5)) +
      
      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count", 
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) + 
      theme(legend.position = "bottom", ggh4x.axis.ticks.length.minor = rel(1),
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)),

    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_obs_annotated_", i, ".pdf"),
    width = 7, height = 8.5, units = "in")
})


aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5) %>% 
      filter(abs(ratio_mod) < 15,
             !is.na(trend))



# ---------------- by trend ---------- #
ggsave(
  aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5, abs(ratio_mod) < 15, !is.na(trend)) %>%
      ggplot() +
      geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = ratio_mod, fill = trend, group = trend), bins = 50, binwidth = 0.5,
                     col = "black", size = 0.5) +
      scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5), minor_breaks = seq(from = -15, to = 15, by = 1), guide = "axis_minor") +
      facet_grid(trend ~ vert_class, #scales = "free", 
                 labeller = as_labeller(aoh_type_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count", 
           caption = "Window size: 5 years, constrained to < 15"
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) + 
      theme(legend.position = "bottom", ggh4x.axis.ticks.length.minor = rel(1)),
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_obs_by_trend.pdf"),
    width = 7, height = 6, units = "in")


# ---------------- version 2 ---------- #

ggsave(
  aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5,
             abs(ratio_mod) < 15,
             !is.na(trend)) %>%
      ggplot() +
      # geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = abs(ratio_mod), fill = trend, col = trend, group = trend), bins = 50, binwidth = 0.5,
                     col = "black", size = 0.5) +
    geom_vline(data = aoh_start_end_l_tmp_plots %>% filter(window_size == 5, 
                                                     # abs(ratio_mod) < 15,
                                                     !is.na(trend)) %>%
                 group_by(trend, vert_class,# site
                          ) %>%
                 summarise(n = n(), mean = mean(abs(ratio_mod)), median = median(abs(ratio_mod))) %>% 
                 pivot_longer(cols = c("mean", "median"), names_to = "Statistic") %>% ungroup(), 
               mapping = aes(xintercept = value, linetype = Statistic), size = 0.75
               ) + 
      scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5),
                         minor_breaks = seq(from = -15, to = 15, by = 1), 
                         guide = "axis_minor") +
      facet_grid(rows = vars(trend), cols = vars(vert_class),
                 scales = "free",
                 labeller = as_labeller(aoh_type_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count", 
           caption = "Window size: 5 years, constrained to < 15"
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) +
      theme(legend.position = "right", ggh4x.axis.ticks.length.minor = rel(1)),
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_obs_by_trend2.pdf"),
    width = 7, height = 5, units = "in")


# --------------- by trend, all together ------ #
ggsave(
  aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5, abs(ratio_mod) < 15, !is.na(trend)) %>%
      ggplot() +
      geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = ratio_mod, fill = trend, group = trend), bins = 50, binwidth = 0.5,
                     col = "black", size = 0.5) +
      scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5),
                         minor_breaks = seq(from = -15, to = 15, by = 1), guide = "axis_minor") +
      facet_grid(rows = vars(vert_class), scales = "free", 
                 labeller = as_labeller(aoh_type_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour2[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count", 
           caption = "Window size: 5 years, constrained to < 15"
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) + 
      theme(legend.position = "bottom", ggh4x.axis.ticks.length.minor = rel(1)),
    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_obs_mam_bird.pdf"),
    width = 7, height = 6, units = "in")




# --------------------------------------------------------------- #
# ------------ factor change in estimated AOH (i.e., negative values are 1/proportion) -------------- #
# --------------------------------------------------------------- #
ggsave(
  aoh_change_df %>%
      filter(aoh_type == "crop_abn_iucn", str_detect(passage_type, "excl"),
             vert_class != "amp", mature_forest_obl < 0.5) %>%
      left_join(aoh_feols_trends %>% select(run_index, trend)) %>%
      select(run_index, aoh_end_est, aoh_start_est, contains("change"), site, trend) %>%
      mutate(ratio = aoh_end_est/aoh_start_est,
             ratio_mod = case_when(ratio < 1 ~ 1/ratio * -1, TRUE ~ ratio)
             ) %>% 
      filter(abs(ratio_mod) < 15) %>%
      ggplot() +
      geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
      geom_histogram(aes(x = ratio_mod, fill = trend, group = trend), bins = 50, binwidth = 0.5, col = "black") +
      scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5)) +
      
      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)) +
      theme_classic() +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)],
                        values = palette_du_jour[c(1, 3, 6)]) +
      labs(x = "Factor change in estimated AOH.", y = "Count", 
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) + 
      theme(legend.position = "bottom",
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0)),

    filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_est.pdf"),
    width = 7, height = 8.5, units = "in")

```

```{r plot-expl}
# birds above 0, mammals below 0:
ggsave(
  aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5, abs(ratio_mod) < 15) %>%
  mutate(rounded = plyr::round_any(ratio_mod, 0.5, ceiling)) %>% #select(run_index, ratio, ratio_mod, rounded) %>%
  group_by(vert_class, site, rounded, trend) %>%
  summarise(freq = n()) %>% ungroup() %>% 

  mutate(n_mod = ifelse(vert_class == "bird", freq, freq*-1)) %>%
  #   full_join(
  #     lapply(c("bird", "mam"), function(i) {
  # lapply(site_df$site, function(j) {
  #     bind_rows(
  #       tibble(vert_class = i, 
  #            site = j,
  #            rounded = seq(from = -15, to = 0, by = 0.5),
  #            trend = "loss"),
  #       tibble(vert_class = i, 
  #            site = j,
  #            rounded = seq(from = 0, to = 15, by = 0.5),
  #            trend = "gain"),
  #       tibble(vert_class = i, 
  #            site = j,
  #            rounded = seq(from = -5, to = 5, by = 0.5),
  #            trend = "no trend")
  #       )}) %>% bind_rows()
  # }) %>% bind_rows()) %>%
  #   mutate(freq = replace_na(freq, 0), n_mod = replace_na(n_mod, 0)) %>%
  ggplot() + 
  geom_col(aes(x = rounded, 
               y = n_mod,
               # y = freq,
               fill = trend, group = trend), col = "black", size = 0.25
           # position = "dodge"
           ) +
  geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
  # geom_histogram(aes(x = ratio_mod, fill = trend, group = trend), bins = 50, binwidth = 0.5, col = "black") +
    theme_classic() +
    scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5),
                       minor_breaks = seq(from = -15, to = 15, by = 1),
                       guide = "axis_minor") +

      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)) +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count",
           # caption = expression("Positive values represent the factor by which AOH increased (corresponding to ratios of ending AOH to starting AOH. Negative values correspond the factor by which AOH was reduced (corresponding to to -1*(ratio"^{-1}*").")
           ) +
      # geom_step(aes(x = rounded, y = n_mod, group = vert_class), direction = "mid", size = 0.5) +
      # geom_density_ridges(aes(x = freq, y = site, fill = trend), stat = "binline", bins = 50, scale = 0.95) +
      theme(legend.position = "bottom",
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0),
            ggh4x.axis.ticks.length.minor = rel(1)),
  
  filename = paste0(p_output, "plots/aoh/effect_size/", "hist_factor_change_obs_v2.pdf"),
    width = 7, height = 8.5, units = "in")



# just the steps:
  aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5, abs(ratio_mod) < 15) %>%
  mutate(rounded = plyr::round_any(ratio_mod, 0.5, floor)) %>%
  group_by(vert_class, site, rounded, trend) %>%
  summarise(freq = n()) %>% ungroup() %>% 
  mutate(n_mod = ifelse(vert_class == "bird", freq, freq*-1)) %>%
    full_join(
      lapply(c("bird", "mam"), function(i) {
  lapply(site_df$site, function(j) {
      bind_rows(tibble(vert_class = i, site = j, rounded = seq(from = -15, to = 0, by = 0.5), trend = "loss"),
        tibble(vert_class = i, site = j, rounded = seq(from = 0, to = 15, by = 0.5), trend = "gain"),
  tibble(vert_class = i, site = j, rounded = seq(from = -5, to = 5, by = 0.5), trend = "no trend")
        )}) %>% bind_rows()
  }) %>% bind_rows()) %>%
    mutate(freq = replace_na(freq, 0), n_mod = replace_na(n_mod, 0)) %>%
    group_by(site, rounded, trend) %>%
  summarise(freq = sum(freq)) %>% ungroup() %>%
  ggplot() + 
  geom_col(aes(x = rounded, 
               # y = n_mod,
               y = freq,
               fill = trend, col = trend), 
           position = "identity",
           # col = "black", 
           # size = 0.25
           ) +
  geom_step(aes(x = rounded, y = freq, #y = n_mod, 
                group = trend), direction = "mid", size = 0.5) +

  geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
    theme_classic() +
    scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5),
                       minor_breaks = seq(from = -15, to = 15, by = 1),
                       guide = "axis_minor") +

      facet_grid(site ~ ., scales = "free", labeller = as_labeller(fancy_labels)) +
      scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) +
      scale_color_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) +
      labs(x = "Factor change in observed AOH.", y = "Count") +
      theme(legend.position = "bottom",
            strip.text.y.right = element_text(size = 8, angle = 0, hjust = 0, vjust = 0),
            ggh4x.axis.ticks.length.minor = rel(1))



# density ridges:
aoh_start_end_l_tmp_plots %>% 
      filter(window_size == 5, abs(ratio_mod) < 15, !is.na(trend)) %>%
  ggplot() + 
  geom_vline(xintercept = 0, linetype = "dashed", col = "gray50") +
    theme_classic() +
    scale_x_continuous(breaks = seq(from = -15, to = 15, by = 5),
                       minor_breaks = seq(from = -15, to = 15, by = 1),
                       guide = "axis_minor") +
      geom_density_ridges(aes(x = ratio_mod, y = fct_relevel(trend, rev), fill = fct_relevel(trend, c("no trend", "loss", "gain"))), 
                           # stat = "binline", bins = 50,
                           scale = 0.95
                          ) + 
        scale_fill_manual(name = "Trend", labels = palette_labels[c(1, 3, 6)], values = palette_du_jour[c(1, 3, 6)]) + 
  facet_grid(vars(vert_class))


```

# Methods figure

```{r *fig4}
# formerly figure 5 before final accepted version of manuscript

sample_traj_df <- tibble(
    year = rep(rep(1987:2017, 10), 3),
    land_cover = rep(c(
      rep(2, 8), rep(3, 10), rep(4, 13),
      rep(2, 4), rep(3, 10), rep(4, 8), rep(2, 9),
      rep(3, 15), rep(4, 8), rep(2, 3), rep(4, 5),
      rep(4, 7), rep(3, 8), rep(4, 8), rep(2, 8),
      rep(3, 10), rep(4, 6), rep(2, 10), rep(3, 5),
      rep(4, 10), rep(3, 10), rep(4, 11),
      
      rep(2, 15), rep(3, 16), 
      rep(3, 31),
      rep(4, 20), rep(2, 11),
      rep(2, 31)
      ), 3),
    include = c(c(
                rep(0, 8), rep(1, 23),
                rep(0, 4), rep(1, 27),
                rep(1, 15), rep(1, 16),
                rep(0, 7), rep(1, 24),
                rep(1, 10), rep(1, 21),
                rep(0, 10), rep(1, 21),
                rep(0, 15), rep(0, 16), 
                rep(0, 31),
                rep(0, 20), rep(0, 11),
                rep(0, 31)
                ),
                c( 
                rep(1, 6), rep(1, 25),
                rep(1, 4), rep(1, 27),
                rep(1, 15), rep(1, 16),
                rep(1, 7), rep(1, 24),
                rep(1, 10), rep(1, 21),
                rep(1, 10), rep(1, 21),
                rep(0, 15), rep(0, 16),
                rep(0, 31),
                rep(0, 20), rep(0, 11),
                rep(0, 31)
                ),
                rep(1, 31*10)
                ),
    pixel = as_factor(rep(rep(1:10, each = 31), 3)),
    label = rep(1:3, each = 31*10),
    type = "sample"
  ) %>%
  mutate(abandoned_pixels = case_when(
    pixel %in% 1:6 ~ "yes",
    pixel %in% 7:10 ~ "no"
  )) %>%
  mutate(abandoned_pixels = fct_relevel(abandoned_pixels, c("yes", "no")))


# ----------------------------- #
# horizontal

excl_rows <- sample_traj_df %>% 
  filter(include == 0) %>%
  bind_rows(
  tibble(
    year = c(1995, 1991, 1994, 1997),
    land_cover = c(2, 2, 4, 4),
    include = rep(0, 4),
    pixel = as_factor(c(1, 2, 4, 6)),
    label = 1,
    type = "sample",
    abandoned_pixels = "yes"
    )) %>%   mutate(abandoned_pixels = fct_relevel(abandoned_pixels, c("yes", "no")))


gg_sample_trajectory_horiz <-
   sample_traj_df %>%
  ggplot(mapping = aes(x = year, 
                       y = fct_reorder(pixel, desc(pixel)), 
                       alpha = as_factor(include),
                       color = factor(land_cover),
                       group = pixel)) +
  theme_classic() + 
  geom_line(size = 3) +
  geom_line(data = excl_rows,
            mapping = aes(x = year, y = fct_reorder(pixel, desc(pixel)), group = pixel),
            inherit.aes = FALSE, linetype = 3, lineend = "butt",
            ) +
     
  facet_grid(rows = vars(abandoned_pixels), cols = vars(label), scales = "free", space = "free",
               labeller = as_labeller(c(
                 "1" = "Calculation 1", "2" = "Calculation 2", "3" = "Calculation 3",
                 "yes" = "Abandoned", "no" = "Not abn.",
                                      "sample" = "Land Cover Trajectories"))) +
    labs(x = "Year", y = "Individual Example Pixels") + 
  scale_alpha_manual(values = c(0.3, 1)) +
  scale_color_manual(name = "Land Cover",
                     labels = c("2" = "Forest", "3" = "Cropland", "4" = "Grassland"),
                     values = c("2" = terrain.colors(9)[1], # dark green
                                "3" = terrain.colors(9)[5], # gold
                                "4" = terrain.colors(9)[3] # light green
                                )) +
    theme(legend.position = c(0.53, -0.3),
          plot.margin = unit(c(2,2,6,2), units = "mm"),
          legend.box.margin = unit(c(0,0,0,0), units = "mm"),
          legend.margin = margin(0,0,0,0, unit = "mm"),
          legend.key = element_blank(),
          legend.box.background = element_blank(),
          legend.background = element_blank(),
          legend.spacing = unit(0, units = "mm")
          ) +
  guides(col = guide_legend(override.aes = list(size = 6), 
                            nrow = 1, title.position = "left"),
         alpha = "none")

# save
lapply(c("pdf", "png"), function(file_type_) {
ggsave(gg_sample_trajectory_horiz,
       filename = paste0(p_output, "figures/figure_5", ".", file_type_),
       # filename = paste0(p_plots, "methods/", "sample_trajectories_horiz.", file_type_),
       height = 2.5, width = 5.5, units = "in"
       )
})


# ------------------------------------ #
# Nature Sustainability - alternative version of Figure 5 (now Figure 4 in final version)

# wide
ggsave(
sample_traj_df %>%
  ggplot(mapping = aes(x = year, 
                       y = fct_reorder(pixel, desc(pixel)), 
                       alpha = as_factor(include),
                       color = factor(land_cover),
                       group = pixel)) +
  theme_classic() + 
  geom_line(size = 3) +
  geom_line(data = excl_rows,
            mapping = aes(x = year, y = fct_reorder(pixel, desc(pixel)), group = pixel),
            inherit.aes = FALSE, linetype = 3, lineend = "butt") +
     
  facet_grid(rows = vars(abandoned_pixels), cols = vars(label), scales = "free", space = "free",
               labeller = as_labeller(c(
                 "1" = "Calculation 1", "2" = "Calculation 2", "3" = "Calculation 3",
                 "yes" = "Abandoned", "no" = "Not abn.",
                                      "sample" = "Land Cover Trajectories"))) +
    labs(x = "Year", y = "Individual Example Pixels") + 
  scale_alpha_manual(values = c(0.3, 1)) +
  scale_color_manual(name = "Land Cover",
                     labels = c("2" = "Forest", "3" = "Cropland", "4" = "Grassland"),
                     values = c("2" = terrain.colors(9)[1], # dark green
                                "3" = terrain.colors(9)[5], # gold
                                "4" = terrain.colors(9)[3] # light green
                                )) +
    theme(legend.position = "right",
          legend.box.margin = unit(c(0,0,0,0), units = "mm"),
          legend.margin = margin(0,0,0,0, unit = "mm"),
          legend.key = element_blank(),
          legend.box.background = element_blank(),
          legend.background = element_blank(),
          legend.spacing = unit(0, units = "mm")
          ) +
  guides(col = guide_legend(),
         alpha = "none"
         ) 
  # save
  , filename = paste0(p_output, "figures/figure_5",
                           "_wide",
                           ".pdf"),
         height = 56, width = 170, units = "mm"
         )


# narrow:
ggsave(gg_sample_trajectory_horiz + theme(legend.position = c(0.48, -0.33)),
       filename = paste0(p_output, "figures/figure_5", "_narrow.pdf"),
                height = 60, width = 100, units = "mm"
       )



# ----------------------------- #
# vertical

gg_sample_trajectory_vert <-
   sample_traj_df %>%
  ggplot(mapping = aes(x = year, y = pixel, col = land_cover, 
                       alpha = as_factor(include),
                       group = pixel)) +
  theme_classic() + 
  geom_line(mapping = aes(color = factor(land_cover)), size = 3,
            show.legend = TRUE) +
  facet_nested(label + abandoned_pixels ~ type, scales = "free", space = "free",
               labeller = as_labeller(c("1" = "Calculation 1",
                                      "2" = "Calculation 2",
                                      "3" = "Calculation 3",
                                      "yes" = "Abandoned", "no" = "Not abn.",
                                      "sample" = "Land Cover Trajectories"))) +
    labs(x = "Year", y = "Individual Example Pixels") + 
    scale_x_continuous(n.breaks = 6) +
  scale_alpha_manual(values = c(0.2, 1)) +
  scale_color_manual(name = "Land\nCover",
                     labels = c("2" = "Forest",
                                "3" = "Cropland", "4" = "Grassland"
                                ),
                     values = c(
                                "2" = terrain.colors(9)[1], # dark green
                                "3" = terrain.colors(9)[5], # gold
                                "4" = terrain.colors(9)[3] # light green
                                )
                     ) +
    theme(legend.position = c(0.53, -0.15),
          plot.margin = unit(c(2,2,13,2), units = "mm"),
          axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0),
          legend.box.margin = unit(c(0,0,0,0), units = "mm"),
          legend.margin = margin(0,0,0,0, unit = "mm"),
          legend.background = element_blank(),
          legend.spacing = unit(0, units = "mm")
          ) +
  guides(col = guide_legend(override.aes= list(size = 4), nrow = 2, title.position = "left"),
         alpha = "none")

# save
ggsave(gg_sample_trajectory_vert,
       filename = paste0(p_plots, "methods/", "sample_trajectories_vert.pdf"),
       width = 2.5, height = 6.5, units = "in")
```




```{r indiv-species-trend}
# purely for exploratory data analysis
aoh_trends_by_sp %>%
  filter(str_detect(common_names, "Downy")) %>% select(binomial) %>% unique() 

species_list %>%
  filter()
sp_name <- "Oenanthe oenanthe"
sp_name <- "Turdus iliacus"
sp_name <- "Sturnella magna"
sp_name <- "Hylatomus pileatus"
sp_name <- "Dryobates pubescens"


site_index <- 11

# gg_aoh_example_sp <-
  aoh %>%
    filter(
      # site %in% site_df$site[c(7)],
      # binomial == sp_name,
      binomial %in% c("Sturnella magna", "Dryobates pubescens", "Setophaga pinus"),
      vert_class == "bird",
      aoh_type %in% aoh_types[c(6, 3, 1)],
      # mature_forest_obl < 0.5,
      passage_type == "exclude_passage"
      ) %>%
  mutate(aoh_type = fct_relevel(aoh_type, aoh_types[c(6, 3, 1)])) %>% 
  filter(aoh_type == "crop_abn_iucn") %>%
    
  ggplot(mapping = aes(x = year, y = aoh/10^3, 
                       # col = aoh_type, group = aoh_type,
                       col = binomial#common_names
                       )) +
  theme_classic() + 
  geom_point() + 
  geom_smooth(method = "lm", se = 0.95) +
  labs(x = "Year", y = expression("AOH (10"^{3}*" ha)"), 
       # title = sp_name
       col = "Species"
       ) +
  scale_x_continuous(n.breaks = 6) +
  # scale_color_manual(values = c("#3b7c70", "#ce9642")) +

  facet_grid(
    # rows = vars(aoh_type), 
    cols = vars(site), scales = "free",
    # labeller = as_labeller(c(aoh_type_labels, cap_labels))
     labeller = as_labeller(c("crop_abn_iucn" = "Calc. 1", 
                              "max_abn_iucn" = "Calc. 2", 
                              "full_iucn" = "Calc. 3", 
                              cap_labels))) +

    theme(legend.position = "bottom",
          # axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)
          ) +
  guides(col = guide_legend(nrow = 3))
  
ggsave(plot = gg_aoh_example_sp,
       filename = paste0(p_output, "plots/methods/", "aoh_ex_downy_woodpecker_meadowlark_pine_n",
                         ".pdf"),
       width = 3, height = 4, units = "in")
  
    # save plot
ggsave(plot = gg_aoh_example_sp,
       filename = paste0(p_output, "plots/methods/", "aoh_example_sp_", 
                         sp_name, ".pdf"),
       width = 2.5, height = 4.5, units = "in")

```


# Exploring the effect of Phylogeny: trends by taxonomic groups

```{r by-taxonomic-order}
# -------------------------------------------------------------------------- #
# plot proportion of species that experience significant gains in habitat, by taxonomy:
# -------------------------------------------------------------------------- #

aoh_mod_tmp_trends_by_sp %>% filter(order == "PERISSODACTYLA")


gg_by_order <-
  aoh_mod_tmp_trends_by_sp %>%
  # aoh_mod_tmp_trends %>%
  left_join(taxonomy_df) %>%
  mutate(
    # order_combo = paste0(order, ": ", order_common)
    order_combo = paste0(order_common, " -- ", order)

    ) %>%
  group_by(vert_class, order_combo) %>%
  summarise(p_gain = mean(overall_trend == "gain"),
            # p_gain_w_weak = mean(str_detect(overall_trend, "gain")), # include weak gains
            # p_loss = mean(overall_trend == "loss"),
            n_sp = n()) %>% ungroup() %>%
  # mutate(vert_class = case_when(vert_class == "bird" ~ "Birds", vert_class == "mam" ~ "Mammals")) %>%
  
  droplevels() %>%

  # filter out families with fewer than 5 species in them
  # filter(n_sp > 5) %>%

  # plot
  ggplot(aes(x = p_gain, y = fct_reorder(order_combo, n_sp), 
             fill = vert_class, label = n_sp)) +
  geom_col() +
  geom_text(size = 3, nudge_x = 0.04) +
    theme_classic() +
  facet_grid(vars(vert_class), scale = "free_y", space = "free_y",
                          labeller = as_labeller(aoh_type_labels)) +
  labs(x = "Proportion of species with significant gains in AOH", y = "Taxonomic Order") +
  geom_vline(xintercept = 0.5) +
    scale_x_continuous(n.breaks = 6) + 
    scale_fill_manual(
    labels = c("bird" = "Birds", "mam" = "Mammals"),
    values = sp_threat_palette,
    ) +
theme(legend.position = "none")

ggsave(gg_by_order,
       filename = paste0(p_output, "plots/aoh/traits/", 
                           "taxonomic_order_p_gain", ".pdf"),
         width = 8, height = 6, units = "in"
       )
```


```{r by-taxonomic-family}

# -------------------------------------------------------------------------- #
# plot proportion of species that experience significant gains in habitat, by taxonomy:
# -------------------------------------------------------------------------- #
aoh_trends_by_taxonomic_family <-
  aoh_mod_tmp_trends_by_sp %>%
  left_join(taxonomy_df) %>%
  mutate(
    # family_combo = paste0(family, ": ", family_common),
    family_combo = paste0(family_common, " -- ", family)
         ) %>%
  group_by(vert_class, family_combo) %>%
  summarise(p_gain = mean(overall_trend == "gain"),
            # p_gain_w_weak = mean(str_detect(overall_trend, "gain")), # include weak gains
            # p_loss = mean(overall_trend == "loss"),
            n_sp = n()) %>% ungroup() %>%
  # mutate(vert_class = case_when(vert_class == "bird" ~ "Birds", vert_class == "mam" ~ "Mammals")) %>%
  
  droplevels() 



gg_by_family <- 
  aoh_trends_by_taxonomic_family %>%

  # filter out families with fewer than 5 species in them
  filter(n_sp > 4,
         # vert_class != "bird"
         ) %>%

  # plot
  ggplot(aes(x = p_gain, y = fct_reorder(family_combo, n_sp), 
             fill = vert_class,
             label = n_sp)) +
  geom_col() +
  geom_text(size = 3, nudge_x = 0.025) +
  theme_classic() +
  facet_grid(vars(vert_class), scale = "free_y", space = "free_y", 
             labeller = as_labeller(aoh_type_labels)) +
  scale_x_continuous(n.breaks = 6) + 
  labs(x = "Proportion of species with significant gains in AOH", y = "Taxonomic Family",
       caption = "Results for only families with > 4 species.") +
  geom_vline(xintercept = 0.5) +
  scale_fill_manual(
    labels = c("bird" = "Birds", "mam" = "Mammals"),
    values = sp_threat_palette,
    ) +
  theme(legend.position = "none")


ggsave(gg_by_family,
       filename = paste0(p_output, "plots/aoh/traits/", 
                         "taxonomic_family_p_gain", 
                         ".pdf"),
       width = 9, height = 9, units = "in")

ggsave(gg_by_family %+% filter(aoh_trends_by_taxonomic_family, vert_class == "bird") + labs(caption = NULL),
       filename = paste0(p_output, "plots/aoh/traits/", "taxonomic_family_p_gain", 
                         "_bird",
                         ".pdf"),
         width = 9, height = 12, units = "in")

ggsave(gg_by_family %+% filter(aoh_trends_by_taxonomic_family, vert_class == "mam") + labs(caption = NULL),
       filename = paste0(p_output, "plots/aoh/traits/", "taxonomic_family_p_gain",
                         "_mam",
                         ".pdf"),
         width = 9, height = 9, units = "in")


# only families with 4 or more species in them
ggsave(gg_by_family %+% filter(aoh_trends_by_taxonomic_family, vert_class == "bird", n_sp > 4),
       filename = paste0(p_output, "plots/aoh/traits/", "taxonomic_family_p_gain", 
                         "_bird_trim", ".pdf"),
         width = 9, height = 7, units = "in")

ggsave(gg_by_family %+% filter(aoh_trends_by_taxonomic_family, vert_class == "mam", n_sp > 4),
       filename = paste0(p_output, "plots/aoh/traits/", "taxonomic_family_p_gain",
                         "_mam_trim", ".pdf"),
         width = 9, height = 5, units = "in")
```




# Site Maps

```{r plot-lc}
# Plot Yin et al. 2020 land cover:

inset_map_titles <- paste0("(", gsub("_", "", site_df$label), ") ", site_df$description)
# cat(inset_map_titles, sep = "; ")
new_titles <- inset_map_titles
new_titles[1] <- "(b) Vitebsk, Belarus /\nSmolensk, Russia"
new_titles[8] <- "(o) Orenburg, Russia /\nUralsk, Kazakhstan"

fancy_labels

year_index <- 1

lapply(c(1, 6, 11, 16, 21, 26, 31
         ),
       function(year_index) {
  
  pdf(file = paste0(p_plots, "land_cover_", 1986 + year_index, ".pdf"), width = 7, height = 6)
  mval <- 1.5
  par(mfrow = c(3, 4), 
        # mar=c(0,0,0,0), 
        oma=c(1,1,0,0),
        adj = 0,
        cex.main = 1#,
        # tcl = -0.2
        )
  
  # if you use maxcell, the 0s start showing up, which messes up the color scale... beware!
  for(i in 1:11) {
    terra::plot(lcc[[i]][[year_index]],
                # site_jung_l2[[i]], # for testing
                col = lc_plot_cols$color, levels = lc_plot_cols$name, 
                colNA = "gray95",
                mar = c(mval - 1, mval - 0.9, mval + 1.25, mval - 0.9), # bltr     
                legend = FALSE, #maxcell = 5000000,
                cex = 1, # controls title sizes
                type = "classes", main = new_titles[i]#"Land cover, 2015",
       )
  }
  
  
  # pdf(file = paste0(p_output, "plots/jung_sites_colors_legend.pdf"), width = 7.5, height = 7.5)
  plot.new()
  plot(lcc[[i]]$y2017, type = "classes",
       col = lc_plot_cols$color, levels = lc_plot_cols$name,
       legend = "left",
       plg = list(cex = 1.5,
                  title = paste0("Land cover, ", 1986 + year_index),
                                  # text.width = 100,
                  title.adj = 0#,
                  # y.intersp	= 1.1
                  # xjust = 0.5
                  ),
       legend.only = TRUE)
  
  dev.off()
})


# turn into a gif:
gif_files <-
  list.files(paste0(p_plots), full.names = TRUE) %>% 
    grep("land_cover_[0-9]{4}.pdf", ., value = TRUE)
lc_gif <- image_animate(image_read(paste0(p_plots, "land_cover_test_gif.gif")), fps = 2)
image_write(lc_gif, paste0(p_plots, "land_cover_gif.gif"))


# turn this into a gif:

lapply(1:11, function(site_index) {
  file_out_tmp <- paste0(p_plots, "animations/", "abn_age",
                       site_df$label[site_index], ".gif")
  saveGIF(
    terra::animate(age_t[[site_index]][[c(2,2:31)]], 
                   # levels = rcl_df$labels %>% unique() %>% .[-1],
                   col = viridis(n = 25, direction = -1),
                   main = paste0(inset_map_titles[site_index], ", Abandonment Age, ", 1987:2017),
                   type = "continuous",
                   range = c(5, 30),
                   maxcell = 500000,
                   colNA = "gray95",
                   # legend = FALSE,
                   mar = c(mval+0.5, mval, mval + 0.7, mval+1.5),
                   n = 1),
    movie.name = file_out_tmp)
  
  # Reload:
  tmp_gif <- image_animate(image_read(file_out_tmp), fps = 4)
  image_write(tmp_gif, file_out_tmp)
})
```

```{r lc-legend}
pdf(file = paste0(p_output, "plots/lc_legend2.pdf"), width = 6, height = 3.5)
plot.new()
plot(lcc[[i]]$y2017, type = "classes",
     col = lc_plot_cols$color, 
     # levels = lc_plot_cols$name,
     levels = c("1 Non veg.", "2 Woody veg. (Forest)", "3 Cropland", "4 Herbaceous veg. (Grassland)"),
     legend = "left",
     plg = list(cex = 1.8,
                title = "Land cover classes",
                                # text.width = 100,
                title.adj = 0#,
                # y.intersp	= 1.1
                # xjust = 0.5
                ),
     legend.only = TRUE)

dev.off()

pdf(file = paste0(p_output, "plots/lc_legend_simple.pdf"), width = 3, height = 2.5)
plot.new()
par(mfrow = c(1, 1), 
        # mar=c(0,0,0,0), 
        oma=c(0.2,0.2,0.2,0.2),
        adj = 0,
        cex.main = 1#,
        # tcl = -0.2
        )
terra::plot(lcc[[9]]$y2017, type = "classes",
     col = lc_plot_cols$color, 
     levels = lc_plot_cols$name,
     legend = "left",
     plg = list(cex = 1.7,
                title = "Land cover",
                                # text.width = 100,
                title.adj = 0#,
                # y.intersp	= 1.1
                # xjust = 0.5
                ),
     legend.only = TRUE)

dev.off()
```

```{r lc-abn}
# plotting the land cover class within abandoned croplands 

plot(abn_lcc[[9]][[31]])
plot(max_abn_lcc[[9]][[1]])

year_index <- 31
i <- 9


coltab(max_abn_lcc[[9]])
# must give colors for values 0, 1, 2, 3, 4, etc.
coltab(max_abn_lcc[[9]], layer = 31) <- lc_plot_cols$color[c(1, 1, 2, 3, 4)]
plot(max_abn_lcc[[9]][[31]])

# what colors do I need for the levels?
max_abn_lcc_freq %>% 
  # filter(year == 1987) %>% 
  group_by(site, year) %>% 
  summarise(n = n(), lc = str_c(unique(lc), collapse = ", ")) %>% 
  # filter(n != 3) %>%
  ungroup() %>% 
  select(lc) %>% unique()

# plot --------------------------------------------------- #
lapply(
  c(1),
  # c(1, 6, 11, 16, 21, 26, 31),
       function(year_index) {
  
  pdf(file = paste0(p_plots, "abn_land_cover_", 1986 + year_index, ".pdf"), width = 7, height = 6)
  mval <- 1.5
  par(mfrow = c(3, 4), 
        # mar=c(0,0,0,0), 
        oma=c(1,1,0,0),
        adj = 0,
        cex.main = 1#,
        # tcl = -0.2
        )
  
  # if you use maxcell, the 0s start showing up, which messes up the color scale... beware!
  for(i in 1:11) {
    terra::plot(max_abn_lcc[[i]][[year_index]],
                # site_jung_l2[[i]], # for testing
                col = c("dark green", lc_plot_cols$color[3:4]),
                levels = lc_plot_cols$name[2:4],
                # breaks = c(0, 1, 2, 3, 4),
                colNA = "gray95",
                # mar = c(mval - 1, mval - 0.9, mval + 1.25, mval - 0.9), # bltr, for ppt
                mar = c(1.5, 1, 2.2, 1), # bltr, for ms     

                legend = FALSE,
                #maxcell = 5000000,
                cex = 1, # controls title sizes
                type = "classes", main = new_titles[i]#"Land cover, 2015",
       )
  }
  
  
  # pdf(file = paste0(p_output, "plots/jung_sites_colors_legend.pdf"), width = 7.5, height = 7.5)
  plot.new()
  plot(max_abn_lcc[[i]]$y2017, type = "classes",
       col = c("dark green", lc_plot_cols$color[3:4]),
       levels = c("Forest", "Cropland", "Grassland"), #lc_plot_cols$name[2:4],
       legend = "left",
       plg = list(cex = 1.5,
                  title = paste0("Land cover, ", 1986 + year_index),
                                  # text.width = 100,
                  title.adj = 0#,
                  # y.intersp	= 1.1
                  # xjust = 0.5
                  ),
       legend.only = TRUE)
  
  dev.off()
})
```



```{r sample-maps}
site_index <- 2

lc_cols_dark <- data.frame(
  color = c("gray80", # gray, 1. Non-veg
            "dark green", # woody veg dark
            # terrain.colors(9)[1], # "#00A600" # dark green, 2. Woody veg
            terrain.colors(9)[5], # "#E8C32E" # gold, 3. Crop
            terrain.colors(9)[3]  # "#8BD000" # light green, 4. Grassland
  ),
  name = c("Non-veg.", 
           "Forest", 
           "Cropland", 
           "Grassland"),
  breaks = c(1, 2, 3, 4))

i <- 9
# full extent

s_lcc <- ratify(raster(lcc[[i]]$y2017))
lcc_levels <- levels(s_lcc)
lcc_levels$landcover <- lc_plot_cols$name
lcc_levels$class <- c('A1', 'B2', 'C3', 'D4')

levels(s_lcc) <- lcc_levels
levelplot(s_lcc, col.regions = lc_plot_cols$color)

plot(s_lcc)


# p_entire_extent <-
  levelplot(
        lcc[[i]]$y2017,
        main = site_sf$lab_desc[i],
        colorkey = FALSE,
        col.regions = lc_plot_cols$color,
        xlab = NULL, ylab = NULL,
        margin = FALSE,
        # maxpixels = 1e7
        )

levelplot(max_abn_lcc[[i]]$y2017,
          xlab = NULL, ylab = NULL,
          margin = FALSE)

levelplot(
        max_abn_lcc[[i]]$y2017,
        main = site_sf$lab_desc[i],
        # maxpixels = 1e6,
        colorkey = TRUE,
        col.regions = lc_plot_cols$color[2:4],
        xlab = NULL, ylab = NULL,
        margin = FALSE
        )


# terra plots

# full extent:
# terra_plot_full <- 
lapply(1:11, function(i) {
  pdf(file = paste0(p_plots, "methods/maps/full_extent_", site_df$site[i], "_2017.pdf"),
      width = 2, height = 2)
par(bg=NA, mar=c(0,0,0,0), oma=c(0,0,0,0))
terra::plot(
  lcc[[i]]$y2017, type = "classes",
  col = lc_plot_cols$color, 
  levels = lc_plot_cols$name,
  mar = c(1.2,1.2,0.5,0.5), legend = F)
dev.off()
})


lapply(1:11, function(i) {
  pdf(file = paste0(p_plots, "methods/maps/full_extent_", site_df$site[i], "_1987.pdf"),
      width = 2, height = 2)
par(bg=NA, mar=c(0,0,0,0), oma=c(0,0,0,0))
terra::plot(
  lcc[[i]]$y1987, type = "classes",
  col = lc_plot_cols$color, 
  levels = lc_plot_cols$name,
  mar = c(1.2,1.2,0.5,0.5), legend = F)
dev.off()
})


lapply(1:11, function(i) {
  pdf(file = paste0(p_plots, "methods/maps/full_extent_", site_df$site[i], "_2000.pdf"),
      width = 2, height = 2)
par(bg=NA, mar=c(0,0,0,0), oma=c(0,0,0,0))
terra::plot(
  lcc[[i]]$y2000, type = "classes",
  col = lc_plot_cols$color, 
  levels = lc_plot_cols$name,
  mar = c(1.2,1.2,0.5,0.5), legend = F)
dev.off()
})

# abandoned pixels only:
lapply(1:11, function(i) {
  pdf(file = paste0(p_plots, "methods/maps/abn_", site_df$site[i], "_2017.pdf"),
      width = 2, height = 2)
par(bg=NA, mar=c(0,0,0,0), oma=c(0,0,0,0))
terra::plot(
  max_abn_lcc[[i]]$y2017, type = "classes",
    col = lc_plot_cols$color[2:4], 
    levels = lc_plot_cols$name[2:4],
  mar = c(1.2,1.2,0.5,0.5), legend = F)
dev.off()
})

lapply(1:11, function(i) {
  pdf(file = paste0(p_plots, "methods/maps/abn_", site_df$site[i], "_1987.pdf"),
      width = 2, height = 2)
par(bg=NA, mar=c(0,0,0,0), oma=c(0,0,0,0))
terra::plot(
  max_abn_lcc[[i]]$y1987, type = "classes",
    col = lc_plot_cols$color[2:4], 
    levels = lc_plot_cols$name[2:4],
  mar = c(1.2,1.2,0.5,0.5), legend = F)
dev.off()
})

# terra_plot_abn <- 
  raster::plot(
    max_abn_lcc[[i]]$y2007, type = "classes",
    col = lc_plot_cols$color[2:4], 
    levels = lc_plot_cols$name[2:4]
    )

```


# Extras


```{r number-sp-per-site}
sp_threat_palette <- palette_du_jour[c(1,6)]
names(sp_threat_palette) <- c("bird", "mam")

sp_threat_palette2 <- c(
  "bird_no" = input_palette[1],
  "bird_yes" = alpha(input_palette[1], 0.4),
  "mam_yes" = alpha(input_palette[4], 0.4),
  "mam_no" = input_palette[4]
)
show_col(sp_threat_palette2)



# this contains all species present in any of the aoh_types. Use aoh_ms_tmp_trends_incl_mature to include only crop_abn_iucn species
aoh_species_list_by_site <-
  aoh %>% 
  filter(
    aoh_type == "crop_abn_iucn",
    passage_type == "exclude_passage",
    aoh > 0,
    vert_class != "amp") %>%
  select(
    # aoh_type,
    vert_class, site, binomial,
    redlistCategory, mature_forest_obl, #common_names, 
    passage_type
    ) %>%
  unique() %>%
  left_join(species_attributes) %>%
  
  # add grouping variables
  mutate(
    threatened = case_when(
      redlistCategory %in% c("Critically Endangered", 
                             "Endangered", "Vulnerable") ~ "Threatened",
      redlistCategory %in% c("Near Threatened", "Least Concern") ~ "Not Threatened",
      redlistCategory == "Data Deficient" ~ "Data Deficient"),
    small = case_when(range_size_quantile > 0.5 ~ "not_small_ranged", range_size_quantile <= 0.5 ~ "small_ranged"),
    mature = case_when(
      mature_forest_obl <= 0.5 ~ "no",
      mature_forest_obl > 0.5 ~ "yes"))

# how many #
aoh_species_list_by_site %>%
  # select(vert_class, mature, threatened, binomial) %>% unique() %>%
  group_by(#vert_class, 
           site, threatened, mature) %>%
  summarise(n_sp = n()) %>% ungroup() %>%
  pivot_wider(id_cols = c(#vert_class, 
                          site, mature), names_from = threatened, values_from = n_sp) %>% 
  replace_na(replace = list(`Not Threatened` = 0, Threatened = 0, `Data Deficient` = 0)) %>%
  arrange(mature) %>%
  print(n = 50)
(75/(2188+75))


# calculate the number of unique "threatened" species that occur at one of my sites
aoh_species_list_by_site %>%
  select(vert_class, binomial, threatened, mature) %>% unique() %>%
  group_by(threatened, mature) %>%
  summarise(n_sp = n()) %>% ungroup()

# ------------------------------------------------ #
# MS version
# New category
# ------------------------------------------------ #
gg_n_sp_by_site_w_iucn_cat_and_mat <-
  aoh_species_list_by_site %>%
  group_by(vert_class, site, threatened, mature) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  group_by(site, vert_class) %>% mutate(n_sp_vert = sum(n_sp)) %>% ungroup() %>% # add total
  group_by(site) %>% mutate(n_sp_total = sum(n_sp)) %>% ungroup() %>% # add total
  filter(threatened != "Data Deficient") %>%
    mutate(vert_class_mature = paste0(vert_class, "_", mature)) %>%
    arrange(site) %>%
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)), 
             fill = vert_class_mature,
             group = vert_class)) +
  geom_col(position = position_dodge2(width = 0.7, preserve = "single"), width = 0.85, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_x_continuous(n.breaks = 8) + 
  scale_fill_manual(labels = c(
    "bird_yes" = "Birds, mature forest obligate",
    "bird_no" = "Birds, non-obligate",
    "mam_yes" = "Mammals, mature forest obligate",
    "mam_no" = "Mammals, non-obligate"), 
    values = sp_threat_palette2) +
  labs(x = "Number of Species with AOH", y = NULL, fill = NULL) +
    guides(fill = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin=margin()) +
  facet_grid(cols = vars(threatened), scales = "free_x")


ggsave(plot = gg_n_sp_by_site_w_iucn_cat_and_mat,
       filename = paste0(p_plots, "richness_by_site_w_iucn_cat_and_mat.pdf"),
       width = 5.5, height = 6, units = "in")

ggsave(plot = gg_n_sp_by_site_w_iucn_cat_and_mat + 
         guides(fill = guide_legend(ncol = 1)) +
         theme(legend.position = "right"),
       filename = paste0(p_plots, "richness_by_site_w_iucn_cat_and_mat_preso.pdf"),
       width = 7, height = 5, units = "in")


# ------------------------------------------------ #
# MS version - small ranged species
# ------------------------------------------------ #
gg_n_sp_by_site_w_iucn_cat_and_small <-
  aoh_species_list_by_site %>%
  group_by(vert_class, site, mature,
           # threatened,
           small
           ) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  group_by(site, vert_class) %>% mutate(n_sp_vert = sum(n_sp)) %>% ungroup() %>% # add total
  group_by(site) %>% mutate(n_sp_total = sum(n_sp)) %>% ungroup() %>% # add total
  filter(
    # threatened != "Data Deficient",
    # small != "Range size >\nglobal median" 
         ) %>%
    mutate(vert_class_mature = paste0(vert_class, "_", mature)) %>%
    arrange(site) %>%
    
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)), 
             fill = vert_class_mature,
             group = vert_class
             )) +
  geom_col(position = position_dodge2(width = 0.7, preserve = "single"),
           width = 0.85, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_x_continuous(n.breaks = 5) + 
  scale_fill_manual(labels = c(
    "bird_yes" = "Birds, mature forest obligate",
    "bird_no" = "Birds, non-obligate",
    "mam_yes" = "Mammals, mature forest obligate",
    "mam_no" = "Mammals, non-obligate"), 
    values = sp_threat_palette2) +
  labs(x = "Number of Species with AOH", y = NULL, fill = NULL) +
    guides(fill = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin=margin()) +
  facet_grid(
    # rows = vars(threatened),
    cols = vars(small),
    scales = "free_x",
    # space = "free_x"
    labeller = as_labeller(c(
      "not_small_ranged" = "Range size >\nglobal median",
      "small_ranged" = "Range size \u2264\nglobal median"
      )))


ggsave(plot = gg_n_sp_by_site_w_iucn_cat_and_small,
       filename = paste0(p_plots, "richness_by_site_w_iucn_cat_and_small.pdf"),
       width = 5.5, height = 6, units = "in",
       device = cairo_pdf)


ggsave(plot = gg_n_sp_by_site_w_iucn_cat_and_small + 
         guides(fill = guide_legend(ncol = 1)) +
         theme(legend.position = "right"),
       filename = paste0(p_plots, "richness_by_site_w_iucn_cat_and_small_preso.pdf"),
       width = 7, height = 5, units = "in",
       device = cairo_pdf)



# --------------------------------------------------- #
# threatened:
# --------------------------------------------------- #

gg_n_sp_by_cat <-s
  aoh_species_list_by_site %>%
  group_by(vert_class, site, threatened#, mature
           ) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  group_by(site) %>% mutate(n_sp_total = sum(n_sp)) %>% ungroup() %>%
  filter(threatened != "Data Deficient") %>%
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)),
             # fill = threatened, alpha = vert_class,
             alpha = threatened,
             fill = vert_class,
             group = vert_class
             # group = interaction(vert_class, threatened)
             )) +
  geom_col(
    position = position_dodge2(width = 0.7, preserve = "total"),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(
    labels = c("bird" = "Birds", "mam" = "Mammals"),
    values = sp_threat_palette,
    ) +
  scale_alpha_manual(values = c(0.5, 1)) +
  labs(x = "Number of Species with AOH", y = NULL,
       alpha = "IUCN Status",
       fill = "Vert. Class") +
  guides(fill = guide_legend(nrow = 2), alpha = guide_legend(reverse = TRUE)) +
  theme(legend.position = c(0.78, 0.75))

gg_n_sp_by_cat + geom_vline(xintercept = 360)

ggsave(plot = gg_n_sp_by_cat,
       filename = paste0(p_plots, "richness_by_site_w_category.pdf"),
       width = 4, height = 4, units = "in")



# --------------------------------------------------- #
# faceted
# --------------------------------------------------- #
# gg_n_sp_by_cat_facet <-
  aoh_species_list_by_site %>%
  group_by(vert_class, site, threatened) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  filter(threatened != "Data Deficient") %>%
    
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp)),
             fill = vert_class, group = vert_class)) +
  geom_col(
    position = position_dodge(width = 0.7, preserve = "total"),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  # scale_fill_manual(labels = c("mam" = "Mammals", "bird" = "Birds"),
  # values = c("black", "gray80")) +
  scale_fill_manual(
  labels = c("bird" = "Birds", "mam" = "Mammals"),
  values = sp_threat_palette
  ) +
  labs(x = "Number of Species with AOH", y = NULL,
       fill = "Vert. Class") +
  theme(legend.position = "bottom") +
  facet_wrap(vars(threatened), scales = "free_x")

ggsave(plot = gg_n_sp_by_cat_facet,
       filename = paste0(p_plots, "richness_by_site_w_category_facet.pdf"),
       width = 4.5, height = 4.5, units = "in")



# --------------------------------------------------- #
# faceted, now excluding mature forest obligates
# --------------------------------------------------- #
aoh_trends_by_sp %>% 
  filter(passage_type == "exclude_passage",
         vert_class != "amp", 
         !aoh_type %in% c("abn_iucn", "potential_abn_iucn"),
         !grepl("potential", aoh_type),
         # aoh_type == "crop_abn_iucn",
         # mature_forest_obl < 0.5
         ) %>%
  group_by(aoh_type, vert_class, passage_type, 
           mature = case_when(
             mature_forest_obl <= 0.5 ~ "no",
             mature_forest_obl > 0.5 ~ "yes"),
           # overall_trend, trend_direction, trend_consistency
           ) %>%
  summarise(n_sp = n()) %>% 
  ungroup() %>% group_by(aoh_type, vert_class) %>% mutate(vN = sum(n_sp)) %>%
  ungroup() %>% group_by(aoh_type) %>% mutate(N = sum(n_sp))


# gg_n_sp_by_cat_facet_no_mat <-
  aoh_species_list_by_site %>%
  group_by(vert_class, site, threatened, mature) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  group_by(site) %>% mutate(n_sp_total = sum(n_sp)) %>% ungroup() %>% # add total
  filter(threatened != "Data Deficient") %>%
    
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp)),
             fill = vert_class, col = vert_class,
             alpha = mature,
             group = interaction(vert_class#, mature
                                 ))) +
  geom_col(
    position = position_dodge2(width = 0.7, preserve = "single"),
    # position = position_stack(),
    width = 0.75, # color = "black"
      ) + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_x_continuous(n.breaks = 8) + 
  scale_fill_manual(labels = c("bird" = "Birds", "mam" = "Mammals"),
                    values = sp_threat_palette) +
      scale_color_manual(labels = c("bird" = "Birds", "mam" = "Mammals"),
                    values = sp_threat_palette) +
  scale_alpha_manual(values = c(1, 0), labels = c("no" = "No", "yes" = "Yes")) +
  labs(x = "Number of Species with AOH", y = NULL,
       fill = "Vert. Class", alpha = "Mature Forest Obligate") +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin=margin()) +
  # guides() +
  facet_wrap(vars(threatened), scales = "free_x")


ggsave(plot = gg_n_sp_by_cat_facet_no_mat,
       filename = paste0(p_plots, "richness_by_site_w_category_facet_no_mat.pdf"),
       width = 5.5, height = 6, units = "in")

ggsave(plot = aoh_species_list_by_site %>%
  group_by(vert_class, site, threatened, mature) %>%
  summarise(n_sp = n()) %>% ungroup() %>% 
  group_by(site) %>% mutate(n_sp_total = sum(n_sp)) %>% ungroup() %>% # add total
  filter(threatened != "Data Deficient") %>%
    
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp)),
             fill = vert_class, alpha = mature,
             group = interaction(vert_class, mature))) +
  geom_col(
    position = position_dodge(width = 0.7, preserve = "single"),
    # position = position_stack(),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_x_continuous(n.breaks = 8) + 
  scale_fill_manual(labels = c("bird" = "Birds", "mam" = "Mammals"),
                    values = sp_threat_palette) +
  scale_alpha_manual(values = c(0.85, 0.25, 1), labels = c("no" = "No", "yes" = "Yes")) +
  labs(x = "Number of Species with AOH", y = NULL,
       fill = "Vert. Class", alpha = "Mature Forest Obligate") +
  theme(legend.position = "right", legend.box = "vertical", legend.margin=margin()) +
  # guides() +
  facet_wrap(vars(threatened), scales = "free_x"),
  
  filename = paste0(p_plots, "richness_by_site_w_category_facet_no_mat_wide.pdf"),
  width = 7.5, height = 5, units = "in")





# # # # # # # # # # # # # # # # # # # # # # # #
# Birds only:

# gg_n_sp_by_cat_facet_no_mat_birds_only <- 
  aoh_species_list_by_site %>%
  filter(
    #passage_type == "exclude_passage",
         vert_class != "amp", 
         # mature_forest_obl < 0.5,
         vert_class == "bird",
         # aoh_type == i
         ) %>%
  mutate(
    threatened = case_when(
      redlistCategory %in% 
        c("Critically Endangered", "Endangered", "Vulnerable") ~ "Threatened",
      TRUE ~ "Not Threatened"),
    mat = case_when(mature_forest_obl > 0.5 ~ "yes",
                    mature_forest_obl < 0.5 ~ "no")
    ) %>%
  group_by(vert_class, site, threatened, mat) %>%
  summarise(n_sp = n()) %>% ungroup() %>% print(n = 100)
  ggplot(aes(x = n_sp, 
             y = fct_reorder(site, desc(n_sp)),
             fill = vert_class, group = vert_class)) +
  geom_col(
    position = position_dodge(width = 0.7, preserve = "total"),
    width = 0.5, color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(labels = c("mam" = "Mammals", "bird" = "Birds"),
                    values = c("black", "gray80")) +
  # scale_fill_manual(
    # labels = c("bird" = "Birds", "mam" = "Mammals"),
    # values = sp_threat_palette
    # ) +
  labs(x = "Number of Species with AOH", y = NULL,
       fill = "Vert. Class") +
  theme(legend.position = "bottom") +
  facet_wrap(vars(threatened), scales = "free_x")


# --------------------------------------------------- #
# Basic richness plot 
# --------------------------------------------------- #
gg_n_sp <-
  n_sp_df %>% 
  ggplot(aes(x = n_sp, y = fct_reorder(site, desc(n_sp_total)), 
             fill = vert_class)) +
  geom_col(position = position_dodge(width = 0.7, preserve = "single"),
           width = 0.5,
           color = "black") + 
  theme_classic() +  
  scale_y_discrete(labels = fancy_labels) +
  scale_fill_manual(labels = c("mam" = "Mammals", "bird" = "Birds"), 
                      values = c("black", "gray80")) + 
  labs(x = "Number of Species with AOH", y = NULL, fill = "Vert. Class") + 
  theme(legend.position = c(0.8, 0.87))

ggsave(plot = gg_n_sp,
       filename = paste0(p_plots, "richness_by_site.pdf"),
       width = 4, height = 4, units = "in")

# --------------------------------------------------- #
# --------------------------------------------------- #


# Composite figure:
world <- ne_countries(scale = "small", returnclass = "sf") #%>% st_make_valid() # can set returnclass to sf or sp.
sf_width <- 0.25
sf_width2 <- 0.1

gg_simple_globe <- 
  ggplot() + 
  # theme_classic() +
  theme_minimal() +
  geom_sf(data = world %>% filter(continent != "Antarctica"), 
          fill = NA, color = "gray50", size = sf_width) +
  geom_sf(data = site_sf, mapping = aes(fill = desc), size = sf_width2) + 
  labs(#subtitle = "Map projection: longlat", 
       x = NULL, y = NULL) +
  theme(legend.position = "none") + 
  geom_label_repel(data = site_sf,
                   aes(label = label, geometry = geometry),
                   stat = "sf_coordinates",
                   min.segment.length = 0.0, segment.alpha = 1,
                   point.padding = 0.2, box.padding = 0.2,
                   label.size = 0.3, color = "black") + 
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", "eqearth")))


ggsave(plot = gg_simple_globe,
       filename = paste0(p_plots, "fig0_new.pdf"),
       width = 5, height = 2.5, units = "in")

i
# construct individual ggplots for each site
for (i in 1:11) {
  assign(
  x = paste0("gg_sp", site_df$label[i]),
  value = 
    n_sp_df %>% 
    filter(site == site_df$site[i]) %>%
    ggplot(aes(x = vert_class, y = n_sp,          
               fill = vert_class, col = vert_class)) +
    geom_col(show.legend = FALSE) + 
    guides(col = "none") +
    theme_classic() +  
    scale_x_discrete(labels = c("mam" = "Mammals", "bird" = "Birds")) + 
    ylim(0, max(n_sp_df$n_sp)) + 
    labs(x = NULL, y = "Number of Species", title = site_sf$lab_desc[i])
  )
}
gg_sp_bh

gg_site_locations <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", "natearth2"))) +
  theme(legend.position = "none",
        plot.margin = margin(0, 0, 2, 0, "mm"))

# for testing:
# pan_top <- plot_grid(tp11, tp1, tp10, tp8, nrow = 1)
# pan_l <- plot_grid(tp7, tp6, ncol = 1)
# pan_r <- plot_grid(tp9, tp3, ncol = 1)
# pan_bottom <- plot_grid(tp4, tp2, tp5, nrow = 1, ncol = 3)

# with full rasters, gray background
pan_top <- plot_grid(gg_sp_w, gg_sp_b, gg_sp_v, gg_sp_o, nrow = 1)
pan_l <- plot_grid(gg_sp_n, gg_sp_mg, ncol = 1)
pan_r <- plot_grid(gg_sp_s, gg_sp_c, ncol = 1)
pan_bottom <- plot_grid(gg_sp_g, gg_sp_bh, gg_sp_i, nrow = 1, ncol = 3)

pan_middle <- plot_grid(pan_l, gg_simple_globe, pan_r, 
                        rel_widths = c(1, 6, 1),
          nrow = 1, ncol = 4)

# save composite figure with map
ggsave(plot = plot_grid(NULL, pan_top, pan_middle, pan_bottom, 
                        ncol = 1, nrow = 4,
                        rel_heights = c(0.05, 1, 4, 1)),
       filename = paste0(p_plots, "site_map_w_richness.pdf"),
       width = 14, height = 10, units = "in", dpi = 400
       )


library(patchwork)

gg_simple_globe + 
  inset_element(gg_sp_b, left = 0.8, bottom = 0.5, right = 1, top = 1)


gg_simple_globe + gg_sp_b
```





